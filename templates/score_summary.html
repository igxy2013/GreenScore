<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>评分汇总</title>
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/all.min.css') }}">
    <!-- 添加Remix Icon图标库 -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        .star-icon {
            font-size: 1.5rem;
            margin: 0 2px;
            vertical-align: middle;
            display: inline-block;
            line-height: 1;
        }
        .score-summary-container {
            margin-bottom: 1.5rem;
        }
        .score-table th, .score-table td {
            padding: 0.75rem 1.5rem;
        }
        
        /* 确保星级图标左对齐 */
        #star-rating-stars-cell {
            vertical-align: middle !important;
            text-align: left !important;
        }
        
        #star-rating-stars {
            display: inline-flex !important;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <input type="hidden" id="current-project-standard" value="{{ project.standard if project and project.standard else '成都市标' }}">
    <input type="hidden" id="current_project_name" value="{{ project.name if project else '' }}">
    <input type="hidden" id="project_id" value="{{ project.id if project else '21' }}">

    <div class="container mx-auto p-4">
        <!-- 各专业得分汇总 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h3 class="text-lg font-medium mr-4">各专业得分汇总</h3>
                </div>
            </div>

            <div class="overflow-x-auto score-summary-container">
                <table class="w-full">
                    <thead>
                        <tr class="bg-blue-500 text-white">
                            <th class="px-6 py-3 text-center">专业</th>
                            <th class="px-6 py-3 text-center">建筑专业</th>
                            <th class="px-6 py-3 text-center">结构专业</th>
                            <th class="px-6 py-3 text-center">给排水专业</th>
                            <th class="px-6 py-3 text-center">电气专业</th>
                            <th class="px-6 py-3 text-center">暖通专业</th>
                            <th class="px-6 py-3 text-center">景观专业</th>
                            <th class="px-6 py-3 text-center" id="env_health_energy_header">环境健康与节能专业</th>
                            <th class="px-6 py-3 text-center">合计</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 专业得分行 -->
                        <tr id="specialty-scores-row" class="border-b text-center">
                            <td class="px-6 py-4">得分</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4" id="env_health_energy_column">0.0</td>
                            <td class="px-6 py-4 font-bold total-score">0.0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 各分类得分汇总 -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-medium mb-4">各分类得分汇总</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-blue-500 text-white">
                            <th class="px-6 py-3 text-center">分类</th>
                            <th class="px-6 py-3 text-center">安全耐久</th>
                            <th class="px-6 py-3 text-center">健康舒适</th>
                            <th class="px-6 py-3 text-center">生活便利</th>
                            <th class="px-6 py-3 text-center">资源节约</th>
                            <th class="px-6 py-3 text-center">环境宜居</th>
                            <th class="px-6 py-3 text-center">提高与创新</th>
                            <th class="px-6 py-3 text-center">合计</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 分类得分行 - 将由JavaScript动态更新 -->
                        <tr id="category-scores-row" class="border-b text-center">
                            <td class="px-6 py-4">得分</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4 font-bold">0.0</td>
                        </tr>
                        <!-- 最低分值行 - 将由JavaScript动态更新 -->
                        <tr>
                            <td class="px-6 py-4">最低分值</td>
                            <td class="px-6 py-4">30.0</td>
                            <td class="px-6 py-4">30.0</td>
                            <td class="px-6 py-4">21.0</td>
                            <td class="px-6 py-4">60.0</td>
                            <td class="px-6 py-4">30.0</td>
                            <td class="px-6 py-4">0.0</td>
                            <td class="px-6 py-4 font-bold">171</td>
                        </tr>
                        <!-- 达标判断行 - 将由JavaScript动态更新 -->
                        <tr>
                            <td class="px-6 py-4">达标判断</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4 font-bold">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 星级判定表格 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h3 class="text-base font-normal mb-4">绿色建筑星级评定</h3>
            <div class="overflow-auto">
                <table class="w-full score-table">
                    <thead>
                        <tr>
                            <th class="px-6 py-4 text-base font-normal text-left bg-blue-500 text-white align-middle">项目名称</th>
                            <th class="px-6 py-4 text-base font-normal text-left bg-blue-500 text-white align-middle">总得分</th>
                            <th class="px-6 py-4 text-base font-normal text-left bg-blue-500 text-white align-middle">星级评定</th>
                            <th class="px-6 py-4 text-base font-normal text-left bg-blue-500 text-white align-middle">评定结果</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="star-rating-row" class="star-rating-row">
                            <td class="px-6 py-4 text-base text-left align-middle">{{ project.name if project else '未设置项目名称' }}</td>
                            <td class="px-6 py-4 text-base text-left align-middle" id="star-rating-score">0.0</td>
                            <td class="px-6 py-4 text-base text-left align-middle" id="star-rating-stars-cell">
                                <span id="star-rating-stars" class="text-2xl inline-flex items-center justify-start"></span>
                            </td>
                            <td class="px-6 py-4 text-base text-left align-middle" id="star-rating-total">-</td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- 添加保存星级案例按钮，仅管理员可见 -->
                {% if session.get('role') == 'admin' %}
                <div class="mt-6 flex justify-center">
                    <button id="saveStarCaseBtn" class="px-6 py-3 bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        <i class="ri-save-line mr-2"></i>保存星级案例
                    </button>
                </div>
                {% endif %}
            </div>
            
            <!-- 星级标准说明 -->
            <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <h4 class="font-bold mb-2">星级评定标准说明：</h4>
                <ul class="list-disc pl-5 space-y-2">
                    <li><span class="inline-block px-3 py-1 rounded-full bg-green-100 text-green-800 font-medium">三星级</span>：总得分 ≥ 450分 且 <span class="font-medium">所有分类均达标</span></li>
                    <li><span class="inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-800 font-medium">二星级</span>：总得分 ≥ 300分 且 <span class="font-medium">所有分类均达标</span></li>
                    <li><span class="inline-block px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 font-medium">一星级</span>：总得分 ≥ 200分 且 <span class="font-medium">所有分类均达标</span></li>
                    <li><span class="inline-block px-3 py-1 rounded-full bg-red-100 text-red-600 font-medium">未达标</span>：总得分 < 200分 或 <span class="text-red-600">任一分类未达标</span></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function updateStarRating() {
            try {
                // 获取总分
                const categoryScoresRow = document.getElementById('category-scores-row');
                if (!categoryScoresRow) {
                    console.error('找不到得分行元素');
                    return;
                }
                
                // 获取总分单元格（第8个单元格，索引为7）
                const totalScoreCell = categoryScoresRow.cells[7];
                if (!totalScoreCell) {
                    console.error('找不到总分单元格');
                    return;
                }
                
                const totalScoreText = totalScoreCell.innerText;
                const totalScore = parseFloat(totalScoreText);
                
                if (isNaN(totalScore)) {
                    console.error('总分不是有效数字:', totalScoreText);
                    return;
                }
                
                console.log('当前总分:', totalScore);
                
                // 更新星级判定表格中的总分
                const starRatingScore = document.getElementById('star-rating-score');
                if (starRatingScore) {
                    starRatingScore.innerText = totalScore.toFixed(1);
                }
                
                // 检查所有分类是否都达标
                const judgmentRow = categoryScoresRow.parentNode.querySelector('tr:nth-child(3)');
                let allCategoriesAchieved = true;
                
                if (judgmentRow) {
                    // 检查每个分类的达标情况（从第2个单元格到第7个单元格，索引1-6）
                    for (let i = 1; i <= 6; i++) {
                        const cell = judgmentRow.cells[i];
                        if (cell && cell.textContent !== '达标') {
                            allCategoriesAchieved = false;
                            console.log(`分类 ${i} 未达标`);
                            break;
                        }
                    }
                    
                    // 检查总体达标情况（第8个单元格，索引7）
                    const totalJudgmentCell = judgmentRow.cells[7];
                    if (totalJudgmentCell && totalJudgmentCell.textContent !== '达标') {
                        allCategoriesAchieved = false;
                        console.log('总体未达标');
                    }
                } else {
                    console.error('找不到达标判断行');
                    allCategoriesAchieved = false;
                }
                
                console.log('所有分类是否达标:', allCategoriesAchieved);
                
                // 判断星级
                let starRating = '-';
                let starClass = '';
                let starIcons = '';
                let rowClass = '';
                
                // 只有当所有分类都达标时，才进行星级判定
                if (allCategoriesAchieved) {
                    if (totalScore >= 450) {
                        starRating = '三星级';
                        starClass = 'star-three';
                        starIcons = '<i class="ri-star-fill star-icon text-green-600"></i>'.repeat(3);
                        rowClass = 'bg-green-50';
                    } else if (totalScore >= 300) {
                        starRating = '二星级';
                        starClass = 'star-two';
                        starIcons = '<i class="ri-star-fill star-icon text-blue-600"></i>'.repeat(2);
                        rowClass = 'bg-blue-50';
                    } else if (totalScore >= 200) {
                        starRating = '一星级';
                        starClass = 'star-one';
                        starIcons = '<i class="ri-star-fill star-icon text-yellow-600"></i>';
                        rowClass = 'bg-yellow-50';
                    } else {
                        starRating = '未达标';
                        starClass = 'star-none';
                        starIcons = '<i class="ri-close-circle-fill star-icon text-red-600"></i>';
                        rowClass = 'bg-red-50';
                    }
                } else {
                    // 如果有任何分类未达标，则星级判定为"未达标"
                    starRating = '未达标';
                    starClass = 'star-none';
                    starIcons = '<i class="ri-close-circle-fill star-icon text-red-600"></i>';
                    rowClass = 'bg-red-50';
                }
                
                // 更新星级判定结果
                const starRatingTotal = document.getElementById('star-rating-total');
                if (starRatingTotal) {
                    starRatingTotal.innerText = starRating;
                    // 使用内联样式直接设置样式
                    if (starClass === 'star-three') {
                        starRatingTotal.style.color = '#10b981';
                    } else if (starClass === 'star-two') {
                        starRatingTotal.style.color = '#3b82f6';
                    } else if (starClass === 'star-one') {
                        starRatingTotal.style.color = '#f59e0b';
                    } else {
                        starRatingTotal.style.color = '#ef4444';
                    }
                }
                
                // 更新星级图标
                const starRatingStars = document.getElementById('star-rating-stars');
                if (starRatingStars) {
                    starRatingStars.innerHTML = starIcons;
                    starRatingStars.style.display = 'inline-flex';
                    starRatingStars.style.justifyContent = 'flex-start';
                    starRatingStars.style.alignItems = 'center';
                    starRatingStars.style.width = '100%';
                }
                
                // 确保星级图标单元格垂直居中
                const starRatingStarsCell = document.getElementById('star-rating-stars-cell');
                if (starRatingStarsCell) {
                    starRatingStarsCell.style.verticalAlign = 'middle';
                    starRatingStarsCell.style.textAlign = 'left';
                }
                
                // 更新星级判定行样式
                const starRatingRow = document.getElementById('star-rating-row');
                if (starRatingRow) {
                    // 移除旧的背景色类
                    starRatingRow.classList.remove('bg-blue-50', 'bg-green-50', 'bg-yellow-50', 'bg-red-50');
                    
                    // 添加新的背景色类
                    starRatingRow.classList.add(rowClass);
                }
                
                console.log('星级判定更新为:', starRating);
            } catch (error) {
                console.error('更新星级判定时出错:', error);
            }
        }

        // 在页面加载完成后执行星级判定
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化星级判定');
            // 移除延迟执行，立即判定星级
            updateStarRating();
            
            // 监听父窗口发送的消息
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'updateScores') {
                    console.log('收到更新评分数据请求:', event.data);
                    // 更新表格中的数据
                    if (event.data.data) {
                        updateTablesWithScores(event.data.data);
                        // 立即更新星级判定，不需要延迟
                        updateStarRating();
                    }
                }
            });
            
            // 发送准备就绪消息给父窗口
            window.parent.postMessage({ type: 'iframeReady' }, '*');
            
            // 更新表格中的评分数据
            function updateTablesWithScores(data) {
                try {
                    console.log('更新表格数据:', data);
                    const specialtyScores = data.specialty_scores || {};
                    const specialtyScoresByCategory = data.specialty_scores_by_category || {};
                    const totalScore = data.total_score || 0;
                    
                    // 更新专业得分行
                    const specialtyScoresRow = document.getElementById('specialty-scores-row');
                    if (specialtyScoresRow) {
                        // 更新各专业得分（API返回的数据格式为专业全称->得分值）
                        specialtyScoresRow.cells[1].innerText = specialtyScores['建筑专业'] !== undefined ? specialtyScores['建筑专业'].toFixed(1) : '0.0';
                        specialtyScoresRow.cells[2].innerText = specialtyScores['结构专业'] !== undefined ? specialtyScores['结构专业'].toFixed(1) : '0.0';
                        specialtyScoresRow.cells[3].innerText = specialtyScores['给排水专业'] !== undefined ? specialtyScores['给排水专业'].toFixed(1) : '0.0';
                        specialtyScoresRow.cells[4].innerText = specialtyScores['电气专业'] !== undefined ? specialtyScores['电气专业'].toFixed(1) : '0.0';
                        specialtyScoresRow.cells[5].innerText = specialtyScores['暖通专业'] !== undefined ? specialtyScores['暖通专业'].toFixed(1) : '0.0';
                        specialtyScoresRow.cells[6].innerText = specialtyScores['景观专业'] !== undefined ? specialtyScores['景观专业'].toFixed(1) : '0.0';
                        specialtyScoresRow.cells[7].innerText = specialtyScores['环境健康与节能专业'] !== undefined ? specialtyScores['环境健康与节能专业'].toFixed(1) : '0.0';
                        // 更新总分
                        specialtyScoresRow.cells[8].innerText = totalScore.toFixed(1);
                    }
                    
                    // 计算各分类得分总和（合并所有专业的分类得分）
                    const categoryScores = {
                        '安全耐久': 0,
                        '健康舒适': 0,
                        '生活便利': 0,
                        '资源节约': 0,
                        '环境宜居': 0,
                        '提高与创新': 0
                    };
                    
                    // 遍历所有专业的分类得分并累加
                    Object.values(specialtyScoresByCategory).forEach(specialtyData => {
                        for (const category in categoryScores) {
                            if (specialtyData[category] !== undefined) {
                                categoryScores[category] += parseFloat(specialtyData[category]) || 0;
                            }
                        }
                    });
                    
                    // 检查是否有直接提供的分类得分数据
                    if (data.scores_detail && data.scores_detail['章节分数']) {
                        const chapterScores = data.scores_detail['章节分数'];
                        for (const category in categoryScores) {
                            if (chapterScores[category] !== undefined) {
                                categoryScores[category] = chapterScores[category];
                            }
                        }
                    }
                    
                    // 更新分类得分行
                    const categoryScoresRow = document.getElementById('category-scores-row');
                    if (categoryScoresRow) {
                        // 更新各分类得分
                        categoryScoresRow.cells[1].innerText = categoryScores['安全耐久'].toFixed(1);
                        categoryScoresRow.cells[2].innerText = categoryScores['健康舒适'].toFixed(1);
                        categoryScoresRow.cells[3].innerText = categoryScores['生活便利'].toFixed(1);
                        categoryScoresRow.cells[4].innerText = categoryScores['资源节约'].toFixed(1);
                        categoryScoresRow.cells[5].innerText = categoryScores['环境宜居'].toFixed(1);
                        categoryScoresRow.cells[6].innerText = categoryScores['提高与创新'].toFixed(1);
                        // 更新总分
                        categoryScoresRow.cells[7].innerText = totalScore.toFixed(1);
                    }
                    
                    // 更新达标判断行
                    if (categoryScoresRow) {
                        const judgmentRow = categoryScoresRow.parentNode.querySelector('tr:nth-child(3)');
                        if (judgmentRow) {
                            // 最低分值限制
                            const minScores = {
                                '安全耐久': 30.0,
                                '健康舒适': 30.0,
                                '生活便利': 21.0,
                                '资源节约': 60.0,
                                '环境宜居': 30.0,
                                '提高与创新': 0.0
                            };
                            
                            // 检查每个分类是否达标
                            let allCategoriesAchieved = true;
                            let categoryIndex = 1; // 从索引1开始
                            
                            for (const category in minScores) {
                                const categoryScore = categoryScores[category] || 0;
                                const isAchieved = categoryScore >= minScores[category];
                                
                                // 更新达标判断结果
                                judgmentRow.cells[categoryIndex].innerText = isAchieved ? '达标' : '未达标';
                                
                                // 设置达标判断结果的样式
                                if (isAchieved) {
                                    judgmentRow.cells[categoryIndex].style.color = '#10b981'; // 绿色
                                } else {
                                    judgmentRow.cells[categoryIndex].style.color = '#ef4444'; // 红色
                                    allCategoriesAchieved = false;
                                }
                                
                                categoryIndex++;
                            }
                            
                            // 更新总体达标判断
                            judgmentRow.cells[7].innerText = allCategoriesAchieved ? '达标' : '未达标';
                            judgmentRow.cells[7].style.color = allCategoriesAchieved ? '#10b981' : '#ef4444';
                        }
                    }
                    
                    // 更新星级评定表格
                    const starRatingScore = document.getElementById('star-rating-score');
                    if (starRatingScore) {
                        starRatingScore.innerText = totalScore.toFixed(1);
                    }
                    
                    // 打印调试信息
                    console.log('各专业得分:', specialtyScores);
                    console.log('各分类得分:', categoryScores);
                    console.log('总分:', totalScore);
                    
                } catch (error) {
                    console.error('更新表格数据时出错:', error);
                }
            }
            
            // 保存星级案例按钮的事件处理
            const saveStarCaseBtn = document.getElementById('saveStarCaseBtn');
            if (saveStarCaseBtn) {
                saveStarCaseBtn.addEventListener('click', function() {
                    // 通知父窗口执行保存操作
                    window.parent.postMessage({ type: 'saveStarCase' }, '*');
                });
            }
        });
    </script>
</body>
</html> 