<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能绿建评价系统</title>
    <script src="/static/js/iframe-resizer.js"></script>
    <!-- 先加载Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- 加载loader.js -->
    <script src="{{ url_for('static', filename='js/loader.js') }}"></script>
    <!-- 加载气候区划查询工具 -->
    <script src="{{ url_for('static', filename='js/climate_zone.js') }}"></script>
    <!-- 添加html2canvas库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.min.css') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='image/greenscore-sm.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='image/greenscore-32.png') }}">
    <link rel="icon" type="image/png" sizes="48x48" href="{{ url_for('static', filename='image/greenscore.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='image/greenscore-lg.png') }}">
    
    <!-- 绿色建材计算所需的外部库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" defer></script>
    <script src="/static/js/green_building_score_calculator.js"></script>
    <!-- 在 head 部分添加对 db_updater.js 的引用 -->
    <script src="/static/js/db_updater.js"></script>
     <!-- 使用Font Awesome图标库 -->
     <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
     <!-- 引入自定义样式表 -->
     <link href="{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
    
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/all.min.css') }}">
    <!-- 使用本地Font Awesome图标库替代Remix Icon -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/icon-compatibility.css') }}">
    
    <!-- 引入JavaScript文件 -->
    <script src="{{ url_for('static', filename='js/score_helper.js') }}"></script>
    <script src="{{ url_for('static', filename='js/score_summary.js') }}"></script>
    
    <script>
    function filterTableByClause(query) {
        // 获取所有表格行
        const rows = document.querySelectorAll('table tbody tr');
        
        // 如果查询为空，显示所有行
        if (!query.trim()) {
            rows.forEach(row => row.style.display = '');
            return;
        }
        
        // 遍历每一行进行过滤
        rows.forEach(row => {
            // 获取条文号列的内容
            const clauseCell = row.querySelector('td:first-child');
            if (clauseCell) {
                const clauseText = clauseCell.textContent.toLowerCase();
                // 如果条文号包含查询文本，显示该行，否则隐藏
                if (clauseText.includes(query.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }
    </script>
    
    <!-- 添加climate_zone.js引用，放在页面头部的script标签之前 -->
    <script src="{{ url_for('static', filename='js/climate_zone.js') }}"></script>
    <script>
        // 页面变量
        // ... existing code ...
    </script>
    <!-- 引入Chart.js用于数据可视化 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/green_building_score_calculator.js"></script>
    <!-- 在 head 部分添加对 db_updater.js 的引用 -->
    <script src="/static/js/db_updater.js"></script>
    <!-- 引入iframe-resizer.js用于iframe高度自适应 -->
    <script src="{{ url_for('static', filename='js/iframe-resizer.js') }}"></script>

    <!-- 添加menu.js引用，确保在所有使用它的代码之前 -->
    <script src="/static/js/menu.js"></script>
    
    <script>
        // 在这里添加自定义的updateScoreSummaryTables函数，它会被scoreUtils.fetchScoreSummary调用
        // 更新评分汇总表格
        function updateScoreSummaryTables(data) {
            console.log('更新评分汇总表格:', data);
            
            // 如果数据为空或无效，显示提示并返回
            if (!data || typeof data !== 'object') {
                console.error('更新评分汇总表格失败: 无效的数据格式', data);
                alert('获取评分数据失败，请刷新页面重试');
                return;
            }
            
            // 显示最后更新时间
            const lastUpdateTimeElement = document.getElementById('lastUpdateTime');
            if (lastUpdateTimeElement && data.timestamp) {
                lastUpdateTimeElement.textContent = `最后更新时间: ${data.timestamp}`;
            }
            
            // 更新专业得分行
            const specialtyScoresRow = document.getElementById('specialty-scores-row');
            if (specialtyScoresRow && data.specialty_scores) {
                const specialtyScores = data.specialty_scores;
                
                // 获取项目评价标准
                const projectStandard = data.project_standard || document.getElementById('current-project-standard')?.value || '';
                
                // 显示或隐藏环境健康与节能专业列
                const envHealthEnergyHeader = document.getElementById('env_health_energy_header');
                const envHealthEnergyColumn = document.getElementById('env_health_energy_column');
                if (envHealthEnergyHeader) {
                    envHealthEnergyHeader.style.display = projectStandard === '四川省标' ? '' : 'none';
                    if (envHealthEnergyColumn) {
                        envHealthEnergyColumn.style.display = projectStandard === '四川省标' ? '' : 'none';
                    }
                }
                
                // 更新各专业得分
                updateCell(specialtyScoresRow, 1, specialtyScores['建筑专业'] || 0);
                updateCell(specialtyScoresRow, 2, specialtyScores['结构专业'] || 0);
                updateCell(specialtyScoresRow, 3, specialtyScores['给排水专业'] || 0);
                updateCell(specialtyScoresRow, 4, specialtyScores['电气专业'] || 0);
                updateCell(specialtyScoresRow, 5, specialtyScores['暖通专业'] || 0);
                updateCell(specialtyScoresRow, 6, specialtyScores['景观专业'] || 0);
                
                // 如果是四川省标，更新环境健康与节能专业得分
                if (projectStandard === '四川省标') {
                    updateCell(specialtyScoresRow, 7, specialtyScores['环境健康与节能专业'] || 0);
                }
                
                // 更新总分
                const totalScore = data.total_score || 0;
                const totalScoreCell = specialtyScoresRow.querySelector('.total-score');
                if (totalScoreCell) {
                    totalScoreCell.textContent = totalScore.toFixed(1);
                }
            }
            
            // 继续保留其余的updateScoreSummaryTables函数内容...
        }
    </script>

    <!-- 更新所有调用fetchScoreSummary的地方改为使用scoreUtils.fetchScoreSummary -->
    <script>
        // 在页面加载完成后获取评分汇总数据
        document.addEventListener('DOMContentLoaded', function() {
            // 使用score_summary.js提供的initializeScoreSummary函数
            if (typeof scoreUtils !== 'undefined' && scoreUtils.initializeScoreSummary) {

            }
        });
    
    </script>

<style>
    body {
        font-family: 'Microsoft YaHei', sans-serif;
        margin: 0;
        padding: 20px;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
        color: #3c8dbc;
        text-align: center;
        margin-bottom: 30px;
    }
    .search-box {
        display: flex;
        margin-bottom: 20px;
    }
    #address {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px 0 0 4px;
        font-size: 16px;
    }
    #search-btn {
        padding: 10px 20px;
        color: white;
        border: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        font-size: 16px;
    }

    #map-container {
        height: 400px;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .result-container {
        margin-bottom: 20px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    table th, table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    table th {
        background-color: #f2f2f2;
    }
    .export-btn {
        padding: 10px 20px;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: block;
        margin: 0 auto;
    }

    .loading {
        text-align: center;
        display: none;
        margin: 20px 0;
    }
    .loading img {
        width: 50px;
    }
</style>

</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 引入用户菜单组件 -->
    {% include 'components/user_menu.html' %}

    <!-- 隐藏字段，用于存储当前项目ID和标准 -->
    <input type="hidden" id="current-project-id" value="{{ project.id if project else '21' }}">
    <input type="hidden" id="current-project-standard" value="{{ project.standard if project else '成都市标' }}">
    
    <div class="page-container">
        <div class="flex min-h-screen">
            <!-- 侧边导航栏 -->
            <aside class="w-72 bg-white shadow-lg fixed h-screen overflow-y-auto z-10">
                <div class="p-6 border-b">
                    <h1 class="text-2xl font-bold text-primary flex items-center">                
                        <picture>
                            <source srcset="{{ url_for('static', filename='image/greenscore@3x.png') }}" media="(-webkit-min-device-pixel-ratio: 3), (min-resolution: 288dpi)">
                            <source srcset="{{ url_for('static', filename='image/greenscore@2x.png') }}" media="(-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi)">
                            <img src="{{ url_for('static', filename='image/greenscore.png') }}" alt="logo" class="inline-block h-8 w-8 mr-2">
                        </picture>
                        <span>智能绿建评价系统</span>
                    </h1>
                    </div>
                <nav class="p-4">
                    <div class="space-y-3">
                        <a href="{{ url_for('project_detail', project_id=project.id) }}" class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50 {% if current_page == 'project_info' %}active{% endif %}">
                            <i class="ri-file-list-line mr-3"></i>
                            <span>项目信息</span>
                        </a>
                        <div class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50" id="basicMenuToggle">
                            <i class="ri-checkbox-line mr-3"></i>
                            <span>基本级</span>
                            <i class="ri-arrow-down-s-line ml-auto"></i>
                        </div>
                        <div id="basicMenuContent" class="menu-content">
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='建筑', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '建筑' %}active{% endif %}">
                                    <i class="ri-building-line mr-3"></i>
                                <span>建筑</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='结构', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '结构' %}active{% endif %}">
                                <i class="ri-layout-2-line mr-3"></i>
                                <span>结构</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='给排水', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '给排水' %}active{% endif %}">
                                <i class="ri-drop-line mr-3"></i>
                                <span>给排水</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='电气', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '电气' %}active{% endif %}">
                                <i class="ri-flashlight-line mr-3"></i>
                                <span>电气</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='暖通', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '暖通' %}active{% endif %}">
                                <i class="ri-temp-hot-line mr-3"></i>
                                <span>暖通</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='景观', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '景观' %}active{% endif %}">
                                <i class="ri-plant-line mr-3"></i>
                                <span>景观</span>
                            </a>
                            {% if project and project.standard == '四川省标' %}
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='环境健康与节能', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '环境健康与节能' %}active{% endif %}">
                                    <i class="ri-leaf-line mr-3"></i>
                                    <span>环境健康与节能</span>
                                </a>
                                {% endif %}
                            </div>

                        {% if not project or project.star_rating_target != '基本级' %}
                        <div class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50" id="advancedMenuToggle">
                            <i class="ri-checkbox-multiple-line mr-3"></i>
                            <span>提高级</span>
                            <i class="ri-arrow-down-s-line ml-auto"></i>
                        </div>
                        <div id="advancedMenuContent" class="menu-content">
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='建筑', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '建筑' %}active{% endif %}">
                                <i class="ri-building-line mr-3"></i>
                                <span>建筑</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='结构', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '结构' %}active{% endif %}">
                                <i class="ri-layout-2-line mr-3"></i>
                                <span>结构</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='给排水', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '给排水' %}active{% endif %}">
                                    <i class="ri-drop-line mr-3"></i>
                                <span>给排水</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='电气', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '电气' %}active{% endif %}">
                                <i class="ri-flashlight-line mr-3"></i>
                                <span>电气</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='暖通', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '暖通' %}active{% endif %}">
                                <i class="ri-temp-hot-line mr-3"></i>
                                <span>暖通</span>
                            </a>
                            {% if project and project.standard == '成都市标' or project and project.standard == '四川省标' %}
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='景观', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '景观' %}active{% endif %}">
                                    <i class="ri-plant-line mr-3"></i>
                                <span>景观</span>
                            </a>
                            {% endif %}
                            {% if project and project.standard == '四川省标' %}
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='环境健康与节能', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '环境健康与节能' %}active{% endif %}">
                                <i class="ri-leaf-line mr-3"></i>
                                    <span>环境健康与节能</span>
                                </a>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        {% if not project or project.star_rating_target != '基本级' %}
                        <a href="{{ url_for('project_detail', project_id=project.id, page='score_summary') }}" 
                        class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50 {% if current_page == 'score_summary' %}active{% endif %}"
                        id="scoreSummaryMenuItem">
                         <i class="ri-bar-chart-line mr-3"></i>
                         <span>评分汇总</span>
                        </a>
                        {% endif %}
                        
                        <div class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50" id="reportMenuToggle">
                            <i class="ri-file-download-line mr-3"></i>
                            <span>报告导出</span>
                            <i class="ri-arrow-down-s-line ml-auto"></i>
                        </div>
                        <div id="reportMenuContent" class="menu-content">
                            <div class="submenu-group" id="reportSubmenu">
                                <a href="javascript:void(0)" onclick="generateWord()" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_page == 'report_table' %}active{% endif %}">
                                    <i class="ri-file-list-3-line mr-3"></i>
                                    <span>报审表</span>
                                </a>
                                <a href="javascript:void(0)" onclick="generateDWG()" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_page == 'dwg_export' %}active{% endif %}">
                                    <i class="ri-leaf-line mr-3"></i>
                                    <span>绿色建筑设计专篇</span>
                                </a>
                                {% if project and project.standard == '国标' %}
                                <a href="javascript:void(0)" onclick="generateSelfAssessmentReport(); return false;" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50">
                                    <i class="ri-book-line mr-3"></i>
                                    <span>绿建自评估报告</span>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50" id="specialCalcMenuToggle">
                            <i class="ri-calculator-line mr-3"></i>
                            <span>专项计算</span>
                            <i class="ri-arrow-down-s-line ml-auto"></i>
                        </div>
                        <div id="specialCalcMenuContent" class="menu-content">
                            <div class="submenu-group" id="specialCalcSubmenu">
                                <a href="{{ url_for('project_detail', project_id=project.id, page='solar_calculator') }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_page == 'solar_calculator' %}active{% endif %}">
                                    <i class="ri-flashlight-line mr-3"></i>
                                    <span>太阳能计算</span>
                                </a>
                                <a href="{{ url_for('project_detail', project_id=project.id, page='green_materials') }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_page == 'green_materials' %}active{% endif %}">
                                    <i class="ri-calculator-line mr-3"></i>
                                    <span>绿色建材应用比例</span>
                                </a>
                                <a href="{{ url_for('project_detail', project_id=project.id, page='public_transport_analysis') }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_page == 'public_transport_analysis' %}active{% endif %}">
                                    <i class="ri-bus-line mr-3"></i>
                                    <span>公共交通分析</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </nav>
            </aside>

            <!-- 主内容区域 -->
            <main class="flex-1 overflow-y-auto p-8 bg-transparent main-content" style="min-height: 100vh;">
              
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <!-- 添加项目管理按钮 -->

                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                            {% if current_page == 'score_summary' %}
                            <h2 class="text-2xl font-bold text-primary">评分汇总</h2>
                            {% elif current_page == 'project_info' %}
                            <h2 class="text-2xl font-bold text-primary">项目信息</h2>
                            {% elif current_page == 'report_table' %}
                            <h2 class="text-2xl font-bold text-primary">报审表</h2>
                            {% elif current_level %}
                            <div class="flex flex-col gap-2">
                                <h2 class="text-2xl font-bold text-primary">{{ current_specialty }}专业</h2>
                                <div class="text-sm text-gray-600">
                                    当前评价标准: {% if project and project.standard == '国标' %}
                                        绿色建筑评价标准 GB/T 50378-2019（2024版）
                                    {% elif project and project.standard == '四川省标' %}
                                        四川省民用绿色建筑设计施工图阶段审查技术要点（2024版）
                                    {% elif project and project.standard == '成都市标' %}
                                        成都市绿色建筑施工图设计与审查技术要点（2024版）
                                    {% else %}
                                        成都市绿色建筑施工图设计与审查技术要点（2024版）
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}

                            {% endif %}
                        </div>
                        <div class="flex items-center gap-4">
                            {% if current_level in ['基本级', '提高级'] %}
                            <div class="relative" >
                                <input type="text" id="clause-filter" placeholder="输入条文号过滤..." class="px-4 py-2 pr-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" oninput="filterTableByClause(this.value)">
                                <!-- <i class="ri-search-line text-gray-400 "></i> -->
                            </div>
                            {% endif %}
                            {% if current_page == 'project_info' %}
                            <a href="{{ url_for('project_management') }}" class="flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                <i class="ri-arrow-left-line mr-2"></i>
                                <span>返回项目管理</span>
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 添加隐藏的项目名称字段，在所有页面都可用 -->
                    <input type="hidden" id="current_project_name" value="{{ project.name if project else '' }}">
                    <!-- 添加隐藏的项目ID字段，在所有页面都可用 -->
                    <input type="hidden" id="project_id" value="{{ project.id if project else '21' }}">

                    {% if current_page == 'score_summary' %}
                    <!-- 通过iframe引入评分汇总页面 -->
                    <iframe id="score-summary-iframe" src="{{ url_for('score_summary_page', project_id=project.id if project else '21') }}" frameborder="0" class="w-full" style="min-height: 1200px;"></iframe>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const iframe = document.getElementById('score-summary-iframe');
                            
                            // 监听iframe中发送的消息
                            window.addEventListener('message', function(event) {
                                if (event.data && event.data.type === 'saveStarCase') {
                                    // 处理保存星级案例的请求
                                    saveStarCase();
                                } else if (event.data && event.data.type === 'iframeReady') {
                                    // iframe已准备就绪，立即发送缓存数据(如果有)
                                    console.log('iframe已准备就绪');
                                    
                                    // 优先使用缓存数据立即显示
                                    const cachedData = sessionStorage.getItem('score_summary_data');
                                    if (cachedData) {
                                        console.log('从缓存加载评分数据到iframe');
                                        updateIframeScores(JSON.parse(cachedData));
                                    }
                                    
                                    // 然后在后台获取最新数据
                                    fetchLatestScoreData();
                                } else if (event.data && event.data.type === 'toast') {
                                    // 处理来自iframe的Toast通知
                                    console.log('收到iframe发来的Toast通知:', event.data.message);
                                    showToast(event.data.message, event.data.toastType || 'info');
                                }
                            });
                            
                            // 保存星级案例的函数
                            function saveStarCase() {
                            const projectId = document.getElementById('project_id').value;
                                fetch('/api/save_star_case', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ project_id: projectId })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        showToast('保存成功', 'success');
                                    } else {
                                        showToast(data.message || '保存失败', 'error');
                                    }
                                })
                                .catch(error => {
                                    console.error('保存星级案例时出错:', error);
                                    showToast('保存失败，请重试', 'error');
                                });
                            }
                            
                            // 向iframe发送评分数据更新的消息
                            function updateIframeScores(data) {
                                iframe.contentWindow.postMessage({
                                    type: 'updateScores',
                                    data: data
                                }, '*');
                            }
                            
                            // 导出updateIframeScores方法，使其可以从外部调用
                            window.updateScoreSummary = updateIframeScores;
                            
                            // 获取最新评分数据并更新iframe
                            function fetchLatestScoreData() {
                                const projectId = document.getElementById('project_id').value;
                                if (!projectId) return;
                                
                                console.log('在后台获取最新评分数据');
                                fetch(`/api/get_score_summary?project_id=${projectId}&force_refresh=true`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(`获取评分数据失败: ${response.status} ${response.statusText}`);
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        console.log('获取最新评分数据成功');
                                        // 更新缓存
                                        sessionStorage.setItem('score_summary_data', JSON.stringify(data));
                                        sessionStorage.setItem('score_summary_cache_time', new Date().getTime().toString());
                                        // 更新iframe
                                        updateIframeScores(data);
                                    })
                                    .catch(error => {
                                        console.error('获取最新评分数据失败:', error);
                                    });
                            }
                            
                            // iframe加载完成后的处理
                            iframe.addEventListener('load', function() {
                                console.log('评分汇总iframe加载完成');
                                
                                // 优先使用缓存数据立即显示
                                const cachedData = sessionStorage.getItem('score_summary_data');
                                if (cachedData) {
                                    console.log('从缓存加载评分数据到iframe');
                                    updateIframeScores(JSON.parse(cachedData));
                                } else {
                                    // 如果没有缓存，在后台获取数据
                                    fetchLatestScoreData();
                                }
                            });
                        });
                    </script>
                    {% endif %}
                    {% block content %}
                    {% if current_page == 'project_info' %}
                    <!-- 项目信息表单 -->
                    <div class="project-info-container">
                        <!-- 使用iframe嵌入项目信息页面，并使用iframe-resizer.js管理高度 -->
                        <iframe id="projectInfoIframe" src="{{ url_for('project_info_page', project_id=project.id if project else '') }}" 
                            style="width:100%; border:none;" scrolling="no"
                            title="项目信息" loading="eager"></iframe>
                    </div>
                    {% elif current_page == 'green_materials' %}
                    <!-- 绿色建材计算器内容 -->
                    <div class="green-materials-container">
                        <!-- 使用iframe嵌入绿色建材计算器，并使用iframe-resizer.js管理高度 -->
                        <iframe id="myIframe" src="{{ url_for('calculator') }}" 
                            style="width:100%; border:none; min-height:800px;" scrolling="auto"
                            title="绿色建材比例计算" loading="eager"></iframe>
                    </div>
                    <script>
                    // 初始化iframe自适应高度
                    document.addEventListener('DOMContentLoaded', function() {
                        if (typeof iFrameResize === 'function') {
                            iFrameResize({
                                log: false,
                                heightCalculationMethod: 'max',
                                checkOrigin: false,
                                scrolling: true,
                                resizeFrom: 'child',
                                autoResize: true,
                                minHeight: 800
                            }, '#myIframe');
                            console.log('绿色建材iframe高度自适应已初始化');
                        } else {
                            console.error('iframe-resizer.js 未正确加载');
                        }
                    });
                    </script>
                    <!-- 移除旧的iframe调整脚本，使用iframe-resizer.js替代 -->
                    {% elif current_page == 'solar_calculator' %}
                    <!-- 太阳能计算器内容 -->
                    <div class="solar-calculator-container">
                        <!-- 使用iframe嵌入太阳能计算器，并使用iframe-resizer.js管理高度 -->
                        <iframe id="solarIframe" src="{{ url_for('solar_calculator', project_id=project.id if project else '') }}" 
                            style="width:100%; border:none;" scrolling="no"
                            title="太阳能计算" loading="eager"></iframe>
                    </div>
                    <!-- 移除旧的iframe调整脚本，使用iframe-resizer.js替代 -->
                    <script>
                        // 初始化太阳能计算器iframe自适应高度
                        document.addEventListener('DOMContentLoaded', function() {
                            if (typeof iFrameResize === 'function') {
                                iFrameResize({
                                    log: false,
                                    heightCalculationMethod: 'bodyOffset',
                                    autoResize: true,
                                    maxHeight: 50000,
                                    scrolling: false,
                                    checkOrigin: false,
                                    resizeFrom: 'child',
                                    inPageLinks: true,
                                    sizeHeight: true,
                                    sizeWidth: false
                                }, '#solarIframe');
                                console.log('太阳能计算器iframe高度自适应已初始化');
                            } else {
                                console.error('太阳能计算器iframe: iframe-resizer.js 未正确加载');
                            }
                        });
                    </script>
                    {% elif current_page == 'specialty' %}
                    <!-- 标准列表内容 -->
                    <!-- 添加隐藏的项目ID字段 -->
                    <input type="hidden" id="project_id" name="project_id" value="{{ project.id if project else '' }}">
                    
                    <div class="overflow-x-auto ">
                        {% if standards %}
                        
                        {% if current_level == '提高级' %}
                        <!-- 提高级分类过滤器 -->
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                            <div class="flex flex-wrap items-center">
                                <span class="mr-2 font-medium">分类过滤:</span>
                                <div class="flex flex-wrap gap-2">
                                    <button id="filter-all" class="px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium category-filter active">全部</button>
                                    <button id="filter-安全耐久" data-category="安全耐久" class="px-3 py-1 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm font-medium category-filter">安全耐久</button>
                                    <button id="filter-健康舒适" data-category="健康舒适" class="px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-800 text-sm font-medium category-filter">健康舒适</button>
                                    <button id="filter-生活便利" data-category="生活便利" class="px-3 py-1 rounded-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 text-sm font-medium category-filter">生活便利</button>
                                    <button id="filter-资源节约" data-category="资源节约" class="px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-800 text-sm font-medium category-filter">资源节约</button>
                                    <button id="filter-环境宜居" data-category="环境宜居" class="px-3 py-1 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 text-sm font-medium category-filter">环境宜居</button>
                                    <button id="filter-提高与创新" data-category="提高与创新" class="px-3 py-1 rounded-full bg-purple-100 hover:bg-purple-200 text-purple-800 text-sm font-medium category-filter">提高与创新</button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <table class="min-w-full divide-y divide-gray-200 table-fixed">
                            <thead class="bg-primary">
                                <tr>
                                    {% if current_level == '基本级' %}
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">条文号</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-30">条文内容</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分值</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">是否达标</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap technical-measures-cell">技术措施</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">审查材料</th>
                                    {% elif current_level == '提高级' %}
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">条文号</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分类</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-30">条文内容</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分值</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">得分</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap technical-measures-cell">技术措施</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">审查材料</th>
                                    {% else %}
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">条文号</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">分类</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">条文内容</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">分值</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">审查材料</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for standard in standards %}
                                <tr class="table-row-hover">
                                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">{{ standard.条文号 }}</td>
                                    {% if current_level == '提高级' %}
                                    <td class="px-6 py-4 whitespace-normal h-16 text-base text-gray-700">
                                        <span class="category-tag category-{{ standard.分类 }}">{{ standard.分类 }}</span>
                                    </td>
                                    {% endif %}
                                    <td class="px-6 py-4 text-base text-gray-700">{{ standard.条文内容 }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">{{ standard.分值 }}</td>
                                    
                                    {% if current_level == '基本级' %}
                                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">
                                        <select name="is_achieved" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary is-achieved-select" title="符合性判断">
                                            <option value="是">是</option>
                                            <option value="否">否</option>
                                            <option value="不参评">不参评</option>
                                        </select>
                                    </td>
                                    <td class="px-6 py-4 text-base text-gray-700">
                                        <textarea name="technical_measures" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary technical-measures" placeholder="请输入技术措施"></textarea>
                                    </td>
                                    <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                                    {% elif current_level == '提高级' %}
                                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">
                                        {% if standard.分值 == '—' %}
                                        <span class="text-gray-500">—</span>
                                        {% else %}
                                        <input type="text" name="score" data-clause="{{ standard.条文号 }}" data-maxscore="{{ standard.分值 }}" class="w-full rounded focus:border-primary" placeholder="得分">
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 text-base text-gray-700 technical-measures-cell">
                                        <textarea name="technical_measures" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary technical-measures" placeholder="请输入技术措施"></textarea>
                                    </td>
                                    <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                                    {% else %}
                                    <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <!-- 添加保存按钮 -->
                        <div class="mt-8 flex justify-center">
                            <button type="button" id="saveScoreBtn" class="px-6 py-3 bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                保存评分信息
                            </button>
                        </div>

                        <!-- 评分统计表格 -->
                        {% if current_level == '提高级' %}

                        {% endif %}
                        {% else %}
                        <div class="text-center py-10">
                            <p class="text-gray-500 text-xl">没有找到符合条件的记录</p>
                            <p class="text-gray-400 text-lg mt-2">请尝试其他筛选条件</p>
                        </div>
                        {% endif %}
                    {% endif %}
                    
                    {% if current_page == 'public_transport_analysis' %}
                    <div class="container">
                        <h1 class="text-3xl font-bold text-primary mb-2">查询地址周边500米范围内的公交站</h1>
                        <div class="search-box">
                            <input type="text" id="address" placeholder="请输入地址（如：北京市海淀区中关村）">
                            <button id="search-btn" class="bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">查询</button>
                        </div>
                        
                        <div id="map-container"></div>
                        
                        <div class="loading" id="loading">
                            <p>数据加载中，请稍候...</p>
                        </div>
                        
                        <div class="result-container">
                            <h2 class="text-2xl font-bold text-primary mb-2">查询结果</h2>
                            <div id="result-count"></div>
                            <table id="result-table" class="min-w-full divide-y divide-gray-200 table-fixed">
                                <thead>
                                    <tr>
                                        <th>序号</th>
                                        <th>站点名称</th>
                                        <th>距离（米）</th>
                                        <th>详细信息</th>
                                    </tr>
                                </thead>
                                <tbody id="result-body" class="min-w-full divide-y divide-gray-200 table-fixed">
                                    <!-- 结果将在这里动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        
                        <button class="export-btn bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary" id="export-btn" disabled>生成公交站点分析报告</button>
                    </div>
                    
                    <script>
                        // 初始化iframe自适应高度
                        document.addEventListener('DOMContentLoaded', function() {
                            if (typeof iFrameResize === 'function') {
                                iFrameResize({
                                    log: false,
                                    heightCalculationMethod: 'bodyOffset',
                                    autoResize: true,
                                    maxHeight: 50000,
                                    scrolling: false,
                                    checkOrigin: false,
                                    resizeFrom: 'child',
                                    inPageLinks: true,
                                    sizeHeight: true,
                                    sizeWidth: false
                                }, '#public-transport-analysis-iframe');
                                console.log('公共交通分析iframe高度自适应已初始化');
                            } else {
                                console.error('iframe-resizer.js 未正确加载');
                            }
                        });
                        
                        // 监听iframe中发送的消息
                        window.addEventListener('message', function(event) {
                            if (event.data && event.data.type === 'toast') {
                                // 处理来自iframe的Toast通知
                                console.log('收到iframe发来的Toast通知:', event.data.message);
                                showToast(event.data.message, event.data.toastType || 'info');
                            }
                        });
                    </script>
                    {% endif %}
                    
                    {% endblock %}
                </div>
            </main>
        </div>
    </div>

    <!-- 添加悬浮保存按钮，仅在基本级和提高级页面显示 -->
    {% if current_level == '基本级' or current_level == '提高级' %}
    <div class="floating-save-btn" id="floatingSaveBtn">
        <i class="ri-save-line"></i>
    </div>
    {% endif %}

    <script>
    // 获取DOM元素
    const basicMenuToggle = document.getElementById('basicMenuToggle');
    const basicMenuContent = document.getElementById('basicMenuContent');
    const advancedMenuToggle = document.getElementById('advancedMenuToggle');
    const advancedMenuContent = advancedMenuToggle ? document.getElementById('advancedMenuContent') : null;
    const reportMenuToggle = document.getElementById('reportMenuToggle');
    const reportMenuContent = document.getElementById('reportMenuContent');
    const specialCalcMenuToggle = document.getElementById('specialCalcMenuToggle');
    const specialCalcMenuContent = document.getElementById('specialCalcMenuContent');
    const loadStarCaseBtn = document.getElementById('loadStarCaseBtn');
    const saveStarCaseBtn = document.getElementById('saveStarCaseBtn');

    // 添加防抖函数
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    // 为保存星级案例按钮添加点击事件
    if (saveStarCaseBtn) {
        saveStarCaseBtn.addEventListener('click', async function() {
            try {
                // 获取项目ID
                const projectId = document.getElementById('project_id').value;
                                if (!projectId) {
                    alert('未找到项目ID');
                                    return;
                                }
                                
                                // 显示加载状态
                const originalText = this.textContent;
                this.textContent = '保存中...';
                this.disabled = true;

                // 调用API保存星级案例数据
                const response = await fetch(`/api/save_star_case?project_id=${projectId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                } else {
                    alert(data.message || '保存星级案例失败');
                }
            } catch (error) {
                console.error('保存星级案例失败:', error);
                alert('保存星级案例失败，请重试');
            } finally {
                // 恢复按钮状态
                this.textContent = '保存星级案例';
                this.disabled = false;
            }
        });
    }

    // 防止页面跳动的函数
    function preventPageJump() {
        // 记录当前滚动位置
        const scrollPosition = window.scrollY;
        
        // 在下一个事件循环中恢复滚动位置
        setTimeout(() => {
            window.scrollTo(0, scrollPosition);
        }, 0);
    }
    
    // 添加菜单切换事件
    basicMenuToggle.addEventListener('click', function() {
        basicMenuContent.classList.toggle('expanded');
        const arrow = this.querySelector('.ri-arrow-down-s-line');
        if (arrow) {
            arrow.style.transform = basicMenuContent.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
    });
    
    if (advancedMenuToggle) {
        advancedMenuToggle.addEventListener('click', function() {
            advancedMenuContent.classList.toggle('expanded');
            const arrow = this.querySelector('.ri-arrow-down-s-line');
            if (arrow) {
                arrow.style.transform = advancedMenuContent.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        });
    }
    
    reportMenuToggle.addEventListener('click', function() {
        reportMenuContent.classList.toggle('expanded');
        const arrow = this.querySelector('.ri-arrow-down-s-line');
        if (arrow) {
            arrow.style.transform = reportMenuContent.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
    });
    
    
    // 项目ID缓存
    let indexCachedProjectId = null;
    
    // 在页面加载完成后处理菜单展开/折叠等事件
    document.addEventListener('DOMContentLoaded', function() {
        // 评分汇总相关代码保留
        if (window.location.href.includes('page=score_summary')) {
            console.log('当前是评分汇总页面');
        }
        
        // 获取评分汇总菜单项
        const scoreSummaryMenuItem = document.querySelector('a[data-content="score-summary"]');
        if (scoreSummaryMenuItem) {
            console.log('找到评分汇总菜单项，添加点击事件');
            
            // 添加点击事件，确保点击时先计算评分
            scoreSummaryMenuItem.addEventListener('click', function(e) {
                // 不阻止默认行为，让导航正常工作
            });
        }
        
        // 为悬浮保存按钮添加点击事件
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');
        if (floatingSaveBtn) {
            console.log('找到悬浮保存按钮，添加点击事件');
            
            // 移除可能已存在的事件监听器，避免重复绑定
            floatingSaveBtn.removeEventListener('click', floatingSaveBtnHandler);
            floatingSaveBtn.removeEventListener('click', saveScoreData);
            
            // 直接绑定saveScoreData函数，与常规保存按钮保持一致
            floatingSaveBtn.addEventListener('click', saveScoreData);
            console.log('已为悬浮保存按钮绑定saveScoreData函数');
        }
        
        // 悬浮按钮处理函数不再需要，可以移除或保留为备用
        function floatingSaveBtnHandler() {
            // 该函数不再使用
        }
        
        // 为当前页面设置data属性，以便menu.js可以使用它们判断当前页面
        document.body.setAttribute('data-level', "{{ current_level }}");
        document.body.setAttribute('data-page', "{{ current_page }}");
        document.body.setAttribute('data-specialty', "{{ current_specialty }}");
    });

    </script>
    

    <!-- 在适当的JS部分添加生成自评估报告的函数 -->
    <script>

    // 绿建自评估报告生成函数
    function generateSelfAssessmentReport() {
        // 获取项目评价标准
        const currentProjectStandard = document.getElementById('current-project-standard')?.value || '国标';
        const currentMenuItems = document.querySelectorAll('.submenu-item.active');
        
        // 只有国标项目才能生成绿建自评估报告
        if (currentProjectStandard !== '国标') {
            alert('只有国标项目才能生成绿建自评估报告！');
            return;
        }
        
        // 移除其他菜单项的激活状态
        currentMenuItems.forEach(item => {
            item.classList.remove('active');
        });
        
        // 找到绿建自评估报告菜单项并添加active类
        const reportMenuItem = document.querySelector('a[onclick="generateSelfAssessmentReport(); return false;"]');
        let progressInterval;
        
        if (reportMenuItem) {
            reportMenuItem.classList.add('active');
            reportMenuItem.classList.add('loading');
            
            // 创建进度条动画
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += 2;
                if (progress > 90) {
                    clearInterval(progressInterval);
                }
                reportMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) ${progress}%, transparent ${progress}%)`;
            }, 100);
        }
        
        // 显示加载指示器
        const pageLoader = document.getElementById('page-loader');
        if (pageLoader) {
            pageLoader.style.display = 'flex';
        }

        // 获取当前项目ID
        const projectId = document.getElementById('project_id').value;
        console.log("项目ID:", projectId);
        
        if (!projectId) {
            alert('未找到项目ID');
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            if (reportMenuItem) {
                reportMenuItem.classList.remove('loading');
                reportMenuItem.style.backgroundImage = '';
                clearInterval(progressInterval);
            }
            return;
        }

        console.log("正在生成绿建自评估报告，项目ID: " + projectId);

        // 发送请求
        fetch('/api/self-assessment-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId
            })
        })
        .then(response => {
            console.log("收到服务器响应状态:", response.status);
            
            if (!response.ok) {
                // 如果服务器返回错误，尝试获取错误信息
                return response.json().then(data => {
                    console.error("服务器返回错误:", data);
                    throw new Error(data.error || '生成绿建自评估报告失败');
                });
            }
            return response.blob();
        })
        .then(blob => {
            console.log("收到blob数据，类型:", blob.type, "大小:", blob.size, "bytes");
            
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            const projectName = document.getElementById('current_project_name').value || '';
            console.log("项目名称:", projectName);
            
            a.href = url;
            a.download = projectName ? `${projectName}_绿建自评估报告.docx` : '绿建自评估报告.docx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 完成进度条
            if (reportMenuItem) {
                clearInterval(progressInterval);
                reportMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) 100%, transparent 100%)`;
                setTimeout(() => {
                    reportMenuItem.classList.remove('loading');
                    reportMenuItem.style.backgroundImage = '';
                }, 500);
            }
        })
        .catch(error => {
            console.error('生成报告失败:', error);
            alert(error.message || '生成绿建自评估报告失败，请稍后重试');
            
            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 重置进度条
            if (reportMenuItem) {
                clearInterval(progressInterval);
                reportMenuItem.classList.remove('loading');
                reportMenuItem.style.backgroundImage = '';
            }
        });
    }
    </script>
    <!-- 评分汇总按钮的JS代码 -->
    <script>
        // 获取当前选中的项目ID
        function getSelectedProjectId() {
            // 先尝试从隐藏字段获取
            let projectId = document.getElementById('current-project-id')?.value;
            if (!projectId) {
                // 尝试从project_id字段获取
                projectId = document.getElementById('project_id')?.value;
            }
            if (!projectId) {
                // 尝试从URL参数获取
                const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('project_id');
            }
            return projectId;
        }
        
        /**
         * 更新项目评分表的函数
         * 注意：此函数不再自动调用，因为后端get_score_summary已集成更新项目表的功能
         * 保留此函数以便需要时手动触发项目评分更新
         */
        async function updateProjectScores(projectId, scoreData) {
            try {
                console.log('更新项目表中的评分数据:', projectId, scoreData);
                
                // 调用更新项目评分的API
                const response = await fetch('/api/update_project_scores', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_id: projectId,
                        scores: scoreData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('成功更新项目评分:', result);
                    return true;
                } else {
                    console.error('更新项目评分失败:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('更新项目评分时出错:', error);
                return false;
            }
        }
        
        // 简单的提示函数
        function showToast(message, type = 'info') {
            // 如果有现成的Toast系统可以使用
            if (typeof toast !== 'undefined') {
                toast(message, type);
                return;
            }
            
            // 否则使用简单的alert
            alert(message);
        }
        
        // 在页面加载完成后，添加评分菜单点击事件
        document.addEventListener('DOMContentLoaded', function() {
            // 如果当前是评分汇总页面，不再自动加载评分数据
            if (window.location.href.includes('page=score_summary')) {
                console.log('当前是评分汇总页面');
            }
            
            // 获取评分汇总菜单项
            const scoreSummaryMenuItem = document.querySelector('a[data-content="score-summary"]');
            if (scoreSummaryMenuItem) {
                console.log('找到评分汇总菜单项，添加点击事件');
                
                // 添加点击事件，确保点击时先计算评分
                scoreSummaryMenuItem.addEventListener('click', function(e) {
                    // 不阻止默认行为，让导航正常工作
                });
            }
        });
    </script>

    <!-- 评分汇总面板 -->
    <div id="score-summary" class="content-panel" style="display: none;">
        <h3>评分汇总</h3>
        <div class="alert alert-info">
            <p id="current-standard-info">当前评价标准: 加载中...</p>
        </div>
        <div id="score-summary-container">
            <!-- 评分汇总内容将通过JavaScript加载 -->
            <div class="text-center p-5">
                <p>请选择项目并点击"评分汇总"菜单查看评分结果</p>
            </div>
        </div>
    </div>

    <script>
        // ... existing code ...

        // 为提高级得分输入框添加验证
        document.addEventListener('DOMContentLoaded', function() {
            // 如果当前是提高级页面，添加输入验证
            if ('{{ current_level }}' === '提高级') {
                // 获取所有得分输入框
                const scoreInputs = document.querySelectorAll('input[name="score"]');
                
                // 为每个输入框添加事件监听
                scoreInputs.forEach(input => {
                    input.addEventListener('input', function(e) {
                        // 获取输入值
                        const scoreValue = parseFloat(this.value);
                        
                        // 如果不是数字，不做处理
                        if (isNaN(scoreValue)) {
                            return;
                        }
                        
                        // 获取最大分值
                        const maxScore = parseFloat(this.getAttribute('data-maxscore'));
                        
                        // 验证输入值不大于最大分值
                        if (scoreValue > maxScore) {
                            // 提示用户
                            alert(`输入的分数不能大于该条文的分值(${maxScore})`);
                            // 重置为最大分值
                            this.value = maxScore;
                        }
                        
                        // 确保不为负数
                        if (scoreValue < 0) {
                            this.value = 0;
                        }
                    });
                    
                    // 添加失焦事件，确保在用户完成输入后格式化值
                    input.addEventListener('blur', function() {
                        // 如果值为空或不是数字，设为0
                        if (this.value === '' || isNaN(parseFloat(this.value))) {
                            this.value = '0';
                        }
                    });
                });
            }
        });
        
        // ... existing code ...
    </script>
    {% if current_level == '提高级' %}
    <!-- 添加悬浮徽章组件 -->
    {% include 'components/floating_badge.html' %}
    {% endif %}
    <script>
    // 添加徽章相关的JavaScript函数已移至组件文件中
    
    // 在页面加载和得分变化时更新徽章
    document.addEventListener('DOMContentLoaded', function() {
        if ('{{ current_level }}' === '提高级') {
            updateCategoryBadges();
            initializeBadgeFilters();
        }
    });
    </script>

    <!-- 页面加载后执行的函数 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 恢复之前保存的滚动位置
            const savedScrollPosition = sessionStorage.getItem('scrollPosition');
            if (savedScrollPosition) {
                window.scrollTo(0, parseInt(savedScrollPosition));
                sessionStorage.removeItem('scrollPosition');
            }
            
            // 监听保存成功事件
            document.addEventListener('save-score-completed', function(event) {
                if (event.detail && event.detail.success) {
                    // 保存成功时显示提示
                    if (typeof toast === 'function') {
                        toast(event.detail.message || '评分信息保存成功！', 'success');
                    }
                }
            });
            
            // 检查是否保存成功
            const saveSuccess = sessionStorage.getItem('save_success');
            if (saveSuccess === 'true') {
                // 如果保存成功，清除临时数据
                sessionStorage.removeItem('saved_green_area');
                sessionStorage.removeItem('save_success');
                console.log('保存成功，已清除临时数据');
            } else {
                // 检查并恢复临时保存的绿地面积数据
                const savedGreenArea = sessionStorage.getItem('saved_green_area');
                if (savedGreenArea) {
                    const greenAreaInput = document.getElementById('green_area');
                    if (greenAreaInput && (!greenAreaInput.value || greenAreaInput.value === '0.00')) {
                        console.log('从临时存储恢复绿地面积:', savedGreenArea);
                        greenAreaInput.value = savedGreenArea;
                    }
                }
            }
            
            // ... 其他现有代码
        });
        
    </script>
    
<script>
        // 添加生成DWG文档的函数
        function generateDWG() {
        // 临时设置当前页面为dwg_export，以便高亮显示菜单项
        const currentProjectStandard = document.getElementById('current-project-standard').value;
        const currentMenuItems = document.querySelectorAll('.submenu-item.active');
        currentMenuItems.forEach(item => {
            item.classList.remove('active');
        });
        
        // 找到绿色建筑设计专篇菜单项并添加active类
        const dwgMenuItem = document.querySelector('a[onclick="generateDWG()"]');
        let progressInterval;
        
        if (dwgMenuItem) {
            dwgMenuItem.classList.add('active');
            dwgMenuItem.classList.add('loading');
            
            // 创建进度条动画
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += 2;
                if (progress > 90) {
                    clearInterval(progressInterval);
                }
                dwgMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) ${progress}%, transparent ${progress}%)`;
            }, 100);
        }
        
        // 显示加载指示器
        const pageLoader = document.getElementById('page-loader');
        if (pageLoader) {
            pageLoader.style.display = 'flex';
        }

        // 获取项目ID
        const projectId = document.getElementById('current-project-id').value;
        if (!projectId) {
            alert('请先选择项目');
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            if (dwgMenuItem) {
                dwgMenuItem.classList.remove('loading');
                dwgMenuItem.style.backgroundImage = '';
                clearInterval(progressInterval);
            }
            return;
        }
        
        // 调用generate_dwg接口
        fetch(`${window.location.protocol}//${window.location.host}/api/generate_dwg`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                standard: currentProjectStandard
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '生成绿色建筑设计专篇失败');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            if (currentProjectStandard=='四川省标') {
                a.download = '绿色建筑设计专篇（四川省标）.dwg';
            } else if (currentProjectStandard=='成都市标') {
                a.download = '绿色建筑设计专篇（成都市标）.dwg';
            } else {
                a.download = '绿色建筑设计专篇.dwg';
            }
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 完成进度条
            if (dwgMenuItem) {
                clearInterval(progressInterval);
                dwgMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) 100%, transparent 100%)`;
                setTimeout(() => {
                    dwgMenuItem.classList.remove('loading');
                    dwgMenuItem.style.backgroundImage = '';
                }, 500);
            }
        })
        .catch(error => {
            console.error('生成绿色建筑设计专篇失败:', error);
            alert(error.message || '生成绿色建筑设计专篇失败，请重试');
            
            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 重置进度条
            if (dwgMenuItem) {
                clearInterval(progressInterval);
                dwgMenuItem.classList.remove('loading');
                dwgMenuItem.style.backgroundImage = '';
            }
        });
    }
    // 添加生成Word文档的函数
    function generateWord() {
        // 临时设置当前页面为report_table，以便高亮显示菜单项
        // 获取项目评价标准
        const currentProjectStandard = document.getElementById('current-project-standard').value;
        const currentMenuItems = document.querySelectorAll('.submenu-item.active');
        if (currentProjectStandard=='国标') {
            alert('当前标准下暂无报审表模板!');
            return;
        }
        currentMenuItems.forEach(item => {
            item.classList.remove('active');
        });
        
        // 找到报审表菜单项并添加active类
        const wordMenuItem = document.querySelector('a[onclick="generateWord()"]');
        let progressInterval;
        
        if (wordMenuItem) {
            wordMenuItem.classList.add('active');
            wordMenuItem.classList.add('loading');
            
            // 创建进度条动画
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += 2;
                if (progress > 90) {
                    clearInterval(progressInterval);
                }
                wordMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) ${progress}%, transparent ${progress}%)`;
            }, 100);
        }
        
        // 显示加载指示器
        const pageLoader = document.getElementById('page-loader');
        if (pageLoader) {
            pageLoader.style.display = 'flex';
        }

        // 获取项目ID
        const projectId = document.getElementById('current-project-id').value;

        if (!projectId) {
            alert('请先选择项目');
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            if (wordMenuItem) {
                wordMenuItem.classList.remove('loading');
                wordMenuItem.style.backgroundImage = '';
                clearInterval(progressInterval);
            }
            return;
        }
        
        // 调用generate_word接口
        fetch('/api/generate_word', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                standard: currentProjectStandard
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '生成报审表失败');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            if (currentProjectStandard=='四川省标') {
                a.download = '四川省绿色建筑报审表.docx';
            } else if (currentProjectStandard=='成都市标') {
                a.download = '成都市绿色建筑报审表.docx';
            } else {
                a.download = '报审表.docx';
            }
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 完成进度条
            if (wordMenuItem) {
                clearInterval(progressInterval);
                wordMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) 100%, transparent 100%)`;
                setTimeout(() => {
                    wordMenuItem.classList.remove('loading');
                    wordMenuItem.style.backgroundImage = '';
                }, 500);
            }
        })
        .catch(error => {
            console.error('生成报审表失败:', error);
            alert(error.message || '生成报审表失败，请重试');
            
            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 重置进度条
            if (wordMenuItem) {
                clearInterval(progressInterval);
                wordMenuItem.classList.remove('loading');
                wordMenuItem.style.backgroundImage = '';
            }
        });
    }
            // 为评分汇总菜单添加点击事件
            const scoreSummaryMenuItem = document.getElementById('scoreSummaryMenuItem');
        if (scoreSummaryMenuItem) {
            // 页面加载时预先获取评分数据
            document.addEventListener('DOMContentLoaded', async function() {
                const projectId = document.getElementById('current-project-id').value;
                if (projectId) {
                    try {
                        // 后台预加载数据，不阻塞其他操作
                        fetchSummaryData(projectId);
                    } catch (error) {
                        console.error('预加载评分数据失败:', error);
                    }
                }
            });
            
            // 添加点击事件，直接跳转而不等待数据加载
            scoreSummaryMenuItem.addEventListener('click', function(e) {
                // 不阻止默认行为，允许直接跳转
                
                // 移除其他菜单项的active类
                const currentMenuItems = document.querySelectorAll('.submenu-item.active');
                currentMenuItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                // 添加active类
                this.classList.add('active');
                
                // 获取项目ID
                const projectId = document.getElementById('current-project-id').value;
                if (!projectId) {
                    alert('请先选择项目');
                    e.preventDefault(); // 如果没有项目ID，则阻止跳转
                    return;
                }
                
                // 在后台更新数据，但不等待它完成
                fetchSummaryData(projectId);
                
                // 直接继续默认跳转，不等待数据加载完成
            });
            
            // 提取获取评分数据的函数，以便重复使用
            async function fetchSummaryData(projectId) {
                try {
                    // 首先检查是否有缓存且缓存时间在1分钟以内
                    const cachedData = sessionStorage.getItem('score_summary_data');
                    const cacheTime = sessionStorage.getItem('score_summary_cache_time');
                    const now = new Date().getTime();
                    
                    // 如果缓存存在且在1分钟以内，直接使用缓存
                    if (cachedData && cacheTime && (now - parseInt(cacheTime)) < 1 * 60 * 1000) {
                        console.log('使用缓存的评分汇总数据');
                        return JSON.parse(cachedData);
                    }
                    
                    // 否则获取新数据
                    console.log('获取最新评分汇总数据');
                    const summaryResponse = await fetch(`/api/get_score_summary?project_id=${projectId}&force_refresh=true`);
                    const summaryData = await summaryResponse.json();
                    
                    // 将数据和时间戳存储到 sessionStorage
                    sessionStorage.setItem('score_summary_data', JSON.stringify(summaryData));
                    sessionStorage.setItem('score_summary_cache_time', now.toString());
                    
                    return summaryData;
                } catch (error) {
                    console.error('获取评分数据失败:', error);
                    throw error;
                }
            }
        }
        // 为项目信息保存按钮添加点击事件
        const saveProjectInfoBtn = document.getElementById('saveProjectInfoBtn');
        if (saveProjectInfoBtn) {
            console.log('找到项目信息保存按钮，添加点击事件');
            saveProjectInfoBtn.addEventListener('click', function(e) {
                e.preventDefault(); // 阻止表单默认提交
                
                // 显示保存中状态
                const originalText = saveProjectInfoBtn.textContent;
                saveProjectInfoBtn.textContent = '保存中...';
                saveProjectInfoBtn.disabled = true;

                // 获取表单元素
                const form = saveProjectInfoBtn.closest('form');
                if (!form) {
                    console.error('未找到表单元素');
                    saveProjectInfoBtn.textContent = originalText;
                    saveProjectInfoBtn.disabled = false;
                    return;
                }
                
                // 使用FormData获取表单数据
                const formData = new FormData(form);
                
                // 临时保存关键字段值到sessionStorage
                const greenArea = document.getElementById('green_area').value;
                if (greenArea) {
                    sessionStorage.setItem('saved_green_area', greenArea);
                    console.log('保存绿地面积临时数据:', greenArea);
                }
                
                // 添加详细表单标志
                formData.append('detail_form', '1');
                
                // 保存当前滚动位置
                const scrollPosition = window.scrollY;
                
                // 使用AJAX提交表单，防止页面刷新
                fetch('/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('提交失败，请稍后重试');
                    }
                    return response.json().catch(() => {
                        console.log('返回值不是JSON格式，可能是重定向响应');
                        // 如果服务器返回了重定向响应，我们手动重载页面并保留滚动位置
                        sessionStorage.setItem('scrollPosition', scrollPosition);
                        window.location.reload();
                        throw new Error('服务器返回了非JSON响应');
                    });
                })
                .then(result => {
                    // 恢复按钮状态
                    saveProjectInfoBtn.textContent = originalText;
                    saveProjectInfoBtn.disabled = false;
                    
                    // 显示成功消息
                    alert('项目信息保存成功');
                    
                    // 记录保存成功状态，用于清除临时数据
                    sessionStorage.setItem('save_success', 'true');
                    
                    // 刷新页面但保持滚动位置
                    sessionStorage.setItem('scrollPosition', scrollPosition);
                    window.location.reload();
                })
                .catch(error => {
                    console.error('保存项目信息出错:', error);
                    
                    // 恢复按钮状态
                    saveProjectInfoBtn.textContent = originalText;
                    saveProjectInfoBtn.disabled = false;
                    
                    // 显示错误消息，但不是重定向错误
                    if (!error.message.includes('非JSON响应')) {
                        alert('保存失败: ' + error.message);
                    }
                });
                
                // 不使用传统的form.submit()，防止页面刷新
                // 注释掉原来的代码: form.submit();
                calculateAndUpdateScores();
            });
        } else {
            console.log('未找到项目信息保存按钮');
        }        
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 如果是提高级页面，初始化分类过滤器
        if ('{{ current_level }}' === '提高级') {
            initializeCategoryFilters();
        }
    });

    // 初始化分类过滤器功能
    function initializeCategoryFilters() {
        const filterButtons = document.querySelectorAll('.category-filter');
        const tableRows = document.querySelectorAll('table tbody tr');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有按钮的active状态
                filterButtons.forEach(btn => btn.classList.remove('active'));
                // 添加当前按钮的active状态
                this.classList.add('active');
                
                const selectedCategory = this.getAttribute('data-category');
                
                // 过滤表格行
                tableRows.forEach(row => {
                    if (this.id === 'filter-all') {
                        // 如果点击"全部"按钮，显示所有行
                        row.style.display = '';
                        row.style.animation = 'fadeIn 0.3s ease-in';
                    } else {
                        // 获取行的分类（在第二列）
                        const rowCategory = row.querySelector('td:nth-child(2) .category-tag')?.textContent.trim();
                        if (rowCategory === selectedCategory) {
                            row.style.display = '';
                            row.style.animation = 'fadeIn 0.3s ease-in';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            });
        });
    }

    // 全局Toast函数实现
    function toast(message, type = 'info') {
        const container = document.getElementById('custom-toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `custom-toast ${type}`;
        
        // 根据类型设置图标
        let icon = '';
        switch(type) {
            case 'success':
                icon = '<i class="ri-check-line custom-toast-icon"></i>';
                break;
            case 'error':
                icon = '<i class="ri-error-warning-line custom-toast-icon"></i>';
                break;
            case 'warning':
                icon = '<i class="ri-alert-line custom-toast-icon"></i>';
                break;
            case 'info':
            default:
                icon = '<i class="ri-information-line custom-toast-icon"></i>';
                break;
        }
        
        toast.innerHTML = `
            ${icon}
            <div class="custom-toast-message">${message}</div>
        `;
        
        container.appendChild(toast);
        
        // 3秒后自动移除
        setTimeout(() => {
            toast.style.animation = 'toast-out 0.3s ease-in forwards';
            setTimeout(() => {
                container.removeChild(toast);
            }, 300);
        }, 3000);
    }
</script>

<!-- 自定义Toast组件 -->
<div id="custom-toast-container" class="fixed top-4 right-4 z-50"></div>
<script>
    // 百度地图API加载
    function loadBaiduMapScript() {
        const script = document.createElement('script');
        script.src = 'https://api.map.baidu.com/api?v=3.0&ak=J6UW18n9sxCMtrxTkjpLE3JkU8pfw3bL&callback=initMap';
        script.onerror = function() {
            alert('百度地图API加载失败，请检查网络连接或API密钥是否有效');
        };
        document.body.appendChild(script);
    }

    // 初始化地图
    function initMap() {
        try {
            window.map = new BMap.Map('map-container');
            const point = new BMap.Point(116.404, 39.915); // 默认北京市中心
            map.centerAndZoom(point, 15);
            // 禁用滚轮放大缩小功能
            map.disableScrollWheelZoom();
            map.addControl(new BMap.NavigationControl());
            map.addControl(new BMap.ScaleControl());
            
            // 初始化搜索功能
            document.getElementById('search-btn').addEventListener('click', searchBusStops);
            
            console.log('地图初始化成功');
        } catch (error) {
            console.error('地图初始化失败:', error);
            alert('地图初始化失败，请刷新页面重试');
        }
    }

    // 搜索附近公交站
    function searchBusStops() {
        const address = document.getElementById('address').value.trim();
        if (!address) {
            alert('请输入有效地址！');
            return;
        }
        
        // 显示加载中
        document.getElementById('loading').style.display = 'block';
        document.getElementById('result-body').innerHTML = '';
        document.getElementById('result-count').innerHTML = '';
        document.getElementById('export-btn').disabled = true;
        
        try {
            // 地址解析
            const geoCoder = new BMap.Geocoder();
            geoCoder.getPoint(address, function(point) {
                if (point) {
                    map.clearOverlays();
                    map.centerAndZoom(point, 16);
                    
                    // 添加中心点标记
                    const centerMarker = new BMap.Marker(point);
                    // 添加自定义属性，标识这是中心点标记
                    centerMarker.customData = {
                        isCenter: true
                    };
                    map.addOverlay(centerMarker);
                    
                    // 添加半径圈
                    const circle = new BMap.Circle(point, 500, {
                        strokeColor: '#3c8dbc',
                        strokeWeight: 2,
                        strokeOpacity: 0.5,
                        fillColor: '#3c8dbc',
                        fillOpacity: 0.1
                    });
                    map.addOverlay(circle);
                    
                    // 搜索周边公交站
                    try {
                        const options = {
                            onSearchComplete: function(results) {
                                document.getElementById('loading').style.display = 'none';
                                
                                if (results && results.getNumPois && results.getNumPois() > 0) {
                                    const busStops = [];
                                    for (let i = 0; i < results.getNumPois(); i++) {
                                        try {
                                            const poi = results.getPoi(i);
                                            if (poi && poi.point) {
                                                const distance = map.getDistance(point, poi.point).toFixed(0);
                                                
                                                // 只保留500米范围内的站点
                                                if (distance <= 500) {
                                                    busStops.push({
                                                        name: poi.title,
                                                        distance: distance,
                                                        address: poi.address || '无详细地址',
                                                        point: poi.point
                                                    });
                                                }
                                            }
                                        } catch (poiError) {
                                            console.error('处理POI数据时出错:', poiError);
                                            continue;
                                        }
                                    }
                                    
                                    // 按距离排序
                                    busStops.sort((a, b) => a.distance - b.distance);
                                    
                                    // 显示结果
                                    displayResults(busStops);
                                } else {
                                    document.getElementById('result-count').innerHTML = '<p>未找到周边公交站点</p>';
                                }
                            },
                            onError: function(error) {
                                document.getElementById('loading').style.display = 'none';
                                console.error('搜索出错:', error);
                                alert('搜索公交站点时出错，请稍后重试');
                            }
                        };
                        
                        const searchLocal = new BMap.LocalSearch(map, options);
                        searchLocal.searchNearby('公交站', point, 500);
                    } catch (searchError) {
                        document.getElementById('loading').style.display = 'none';
                        console.error('创建搜索时出错:', searchError);
                        alert('搜索功能初始化失败，请稍后重试');
                    }
                } else {
                    document.getElementById('loading').style.display = 'none';
                    alert('无法解析该地址，请输入正确的地址！');
                }
            });
        } catch (error) {
            document.getElementById('loading').style.display = 'none';
            console.error('搜索过程出错:', error);
            alert('搜索过程中出现错误，请稍后重试');
        }
    }

    // 显示搜索结果
    function displayResults(busStops) {
        const tbody = document.getElementById('result-body');
        tbody.innerHTML = '';
        
        document.getElementById('result-count').innerHTML = `<p>共找到 <strong>${busStops.length}</strong> 个公交站点</p>`;
        
        // 先清除所有公交站点标记，但保留中心点和圆圈
        // 获取所有覆盖物
        const allOverlays = map.getOverlays();
        const overlaysToRemove = [];
        
        // 找出所有公交站点标记（非中心点标记）
        if (allOverlays && allOverlays.length > 0) {
            allOverlays.forEach(overlay => {
                // 检查是否是公交站点标记（使用自定义属性）
                if (overlay instanceof BMap.Marker && overlay.customData && overlay.customData.isBusStop) {
                    overlaysToRemove.push(overlay);
                }
            });
        }
        
        // 移除公交站点标记
        overlaysToRemove.forEach(overlay => {
            map.removeOverlay(overlay);
        });
        
        busStops.forEach((stop, index) => {
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${stop.name}</td>
                <td>${stop.distance}</td>
                <td>${stop.address || '无详细信息'}</td>
            `;
            
            tbody.appendChild(tr);
            
            // 确保stop.point存在
            if (stop && stop.point) {
                // 在地图上添加标记
                const marker = new BMap.Marker(stop.point);
                // 添加自定义属性，标识这是公交站点标记
                marker.customData = {
                    isBusStop: true,
                    index: index + 1  // 记录序号，从1开始
                };
                map.addOverlay(marker);
                
                // 添加信息窗口
                const infoWindow = new BMap.InfoWindow(`
                    <div style="padding: 10px">
                        <h4>${stop.name}</h4>
                        <p>距离：${stop.distance}米</p>
                        <p>地址：${stop.address || '无详细信息'}</p>
                    </div>
                `);
                
                marker.addEventListener('click', function() {
                    this.openInfoWindow(infoWindow);
                });
            }
        });
        
        // 启用导出按钮
        if (busStops.length > 0) {
            document.getElementById('export-btn').disabled = false;
        }
    }

    // 导出到Word文档
    document.getElementById('export-btn').addEventListener('click', function() {
        const address = document.getElementById('address').value;
        
        // 获取表格数据
        const busStops = [];
        const rows = document.querySelectorAll('#result-body tr');
        rows.forEach((row, index) => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 4) {
                busStops.push({
                    name: cells[1].textContent,
                    distance: cells[2].textContent,
                    address: cells[3].textContent
                });
            }
        });
        
        // 显示加载中
        document.getElementById('loading').style.display = 'block';
        
        // 获取当前地图中心点和缩放级别
        const center = window.map.getCenter();
        const zoom = window.map.getZoom();
        
        // 收集标记点和圆圈信息
        const allOverlays = window.map.getOverlays();
        const markers = [];
        let circleInfo = null;
        
        // 收集所有标记点和圆圈信息
        if (allOverlays && allOverlays.length > 0) {
            allOverlays.forEach(overlay => {
                if (overlay instanceof BMap.Marker) {
                    const pos = overlay.getPosition();
                    // 使用自定义属性判断标记类型
                    const isCenter = overlay.customData && overlay.customData.isCenter;
                    const busStopIndex = overlay.customData && overlay.customData.isBusStop ? overlay.customData.index : null;
                    
                    if (pos) {
                        markers.push({
                            lng: pos.lng,
                            lat: pos.lat,
                            isCenter: isCenter,
                            busStopIndex: busStopIndex
                        });
                    }
                } else if (overlay instanceof BMap.Circle) {
                    const centerPos = overlay.getCenter();
                    const radius = overlay.getRadius();
                    if (centerPos) {
                        circleInfo = {
                            center: {
                                lng: centerPos.lng,
                                lat: centerPos.lat
                            },
                            radius: radius
                        };
                    }
                }
            });
        }
        
        // 创建一个包含地图和标记的完整图像
        function createMapScreenshot() {
            return new Promise((resolve, reject) => {
                try {
                    const mapContainer = document.getElementById('map-container');
                    const width = mapContainer.offsetWidth;
                    const height = mapContainer.offsetHeight;
                    
                    // 第一步：使用html2canvas截取地图底图
                    html2canvas(mapContainer, {
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: "#ffffff",
                        scale: 1,
                        logging: true,
                        ignoreElements: function(element) {
                            // 忽略标记和圆圈，只保留底图
                            return element.className && 
                                  (typeof element.className === 'string') && 
                                  (element.className.includes('BMap_Marker') || 
                                   element.className.includes('BMap_Circle') ||
                                   element.className.includes('BMap_Overlay'));
                        }
                    }).then(baseMapCanvas => {
                        // 第二步：创建新的Canvas来绘制标记和圆圈
                        const markersCanvas = document.createElement('canvas');
                        markersCanvas.width = width;
                        markersCanvas.height = height;
                        const markersCtx = markersCanvas.getContext('2d');
                        
                        // 绘制所有标记和圆圈
                        // 绘制圆圈
                        if (circleInfo && window.map) {
                            try {
                                const pixel = window.map.pointToPixel(new BMap.Point(circleInfo.center.lng, circleInfo.center.lat));
                                const radius = window.map.getZoomUnits() * circleInfo.radius * Math.pow(2, (18 - zoom));
                                
                                // 使用更明显的样式绘制圆圈
                                markersCtx.beginPath();
                                markersCtx.arc(pixel.x, pixel.y, radius, 0, Math.PI * 2);
                                markersCtx.strokeStyle = "#FF0000";  // 红色边框
                                markersCtx.lineWidth = 3;            // 加粗边框
                                markersCtx.stroke();
                                
                                // 使用半透明红色填充
                                markersCtx.fillStyle = "rgba(255, 0, 0, 0.15)";
                                markersCtx.fill();
                                
                                // 添加一个内圈增加可见性
                                markersCtx.beginPath();
                                markersCtx.arc(pixel.x, pixel.y, radius - 3, 0, Math.PI * 2);
                                markersCtx.strokeStyle = "rgba(255, 0, 0, 0.5)";
                                markersCtx.lineWidth = 1;
                                markersCtx.stroke();
                            } catch(e) {
                                console.error('绘制圆圈失败:', e);
                            }
                        }
                        
                        // 绘制标记点
                        markers.forEach((marker) => {
                            try {
                                const pixel = window.map.pointToPixel(new BMap.Point(marker.lng, marker.lat));
                                
                                if (marker.isCenter) {
                                    // 中心点标记样式 - 使用蓝色
                                    markersCtx.beginPath();
                                    markersCtx.arc(pixel.x, pixel.y, 10, 0, Math.PI * 2);
                                    markersCtx.fillStyle = "#3c8dbc"; // 蓝色填充
                                    markersCtx.fill();
                                    
                                    // 绘制白色边框
                                    markersCtx.strokeStyle = "#FFFFFF";
                                    markersCtx.lineWidth = 2;
                                    markersCtx.stroke();
                                    
                                    // 绘制"起点"标记
                                    markersCtx.font = "bold 10px Arial";
                                    markersCtx.fillStyle = "#FFFFFF";
                                    markersCtx.textAlign = "center";
                                    markersCtx.textBaseline = "middle";
                                    markersCtx.fillText("起", pixel.x, pixel.y);
                                } else if (marker.busStopIndex) {
                                    // 公交站点标记样式 - 使用红色
                                    markersCtx.beginPath();
                                    markersCtx.arc(pixel.x, pixel.y, 12, 0, Math.PI * 2);
                                    markersCtx.fillStyle = "#FF0000";
                                    markersCtx.fill();
                                    
                                    // 绘制白色边框
                                    markersCtx.strokeStyle = "#FFFFFF";
                                    markersCtx.lineWidth = 2;
                                    markersCtx.stroke();
                                    
                                    // 绘制序号文字
                                    markersCtx.font = "bold 10px Arial";
                                    markersCtx.fillStyle = "#FFFFFF";
                                    markersCtx.textAlign = "center";
                                    markersCtx.textBaseline = "middle";
                                    
                                    // 使用公交站点的实际序号
                                    markersCtx.fillText(marker.busStopIndex.toString(), pixel.x, pixel.y);
                                }
                            } catch(e) {
                                console.error('绘制标记点失败:', e);
                            }
                        });
                        
                        // 第三步：创建最终合成的Canvas
                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.width = width;
                        finalCanvas.height = height;
                        const finalCtx = finalCanvas.getContext('2d');
                        
                        // 先绘制底图
                        finalCtx.drawImage(baseMapCanvas, 0, 0, width, height);
                        
                        // 叠加标记层
                        finalCtx.drawImage(markersCanvas, 0, 0, width, height);
                        
                        // 绘制标题背景
                        finalCtx.fillStyle = "rgba(255, 255, 255, 0.8)";
                        finalCtx.fillRect(0, 0, width, 30);
                        
                        // 绘制标题文本
                        finalCtx.fillStyle = "#333333";
                        finalCtx.font = "bold 16px 微软雅黑";
                        finalCtx.textAlign = "center";
                        finalCtx.fillText(address + " 周边公交站位置", width/2, 20);
                        
                        // 返回最终的图像
                        resolve(finalCanvas.toDataURL('image/png'));
                    }).catch(error => {
                        console.error("底图截取失败，尝试使用静态地图API:", error);
                        
                        // 如果html2canvas截图失败，回退到使用静态地图API
                        const staticMapCanvas = document.createElement('canvas');
                        staticMapCanvas.width = width;
                        staticMapCanvas.height = height;
                        const staticCtx = staticMapCanvas.getContext('2d');
                        
                        // 绘制白色背景
                        staticCtx.fillStyle = "#ffffff";
                        staticCtx.fillRect(0, 0, width, height);
                        
                        // 尝试使用百度地图静态图API
                        const centerPoint = window.map.getCenter();
                        const zoom = window.map.getZoom();
                        const staticMapUrl = `https://api.map.baidu.com/staticimage/v2?ak=J6UW18n9sxCMtrxTkjpLE3JkU8pfw3bL&width=${width}&height=${height}&center=${centerPoint.lng},${centerPoint.lat}&zoom=${zoom}&copyright=1`;
                        
                        const mapImage = new Image();
                        mapImage.crossOrigin = "Anonymous";
                        
                        mapImage.onload = function() {
                            // 绘制地图底图
                            staticCtx.drawImage(mapImage, 0, 0, width, height);
                            
                            // 绘制标记和标题
                            // 绘制圆圈
                            if (circleInfo && window.map) {
                                try {
                                    const pixel = window.map.pointToPixel(new BMap.Point(circleInfo.center.lng, circleInfo.center.lat));
                                    const radius = window.map.getZoomUnits() * circleInfo.radius * Math.pow(2, (18 - zoom));
                                    
                                    staticCtx.beginPath();
                                    staticCtx.arc(pixel.x, pixel.y, radius, 0, Math.PI * 2);
                                    staticCtx.strokeStyle = "#FF0000";  // 红色边框
                                    staticCtx.lineWidth = 3;            // 加粗边框
                                    staticCtx.stroke();
                                    
                                    // 使用半透明红色填充
                                    staticCtx.fillStyle = "rgba(255, 0, 0, 0.15)";
                                    staticCtx.fill();
                                    
                                    // 添加一个内圈增加可见性
                                    staticCtx.beginPath();
                                    staticCtx.arc(pixel.x, pixel.y, radius - 3, 0, Math.PI * 2);
                                    staticCtx.strokeStyle = "rgba(255, 0, 0, 0.5)";
                                    staticCtx.lineWidth = 1;
                                    staticCtx.stroke();
                                } catch(e) {
                                    console.error('绘制圆圈失败:', e);
                                }
                            }
                            
                            // 绘制标记点
                            markers.forEach((marker) => {
                                try {
                                    const pixel = window.map.pointToPixel(new BMap.Point(marker.lng, marker.lat));
                                    
                                    if (marker.isCenter) {
                                        // 中心点标记样式 - 使用蓝色
                                        staticCtx.beginPath();
                                        staticCtx.arc(pixel.x, pixel.y, 10, 0, Math.PI * 2);
                                        staticCtx.fillStyle = "#3c8dbc"; // 蓝色填充
                                        staticCtx.fill();
                                        
                                        // 绘制白色边框
                                        staticCtx.strokeStyle = "#FFFFFF";
                                        staticCtx.lineWidth = 2;
                                        staticCtx.stroke();
                                        
                                        // 绘制"起点"标记
                                        staticCtx.font = "bold 10px Arial";
                                        staticCtx.fillStyle = "#FFFFFF";
                                        staticCtx.textAlign = "center";
                                        staticCtx.textBaseline = "middle";
                                        staticCtx.fillText("起", pixel.x, pixel.y);
                                    } else if (marker.busStopIndex) {
                                        // 公交站点标记样式 - 使用红色
                                        staticCtx.beginPath();
                                        staticCtx.arc(pixel.x, pixel.y, 12, 0, Math.PI * 2);
                                        staticCtx.fillStyle = "#FF0000";
                                        staticCtx.fill();
                                        
                                        // 绘制白色边框
                                        staticCtx.strokeStyle = "#FFFFFF";
                                        staticCtx.lineWidth = 2;
                                        staticCtx.stroke();
                                        
                                        // 绘制序号文字
                                        staticCtx.font = "bold 10px Arial";
                                        staticCtx.fillStyle = "#FFFFFF";
                                        staticCtx.textAlign = "center";
                                        staticCtx.textBaseline = "middle";
                                        
                                        // 使用公交站点的实际序号
                                        staticCtx.fillText(marker.busStopIndex.toString(), pixel.x, pixel.y);
                                    }
                                } catch(e) {
                                    console.error('绘制标记点失败:', e);
                                }
                            });
                            
                            // 绘制标题
                            staticCtx.fillStyle = "rgba(255, 255, 255, 0.8)";
                            staticCtx.fillRect(0, 0, width, 30);
                            staticCtx.fillStyle = "#333333";
                            staticCtx.font = "bold 16px 微软雅黑";
                            staticCtx.textAlign = "center";
                            staticCtx.fillText(address + " 周边公交站位置", width/2, 20);
                            
                            resolve(staticMapCanvas.toDataURL('image/png'));
                        };
                        
                        mapImage.onerror = function() {
                            console.error("静态地图加载失败，使用纯标记图片");
                            
                            // 绘制提示文字
                            staticCtx.fillStyle = "#333333";
                            staticCtx.font = "bold 16px 微软雅黑";
                            staticCtx.textAlign = "center";
                            staticCtx.fillText(address + " 周边公交站位置", width/2, 20);
                            
                            staticCtx.font = "14px 微软雅黑";
                            staticCtx.fillText("地图底图加载失败，仅显示位置标记", width/2, height/2);
                            
                            // 尝试直接绘制圆圈和标记
                            if (circleInfo && window.map) {
                                const centerPixel = window.map.pointToPixel(new BMap.Point(circleInfo.center.lng, circleInfo.center.lat));
                                if (centerPixel) {
                                    // 绘制红色圆圈
                                    staticCtx.beginPath();
                                    staticCtx.arc(centerPixel.x, centerPixel.y, 100, 0, Math.PI * 2); // 使用固定半径
                                    staticCtx.strokeStyle = "#FF0000";  // 红色边框
                                    staticCtx.lineWidth = 3;            // 加粗边框
                                    staticCtx.stroke();
                                    
                                    // 使用半透明红色填充
                                    staticCtx.fillStyle = "rgba(255, 0, 0, 0.15)";
                                    staticCtx.fill();
                                    
                                    // 添加一个内圈增加可见性
                                    staticCtx.beginPath();
                                    staticCtx.arc(centerPixel.x, centerPixel.y, 100 - 3, 0, Math.PI * 2);
                                    staticCtx.strokeStyle = "rgba(255, 0, 0, 0.5)";
                                    staticCtx.lineWidth = 1;
                                    staticCtx.stroke();
                                }
                            }
                            
                            resolve(staticMapCanvas.toDataURL('image/png'));
                        };
                        
                        mapImage.src = staticMapUrl;
                    });
                } catch(e) {
                    console.error("创建Canvas失败:", e);
                    reject(e);
                }
            });
        }
        
        // 执行地图截图
        createMapScreenshot().then(mapImageData => {
            // 发送数据到后端
            fetch('/api/fill_transport_report_template', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    address: address,
                    stations: busStops,
                    mapImage: mapImageData,
                    mapInfo: {
                        center: {
                            lng: center.lng,
                            lat: center.lat
                        },
                        zoom: zoom,
                        markers: markers,
                        circle: circleInfo
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`服务器响应错误: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // 隐藏加载中
                document.getElementById('loading').style.display = 'none';
                
                if (data.success) {
                    console.log('成功收到响应:', data);
                    
                    // 创建下载链接 - 确保使用正确的属性名称
                    const link = document.createElement('a');
                    // 检查两种可能的属性名
                    const downloadUrl = data.download_url || data.downloadUrl;
                    
                    if (!downloadUrl) {
                        console.error('响应中缺少下载链接:', data);
                        alert('生成报告失败: 服务器未返回下载链接');
                        return;
                    }
                    
                    link.href = downloadUrl;
                    link.download = `公交站点查询结果_${address}_${new Date().toLocaleDateString()}.docx`;
                    
                    // 触发下载
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    console.error('生成报告失败:', data.message);
                    alert('生成报告失败: ' + data.message);
                }
            })
            .catch(error => {
                // 隐藏加载中
                document.getElementById('loading').style.display = 'none';
                console.error('API请求失败:', error);
                alert('导出失败: ' + error.message);
            });
        }).catch(error => {
            // 隐藏加载中
            document.getElementById('loading').style.display = 'none';
            console.error('地图截图创建失败:', error);
            alert('地图截图创建失败: ' + error.message);
        });
    });

    // 加载百度地图API
    loadBaiduMapScript();

    // 全局函数，供百度地图API回调
    window.initMap = initMap;
</script>
</body>
</html>