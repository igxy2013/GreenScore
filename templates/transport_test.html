<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公共交通站点分析报告测试</title>
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/all.min.css" rel="stylesheet">
    <style>
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold mb-6">公共交通站点分析报告测试</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">项目信息</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="projectName">项目名称</label>
                    <input id="projectName" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="测试项目">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="projectLocation">项目地点</label>
                    <input id="projectLocation" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="成都市武侯区天府大道北段1700号">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="projectId">项目编号</label>
                    <input id="projectId" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="TEST-2024-001">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="developer">建设单位</label>
                    <input id="developer" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="测试建设公司">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="designer">设计单位</label>
                    <input id="designer" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="测试设计院">
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">站点信息</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase">站点名称</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase">类型</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase">距离(m)</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase">详细信息</th>
                            <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase">操作</th>
                        </tr>
                    </thead>
                    <tbody id="stationsTableBody">
                        <!-- 站点数据将通过JS动态添加 -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4">
                <button id="addStationBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    添加站点
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">评价结论</h2>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="conclusion612">规范6.1.2评价</label>
                <textarea id="conclusion612" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" rows="2">符合规范6.1.2要求。最近公交站距离为120m，最近地铁站距离为480m。</textarea>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="conclusion621">规范6.2.1评价</label>
                <textarea id="conclusion621" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" rows="4">按照规范6.2.1评分，总得分为8分，其中：
- 最近公交站距离为120m，最近地铁站距离为480m，得4分；
- 周边800m内有3个公交站（包括天府五街站、天府三街站等），有1个地铁站（包括天府二街站），总计5条线路，得4分。</textarea>
            </div>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="totalScore">总得分</label>
                <input id="totalScore" type="number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="8">
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">地图截图</h2>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="mapImage">上传地图截图</label>
                <input id="mapImage" type="file" accept="image/*" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div id="mapPreview" class="mt-4 border rounded p-4 bg-gray-50 hidden">
                <img id="mapPreviewImage" src="" alt="地图预览" class="max-w-full h-auto">
            </div>
        </div>
        
        <div class="flex justify-end">
            <button id="generateReportBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                生成报告
            </button>
        </div>
    </div>
    
    <!-- 站点编辑模态框 -->
    <div id="stationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-8 max-w-md w-full">
            <h2 id="modalTitle" class="text-xl font-semibold mb-4">添加站点</h2>
            <div>
                <label class="block text-gray-700 text-sm font-bold mb-2" for="stationName">站点名称</label>
                <input id="stationName" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mt-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="stationType">类型</label>
                <select id="stationType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="公交站">公交站</option>
                    <option value="地铁站">地铁站</option>
                </select>
            </div>
            <div class="mt-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="stationDistance">距离(m)</label>
                <input id="stationDistance" type="number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mt-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="stationDetail">详细信息</label>
                <input id="stationDetail" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="线路信息，如: 1路、2路">
            </div>
            <div class="mt-6 flex justify-end">
                <button id="cancelStationBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2 focus:outline-none focus:shadow-outline">
                    取消
                </button>
                <button id="saveStationBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    保存
                </button>
            </div>
        </div>
    </div>
    
    <!-- 加载中提示 -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>生成报告中，请稍候...</div>
    </div>
    
    <script>
        // 站点数据
        let stations = [
            {name: "天府五街站", type: "公交站", distance: "120", detail: "1路、2路、3路"},
            {name: "天府三街站", type: "公交站", distance: "350", detail: "4路、5路"},
            {name: "天府二街站", type: "地铁站", distance: "480", detail: "1号线、7号线"}
        ];
        
        // 当前编辑的站点索引
        let currentEditIndex = -1;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化站点表格
            refreshStationsTable();
            
            // 添加站点按钮点击事件
            document.getElementById('addStationBtn').addEventListener('click', function() {
                openStationModal();
            });
            
            // 取消按钮点击事件
            document.getElementById('cancelStationBtn').addEventListener('click', function() {
                closeStationModal();
            });
            
            // 保存按钮点击事件
            document.getElementById('saveStationBtn').addEventListener('click', function() {
                saveStation();
            });
            
            // 生成报告按钮点击事件
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                generateReport();
            });
            
            // 地图图片上传事件
            document.getElementById('mapImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('mapPreviewImage').src = e.target.result;
                        document.getElementById('mapPreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
        
        // 刷新站点表格
        function refreshStationsTable() {
            const tableBody = document.getElementById('stationsTableBody');
            tableBody.innerHTML = '';
            
            stations.forEach((station, index) => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.className = 'py-2 px-4 border-b border-gray-200';
                nameCell.textContent = station.name;
                row.appendChild(nameCell);
                
                const typeCell = document.createElement('td');
                typeCell.className = 'py-2 px-4 border-b border-gray-200';
                typeCell.textContent = station.type;
                row.appendChild(typeCell);
                
                const distanceCell = document.createElement('td');
                distanceCell.className = 'py-2 px-4 border-b border-gray-200';
                distanceCell.textContent = station.distance;
                row.appendChild(distanceCell);
                
                const detailCell = document.createElement('td');
                detailCell.className = 'py-2 px-4 border-b border-gray-200';
                detailCell.textContent = station.detail;
                row.appendChild(detailCell);
                
                const actionCell = document.createElement('td');
                actionCell.className = 'py-2 px-4 border-b border-gray-200';
                
                const editBtn = document.createElement('button');
                editBtn.className = 'text-blue-500 hover:text-blue-700 mr-2';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.addEventListener('click', function() {
                    editStation(index);
                });
                actionCell.appendChild(editBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.addEventListener('click', function() {
                    deleteStation(index);
                });
                actionCell.appendChild(deleteBtn);
                
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
        }
        
        // 打开站点模态框
        function openStationModal(index = -1) {
            currentEditIndex = index;
            
            // 设置模态框标题
            document.getElementById('modalTitle').textContent = index === -1 ? '添加站点' : '编辑站点';
            
            // 如果是编辑，填充现有数据
            if (index !== -1) {
                const station = stations[index];
                document.getElementById('stationName').value = station.name;
                document.getElementById('stationType').value = station.type;
                document.getElementById('stationDistance').value = station.distance;
                document.getElementById('stationDetail').value = station.detail;
            } else {
                // 如果是添加，清空表单
                document.getElementById('stationName').value = '';
                document.getElementById('stationType').value = '公交站';
                document.getElementById('stationDistance').value = '';
                document.getElementById('stationDetail').value = '';
            }
            
            // 显示模态框
            document.getElementById('stationModal').classList.remove('hidden');
        }
        
        // 关闭站点模态框
        function closeStationModal() {
            document.getElementById('stationModal').classList.add('hidden');
        }
        
        // 保存站点
        function saveStation() {
            const name = document.getElementById('stationName').value.trim();
            const type = document.getElementById('stationType').value;
            const distance = document.getElementById('stationDistance').value.trim();
            const detail = document.getElementById('stationDetail').value.trim();
            
            // 简单验证
            if (!name || !distance) {
                alert('请填写站点名称和距离');
                return;
            }
            
            const station = {
                name: name,
                type: type,
                distance: distance,
                detail: detail
            };
            
            if (currentEditIndex === -1) {
                // 添加新站点
                stations.push(station);
            } else {
                // 更新现有站点
                stations[currentEditIndex] = station;
            }
            
            // 刷新表格
            refreshStationsTable();
            
            // 关闭模态框
            closeStationModal();
        }
        
        // 编辑站点
        function editStation(index) {
            openStationModal(index);
        }
        
        // 删除站点
        function deleteStation(index) {
            if (confirm('确定要删除这个站点吗？')) {
                stations.splice(index, 1);
                refreshStationsTable();
            }
        }
        
        // 生成报告
        async function generateReport() {
            try {
                // 显示加载提示
                document.getElementById('loading').style.display = 'flex';
                
                // 准备数据
                const projectInfo = {
                    "项目名称": document.getElementById('projectName').value,
                    "项目地点": document.getElementById('projectLocation').value,
                    "项目编号": document.getElementById('projectId').value,
                    "建设单位": document.getElementById('developer').value,
                    "设计单位": document.getElementById('designer').value,
                    "总用地面积": "",
                    "总建筑面积": "",
                    "建筑密度": "",
                    "绿地率": "",
                    "容积率": ""
                };
                
                // 获取地图图片
                let mapImage = '';
                const mapImageElement = document.getElementById('mapPreviewImage');
                if (mapImageElement.src) {
                    mapImage = mapImageElement.src;
                }
                
                // 准备结论
                const conclusion = {
                    result6_1_2: document.getElementById('conclusion612').value,
                    result6_2_1: document.getElementById('conclusion621').value,
                    totalScore: document.getElementById('totalScore').value
                };
                
                // 准备请求数据
                const requestData = {
                    address: projectInfo["项目地点"],
                    stations: stations,
                    map_image: mapImage,
                    conclusion: conclusion,
                    project_info: projectInfo
                };
                
                // 发送请求
                const response = await fetch('/api/generate_transport_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                // 处理响应
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`生成报告失败: ${response.status} - ${errorText}`);
                }
                
                // 获取生成的报告文件
                const blob = await response.blob();
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `公共交通站点分析报告_${projectInfo["项目名称"]}.docx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 清理URL对象
                URL.revokeObjectURL(url);
                
                // 隐藏加载提示
                document.getElementById('loading').style.display = 'none';
                
                alert('报告生成成功！');
            } catch (error) {
                // 隐藏加载提示
                document.getElementById('loading').style.display = 'none';
                
                console.error('生成报告失败:', error);
                alert('生成报告失败: ' + error.message);
            }
        }
    </script>
</body>
</html> 