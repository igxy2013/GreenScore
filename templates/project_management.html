<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind-full-3.4.16.css') }}">
    <title>智能绿建评价系统-项目管理</title>
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='image/greenscore-sm.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='image/greenscore-32.png') }}">
    <link rel="icon" type="image/png" sizes="48x48" href="{{ url_for('static', filename='image/greenscore.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='image/greenscore-lg.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.min.css') }}">
        <!-- 使用Font Awesome图标库 -->
    <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">

    <style>
    /* 图标样式兼容处理 */
    [class^="ri-"], [class*=" ri-"] {
        display: inline-block;
        font-style: normal;
        font-variant: normal;
        text-rendering: auto;
        line-height: 1;
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
    }

    /* 定义图标映射关系 */
    .ri-add-line:before { content: "\f067"; }                    /* fa-plus */
    .ri-delete-bin-line:before { content: "\f2ed"; }            /* fa-trash-alt */
    .ri-edit-line:before { content: "\f044"; }                  /* fa-edit */
    .ri-search-line:before { content: "\f002"; }                /* fa-search */
    .ri-menu-line:before { content: "\f0c9"; }                  /* fa-bars */
    .ri-settings-line:before { content: "\f013"; }              /* fa-cog */
    .ri-user-line:before { content: "\f007"; }                  /* fa-user */
    .ri-home-line:before { content: "\f015"; }                  /* fa-home */
    .ri-arrow-down-s-line:before { content: "\f107"; }          /* fa-angle-down */
    .ri-arrow-up-s-line:before { content: "\f106"; }            /* fa-angle-up */
    .ri-close-line:before { content: "\f00d"; }                 /* fa-times */
    .ri-check-line:before { content: "\f00c"; }                 /* fa-check */
    .ri-information-line:before { content: "\f129"; }           /* fa-info */
    .ri-file-list-line:before { content: "\f15c"; }             /* fa-file-alt */
    .ri-calendar-line:before { content: "\f133"; }              /* fa-calendar */
    .ri-save-line:before { content: "\f0c7"; }                  /* fa-save */
    .ri-upload-line:before { content: "\f093"; }                /* fa-cloud-upload-alt */
    .ri-download-line:before { content: "\f019"; }              /* fa-download */
    .ri-refresh-line:before { content: "\f2f1"; }               /* fa-sync */
    .ri-loader-2-line:before { content: "\f110"; }             /* fa-spinner */
    .ri-arrow-left-line:before { content: "\f060"; }           /* fa-arrow-left */
    .ri-star-fill:before { content: "\f005"; }                  /* fa-star */
    .ri-close-circle-fill:before { content: "\f057"; }          /* fa-times-circle */
    .ri-bar-chart-line:before { content: "\f080"; }             /* fa-chart-bar */
    .ri-file-download-line:before { content: "\f56d"; }         /* fa-file-download */
    .ri-calculator-line:before { content: "\f1ec"; }            /* fa-calculator */
    .ri-building-line:before { content: "\f1ad"; }              /* fa-building */
    .ri-layout-2-line:before { content: "\f0db"; }              /* fa-columns */
    .ri-drop-line:before { content: "\f043"; }                  /* fa-tint */
    .ri-flashlight-line:before { content: "\f0eb"; }            /* fa-lightbulb */
    .ri-temp-hot-line:before { content: "\f2c7"; }             /* fa-thermometer-full */
    .ri-plant-line:before { content: "\f4d8"; }                 /* fa-seedling */
    .ri-checkbox-line:before { content: "\f0c8"; }              /* fa-square */
    .ri-checkbox-multiple-line:before { content: "\f14a"; }     /* fa-check-square */
    .ri-leaf-line:before { content: "\f06c"; }                  /* fa-leaf */
    .ri-file-list-3-line:before { content: "\f15c"; }          /* fa-file-alt */

    /* 添加动画效果 */
    .fa-spin {
        animation: fa-spin 2s infinite linear;
    }
    @keyframes fa-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* 修改表格容器样式 */
    .table-container {
        position: relative;
        z-index: 1;
        min-height: 500px;
        padding-bottom: 100px;
        flex: 1;
        overflow: visible;
    }

    /* 修改表格行样式 */
    .table-container tr {
        position: relative;
    }

    /* 修改表格列宽度 */
    .table-container table th:first-child {
        width: 30%;  /* 项目名称列宽度 */
        max-width: 400px;
    }

    .table-container table th:nth-child(2),
    .table-container table th:nth-child(3),
    .table-container table th:nth-child(4),
    .table-container table th:nth-child(5),
    .table-container table th:nth-child(6) {
        width: 10%;  /* 其他列宽度 */
    }

    .table-container table th:last-child {
        width: 20%;  /* 操作列宽度 */
        min-width: 250px;
    }

    /* 确保文本溢出时显示省略号 */
    .table-container td:first-child {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* 修改最后一列（操作列）的样式 */
    .table-container td:last-child {
        position: relative;
        min-width: 250px;
        width: 25%;
        padding-right: 1rem;
    }

    /* 修改下拉菜单容器样式 */
    [data-dropdown-container] {
        position: relative;
        display: inline-block;
    }

    /* 修改下拉菜单样式 */
    .dropdown-menu {
        position: absolute;
        right: 0;
        top: 0;  /* 改为与触发按钮同高 */
        transform: translateX(100%);  /* 向右偏移100% */
        margin-left: 0.5rem;  /* 与触发按钮保持一定距离 */
        z-index: 50;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        min-width: 150px;
        transform-origin: left center;  /* 从左侧中心开始变换 */
        transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .dropdown-menu.hidden {
        opacity: 0;
        transform: translateX(100%) scale(0.95);
        pointer-events: none;
    }

    /* 修改主容器样式 */
    .page-container {
        min-height: calc(100vh - 2rem);
        margin-bottom: 2rem;
    }

    .content-card {
        min-height: 500px;
        display: flex;
        flex-direction: column;
    }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="min-h-screen bg-gray-100">
        <!-- 引入用户菜单组件 -->
        {% include 'components/user_menu.html' %}

        <div class="page-container max-w-[80%] mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold text-primary mb-6">    
                <picture>
                    <source srcset="{{ url_for('static', filename='image/greenscore@3x.png') }}" media="(-webkit-min-device-pixel-ratio: 3), (min-resolution: 288dpi)">
                    <source srcset="{{ url_for('static', filename='image/greenscore@2x.png') }}" media="(-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi)">
                    <img src="{{ url_for('static', filename='image/greenscore.png') }}" alt="logo" class="inline-block h-10">
                </picture>
                <span>智能绿建评价系统</span>
            </h1>
            
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl text-primary font-bold">项目管理中心</h2>
                <div class="flex items-center">
                    <a href="{{ url_for('user_guide') }}" class="inline-flex items-center text-primary hover:text-primary/80 mr-2 bg-blue-50 px-3 py-1 rounded-full transition-all duration-300 hover:bg-blue-100">
                        <i class="fas fa-question-circle mr-2"></i>
                        <span>使用指南</span>
                    </a>
                </div>
            </div>
            <div class="content-card bg-white rounded-lg shadow-sm p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">现有项目</h3>
                    <!-- 添加新建项目按钮 -->
                    <button id="openCreateProjectModal" class="px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90 transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        <span>新建项目</span>
                    </button>
                </div>
                
                <!-- 添加搜索框 -->
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="projectSearchInput" 
                            class="w-full px-4 py-2 pl-10 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-primary"
                            placeholder="搜索项目名称...">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- 添加状态过滤器 -->
                <div class="mb-4 flex items-center space-x-4">
                    <label class="text-gray-700">项目状态：</label>
                    <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-primary" title="项目状态过滤器">
                        <option value="进行中">进行中</option>
                        <option value="all">全部</option>
                        <option value="已完成">已完成</option>
                        <option value="已暂停">已暂停</option>
                        <option value="已取消">已取消</option>
                    </select>

                    <label class="text-gray-700 ml-4">角色：</label>
                    <select id="roleFilter" class="px-4 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-primary" title="项目角色过滤器">
                        <option value="all">全部</option>
                        <option value="创建者">我创建的</option>
                        <option value="参与者">我参与的</option>
                    </select>
                </div>
                
                <div class="relative w-full overflow-x-auto max-h-[500px] overflow-y-auto table-container">
                    <table class="w-full table-auto divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-bold uppercase tracking-wider">项目名称</th>
                                <th class="px-6 py-3 text-left text-sm font-bold uppercase tracking-wider">目标星级</th>
                                <th class="px-6 py-3 text-left text-sm font-bold uppercase tracking-wider">建筑类型</th>
                                <th class="px-6 py-3 text-left text-sm font-bold uppercase tracking-wider">评价标准</th>
                                <th class="px-6 py-3 text-left text-sm font-bold uppercase tracking-wider">项目状态</th>
                                <th class="px-6 py-3 text-left text-sm font-bold uppercase tracking-wider">创建时间</th>
                                <th class="px-6 py-3 text-left text-sm font-bold uppercase tracking-wider">我的角色</th>
                                <th class="px-6 py-3 text-left text-sm font-bold uppercase tracking-wider relative">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="projectList">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                    正在加载项目列表...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 添加分页控件 -->
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        显示 <span id="pageStart">1</span> 到 <span id="pageEnd">10</span> 条，共 <span id="totalRecords">0</span> 条记录
                    </div>
                    <div class="flex space-x-2">
                        <button id="prevPageBtn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            上一页
                        </button>
                        <div id="pageNumbers" class="flex space-x-1">
                            <!-- 页码将通过JavaScript动态生成 -->
                        </div>
                        <button id="nextPageBtn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            下一页
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 创建新项目模态窗口 -->
            <div id="createProjectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-1xl p-6 relative">
                    <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" title="关闭">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">创建新项目</h3>
                    
                    <form id="modalProjectForm" action="/create_project" method="POST" class="space-y-6">
                        <div class="grid grid-cols-1 gap-2">
                            <div>
                                <label for="project_name" class="block text-base font-medium text-gray-700 mb-1">项目名称 <span class="text-red-500">*</span></label>
                                <input type="text" id="project_name" name="project_name" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入项目名称" required>
                            </div>
                            
                            <div>
                                <label for="standard_selection" class="block text-base font-medium text-gray-700 mb-1">评价标准 <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <select id="standard_selection" name="standard_selection" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary appearance-none pr-8" required title="评价标准">
                                        <option value="">请选择评价标准</option>
                                        <option value="国标">绿色建筑评价标准 GB/T 50378-2019（2024版）</option>
                                        <option value="四川省标">四川省民用绿色建筑设计施工图阶段审查技术要点（2024版）</option>
                                        <option value="成都市标">成都市绿色建筑施工图设计与审查技术要点（2024版）</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="building_type" class="block text-base font-medium text-gray-700 mb-1">建筑类型 <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <select id="building_type" name="building_type" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary appearance-none pr-8" required title="建筑类型">
                                        <option value="">请选择建筑类型</option>
                                        <option value="居住建筑">居住建筑</option>
                                        <option value="公共建筑">公共建筑</option>
                                        <option value="居住+公共建筑">居住+公共建筑</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="target_star_level" class="block text-base font-medium text-gray-700 mb-1">目标星级<span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <select id="star_rating_target" name="star_rating_target" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary appearance-none pr-8" required title="目标星级">
                                        <option value="">请选择目标星级</option>
                                        <option value="基本级">基本级</option>
                                        <option value="一星级">一星级</option>
                                        <option value="二星级">二星级</option>
                                        <option value="三星级">三星级</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label for="project_status" class="block text-base font-medium text-gray-700 mb-1">项目状态</label>
                                <div class="relative">
                                    <select id="project_status" name="project_status" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary appearance-none pr-8" title="项目状态">
                                        <option value="进行中">进行中</option>
                                        <option value="已完成">已完成</option>
                                        <option value="已暂停">已暂停</option>
                                        <option value="已取消">已取消</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <i class="fas fa-chevron-down text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-center">
                            <button type="submit" class="px-6 py-2 bg-primary text-white rounded-button hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                                创建项目
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 项目状态修改模态窗口 -->
        <div id="updateStatusModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
                <button id="closeStatusModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" title="关闭">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">修改项目状态</h3>
                
                <form id="updateStatusForm" class="space-y-6">
                    <input type="hidden" id="statusProjectId" name="statusProjectId">
                    <div>
                        <label for="projectStatusSelect" class="block text-base font-medium text-gray-700 mb-1">项目状态 <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <select id="projectStatusSelect" name="projectStatusSelect" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary appearance-none pr-8" required title="项目状态">
                                <option value="进行中">进行中</option>
                                <option value="已完成">已完成</option>
                                <option value="已暂停">已暂停</option>
                                <option value="已取消">已取消</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-center">
                        <button type="submit" class="px-6 py-2 bg-primary text-white rounded-button hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            保存修改
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 项目分享模态窗口 -->
    <div id="shareProjectModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <button id="closeShareModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" title="关闭">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">分享项目</h3>
            
            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-2 text-gray-800">已有分享链接</h4>
                <div id="existingInvitations" class="bg-gray-50 p-4 rounded-lg max-h-40 overflow-y-auto mb-4">
                    <p class="text-gray-500 text-center py-2">正在加载...</p>
                </div>
            </div>
            
            <form id="shareProjectForm" class="space-y-4">
                <input type="hidden" id="shareProjectId" name="shareProjectId">
                
                <div>
                    <label for="sharePermissions" class="block text-base font-medium text-gray-700 mb-1">访问权限</label>
                    <div class="relative">
                        <select id="sharePermissions" name="sharePermissions" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary appearance-none pr-8" required title="访问权限">
                            <option value="只读">只读 - 可查看项目内容</option>
                            <option value="编辑">编辑 - 可修改项目内容</option>
                            <option value="管理">管理 - 可管理项目和协作者</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="shareExpireDays" class="block text-base font-medium text-gray-700 mb-1">链接有效期</label>
                    <div class="relative">
                        <select id="shareExpireDays" name="shareExpireDays" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary appearance-none pr-8" required title="链接有效期">
                            <option value="1">1天</option>
                            <option value="3">3天</option>
                            <option value="7" selected>7天</option>
                            <option value="30">30天</option>
                            <option value="90">90天</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                            <i class="fas fa-chevron-down text-gray-400"></i>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-center">
                    <button type="submit" class="px-6 py-2 bg-primary text-white rounded-button hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                        生成分享链接
                    </button>
                </div>
            </form>
            
            <div id="shareResultContainer" class="mt-6 hidden">
                <h4 class="text-lg font-semibold mb-2 text-gray-800">分享链接</h4>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex items-center mb-2">
                        <input type="text" id="shareLink" class="w-full px-4 py-2 border border-gray-300 rounded-l-button focus:ring-2 focus:ring-primary focus:border-primary" readonly aria-label="分享链接">
                        <button id="copyShareLinkBtn" class="px-4 py-2 bg-primary text-white rounded-r-button hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50" title="复制链接">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500">分享此链接给其他人，他们可以通过此链接加入项目。</p>
                    <p class="text-sm text-gray-500">链接有效期至: <span id="linkExpireTime"></span></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 管理协作者模态窗口 -->
    <div id="manageCollaboratorsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 relative">
            <button id="closeCollaboratorsModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" title="关闭">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">管理项目成员</h3>
            <h4 id="collaboratorsProjectName" class="text-lg font-medium text-center mb-4"></h4>
            
            <div class="mb-4">
                <h5 class="text-base font-medium text-gray-800 mb-2">创建者</h5>
                <div id="projectCreator" class="bg-gray-100 p-3 rounded-lg mb-4">
                    <p class="text-gray-500 text-center py-2">加载中...</p>
                </div>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h5 class="text-base font-medium text-gray-800">项目成员</h5>
                    <button id="refreshCollaboratorsBtn" class="text-primary hover:text-primary/80 text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> 刷新
                    </button>
                </div>
                <div id="collaboratorsList" class="bg-gray-50 p-4 rounded-lg min-h-[150px] max-h-[300px] overflow-y-auto">
                    <p class="text-gray-500 text-center py-2">加载中...</p>
                </div>
            </div>
            
            <div class="mt-4 flex flex-col sm:flex-row justify-between gap-4">
                <button id="generateShareLinkBtn" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-button hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-opacity-50">
                    <i class="fas fa-share-alt mr-2"></i> 生成分享链接
                </button>
                <button id="closeManageCollaboratorsBtn" class="flex-1 px-4 py-2 bg-gray-300 text-gray-800 rounded-button hover:bg-gray-400 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50">
                    关闭
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 页面加载完成后获取项目列表
        document.addEventListener('DOMContentLoaded', function() {
            fetchProjects();
            
            // 添加搜索框事件监听
            const searchInput = document.getElementById('projectSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    // 防止页面滚动
                    e.preventDefault();
                    
                    // 保存当前滚动位置
                    const scrollPos = window.scrollY;
                    
                    currentPage = 1; // 搜索时重置到第一页
                    fetchProjects();
                    
                    // 恢复滚动位置
                    setTimeout(() => {
                        window.scrollTo(0, scrollPos);
                    }, 10);
                });
            }
            
            // 添加分页按钮事件监听
            document.getElementById('prevPageBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    fetchProjects();
                }
            });
            
            document.getElementById('nextPageBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchProjects();
                }
            });
            
            // 使用事件委托处理页码按钮点击
            document.getElementById('pageNumbers').addEventListener('click', function(e) {
                const pageButton = e.target.closest('button[data-page]');
                if (pageButton) {
                    e.preventDefault();
                    e.stopPropagation();
                    const pageNum = parseInt(pageButton.getAttribute('data-page'), 10);
                    if (!isNaN(pageNum) && currentPage !== pageNum) {
                        currentPage = pageNum;
                        fetchProjects();
                    }
                }
            });
            
            // 添加项目操作的事件委托（删除、修改状态、分享项目和管理协作者）
            document.getElementById('projectList').addEventListener('click', function(e) {
                // 处理删除按钮点击
                const deleteBtn = e.target.closest('.delete-project-btn');
                if (deleteBtn) {
                    const projectId = deleteBtn.getAttribute('data-project-id');
                    const projectName = deleteBtn.getAttribute('data-project-name');
                    
                    if (confirm(`确定要删除项目"${projectName}"吗？此操作不可恢复。`)) {
                        deleteProject(projectId);
                    }
                }
                
                // 处理修改状态按钮点击
                const updateStatusBtn = e.target.closest('.update-status-btn');
                if (updateStatusBtn) {
                    const projectId = updateStatusBtn.getAttribute('data-project-id');
                    const projectName = updateStatusBtn.getAttribute('data-project-name');
                    
                    // 打开状态修改模态框
                    openUpdateStatusModal(projectId, projectName);
                }
                
                // 处理分享项目按钮点击
                const shareBtn = e.target.closest('.share-project-btn');
                if (shareBtn) {
                    const projectId = shareBtn.getAttribute('data-project-id');
                    const projectName = shareBtn.getAttribute('data-project-name');
                    
                    // 打开分享项目模态框
                    openShareModal(projectId, projectName);
                }
                
                // 处理管理协作者按钮点击
                const manageBtn = e.target.closest('.manage-collaborators-btn');
                if (manageBtn) {
                    const projectId = manageBtn.getAttribute('data-project-id');
                    const projectName = manageBtn.getAttribute('data-project-name');
                    
                    // 打开管理协作者模态框
                    openManageCollaboratorsModal(projectId, projectName);
                }
                
                // 处理退出项目按钮点击
                const leaveBtn = e.target.closest('.leave-project-btn');
                if (leaveBtn) {
                    const projectId = leaveBtn.getAttribute('data-project-id');
                    const projectName = leaveBtn.getAttribute('data-project-name');
                    
                    if (confirm(`确定要退出项目"${projectName}"吗？`)) {
                        leaveProject(projectId);
                    }
                }
            });
            
            // 初始化状态修改模态框
            initUpdateStatusModal();
            
            // 初始化分享模态窗口
            initShareModal();
            
            // 初始化协作者管理模态窗口
            initManageCollaboratorsModal();
            
            // 处理下拉菜单的显示和隐藏
            document.addEventListener('click', function(e) {
                const dropdownTrigger = e.target.closest('.dropdown-trigger');
                const dropdownContainer = e.target.closest('[data-dropdown-container]');
                
                console.log('点击事件:', {
                    'target': e.target.tagName,
                    '是否触发按钮': !!dropdownTrigger,
                    '是否在下拉容器内': !!dropdownContainer
                });
                
                // 关闭所有其他打开的下拉菜单
                document.querySelectorAll('.dropdown-menu:not(.hidden)').forEach(menu => {
                    if (!menu.parentElement.contains(e.target)) {
                        menu.classList.add('hidden');
                    }
                });
                
                if (dropdownTrigger) {
                    const dropdownMenu = dropdownTrigger.parentElement.querySelector('.dropdown-menu');
                    console.log('找到下拉菜单:', !!dropdownMenu, dropdownMenu ? dropdownMenu.className : '未找到');
                    
                    // 确保下拉菜单存在
                    if (dropdownMenu) {
                        dropdownMenu.classList.toggle('hidden');
                        console.log('切换下拉菜单显示状态:', !dropdownMenu.classList.contains('hidden'));
                        e.stopPropagation();
                    }
                } else if (!dropdownContainer) {
                    // 点击其他地方时关闭所有下拉菜单
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.add('hidden');
                    });
                }
            });

            // 添加状态过滤器的事件监听
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    currentPage = 1; // 重置到第一页
                    fetchProjects();
                });
            }
        });
        
        // 分页变量
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = 10;
        let allProjects = [];
        
        // 获取项目列表
        function fetchProjects() {
            // 显示加载中提示
            document.getElementById('projectList').innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                        <i class="fas fa-sync fa-spin mr-2"></i> 正在加载项目列表...
                    </td>
                </tr>
            `;
            
            fetch('/api/projects')
                .then(response => {
                    // 检查HTTP状态码
                    if (!response.ok) {
                        if (response.status === 401) {
                            throw new Error('用户未登录，请重新登录');
                        } else if (response.status === 500) {
                            throw new Error('服务器错误，可能是数据库连接问题');
                        } else {
                            throw new Error(`服务器返回错误状态码: ${response.status}`);
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    // 添加调试信息
                    console.log('API返回的项目数据:', data);
                    
                    if (data.success && Array.isArray(data.projects)) {
                        // 检查每个项目的状态字段
                        data.projects.forEach(project => {
                            console.log(`项目 ${project.name} 的状态:`, project.status);
                            // 如果是旧的"规划中"状态，自动更新为"进行中"
                            if (project.status === '规划中') {
                                project.status = '进行中';
                            }
                        });
                        
                        // 保存所有项目数据
                        allProjects = data.projects;
                        
                        // 应用搜索过滤
                        const searchTerm = document.getElementById('projectSearchInput').value.toLowerCase();
                        const statusFilter = document.getElementById('statusFilter').value;
                        const roleFilter = document.getElementById('roleFilter').value;
                        const filteredProjects = allProjects.filter(project => {
                            const nameMatch = project.name && project.name.toLowerCase().includes(searchTerm);
                            const statusMatch = statusFilter === 'all' || (project.status === statusFilter);
                            const roleMatch = roleFilter === 'all' || 
                                             (roleFilter === '创建者' && project.is_owner) ||
                                             (roleFilter === '参与者' && !project.is_owner);
                            return nameMatch && statusMatch && roleMatch;
                        });
                        
                        // 计算分页信息
                        totalPages = Math.ceil(filteredProjects.length / pageSize);
                        if (totalPages === 0) totalPages = 1;
                        if (currentPage > totalPages) currentPage = totalPages;
                        
                        // 获取当前页的项目
                        const startIndex = (currentPage - 1) * pageSize;
                        const endIndex = Math.min(startIndex + pageSize, filteredProjects.length);
                        const currentPageProjects = filteredProjects.slice(startIndex, endIndex);
                        
                        // 更新分页信息显示
                        document.getElementById('pageStart').textContent = filteredProjects.length > 0 ? startIndex + 1 : 0;
                        document.getElementById('pageEnd').textContent = endIndex;
                        document.getElementById('totalRecords').textContent = filteredProjects.length;
                        
                        // 更新分页按钮状态
                        document.getElementById('prevPageBtn').disabled = currentPage <= 1;
                        document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
                        
                        // 生成页码按钮
                        generatePageNumbers(currentPage, totalPages);
                        
                        // 显示项目列表
                        displayProjects(currentPageProjects);
                    } else {
                        console.error('API返回数据格式错误:', data);
                        displayNoProjects();
                    }
                })
                .catch(error => {
                    console.error('获取项目列表失败:', error);
                    // 显示更友好的错误信息
                    document.getElementById('projectList').innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4">
                                <div class="text-center">
                                    <div class="text-red-500 font-bold mb-2">
                                        <i class="fas fa-exclamation-triangle mr-2"></i> 获取项目列表失败
                                    </div>
                                    <p class="text-gray-700 mb-3">${error.message || '请检查网络连接并刷新页面'}</p>
                                    <div class="text-left bg-gray-50 p-4 rounded-lg text-sm mx-auto max-w-lg">
                                        <p class="font-medium mb-2">可能的解决方法:</p>
                                        <ul class="list-disc pl-5 space-y-1">
                                            <li>检查MySQL数据库是否正在运行</li>
                                            <li>验证数据库连接参数是否正确</li>
                                            <li>确保数据库表结构已正确创建</li>
                                            <li>刷新页面重试</li>
                                        </ul>
                                    </div>
                                    <button onclick="fetchProjects()" class="mt-4 px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90">
                                        <i class="fas fa-sync mr-2"></i> 重试加载
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    // 更新分页信息
                    document.getElementById('pageStart').textContent = '0';
                    document.getElementById('pageEnd').textContent = '0';
                    document.getElementById('totalRecords').textContent = '0';
                    document.getElementById('prevPageBtn').disabled = true;
                    document.getElementById('nextPageBtn').disabled = true;
                    document.getElementById('pageNumbers').innerHTML = '';
                });
        }
        
        // 生成页码按钮
        function generatePageNumbers(currentPage, totalPages) {
            const pageNumbersContainer = document.getElementById('pageNumbers');
            pageNumbersContainer.innerHTML = '';
            
            // 确定显示的页码范围
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // 添加第一页按钮
            if (startPage > 1) {
                addPageButton(1, currentPage === 1);
                if (startPage > 2) {
                    // 添加省略号
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-3 py-1 text-gray-500';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }
            
            // 添加中间页码
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i, currentPage === i);
            }
            
            // 添加最后一页按钮
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    // 添加省略号
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-3 py-1 text-gray-500';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
                addPageButton(totalPages, currentPage === totalPages);
            }
            
            function addPageButton(pageNum, isActive) {
                // 创建按钮元素，使用data-page属性存储页码
                const buttonHtml = `
                    <button type="button" 
                        class="${isActive 
                            ? 'px-3 py-1 bg-primary text-white rounded' 
                            : 'px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300'}"
                        data-page="${pageNum}">
                        ${pageNum}
                    </button>
                `;
                
                // 将HTML字符串添加到容器中
                pageNumbersContainer.insertAdjacentHTML('beforeend', buttonHtml);
            }
        }
        
        // 显示项目列表
        function displayProjects(projects) {
            const projectList = document.getElementById('projectList');
            
            if (projects && projects.length > 0) {
                // 清空加载提示
                projectList.innerHTML = '';
                
                // 获取过滤条件
                const searchTerm = document.getElementById('projectSearchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const roleFilter = document.getElementById('roleFilter').value;
                
                // 过滤项目
                const filteredProjects = projects.filter(project => {
                    const nameMatch = project.name && project.name.toLowerCase().includes(searchTerm);
                    const statusMatch = statusFilter === 'all' || (project.status === statusFilter);
                    const roleMatch = roleFilter === 'all' || 
                                     (roleFilter === '创建者' && project.is_owner) ||
                                     (roleFilter === '参与者' && !project.is_owner);
                    return nameMatch && statusMatch && roleMatch;
                });
                
                if (filteredProjects.length === 0) {
                    projectList.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                未找到匹配的项目
                            </td>
                        </tr>
                    `;
                    
                    // 更新分页信息
                    document.getElementById('pageStart').textContent = '0';
                    document.getElementById('pageEnd').textContent = '0';
                    document.getElementById('totalRecords').textContent = '0';
                    document.getElementById('prevPageBtn').disabled = true;
                    document.getElementById('nextPageBtn').disabled = true;
                    document.getElementById('pageNumbers').innerHTML = '';
                    return;
                }
                
                // 添加项目列表
                filteredProjects.forEach((project, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    // 获取建筑类型显示文本
                    let buildingType = '未设置';
                    if (project.building_type) {
                        buildingType = project.building_type;
                    }
                    
                    // 如果项目状态是旧的"规划中"，自动转换为"进行中"显示
                    let statusText = project.status || '进行中';
                    if (statusText === '规划中') {
                        statusText = '进行中';
                    }
                    
                    // 根据项目状态设置不同的样式
                    let statusClass = 'bg-gray-100 text-gray-600';
                    
                    // 根据状态设置不同的颜色
                    if (statusText === '进行中') {
                        statusClass = 'bg-green-100 text-green-600';
                    } else if (statusText === '已完成') {
                        statusClass = 'bg-purple-100 text-purple-600';
                    } else if (statusText === '已暂停') {
                        statusClass = 'bg-yellow-100 text-yellow-600';
                    } else if (statusText === '已取消') {
                        statusClass = 'bg-red-100 text-red-600';
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${project.name || '未设置'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${project.star_rating_target || '未设置'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${buildingType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${project.standard || '未设置'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${project.created_at ? new Date(project.created_at).toLocaleDateString() : '未知'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${project.is_owner ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'}">
                                ${project.role || '创建者'} · ${project.permissions || '管理'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm flex items-center space-x-2">
                            <a href="/project/${project.id}" class="px-4 py-2 bg-primary text-white rounded-button hover:bg-primary/90 transition-colors cursor-pointer">
                                进入项目
                            </a>
                            <div class="relative inline-block" data-dropdown-container>
                                <button type="button" 
                                    class="px-3 py-2 text-gray-500 hover:bg-gray-100 rounded-button transition-colors cursor-pointer dropdown-trigger"
                                    data-project-id="${project.id}">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="hidden dropdown-menu">
                                    <div class="py-1">
                                        ${project.is_owner || project.permissions === '管理' ? `
                                        <button type="button" 
                                            class="w-full px-4 py-2 text-left text-sm text-blue-500 hover:bg-blue-100/80 transition-colors flex items-center space-x-2 group update-status-btn"
                                            data-project-id="${project.id}" 
                                            data-project-name="${project.name || ''}">
                                            <i class="fas fa-edit text-blue-500 group-hover:text-blue-600 transition-colors"></i>
                                            <span class="group-hover:text-blue-600 transition-colors">修改状态</span>
                                        </button>
                                        ` : ''}
                                        ${project.is_owner || project.permissions === '管理' ? `
                                        <button type="button" 
                                            class="w-full px-4 py-2 text-left text-sm text-green-500 hover:bg-green-100/80 transition-colors flex items-center space-x-2 group share-project-btn"
                                            data-project-id="${project.id}" 
                                            data-project-name="${project.name || ''}">
                                            <i class="fas fa-share-alt text-green-500 group-hover:text-green-600 transition-colors"></i>
                                            <span class="group-hover:text-green-600 transition-colors">分享项目</span>
                                        </button>
                                        ` : ''}
                                        ${project.is_owner || project.permissions === '管理' ? `
                                        <button type="button" 
                                            class="w-full px-4 py-2 text-left text-sm text-purple-500 hover:bg-purple-100/80 transition-colors flex items-center space-x-2 group manage-collaborators-btn"
                                            data-project-id="${project.id}" 
                                            data-project-name="${project.name || ''}">
                                            <i class="fas fa-users text-purple-500 group-hover:text-purple-600 transition-colors"></i>
                                            <span class="group-hover:text-purple-600 transition-colors">管理项目成员</span>
                                        </button>
                                        ` : ''}
                                        ${!project.is_owner ? `
                                        <button type="button" 
                                            class="w-full px-4 py-2 text-left text-sm text-orange-500 hover:bg-orange-100/80 transition-colors flex items-center space-x-2 group leave-project-btn"
                                            data-project-id="${project.id}" 
                                            data-project-name="${project.name || ''}">
                                            <i class="fas fa-sign-out-alt text-orange-500 group-hover:text-orange-600 transition-colors"></i>
                                            <span class="group-hover:text-orange-600 transition-colors">退出项目</span>
                                        </button>
                                        ` : ''}
                                        ${project.is_owner ? `
                                        <button type="button" 
                                            class="w-full px-4 py-2 text-left text-sm text-red-500 hover:bg-red-100/80 transition-colors flex items-center space-x-2 group delete-project-btn"
                                            data-project-id="${project.id}" 
                                            data-project-name="${project.name || ''}">
                                            <i class="fas fa-trash-alt text-red-500 group-hover:text-red-600 transition-colors"></i>
                                            <span class="group-hover:text-red-600 transition-colors">删除</span>
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    
                    projectList.appendChild(row);
                });
                
                // 更新分页信息
                document.getElementById('pageStart').textContent = filteredProjects.length > 0 ? 1 : 0;
                document.getElementById('pageEnd').textContent = filteredProjects.length;
                document.getElementById('totalRecords').textContent = filteredProjects.length;
                
                // 更新分页按钮状态
                document.getElementById('prevPageBtn').disabled = true;
                document.getElementById('nextPageBtn').disabled = true;
                
                // 生成页码按钮
                generatePageNumbers(1, 1);
            } else {
                displayNoProjects();
            }
        }
        
        // 删除项目
        function deleteProject(projectId) {
            fetch(`/api/projects/${projectId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 显示成功消息
                    showNotification('项目删除成功', 'success');
                    
                    // 重新加载项目列表
                    fetchProjects();
                } else {
                    showNotification('删除失败: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('删除项目失败:', error);
                showNotification('删除失败，请稍后重试', 'error');
            });
        }
        
        // 初始化状态修改模态框
        function initUpdateStatusModal() {
            const statusModal = document.getElementById('updateStatusModal');
            const closeStatusModalBtn = document.getElementById('closeStatusModalBtn');
            const statusForm = document.getElementById('updateStatusForm');
            
            // 关闭模态框
            closeStatusModalBtn.addEventListener('click', function() {
                statusModal.classList.add('hidden');
                document.body.style.overflow = '';
            });
            
            // 点击模态框外部关闭
            statusModal.addEventListener('click', function(e) {
                if (e.target === statusModal) {
                    statusModal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
            
            // 提交状态修改表单
            statusForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const projectId = document.getElementById('statusProjectId').value;
                const newStatus = document.getElementById('projectStatusSelect').value;
                
                // 显示加载中状态
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
                
                // 发送更新请求
                updateProjectStatus(projectId, newStatus)
                    .then(() => {
                        // 恢复按钮状态
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        
                        // 关闭模态框
                        statusModal.classList.add('hidden');
                        document.body.style.overflow = '';
                    })
                    .catch(() => {
                        // 恢复按钮状态
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    });
            });
        }
        
        // 打开状态修改模态框
        function openUpdateStatusModal(projectId, projectName) {
            const statusModal = document.getElementById('updateStatusModal');
            document.getElementById('statusProjectId').value = projectId;
            
            // 查找当前项目的状态并设置为默认选中
            const currentProject = allProjects.find(p => p.id == projectId);
            if (currentProject && currentProject.status) {
                // 如果是旧的"规划中"状态，自动转为"进行中"
                let statusToSet = currentProject.status;
                if (statusToSet === '规划中') {
                    statusToSet = '进行中';
                }
                document.getElementById('projectStatusSelect').value = statusToSet;
            } else {
                document.getElementById('projectStatusSelect').value = '进行中';
            }
            
            // 显示模态框
            statusModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // 更新项目状态
        function updateProjectStatus(projectId, newStatus) {
            return fetch(`/api/projects/${projectId}/update_status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: newStatus
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 显示成功消息
                    showNotification('项目状态更新成功', 'success');
                    
                    // 强制清空缓存的项目数据
                    allProjects = [];
                    
                    // 立即重新获取最新的项目数据
                    return fetch('/api/projects')
                        .then(response => response.json())
                        .then(newData => {
                            if (newData.success && Array.isArray(newData.projects)) {
                                allProjects = newData.projects;
                                // 重新渲染项目列表
                                fetchProjects();
                            }
                            return data;
                        });
                } else {
                    showNotification('状态更新失败: ' + data.error, 'error');
                    throw new Error(data.error || '状态更新失败');
                }
            })
            .catch(error => {
                console.error('更新项目状态失败:', error);
                showNotification('状态更新失败，请稍后重试', 'error');
                throw error;
            });
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            
            // 根据类型设置不同的样式
            let bgColor, textColor, icon;
            switch(type) {
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                    icon = '<i class="fas fa-exclamation-triangle mr-2"></i>';
                    break;
                case 'success':
                default:
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = '<i class="fas fa-check-circle mr-2"></i>';
                    break;
            }
            
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded shadow-lg transform transition-all duration-500 opacity-0 ${bgColor} ${textColor} z-50 flex items-center`;
            notification.innerHTML = `${icon}<span>${message}</span>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 3000);
        }
        
        // 显示无项目提示
        function displayNoProjects() {
            document.getElementById('projectList').innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                        暂无项目，请创建新项目
                    </td>
                </tr>
            `;
            
            // 更新分页信息
            document.getElementById('pageStart').textContent = '0';
            document.getElementById('pageEnd').textContent = '0';
            document.getElementById('totalRecords').textContent = '0';
            document.getElementById('prevPageBtn').disabled = true;
            document.getElementById('nextPageBtn').disabled = true;
            document.getElementById('pageNumbers').innerHTML = '';
        }
        
        // 模态窗口相关的JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const openModalBtn = document.getElementById('openCreateProjectModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modal = document.getElementById('createProjectModal');
            const modalForm = document.getElementById('modalProjectForm');
            
            // 状态修改模态框元素
            const statusModal = document.getElementById('updateStatusModal');
            const closeStatusModalBtn = document.getElementById('closeStatusModalBtn');
            const statusForm = document.getElementById('updateStatusForm');
            
            // 打开模态窗口
            openModalBtn.addEventListener('click', function() {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // 防止背景滚动
            });
            
            // 关闭模态窗口
            closeModalBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // 恢复背景滚动
            });
            
            // 点击模态窗口外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
            
            // 模态窗口表单提交
            modalForm.addEventListener('submit', async function(e) {
                e.preventDefault(); // 阻止表单默认提交
                
                const projectName = document.getElementById('project_name').value;
                const standardSelection = document.getElementById('standard_selection').value;
                const buildingType = document.getElementById('building_type').value;
                const starRatingTarget = document.getElementById('star_rating_target').value;
                
                // 显示加载中状态
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
                
                try {
                    const response = await fetch('/create_project', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: projectName,
                            standard: standardSelection,
                            building_type: buildingType,
                            star_rating_target: starRatingTarget
                        })
                    });
                    
                    const data = await response.json();
                    
                    // 项目创建成功
                    if (data.id) {
                        // 关闭模态窗口
                        modal.classList.add('hidden');
                        document.body.style.overflow = '';
                        
                        // 显示成功消息
                        showNotification('项目创建成功！正在进入项目...', 'success');
                        
                        // 跳转到项目页面
                        setTimeout(() => {
                            window.location.href = `/project/${data.id}`;
                        }, 1500);
                    } else if (!response.ok) {
                        // HTTP错误
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        showNotification(data.error || `服务器错误: ${response.status}`, 'error');
                    } else {
                        // 其他错误
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        showNotification(data.error || '创建项目失败', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    showNotification('创建项目失败，请稍后重试', 'error');
                }
            });
        });

        // 初始化项目分享和协作者管理模态窗口
        function initShareModal() {
            const modal = document.getElementById('shareProjectModal');
            const closeBtn = document.getElementById('closeShareModalBtn');
            const form = document.getElementById('shareProjectForm');
            const copyBtn = document.getElementById('copyShareLinkBtn');
            
            // 关闭模态窗口
            closeBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            });
            
            // 点击模态窗口外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
            
            // 提交分享表单
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const projectId = document.getElementById('shareProjectId').value;
                const permissions = document.getElementById('sharePermissions').value;
                const expireDays = document.getElementById('shareExpireDays').value;
                
                // 显示加载中状态
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
                
                try {
                    const response = await fetch(`/api/projects/${projectId}/share`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            permissions: permissions,
                            expires_days: parseInt(expireDays)
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // 显示分享链接
                        document.getElementById('shareLink').value = data.share_link;
                        document.getElementById('linkExpireTime').textContent = data.expires_at;
                        document.getElementById('shareResultContainer').classList.remove('hidden');
                        
                        // 刷新已有分享链接列表
                        fetchProjectInvitations(projectId);
                    } else {
                        showNotification(data.error || '生成分享链接失败', 'error');
                    }
                } catch (error) {
                    console.error('生成分享链接失败:', error);
                    showNotification('生成分享链接失败，请稍后重试', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
            
            // 复制分享链接
            copyBtn.addEventListener('click', function() {
                const linkInput = document.getElementById('shareLink');
                linkInput.select();
                document.execCommand('copy');
                
                showNotification('链接已复制到剪贴板', 'success');
            });
        }
        
        // 打开分享模态窗口
        function openShareModal(projectId, projectName) {
            const modal = document.getElementById('shareProjectModal');
            document.getElementById('shareProjectId').value = projectId;
            
            // 隐藏之前的分享结果
            document.getElementById('shareResultContainer').classList.add('hidden');
            
            // 重置表单
            document.getElementById('shareProjectForm').reset();
            
            // 获取已有的分享链接
            fetchProjectInvitations(projectId);
            
            // 显示模态窗口
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
        
        // 打开管理协作者模态窗口
        function openManageCollaboratorsModal(projectId, projectName) {
            const modal = document.getElementById('manageCollaboratorsModal');
            
            // 设置项目ID和名称
            modal.setAttribute('data-project-id', projectId);
            modal.setAttribute('data-project-name', projectName);
            document.getElementById('collaboratorsProjectName').textContent = `项目: ${projectName}`;
            
            // 获取项目协作者信息
            fetchProjectCollaborators(projectId);
            
            // 显示模态窗口
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
        
        // 获取项目邀请链接
        async function fetchProjectInvitations(projectId) {
            const container = document.getElementById('existingInvitations');
            container.innerHTML = '<p class="text-gray-500 text-center py-2">正在加载...</p>';
            
            try {
                const response = await fetch(`/api/projects/${projectId}/invitations`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    if (data.invitations && data.invitations.length > 0) {
                        let html = '';
                        
                        data.invitations.forEach(inv => {
                            html += `
                                <div class="mb-2 p-2 border border-gray-200 rounded-lg bg-white">
                                    <div class="flex justify-between items-start mb-1">
                                        <div>
                                            <span class="text-xs font-medium text-gray-700">权限: 
                                                <span class="font-normal ${getPermissionColor(inv.permissions)}">${inv.permissions}</span>
                                            </span>
                                        </div>
                                        <button class="text-red-500 hover:text-red-700 revoke-invitation-btn" 
                                            data-invitation-id="${inv.id}" 
                                            data-project-id="${projectId}"
                                            title="撤销此链接">
                                            <i class="fas fa-times-circle"></i>
                                        </button>
                                    </div>
                                    <div class="text-xs text-gray-500 flex items-center justify-between">
                                        <span>创建于: ${formatDate(inv.created_at)}</span>
                                        <span>过期于: ${formatDate(inv.expires_at)}</span>
                                    </div>
                                    <div class="mt-1 flex items-center">
                                        <input type="text" value="${inv.share_link}" class="text-xs w-full p-1 border border-gray-300 rounded-l-sm" readonly>
                                        <button class="p-1 bg-primary text-white rounded-r-sm hover:bg-primary/90 copy-link-btn"
                                            data-link="${inv.share_link}">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                        
                        // 添加复制链接按钮事件
                        container.querySelectorAll('.copy-link-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const link = this.getAttribute('data-link');
                                navigator.clipboard.writeText(link).then(() => {
                                    showNotification('链接已复制到剪贴板', 'success');
                                });
                            });
                        });
                        
                        // 添加撤销邀请按钮事件
                        container.querySelectorAll('.revoke-invitation-btn').forEach(btn => {
                            btn.addEventListener('click', async function() {
                                const invitationId = this.getAttribute('data-invitation-id');
                                const projectId = this.getAttribute('data-project-id');
                                
                                if (confirm('确定要撤销此邀请链接吗？')) {
                                    try {
                                        const response = await fetch(`/api/projects/${projectId}/invitations/${invitationId}`, {
                                            method: 'DELETE'
                                        });
                                        
                                        const data = await response.json();
                                        
                                        if (response.ok && data.success) {
                                            showNotification('邀请已撤销', 'success');
                                            fetchProjectInvitations(projectId);
                                        } else {
                                            showNotification(data.error || '撤销邀请失败', 'error');
                                        }
                                    } catch (error) {
                                        console.error('撤销邀请失败:', error);
                                        showNotification('撤销邀请失败，请稍后重试', 'error');
                                    }
                                }
                            });
                        });
                    } else {
                        container.innerHTML = '<p class="text-gray-500 text-center py-2">暂无有效的分享链接</p>';
                    }
                } else {
                    container.innerHTML = `<p class="text-red-500 text-center py-2">${data.error || '获取邀请链接失败'}</p>`;
                }
            } catch (error) {
                console.error('获取项目邀请链接失败:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-2">获取邀请链接失败，请稍后重试</p>';
            }
        }
        
        // 初始化协作者管理模态窗口
        function initManageCollaboratorsModal() {
            const modal = document.getElementById('manageCollaboratorsModal');
            const closeBtn = document.getElementById('closeCollaboratorsModalBtn');
            const closeManageBtn = document.getElementById('closeManageCollaboratorsBtn');
            const refreshBtn = document.getElementById('refreshCollaboratorsBtn');
            const generateShareLinkBtn = document.getElementById('generateShareLinkBtn');
            
            // 关闭模态窗口
            closeBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            });
            
            closeManageBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            });
            
            // 点击模态窗口外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
            });
            
            // 刷新协作者列表
            refreshBtn.addEventListener('click', function() {
                const projectId = modal.getAttribute('data-project-id');
                fetchProjectCollaborators(projectId);
            });
            
            // 生成分享链接
            generateShareLinkBtn.addEventListener('click', function() {
                const projectId = modal.getAttribute('data-project-id');
                const projectName = modal.getAttribute('data-project-name');
                
                // 关闭当前模态窗口
                modal.classList.add('hidden');
                
                // 打开分享模态窗口
                openShareModal(projectId, projectName);
            });
        }
        
        // 获取项目协作者
        async function fetchProjectCollaborators(projectId) {
            const creatorContainer = document.getElementById('projectCreator');
            const collaboratorsContainer = document.getElementById('collaboratorsList');
            
            creatorContainer.innerHTML = '<p class="text-gray-500 text-center py-2">加载中...</p>';
            collaboratorsContainer.innerHTML = '<p class="text-gray-500 text-center py-2">加载中...</p>';
            
            try {
                const response = await fetch(`/api/projects/${projectId}/collaborators`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // 显示项目创建者
                    creatorContainer.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <p class="text-gray-800 font-medium">${data.project.creator.nickname || data.project.creator.email}</p>
                                    <p class="text-xs text-gray-500">创建者 · 管理权限</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 获取普通成员（排除创建者）
                    const collaborators = data.project.collaborators.filter(c => c.role !== '创建者');
                    
                    if (collaborators.length > 0) {
                        let html = '';
                        
                        collaborators.forEach(c => {
                            html += `
                                <div class="mb-3 p-3 border border-gray-200 rounded-lg bg-white">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 mr-3">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div>
                                                <p class="text-gray-800">${c.nickname || c.email}</p>
                                                <p class="text-xs text-gray-500">
                                                    ${c.role} · ${c.permissions} · 
                                                    加入于 ${formatDate(c.joined_at)}
                                                </p>
                                            </div>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="relative mr-2">
                                                <button class="px-2 py-1 text-sm border border-gray-300 rounded-button hover:bg-gray-100 change-permission-btn"
                                                    data-collaborator-id="${c.id}"
                                                    data-project-id="${projectId}"
                                                    data-current-permission="${c.permissions}">
                                                    修改权限
                                                </button>
                                                <div class="hidden permission-dropdown absolute right-0 mt-2 w-36 bg-white border border-gray-200 rounded-lg shadow-lg z-10 py-1">
                                                    <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 permission-option" data-value="只读">只读</button>
                                                    <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 permission-option" data-value="编辑">编辑</button>
                                                    <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 permission-option" data-value="管理">管理</button>
                                                </div>
                                            </div>
                                            <button class="px-2 py-1 text-sm text-red-500 border border-red-200 rounded-button hover:bg-red-50 remove-collaborator-btn"
                                                data-collaborator-id="${c.id}"
                                                data-project-id="${projectId}"
                                                data-email="${c.nickname || c.email}">
                                                移除
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        collaboratorsContainer.innerHTML = html;
                        
                        // 添加权限修改按钮事件
                        collaboratorsContainer.querySelectorAll('.change-permission-btn').forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                                
                                // 关闭所有其他权限下拉菜单
                                document.querySelectorAll('.permission-dropdown:not(.hidden)').forEach(dropdown => {
                                    if (dropdown !== this.nextElementSibling) {
                                        dropdown.classList.add('hidden');
                                    }
                                });
                                
                                // 切换当前下拉菜单
                                const dropdown = this.nextElementSibling;
                                dropdown.classList.toggle('hidden');
                            });
                        });
                        
                        // 添加权限选项点击事件
                        collaboratorsContainer.querySelectorAll('.permission-option').forEach(option => {
                            option.addEventListener('click', async function() {
                                const newPermission = this.getAttribute('data-value');
                                const dropdown = this.closest('.permission-dropdown');
                                const btn = dropdown.previousElementSibling;
                                const collaboratorId = btn.getAttribute('data-collaborator-id');
                                const projectId = btn.getAttribute('data-project-id');
                                const currentPermission = btn.getAttribute('data-current-permission');
                                
                                // 如果权限没有变化，直接关闭下拉菜单
                                if (newPermission === currentPermission) {
                                    dropdown.classList.add('hidden');
                                    return;
                                }
                                
                                // 更新协作者权限
                                try {
                                    const response = await fetch(`/api/projects/${projectId}/collaborators/${collaboratorId}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            permissions: newPermission
                                        })
                                    });
                                    
                                    const data = await response.json();
                                    
                                    if (response.ok && data.success) {
                                        showNotification('协作者权限已更新', 'success');
                                        btn.setAttribute('data-current-permission', newPermission);
                                        
                                        // 更新显示的权限文本
                                        const permissionText = btn.closest('.mb-3').querySelector('.text-xs.text-gray-500');
                                        const textParts = permissionText.textContent.split('·');
                                        permissionText.textContent = `${textParts[0]}· ${newPermission} · ${textParts[2]}`;
                                    } else {
                                        showNotification(data.error || '更新权限失败', 'error');
                                    }
                                } catch (error) {
                                    console.error('更新协作者权限失败:', error);
                                    showNotification('更新权限失败，请稍后重试', 'error');
                                } finally {
                                    dropdown.classList.add('hidden');
                                }
                            });
                        });
                        
                        // 添加移除协作者按钮事件
                        collaboratorsContainer.querySelectorAll('.remove-collaborator-btn').forEach(btn => {
                            btn.addEventListener('click', async function() {
                                const collaboratorId = this.getAttribute('data-collaborator-id');
                                const projectId = this.getAttribute('data-project-id');
                                const email = this.getAttribute('data-email');
                                
                                if (confirm(`确定要移除项目成员 ${email} 吗？`)) {
                                    try {
                                        const response = await fetch(`/api/projects/${projectId}/collaborators/${collaboratorId}`, {
                                            method: 'DELETE'
                                        });
                                        
                                        const data = await response.json();
                                        
                                        if (response.ok && data.success) {
                                            showNotification('项目成员已移除', 'success');
                                            fetchProjectCollaborators(projectId);
                                        } else {
                                            showNotification(data.error || '移除项目成员失败', 'error');
                                        }
                                    } catch (error) {
                                        console.error('移除项目成员失败:', error);
                                        showNotification('移除项目成员失败，请稍后重试', 'error');
                                    }
                                }
                            });
                        });
                        
                        // 点击其他区域关闭权限下拉菜单
                        document.addEventListener('click', function() {
                            document.querySelectorAll('.permission-dropdown').forEach(dropdown => {
                                dropdown.classList.add('hidden');
                            });
                        });
                    } else {
                        collaboratorsContainer.innerHTML = '<p class="text-gray-500 text-center py-2">暂无项目成员</p>';
                    }
                } else {
                    creatorContainer.innerHTML = `<p class="text-red-500 text-center py-2">${data.error || '获取创建者信息失败'}</p>`;
                    collaboratorsContainer.innerHTML = `<p class="text-red-500 text-center py-2">${data.error || '获取协作者列表失败'}</p>`;
                }
            } catch (error) {
                console.error('获取项目协作者失败:', error);
                creatorContainer.innerHTML = '<p class="text-red-500 text-center py-2">获取创建者信息失败，请稍后重试</p>';
                collaboratorsContainer.innerHTML = '<p class="text-red-500 text-center py-2">获取协作者列表失败，请稍后重试</p>';
            }
        }
        
        // 根据权限获取颜色类名
        function getPermissionColor(permission) {
            switch (permission) {
                case '只读':
                    return 'text-blue-500';
                case '编辑':
                    return 'text-green-500';
                case '管理':
                    return 'text-purple-500';
                default:
                    return 'text-gray-500';
            }
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '未知';
            
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 退出项目
        function leaveProject(projectId) {
            fetch(`/api/projects/${projectId}/leave`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 显示成功消息
                    showNotification('已成功退出项目', 'success');
                    
                    // 重新加载项目列表
                    fetchProjects();
                } else {
                    showNotification('退出项目失败: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('退出项目失败:', error);
                showNotification('退出项目失败，请稍后重试', 'error');
            });
        }
    </script>
</body>
</html>