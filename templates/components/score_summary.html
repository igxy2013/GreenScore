<!-- 评分汇总组件 -->
<style>
    .star-icon {
        font-size: 1.5rem;
        margin: 0 2px;
        vertical-align: middle;
        display: inline-block;
        line-height: 1;
    }
    .score-summary-container {
        margin-bottom: 1.5rem;
    }
    .score-table th, .score-table td {
        padding: 0.75rem 1.5rem;
    }
    
    /* 确保星级图标左对齐 */
    #star-rating-stars-cell {
        vertical-align: middle !important;
        text-align: left !important;
    }
    
    #star-rating-stars {
        display: inline-flex !important;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
    }
</style>

<input type="hidden" id="current-project-standard" value="{{ project.standard if project and project.standard else '成都市标' }}">
<input type="hidden" id="current_project_name" value="{{ project.name if project else '' }}">
<input type="hidden" id="project_id" value="{{ project.id if project else '21' }}">

<div class="container mx-auto p-4">
    <!-- 各专业得分汇总 -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center">
                <h3 class="text-lg font-medium mr-4">各专业得分汇总</h3>
                <div id="debug-info" class="text-sm text-gray-500"></div>
            </div>
        </div>

        <div class="overflow-x-auto score-summary-container">
            <table class="w-full">
                <thead>
                    <tr class="bg-blue-500 text-white">
                        <th class="px-6 py-3 text-center">专业</th>
                        <th class="px-6 py-3 text-center">建筑专业</th>
                        <th class="px-6 py-3 text-center">结构专业</th>
                        <th class="px-6 py-3 text-center">给排水专业</th>
                        <th class="px-6 py-3 text-center">电气专业</th>
                        <th class="px-6 py-3 text-center">暖通专业</th>
                        <th class="px-6 py-3 text-center">景观专业</th>
                        <th class="px-6 py-3 text-center" id="env_health_energy_header">环境健康与节能专业</th>
                        <th class="px-6 py-3 text-center">合计</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 专业得分行 -->
                    <tr id="specialty-scores-row" class="border-b text-center">
                        <td class="px-6 py-4">得分</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4" id="env_health_energy_column">0.0</td>
                        <td class="px-6 py-4 font-bold total-score">0.0</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 各分类得分汇总 -->
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h3 class="text-lg font-medium mb-4">各分类得分汇总</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-blue-500 text-white">
                        <th class="px-6 py-3 text-center">分类</th>
                        <th class="px-6 py-3 text-center">安全耐久</th>
                        <th class="px-6 py-3 text-center">健康舒适</th>
                        <th class="px-6 py-3 text-center">生活便利</th>
                        <th class="px-6 py-3 text-center">资源节约</th>
                        <th class="px-6 py-3 text-center">环境宜居</th>
                        <th class="px-6 py-3 text-center">提高与创新</th>
                        <th class="px-6 py-3 text-center">合计</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 分类得分行 - 将由JavaScript动态更新 -->
                    <tr id="category-scores-row" class="border-b text-center">
                        <td class="px-6 py-4">得分</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4 font-bold">0.0</td>
                    </tr>
                    <!-- 最低分值行 - 将由JavaScript动态更新 -->
                    <tr>
                        <td class="px-6 py-4">最低分值</td>
                        <td class="px-6 py-4">30.0</td>
                        <td class="px-6 py-4">30.0</td>
                        <td class="px-6 py-4">21.0</td>
                        <td class="px-6 py-4">60.0</td>
                        <td class="px-6 py-4">30.0</td>
                        <td class="px-6 py-4">0.0</td>
                        <td class="px-6 py-4 font-bold">171</td>
                    </tr>
                    <!-- 达标判断行 - 将由JavaScript动态更新 -->
                    <tr>
                        <td class="px-6 py-4">达标判断</td>
                        <td class="px-6 py-4">-</td>
                        <td class="px-6 py-4">-</td>
                        <td class="px-6 py-4">-</td>
                        <td class="px-6 py-4">-</td>
                        <td class="px-6 py-4">-</td>
                        <td class="px-6 py-4">-</td>
                        <td class="px-6 py-4 font-bold">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 星级判定表格 -->
    <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
        <h3 class="text-lg font-normal mb-4">绿色建筑星级评定</h3>
        <div class="overflow-auto">
            <table class="w-full score-table">
                <thead>
                    <tr>
                        <th class="px-6 py-4 text-base font-normal text-left bg-blue-500 text-white align-middle">项目名称</th>
                        <th class="px-6 py-4 text-base font-normal text-left bg-blue-500 text-white align-middle">总得分</th>
                        <th class="px-6 py-4 text-base font-normal text-left bg-blue-500 text-white align-middle">星级评定</th>
                        <th class="px-6 py-4 text-base font-normal text-left bg-blue-500 text-white align-middle">评定结果</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="star-rating-row" class="star-rating-row">
                        <td class="px-6 py-4 text-base text-left align-middle">{{ project.name if project else '未设置项目名称' }}</td>
                        <td class="px-6 py-4 text-base text-left align-middle" id="star-rating-score">0.0</td>
                        <td class="px-6 py-4 text-base text-left align-middle" id="star-rating-stars-cell">
                            <span id="star-rating-stars" class="text-2xl inline-flex items-center justify-start"></span>
                        </td>
                        <td class="px-6 py-4 text-base text-left align-middle" id="star-rating-total">-</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- 添加保存星级案例按钮，仅管理员可见 -->
            {% if session.get('role') == 'admin' %}
            <div class="mt-6 flex justify-center">
                <button id="saveStarCaseBtn" class="px-6 py-3 bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    <i class="ri-save-line mr-2"></i>保存星级案例
                </button>
            </div>
            {% endif %}
        </div>
        
        <!-- 星级标准说明 -->
        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
            <h4 class="font-bold mb-2">星级评定标准说明：</h4>
            <ul class="list-disc pl-5 space-y-2">
                <li><span class="inline-block px-3 py-1 rounded-full bg-green-100 text-green-800 font-medium">三星级</span>：总得分 ≥ 450分 且 <span class="font-medium">所有分类均达标</span></li>
                <li><span class="inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-800 font-medium">二星级</span>：总得分 ≥ 300分 且 <span class="font-medium">所有分类均达标</span></li>
                <li><span class="inline-block px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 font-medium">一星级</span>：总得分 ≥ 200分 且 <span class="font-medium">所有分类均达标</span></li>
                <li><span class="inline-block px-3 py-1 rounded-full bg-red-100 text-red-600 font-medium">未达标</span>：总得分 < 200分 或 <span class="text-red-600">任一分类未达标</span></li>
            </ul>
        </div>
    </div>
</div>

<!-- 评分汇总相关的JavaScript -->
<script defer>
    // 在页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('评分汇总页面加载完成');
        const projectId = document.getElementById('project_id').value;
        if (document.getElementById('debug-info')) {
            document.getElementById('debug-info').textContent = ``;
        }
        console.log('当前项目ID:', projectId);
        
        // 初始化后，尝试主动获取数据
        try {
            // 检查全局函数是否存在
            if (typeof window.fetchScoreSummary === 'function') {
                console.log('使用全局fetchScoreSummary函数获取数据');
                window.fetchScoreSummary(true).then(data => {
                    if (data) {
                        console.log('成功获取评分数据');
                    }
                }).catch(err => {
                    console.error('获取数据失败，尝试直接加载:', err);
                    loadDataDirectly(projectId);
                });
            } else {
                console.log('全局函数不存在，使用组件内部函数获取数据');
                loadDataDirectly(projectId);
            }
        } catch (e) {
            console.error('初始化获取数据失败:', e);
            loadDataDirectly(projectId);
        }
    });
    
    // 直接获取数据的函数
    function loadDataDirectly(projectId) {
        console.log('直接获取评分数据，项目ID:', projectId);
        fetch(`/api/get_score_summary?project_id=${projectId}&force_refresh=true`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`获取评分数据失败: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('直接获取评分数据成功:', data);
                // 更新页面
                updateComponentScores(data);
            })
            .catch(error => {
                console.error('直接获取评分数据失败:', error);
                if (document.getElementById('debug-info')) {
                    document.getElementById('debug-info').textContent = `错误: ${error.message}`;
                }
            });
    }
    
    function updateStarRating() {
        try {
            // 获取总分
            const totalScoreElement = document.getElementById('specialty-scores-row');
            if (!totalScoreElement) {
                console.warn('specialty-scores-row元素不存在');
                return;
            }
            
            const totalScoreCell = totalScoreElement.querySelector('.total-score');
            if (!totalScoreCell) {
                console.warn('total-score元素不存在');
                return;
            }
            
            const totalScore = parseFloat(totalScoreCell.textContent) || 0;
            
            // 获取星级评定元素
            const starRatingScore = document.getElementById('star-rating-score');
            const starRatingStars = document.getElementById('star-rating-stars');
            const starRatingTotal = document.getElementById('star-rating-total');
            
            if (!starRatingScore || !starRatingStars || !starRatingTotal) {
                console.warn('星级评定元素不存在');
                return;
            }
            
            // 更新总分显示
            starRatingScore.textContent = totalScore.toFixed(1);
            
            // 判断是否所有分类都达标
            const judgmentRow = document.querySelector('tbody tr:nth-child(3)');
            let allCategoriesAchieved = true;
            
            if (judgmentRow) {
                for (let i = 1; i <= 6; i++) { // 检查6个分类
                    if (judgmentRow.cells[i] && judgmentRow.cells[i].textContent === '未达标') {
                        allCategoriesAchieved = false;
                        break;
                    }
                }
            }
            
            // 根据总分和达标情况确定星级
            let stars = 0;
            let starRatingText = '未达标';
            
            if (allCategoriesAchieved) {
                if (totalScore >= 450) {
                    stars = 3;
                    starRatingText = '三星级';
                } else if (totalScore >= 300) {
                    stars = 2;
                    starRatingText = '二星级';
                } else if (totalScore >= 200) {
                    stars = 1;
                    starRatingText = '一星级';
                }
            }
            
            // 更新星级显示
            starRatingStars.innerHTML = '';
            for (let i = 0; i < stars; i++) {
                const starIcon = document.createElement('i');
                starIcon.className = 'fas fa-star star-icon text-yellow-500';
                starRatingStars.appendChild(starIcon);
            }
            
            // 更新评定结果
            starRatingTotal.textContent = starRatingText;
            starRatingTotal.className = 'px-6 py-4 text-base text-left align-middle';
            
            // 根据星级设置评定结果的颜色
            if (stars === 3) {
                starRatingTotal.classList.add('text-green-600', 'font-bold');
            } else if (stars === 2) {
                starRatingTotal.classList.add('text-blue-600', 'font-bold');
            } else if (stars === 1) {
                starRatingTotal.classList.add('text-yellow-600', 'font-bold');
            } else {
                starRatingTotal.classList.add('text-red-600');
            }
            
            console.log('星级评定更新完成:', {stars, starRatingText, totalScore, allCategoriesAchieved});
        } catch (error) {
            console.error('更新星级评定时出错:', error);
        }
    }
    
    // 组件内部的更新函数，重命名以避免冲突
    function updateComponentScores(data) {
        try {
            // 更新调试信息
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.textContent = `数据已更新 - ${new Date().toLocaleTimeString()}`;
            }
            
            // 检查数据是否有效
            if (!data || !data.specialty_scores) {
                console.warn('评分数据无效:', data);
                return;
            }
            
            // 提取专业得分和专业分类得分
            const specialtyScores = data.specialty_scores || {};
            const specialtyScoresByCategory = data.specialty_scores_by_category || {};
            const totalScore = data.total_score || 0;
            
            // 显示或隐藏环境健康与节能专业列
            const projectStandardEl = document.getElementById('current-project-standard');
            const projectStandard = projectStandardEl ? projectStandardEl.value : '成都市标';
            
            const envHealthEnergyHeader = document.getElementById('env_health_energy_header');
            const envHealthEnergyColumn = document.getElementById('env_health_energy_column');
            const showEnvHealthEnergy = projectStandard === '四川省标';
            
            if (envHealthEnergyHeader) {
                envHealthEnergyHeader.style.display = showEnvHealthEnergy ? '' : 'none';
            }
            if (envHealthEnergyColumn) {
                envHealthEnergyColumn.style.display = showEnvHealthEnergy ? '' : 'none';
            }
            
            // 更新专业得分行
            const specialtyScoresRow = document.getElementById('specialty-scores-row');
            if (specialtyScoresRow) {
                if (specialtyScoresRow.cells[1]) specialtyScoresRow.cells[1].textContent = (specialtyScores['建筑专业'] || 0).toFixed(1);
                if (specialtyScoresRow.cells[2]) specialtyScoresRow.cells[2].textContent = (specialtyScores['结构专业'] || 0).toFixed(1);
                if (specialtyScoresRow.cells[3]) specialtyScoresRow.cells[3].textContent = (specialtyScores['给排水专业'] || 0).toFixed(1);
                if (specialtyScoresRow.cells[4]) specialtyScoresRow.cells[4].textContent = (specialtyScores['电气专业'] || 0).toFixed(1);
                if (specialtyScoresRow.cells[5]) specialtyScoresRow.cells[5].textContent = (specialtyScores['暖通专业'] || 0).toFixed(1);
                if (specialtyScoresRow.cells[6]) specialtyScoresRow.cells[6].textContent = (specialtyScores['景观专业'] || 0).toFixed(1);
                
                if (showEnvHealthEnergy && specialtyScoresRow.cells[7]) {
                    specialtyScoresRow.cells[7].textContent = (specialtyScores['环境健康与节能专业'] || 0).toFixed(1);
                }
                
                // 更新总分
                const totalScoreEl = specialtyScoresRow.querySelector('.total-score');
                if (totalScoreEl) {
                    totalScoreEl.textContent = totalScore.toFixed(1);
                }
            }
            
            // 计算各分类得分
            const categoryScores = {
                '安全耐久': 0,
                '健康舒适': 0,
                '生活便利': 0,
                '资源节约': 0,
                '环境宜居': 0,
                '提高与创新': 0
            };
            
            // 处理各分类得分
            Object.values(specialtyScoresByCategory).forEach(specialtyData => {
                for (const category in categoryScores) {
                    if (specialtyData[category] !== undefined) {
                        categoryScores[category] += parseFloat(specialtyData[category]) || 0;
                    }
                }
            });
            
            // 更新分类得分行
            const categoryScoresRow = document.getElementById('category-scores-row');
            if (categoryScoresRow) {
                // 更新各分类得分
                for (let i = 0; i < Object.keys(categoryScores).length; i++) {
                    const category = Object.keys(categoryScores)[i];
                    if (categoryScoresRow.cells[i+1]) {
                        categoryScoresRow.cells[i+1].textContent = categoryScores[category].toFixed(1);
                    }
                }
                
                // 更新总分
                if (categoryScoresRow.cells[7]) {
                    categoryScoresRow.cells[7].textContent = totalScore.toFixed(1);
                }
            }
            
            // 更新判断行
            const judgmentRow = document.querySelector('tbody tr:nth-child(3)');
            if (judgmentRow) {
                const minScores = {
                    '安全耐久': 30.0,
                    '健康舒适': 30.0,
                    '生活便利': 21.0,
                    '资源节约': 60.0,
                    '环境宜居': 30.0,
                    '提高与创新': 0.0
                };
                
                // 更新各分类达标判断
                let allAchieved = true;
                for (let i = 0; i < Object.keys(categoryScores).length; i++) {
                    const category = Object.keys(categoryScores)[i];
                    const isAchieved = categoryScores[category] >= minScores[category];
                    
                    if (judgmentRow.cells[i+1]) {
                        judgmentRow.cells[i+1].textContent = isAchieved ? '达标' : '未达标';
                        judgmentRow.cells[i+1].style.color = isAchieved ? '#10b981' : '#ef4444';
                    }
                    
                    if (!isAchieved) allAchieved = false;
                }
                
                // 更新总体达标判断
                if (judgmentRow.cells[7]) {
                    judgmentRow.cells[7].textContent = allAchieved ? '达标' : '未达标';
                    judgmentRow.cells[7].style.color = allAchieved ? '#10b981' : '#ef4444';
                }
            }
            
            // 更新星级评定
            setTimeout(updateStarRating, 100);
        } catch (error) {
            console.error('更新评分汇总表格时出错:', error);
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.textContent = `错误: ${error.message}`;
            }
        }
    }
    
    // 覆盖全局函数以确保兼容性
    window.updateScoreSummaryTables = updateComponentScores;
    
    // 保存星级案例按钮的事件处理
    document.addEventListener('DOMContentLoaded', function() {
        const saveStarCaseBtn = document.getElementById('saveStarCaseBtn');
        if (saveStarCaseBtn) {
            saveStarCaseBtn.addEventListener('click', function() {
                const projectId = document.getElementById('project_id').value;
                console.log('执行保存星级案例，项目ID:', projectId);
                
                fetch('/api/save_star_case', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ project_id: projectId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('保存成功');
                    } else {
                        alert(data.message || '保存失败');
                    }
                })
                .catch(error => {
                    console.error('保存星级案例时出错:', error);
                    alert('保存失败，请重试');
                });
            });
        }
    });
</script>
