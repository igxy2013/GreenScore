<!-- 标准列表内容 -->
<!-- 添加隐藏的项目ID字段 -->
<input type="hidden" id="project_id" name="project_id" value="{{ project.id if project else '' }}">
<input type="hidden" id="current-project-id" name="current-project-id" value="{{ project.id if project else '' }}">

<!-- 添加图片相关样式 -->
<style>
    .standard-image-container {
        margin-top: 8px;
    }
    .standard-image {
        max-width: 50%;
        max-height: 150px;
        object-fit: contain;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .standard-image:hover {
        transform: scale(1.02);
    }
</style>

{% if current_level == '提高级' %}
<!-- 在提高级页面加载浮动徽章组件 -->
{% include 'components/floating_badge.html' %}
{% endif %}
<!-- 在页面添加悬浮保存按钮 -->
<div class="fixed bottom-8 right-8 z-50" id="floatingSaveBtn">
    <button class="bg-primary text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-primary-dark transition-colors" title="保存评分信息">
        <i class="ri-save-3-line text-xl"></i>
    </button>
</div>


<div class="overflow-x-auto">
    {% if standards %}
    
    {% if current_level == '提高级' %}
    <!-- 提高级分类过滤器 -->
    <div class="mb-4 p-4 bg-gray-50 rounded-lg shadow-sm">
        <div class="flex flex-wrap items-center gap-2">
            <!-- AI Extract Button -->
            <button id="aiExtractBtn" class="ai-extract-btn flex items-center bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 text-white px-3 py-3 rounded-lg shadow-lg transform hover:scale-105 transition-all hover:shadow-[0_0_15px_rgba(139,92,246,0.5)] group">
                <i class="ri-magic-line"></i> AI提取报告得分
            </button>
            <span class="font-medium">分类过滤:</span>
            <div class="flex flex-wrap gap-1">
                <button id="filter-all" class="px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium category-filter active">全部</button>
                <button id="filter-安全耐久" data-category="安全耐久" class="px-3 py-1 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm font-medium category-filter">安全耐久</button>
                <button id="filter-健康舒适" data-category="健康舒适" class="px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-800 text-sm font-medium category-filter">健康舒适</button>
                <button id="filter-生活便利" data-category="生活便利" class="px-3 py-1 rounded-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 text-sm font-medium category-filter">生活便利</button>
                <button id="filter-资源节约" data-category="资源节约" class="px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-800 text-sm font-medium category-filter">资源节约</button>
                <button id="filter-环境宜居" data-category="环境宜居" class="px-3 py-1 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 text-sm font-medium category-filter">环境宜居</button>
                <button id="filter-提高与创新" data-category="提高与创新" class="px-3 py-1 rounded-full bg-purple-100 hover:bg-purple-200 text-purple-800 text-sm font-medium category-filter">提高与创新</button>
            </div>

            <!-- Hidden File Input -->
            <input type="file" id="aiFileUploader" multiple accept=".doc,.docx,.pdf" style="display: none;">
             <!-- Loading Indicator -->
             <div id="aiLoadingIndicator" class="ml-2 hidden">
                 <svg class="animate-spin h-5 w-5 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                 </svg>
             </div>
        </div>
    </div>
    {% endif %}
    
    <table class="min-w-full divide-y divide-gray-200 table-fixed">
        <thead class="bg-primary">
            <tr>
                {% if current_level == '基本级' %}
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">条文号</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-30">条文内容</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分值</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">是否达标</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap technical-measures-cell">技术措施</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">审查材料</th>
                {% elif current_level == '提高级' %}
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">条文号</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分类</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-30">条文内容</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分值</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">得分</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap technical-measures-cell">技术措施</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">审查材料</th>
                {% else %}
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">条文号</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">分类</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">条文内容</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">分值</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">审查材料</th>
                {% endif %}
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for standard in standards %}
            <tr class="table-row-hover">
                <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">{{ standard.条文号 }}</td>
                {% if current_level == '提高级' %}
                <td class="px-6 py-4 whitespace-normal h-16 text-base text-gray-700">
                    <span class="category-tag category-{{ standard.分类 }}">{{ standard.分类 }}</span>
                </td>
                {% endif %}
                <td class="px-6 py-4 text-base text-gray-700">
                    {% if standard.图片路径 %}
                    <div class="mb-2">{{ standard.条文内容 }}</div>
                    <div class="standard-image-container">
                        <img src="{{ standard.图片路径 }}" alt="条文图片" class="standard-image max-w-full h-auto rounded border border-gray-200 hover:border-primary transition-colors cursor-pointer" onclick="showImageModal(this.src)">
                    </div>
                    {% else %}
                    {{ standard.条文内容 }}
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">{{ standard.分值 }}</td>
                
                {% if current_level == '基本级' %}
                <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">
                    <select name="is_achieved" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary is-achieved-select" title="符合性判断">
                        <option value="是">是</option>
                        <option value="否">否</option>
                        <option value="不参评">不参评</option>
                    </select>
                </td>
                <td class="px-6 py-4 text-base text-gray-700">
                    <textarea name="technical_measures" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary technical-measures" placeholder="请输入技术措施"></textarea>
                </td>
                <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                {% elif current_level == '提高级' %}
                <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">
                    {% if standard.分值 == '—' %}
                    <input type="text" name="score" data-clause="{{ standard.条文号 }}" data-maxscore="0" value="—" class="w-full rounded bg-gray-100 text-gray-500 cursor-not-allowed" disabled readonly>
                    {% else %}
                    <input type="number" name="score" data-clause="{{ standard.条文号 }}" data-maxscore="{{ standard.分值 }}" 
                           class="w-full rounded focus:border-primary score-input" 
                           placeholder="得分"
                           min="0"
                           max="{{ standard.分值 }}"
                           oninput="validateScore(this)">
                    {% endif %}
                </td>
                <td class="px-6 py-4 text-base text-gray-700 technical-measures-cell">
                    <textarea name="technical_measures" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary technical-measures" placeholder="请输入技术措施"></textarea>
                </td>
                <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                {% else %}
                <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 添加保存按钮 -->
    <div class="mt-8 flex justify-center">
        <button type="button" id="saveScoreBtn" class="px-6 py-3 bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
            保存评分信息
        </button>
    </div>

    <!-- 评分统计表格 -->
    {% if current_level == '提高级' %}
    <!-- 这里可以添加提高级评分统计表格的内容 -->
    {% endif %}
    {% else %}
    <div class="text-center py-10">
        <p class="text-gray-500 text-xl">没有找到符合条件的记录</p>
        <p class="text-gray-400 text-lg mt-2">请尝试其他筛选条件</p>
    </div>
    {% endif %}
</div>

<!-- AI Score Extraction Upload Modal (New) -->
<div id="aiScoreUploadModal" class="fixed inset-0 z-[100] hidden overflow-auto bg-black bg-opacity-75 flex items-center justify-center p-4 dashboard-modal-backdrop">
    <div class="relative bg-gray-900 rounded-lg shadow-xl max-w-md w-full mx-auto dashboard-modal-content">
        <!-- Modal Header -->
        <div class="p-4 flex justify-between items-center border-b border-gray-700">
            <h3 class="text-xl font-bold text-white">AI提取报告得分</h3>
            <button type="button" class="text-purple-300 hover:text-purple-100 p-1 rounded-full hover:bg-purple-900 transition-all" onclick="closeAiUploadModal()" title="关闭">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Modal Body -->
        <div class="p-4">
            <!-- Word/PDF Upload Area -->
            <div id="fileUploadTab" class="mb-4">
                 <p class="text-sm text-gray-400 mb-3">请上传包含评分信息的报告文件（支持 .doc, .docx, .pdf 格式）。</p>
                <label for="aiScoreFileInput" class="block cursor-pointer">
                    <div id="fileDropArea" class="text-center py-6 border-2 border-dashed border-purple-500 rounded-lg hover:border-purple-300 transition-all bg-gray-800 file-upload-area">
                        <i class="ri-upload-cloud-2-line text-purple-400 text-4xl mb-2"></i>
                        <p class="text-gray-300 mb-1">点击或拖放文件到此处</p>
                        <p class="text-gray-400 text-sm">支持 .doc, .docx, .pdf</p>
                    </div>
                </label>
                <input type="file" id="aiScoreFileInput" multiple accept=".doc,.docx,.pdf" class="hidden">
                <div id="selectedFilesInfo" class="mt-3 text-sm text-gray-400 text-center">尚未选择文件</div>
            </div>

             <!-- Loading Indicator within Modal -->
             <div id="aiUploadLoadingIndicator" class="mb-4 hidden">
                 <div class="flex items-center justify-center p-4 bg-gray-800 rounded-md">
                     <i class="ri-loader-4-line animate-spin text-purple-400 text-2xl mr-3"></i>
                     <span class="text-gray-300">正在上传和提取，请稍候...</span>
                 </div>
             </div>
        </div>
        <!-- Modal Footer -->
        <div class="p-4 flex justify-end items-center border-t border-gray-700 space-x-3">
            <button type="button" id="aiUploadCancelBtn" class="px-4 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700 transition-all">取消</button>
            <button type="button" id="startAiExtractionBtn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all font-bold extract-button">
                开始提取得分
            </button>
        </div>
    </div>
</div>

<!-- AI Score Extraction Preview Modal -->
<div id="aiScorePreviewModal" class="fixed inset-0 z-[100] hidden overflow-auto bg-black bg-opacity-75 flex items-center justify-center p-4 dashboard-modal-backdrop">
    <div class="relative bg-gray-900 rounded-lg shadow-xl max-w-md w-full mx-auto dashboard-modal-content">
        <!-- Modal Header -->
        <div class="p-4 flex justify-between items-center border-b border-gray-700">
            <h3 class="text-xl font-bold text-white">AI提取结果预览</h3>
            <button type="button" class="text-purple-300 hover:text-purple-100 p-1 rounded-full hover:bg-purple-900 transition-all" onclick="closeAiPreviewModal()" title="关闭">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Modal Body -->
        <div class="p-4 max-h-[60vh] overflow-y-auto">
            <p class="text-sm text-gray-400 mb-3">请检查提取的得分，确认无误后点击"应用到项目"。</p>
            <div id="aiScorePreviewContent">
                <p class="text-gray-500">正在加载预览...</p>
            </div>
        </div>
        <!-- Modal Footer -->
        <div class="p-4 flex justify-end items-center border-t border-gray-700 space-x-3">
             <span id="aiPreviewSummary" class="text-sm text-gray-400 mr-auto"></span>
            <button type="button" class="px-4 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700 transition-all" onclick="closeAiPreviewModal()">取消</button>
            <button type="button" id="applyAiScoresBtn" class="px-4 py-2 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg hover:from-green-700 hover:to-teal-700 transition-all font-bold">
                应用到项目
            </button>
        </div>
    </div>
</div>

<!-- 图片模态框 -->
<div id="imageModal" class="fixed inset-0 z-50 hidden overflow-auto bg-black bg-opacity-75 flex items-center justify-center p-4">
    <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full mx-auto">
        <div class="p-2 flex justify-between items-center border-b">
            <h3 class="text-lg font-medium text-gray-900">图片预览</h3>
            <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeImageModal()" title="关闭">
                <i class="ri-close-line text-xl"></i>
            </button>
        </div>
        <div class="p-4 flex justify-center">
            <img id="modalImage" src="" alt="放大图片" class="max-w-full max-h-[80vh]">
        </div>
    </div>
</div>

<!-- 添加标准表格相关的JavaScript -->
<script>
    // 定义权限控制变量
    let hasEditPermission = true; // 默认为可编辑
    let userPermissions = null;
    let selectedAiFiles = null; // 存储从新模态框选择的文件

    // --- Moved Functions Outside DOMContentLoaded --- // --- 将函数移至 DOMContentLoaded 外部 ---
    function showAiUploadModal() {
        const modal = document.getElementById('aiScoreUploadModal');
        if (modal) {
            // Reset file input and selection info // 重置文件输入和选择信息
            const fileInput = document.getElementById('aiScoreFileInput');
            if(fileInput) fileInput.value = null;
            selectedAiFiles = null;
            updateSelectedFilesInfo();
            // Hide loading indicator if it was somehow visible // 隐藏加载指示器（如果它不知何故可见）
            const loadingIndicator = document.getElementById('aiUploadLoadingIndicator');
            if(loadingIndicator) loadingIndicator.classList.add('hidden');

            modal.classList.remove('hidden');
            modal.classList.add('show'); // 添加 .show 类
            document.body.classList.add('overflow-hidden');
            // Add ESC key listener for upload modal // 为上传模态框添加 ESC 键监听器
            document.addEventListener('keydown', handleEscKeyForUploadModal);
        }
    }

    function closeAiUploadModal() {
        //--> 添加日志确认函数被调用 <--
        // console.log('closeAiUploadModal 函数被调用');
        const modal = document.getElementById('aiScoreUploadModal');
        if (modal) {
            // console.log('找到模态框，添加 hidden 类并移除 show 类'); // <-- 确认找到模态框
            modal.classList.add('hidden');
            modal.classList.remove('show'); // 移除 .show 类
        } else {
           console.error('未找到上传模态框！'); // <-- 如果没找到模态框
        }
        document.body.classList.remove('overflow-hidden');
         // Ensure loading indicators are hidden on close // 确保关闭时隐藏加载指示器
         const uploadLoading = document.getElementById('aiUploadLoadingIndicator');
         if(uploadLoading) uploadLoading.classList.add('hidden');
         const globalLoading = document.getElementById('aiLoadingIndicator'); // Also hide the global one // 同时隐藏全局的那个
         if(globalLoading) globalLoading.classList.add('hidden');
         const extractBtn = document.getElementById('aiExtractBtn'); // Re-enable main button // 重新启用主按钮
         if(extractBtn) extractBtn.disabled = false;
         // Remove ESC key listener for upload modal // 移除上传模态框的 ESC 键监听器
         document.removeEventListener('keydown', handleEscKeyForUploadModal);
    }

    // Function to handle ESC key for the upload modal // 处理上传模态框 ESC 键的函数
    function handleEscKeyForUploadModal(event) {
        if (event.key === 'Escape') {
            closeAiUploadModal();
        }
    }

    function updateSelectedFilesInfo() {
        const infoDiv = document.getElementById('selectedFilesInfo');
        if (!infoDiv) return;
        if (selectedAiFiles && selectedAiFiles.length > 0) {
            let fileNames = Array.from(selectedAiFiles).map(f => f.name).join(', ');
             if (fileNames.length > 100) { // Truncate if too long // 如果太长则截断
                 fileNames = fileNames.substring(0, 97) + '...';
             }
            infoDiv.textContent = `已选择 ${selectedAiFiles.length} 个文件: ${fileNames}`;
            infoDiv.classList.remove('text-red-500');
        } else {
            infoDiv.textContent = '尚未选择文件。';
        }
    }

     function handleFileSelection(files) {
         // Check file types // 检查文件类型
         const allowedTypes = ['.doc', '.docx', '.pdf'];
         const invalidFiles = [];
         for (let file of files) {
             const extension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
             if (!allowedTypes.includes(extension)) {
                 invalidFiles.push(file.name);
             }
         }

         if (invalidFiles.length > 0) {
             const msg = `包含不支持的文件类型: ${invalidFiles.join(', ')}. 只允许 ${allowedTypes.join(', ')}`;
             // 修改：使用 Toastify
             if (typeof Toastify === 'function') {
                 Toastify({
                     text: msg,
                     duration: 3000,
                     gravity: 'top',
                     position: 'right',
                     style: {
                         background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                     }
                 }).showToast();
             } else {
                 alert(msg);
             }
             selectedAiFiles = null; // Reject the selection // 拒绝选择
              // Clear the file input visually if possible (might not work reliably cross-browser) // 尝试在视觉上清除文件输入（可能无法跨浏览器可靠工作）
              const fileInput = document.getElementById('aiScoreFileInput');
              if(fileInput) fileInput.value = null;
         } else {
            selectedAiFiles = files; // Accept the selection // 接受选择
         }
          updateSelectedFilesInfo();
     }

    // Function to close the AI preview modal // 关闭 AI 预览模态框的函数
    window.closeAiPreviewModal = function() {
        const modal = document.getElementById('aiScorePreviewModal'); // Find the preview modal // 查找预览模态框
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('show'); // Remove .show class // 移除 .show 类
        }
        document.body.classList.remove('overflow-hidden');
        // Remove ESC key listener for preview modal // 移除预览模态框的 ESC 键监听器
        document.removeEventListener('keydown', handleEscKeyForPreviewModal);
    }

    // Function to handle ESC key for the preview modal (Keep global for now or move if needed) // 处理预览模态框 ESC 键的函数（暂时保持全局或根据需要移动）
    function handleEscKeyForPreviewModal(event) {
        if (event.key === 'Escape') {
            closeAiPreviewModal();
        }
    }

    // Refactored function to handle the actual extraction API call // 重构的函数，用于处理实际的提取 API 调用
    async function triggerAiScoreExtraction(files) {
        // console.log('triggerAiScoreExtraction 函数被调用'); // 添加日志
        // --- Add Permission Check --- // --- 添加权限检查 ---
        if (!hasEditPermission) {
            // 修改：使用 Toastify
            if (typeof Toastify === 'function') {
                Toastify({
                    text: '您没有编辑权限，无法执行此操作',
                    duration: 3000,
                    gravity: 'top',
                    position: 'right',
                    style: {
                        background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                    }
                }).showToast();
            } else {
                alert('您没有编辑权限，无法执行此操作');
            }
            closeAiUploadModal(); // Close the modal if no permission // 如果没有权限则关闭模态框
            return;
        }
        // --- End Permission Check --- // --- 结束权限检查 ---

        if (!files || files.length === 0) {
            return; // Should be checked before calling, but double-check // 调用前应检查，但再次确认
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]); // Backend expects 'files' key // 后端期望 'files' 键
        }

        // Show loading indicator (inside the upload modal) & Disable button // 显示加载指示器（上传模态框内）并禁用按钮
        const uploadLoadingIndicator = document.getElementById('aiUploadLoadingIndicator');
        const startExtractionBtn = document.getElementById('startAiExtractionBtn'); // Need this reference here too // 这里也需要这个引用
        const aiExtractBtn = document.getElementById('aiExtractBtn'); // And this one // 还有这个

        if(uploadLoadingIndicator) uploadLoadingIndicator.classList.remove('hidden');
        if(startExtractionBtn) startExtractionBtn.disabled = true;
        if(aiExtractBtn) aiExtractBtn.disabled = true;


        try {
            const response = await fetch('/api/extract_scores_from_files', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            // Close the upload modal BEFORE showing results/errors // 在显示结果/错误之前关闭上传模态框
            closeAiUploadModal();

            if (data.success && data.scores) {
                extractedScoresData = data.scores; // Store data // 存储数据
                displayAiScorePreview(extractedScoresData);
                const aiScorePreviewModal = document.getElementById('aiScorePreviewModal'); // Need reference // 需要引用
                if (aiScorePreviewModal) {
                    aiScorePreviewModal.classList.remove('hidden');
                    aiScorePreviewModal.classList.add('show'); // Add .show class // 添加 .show 类
                }
                document.body.classList.add('overflow-hidden'); // Add overflow hidden for preview modal // 为预览模态框添加 overflow hidden
                // Add ESC key listener for preview modal // 为预览模态框添加 ESC 键监听器
                document.addEventListener('keydown', handleEscKeyForPreviewModal);
                // 修改：使用 Toastify
                if (typeof Toastify === 'function') {
                    Toastify({
                        text: `成功提取 ${extractedScoresData.length} 条得分记录`,
                        duration: 3000,
                        gravity: 'top',
                        position: 'right',
                        style: {
                            background: 'linear-gradient(to right, #00b09b, #96c93d)'
                        }
                    }).showToast();
                }

            } else {
                console.error('AI提取失败:', data.error);
                const msg = `AI提取失败: ${data.error || '未知错误'}`;
                // 修改：使用 Toastify
                if (typeof Toastify === 'function') {
                    Toastify({
                        text: msg,
                        duration: 3000,
                        gravity: 'top',
                        position: 'right',
                        style: {
                            background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                        }
                    }).showToast();
                } else {
                    alert(msg);
                }
                extractedScoresData = []; // Clear previous data on failure // 失败时清除先前的数据
            }

        } catch (error) {
            console.error('请求AI提取接口失败:', error);
            const msg = `请求失败: ${error.message}`;
             // Ensure upload modal is closed even on fetch error // 确保即使在 fetch 错误时也关闭上传模态框
             closeAiUploadModal();
            // 修改：使用 Toastify
            if (typeof Toastify === 'function') {
                Toastify({
                    text: msg,
                    duration: 3000,
                    gravity: 'top',
                    position: 'right',
                    style: {
                        background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                    }
                }).showToast();
            } else {
                alert(msg);
            }
            extractedScoresData = []; // Clear previous data on failure // 失败时清除先前的数据
        } finally {
            // Hide loading indicator (upload modal one is hidden by closeAiUploadModal) // 隐藏加载指示器（上传模态框的那个由 closeAiUploadModal 隐藏）
            // Re-enable buttons // 重新启用按钮
            if(startExtractionBtn) startExtractionBtn.disabled = false;
            if(aiExtractBtn) aiExtractBtn.disabled = false; // Re-enable main button // 重新启用主按钮
        }
    }

    // Display the extracted scores in the preview modal (Adjusted table styles) // 在预览模态框中显示提取的分数（调整了表格样式）
    function displayAiScorePreview(scores) {
        const aiScorePreviewContent = document.getElementById('aiScorePreviewContent'); // Need reference // 需要引用
        const applyAiScoresBtn = document.getElementById('applyAiScoresBtn'); // Need reference // 需要引用
        const aiPreviewSummary = document.getElementById('aiPreviewSummary'); // Need reference // 需要引用

        if (!aiScorePreviewContent) return;

        if (!scores || scores.length === 0) {
            aiScorePreviewContent.innerHTML = '<p class="text-center text-gray-500">未能从文件中提取到任何得分信息。</p>';
            if (applyAiScoresBtn) applyAiScoresBtn.disabled = true;
            if (aiPreviewSummary) aiPreviewSummary.textContent = '共 0 条记录';
            return;
        }

        let tableHTML = `
            <div class="bg-gray-800 rounded-md text-sm max-h-56 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-700 text-sm">
                    <thead class="sticky top-0 bg-gray-800 z-10">
                        <tr>
                            <th class="px-3 py-2 text-left font-bold text-purple-300 tracking-wider">条文号</th>
                            <th class="px-3 py-2 text-left font-bold text-purple-300 tracking-wider">提取得分</th>
                            <th class="px-3 py-2 text-left font-bold text-purple-300 tracking-wider">来源文件</th>
                            <th class="px-3 py-2 text-left font-bold text-purple-300 tracking-wider">状态</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
        `;

        let applicableCount = 0;
        scores.forEach(item => {
            // Check if a corresponding input exists in the main table, including fallbacks
            const findResult = findTargetElementsWithFallback(item.clause);
            let targetInput = null;
            let foundClauseForStatus = null;

            if (findResult) {
                targetInput = findResult.elements.input;
                foundClauseForStatus = findResult.foundClause;
            }

            let statusIcon = '';
            let statusText = '';

            if (targetInput) {
                // Now we have a targetInput, either primary or fallback
                const maxScore = parseFloat(targetInput.dataset.maxscore);
                const currentScore = parseFloat(item.score);

                if (isNaN(maxScore)) { // Handle non-scoreable items like "—"
                    statusIcon = '<i class="ri-prohibited-line text-gray-500" title="此项不可评分"></i>';
                    statusText = '<span class="text-gray-500">不可评分</span>';
                } else if (isNaN(currentScore)) {
                    statusIcon = '<i class="ri-error-warning-line text-yellow-500" title="提取值非数字"></i>';
                    statusText = '<span class="text-yellow-500">非数字</span>';
                } else if (currentScore > maxScore) {
                    statusIcon = '<i class="ri-error-warning-fill text-orange-500" title="提取分数超过最大值"></i>';
                    statusText = `<span class="text-orange-500">超限(${maxScore})</span>`;
                    applicableCount++; // Still applicable, but needs clamping
                } else {
                    statusIcon = '<i class="ri-check-fill text-green-500" title="可应用"></i>';
                    statusText = '<span class="text-green-400">可应用</span>';
                    // Add a title if a fallback was used
                    if (foundClauseForStatus !== item.clause) {
                         statusText += ` <span class="text-gray-400 text-xs">(匹配到${foundClauseForStatus})</span>`;
                         statusIcon += `<span class="text-gray-400 text-xs ml-1" title="实际匹配条文: ${foundClauseForStatus}"><i class="ri-arrow-right-double-line"></i></span>`;
                    }
                    applicableCount++;
                }
            } else {
                // No match found, even with fallbacks
                statusIcon = '<i class="ri-question-fill text-gray-500" title="项目中未找到对应条文（包括备选）"></i>';
                statusText = '<span class="text-gray-500">无匹配</span>';
            }

            tableHTML += `
                <tr>
                    <td class="px-3 py-2 whitespace-nowrap font-medium text-gray-300">${item.clause || 'N/A'}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-gray-300">${item.score !== undefined ? item.score : 'N/A'}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-gray-400 truncate" title="${item.filename || ''}">${item.filename || 'N/A'}</td>
                     <td class="px-3 py-2 whitespace-nowrap text-gray-400 flex items-center gap-1">${statusIcon} ${statusText}</td>
                </tr>
            `;
        });

        tableHTML += `</tbody></table></div>`;
        aiScorePreviewContent.innerHTML = tableHTML;
        if(applyAiScoresBtn) applyAiScoresBtn.disabled = applicableCount === 0;
        if(aiPreviewSummary) aiPreviewSummary.textContent = `共 ${scores.length} 条记录，${applicableCount} 条可应用`;
    }

    // --- End Moved Functions --- // --- 结束移动的函数 ---

    // 图片模态框相关函数
    function showImageModal(imageSrc) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageSrc;
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    
    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
    
    // 点击模态框背景关闭
    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImageModal();
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== 初始化提高级页面 ===');
        // console.log('DOMContentLoaded 事件触发。');
        
        // 加载用户权限
        loadUserPermissionsForStandards();
        
        // 获取保存按钮并绑定事件
        const saveButton = document.getElementById('saveScoreBtn');
        if (saveButton) {
            saveButton.addEventListener('click', function() {
                saveScores();
            });
        }
        
        // 绑定悬浮保存按钮点击事件
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');
        if (floatingSaveBtn) {
            floatingSaveBtn.querySelector('button').addEventListener('click', function() {
                saveScores();
            });
        }
        
        // 提高级分类过滤器
        const categoryFilters = document.querySelectorAll('.category-filter');
        categoryFilters.forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有按钮的active类
                categoryFilters.forEach(btn => btn.classList.remove('active'));
                // 为当前按钮添加active类
                this.classList.add('active');
                
                // 获取分类
                const category = this.dataset.category;
                
                // 过滤表格行
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    // 如果是"全部"按钮，显示所有行
                    if (this.id === 'filter-all') {
                        row.style.display = '';
                        return;
                    }
                    
                    // 获取分类单元格 - 修复分类过滤器的选择器
                    const categoryCell = row.querySelector('td:nth-child(2)');
                    if (categoryCell) {
                        // 确保我们获取正确的分类文本内容
                        const categoryText = categoryCell.textContent.trim();
                        const categoryTag = categoryCell.querySelector('.category-tag');
                        
                        if ((categoryTag && categoryTag.textContent === category) || 
                            categoryText === category) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            });
        });
        
        // 检查是否需要强制刷新数据
        const projectId = document.getElementById('project_id').value;
        const lastSavedProject = sessionStorage.getItem('last_saved_project');
        const scoresSavedSuccessfully = sessionStorage.getItem('scores_saved_successfully') === 'true';
        
        if (scoresSavedSuccessfully && lastSavedProject === projectId) {
            console.log('检测到上次保存成功，强制刷新数据');
            // 清除会话存储的标记
            sessionStorage.removeItem('scores_saved_successfully');
            sessionStorage.removeItem('last_saved_project');
            // 强制刷新数据
            loadScores(true);
        } else {
            // 正常加载数据
            loadScores(false);
        }
        
        // 如果是提高级，初始化徽章过滤器和更新徽章状态
        if ('{{ current_level }}' === '提高级') {
            if (typeof initializeBadgeFilters === 'function') {
                initializeBadgeFilters();
            }
            if (typeof updateCategoryBadges === 'function') {
                setTimeout(updateCategoryBadges, 1500);
            }
        }
        
        // 添加得分输入验证函数
        window.validateScore = function(input) {
            const maxScore = parseFloat(input.dataset.maxscore);
            const currentScore = parseFloat(input.value);
            
            if (isNaN(currentScore)) {
                input.value = '';
                return;
            }
            
            if (currentScore > maxScore) {
                input.value = maxScore;
                // 修改：使用 Toastify
                if (typeof Toastify === 'function') {
                    Toastify({
                        text: `得分不能超过最大分值${maxScore}`,
                        duration: 3000,
                        gravity: 'top',
                        position: 'right',
                        style: {
                            background: 'linear-gradient(to right, #f59e0b, #f7b733)'
                        }
                    }).showToast();
                } else {
                    alert(`得分不能超过最大分值${maxScore}`);
                }
            }
            // 如果分数在 0 和 maxScore 之间，则保持不变
            // Normalize display for valid numbers (e.g., "09" -> "9")
            // We do this *after* range checks to ensure the final value is correct
            if (!isNaN(currentScore) && currentScore >= 0 && currentScore <= maxScore) {
                // Check if the displayed value differs from the normalized numeric value's string representation
                if (input.value !== currentScore.toString()) {
                    input.value = currentScore.toString(); // Update display
                }
            }
        };
        
        // 为所有得分输入框添加验证
        const scoreInputs = document.querySelectorAll('.score-input');
        scoreInputs.forEach(input => {
            input.addEventListener('input', function() {
                validateScore(this);
            });
        });

        // --- Setup Event Listeners --- Moved from outside --- // --- 设置事件监听器 --- 从外部移入 ---
        // console.log('尝试查找模态框元素...'); // Added log
        const fileInput = document.getElementById('aiScoreFileInput');
        const dropArea = document.getElementById('fileDropArea');
        const startExtractionBtn = document.getElementById('startAiExtractionBtn');
        const cancelUploadBtn = document.getElementById('aiUploadCancelBtn'); // Added selector for cancel button
        const aiExtractBtn = document.getElementById('aiExtractBtn'); // Main AI Button
        const aiScorePreviewModal = document.getElementById('aiScorePreviewModal'); // Preview Modal
        const applyAiScoresBtn = document.getElementById('applyAiScoresBtn'); // Apply Button in Preview // 应用按钮（预览模态框中）

        /* // 移除元素存在性检查日志
        console.log(`文件输入框找到: ${!!fileInput}`);
        console.log(`拖放区域找到: ${!!dropArea}`);
        console.log(`开始提取按钮找到: ${!!startExtractionBtn}`);
        console.log(`取消按钮找到: ${!!cancelUploadBtn}`);
        console.log(`主 AI 提取按钮找到: ${!!aiExtractBtn}`);
        console.log(`预览模态框找到: ${!!aiScorePreviewModal}`);
        console.log(`应用得分按钮找到: ${!!applyAiScoresBtn}`);
        */

        if (fileInput) {
            // console.log('为文件输入框添加 change 监听器。');
            fileInput.addEventListener('change', (event) => {
                // console.log('文件输入框 change 事件触发'); // Added log
                if (event.target.files) {
                   handleFileSelection(event.target.files);
               }
           });
        }

        if (dropArea) {
            // console.log('为拖放区域添加 drag/drop 监听器。');
             // 阻止默认拖拽行为
             ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                 dropArea.addEventListener(eventName, preventDefaults, false);
                 document.body.addEventListener(eventName, preventDefaults, false); // Prevent browser opening file // 阻止浏览器打开文件
             });

             // Highlight drop area when item is dragged over it // 当项目拖拽到其上时高亮拖放区域
             ['dragenter', 'dragover'].forEach(eventName => {
                 dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight-drop'), false);
             });

             ['dragleave', 'drop'].forEach(eventName => {
                 dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight-drop'), false);
             });

             // Handle dropped files // 处理拖放的文件
             dropArea.addEventListener('drop', (event) => {
                // console.log('文件 drop 事件触发'); // Added log
                 const dt = event.dataTransfer;
                 const files = dt.files;
                  if (files && files.length > 0) {
                      handleFileSelection(files);
                      // Optional: Update the file input's files list for consistency, though not strictly necessary
                      // if we use the selectedAiFiles variable directly.
                      // try { fileInput.files = files; } catch (e) { console.warn("Could not set file input files property."); }
                  }
             }, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Add event listener for Cancel button (instead of inline onclick) // 为取消按钮添加事件监听器（而不是内联 onclick）
        if (cancelUploadBtn) {
            // console.log('尝试为取消按钮添加事件监听器。'); // Added log
            // Ensure previous listeners are removed if any (though unlikely needed here) // 确保移除之前的监听器（如果存在）（虽然这里不太可能需要）
            // cancelUploadBtn.removeEventListener('click', closeAiUploadModal);
            cancelUploadBtn.addEventListener('click', closeAiUploadModal);
        } else {
            console.error('未能找到取消按钮以附加监听器。');
        }

        if (startExtractionBtn) {
            // console.log('尝试为开始提取按钮添加事件监听器。'); // Added log
            startExtractionBtn.addEventListener('click', () => {
                // console.log('开始提取按钮被点击'); // Added log
                if (!selectedAiFiles || selectedAiFiles.length === 0) {
                     const msg = "请先选择要上传的文件。";
                     // 修改：使用 Toastify
                     if (typeof Toastify === 'function') {
                         Toastify({
                             text: msg,
                             duration: 3000,
                             gravity: 'top',
                             position: 'right',
                             style: {
                                 background: 'linear-gradient(to right, #f59e0b, #f7b733)'
                             }
                         }).showToast();
                     } else {
                         alert(msg);
                     }
                     return;
                }
                 // Start the extraction process using the selected files
                 triggerAiScoreExtraction(selectedAiFiles);
            });
        } else {
            console.error('未能找到开始提取按钮以附加监听器。');
        }
         // Close upload modal on background click // 点击背景关闭上传模态框
         const aiUploadModal = document.getElementById('aiScoreUploadModal');
         if (aiUploadModal) {
            // console.log('为上传模态框添加背景点击监听器。');
             aiUploadModal.addEventListener('click', function(e) {
                 // 检查点击目标是否是背景本身
                 if (e.target === this) {
                    // console.log('上传模态框背景被点击。');
                     closeAiUploadModal();
                 }
             });
         }
        // --- End Setup for New Upload Modal --- // --- 结束新上传模态框的设置 ---

        // Modify AI Extract Button: Open the new upload modal instead of triggering file input // 修改 AI 提取按钮：打开新的上传模态框而不是触文件输入
        if (aiExtractBtn) {
            // console.log('为主 AI 提取按钮添加 click 监听器。');
            aiExtractBtn.addEventListener('click', () => {
                // console.log('主 AI 提取按钮被点击。');
                showAiUploadModal(); // 新行为：打开上传模态框
            });
        }

        // Handle applying the scores (Apply button in Preview Modal) // 处理应用得分（预览模态框中的应用按钮）
        if (applyAiScoresBtn) {
            // console.log('为应用得分按钮添加 click 监听器。');
            applyAiScoresBtn.addEventListener('click', () => {
                // console.log('应用得分按钮被点击。');
                if (!extractedScoresData || extractedScoresData.length === 0) {
                    // 修改：使用 Toastify
                    if (typeof Toastify === 'function') {
                        Toastify({
                            text: '没有可应用的得分',
                            duration: 3000,
                            gravity: 'top',
                            position: 'right',
                            style: {
                                background: 'linear-gradient(to right, #4facfe, #00f2fe)' // Info color
                            }
                        }).showToast();
                    } else {
                        alert('没有可应用的得分');
                    }
                    return;
                }

                 // 检查是否有编辑权限
                 if (!hasEditPermission) {
                     // 修改：使用 Toastify
                     if (typeof Toastify === 'function') {
                         Toastify({
                             text: '您没有编辑权限，无法应用得分',
                             duration: 3000,
                             gravity: 'top',
                             position: 'right',
                             style: {
                                 background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                             }
                         }).showToast();
                     } else {
                         alert('您没有编辑权限，无法应用得分');
                     }
                     return;
                 }

                let appliedCount = 0;
                extractedScoresData.forEach(item => {
                     if (!item || typeof item.clause === 'undefined') return; // Skip invalid items

                     const primaryClause = item.clause;
                     let elements = null;
                     let foundClause = null; // 记录最终找到的条文号

                     // 1. 尝试查找主条文号
                     elements = findScoreElements(primaryClause);
                     if (elements) {
                         foundClause = primaryClause;
                     } else {
                         // 2. 如果主条文号未找到，检查是否有备选定义
                         const fallbacks = clauseFallbacks[primaryClause];
                         if (fallbacks && Array.isArray(fallbacks)) {
                             console.log(`条文 ${primaryClause} 未找到，开始查找备选: ${fallbacks.join(', ')}`);
                             // 遍历备选条文号
                             for (const fallbackClause of fallbacks) {
                                 elements = findScoreElements(fallbackClause);
                                 if (elements) {
                                     console.log(`条文 ${primaryClause} 的备选 ${fallbackClause} 找到.`);
                                     foundClause = fallbackClause; // 记录找到的备选条文号
                                     break; // 找到第一个匹配的备选就停止
                                 }
                             }
                         }
                     }

                     // 3. 如果找到了元素（主或备选），则应用得分和技术措施
                     if (elements && foundClause) {
                         const targetInput = elements.input;
                         const targetTextarea = elements.textarea;

                         // 检查是否可评分 (对找到的元素进行检查)
                         const maxScoreText = targetInput.dataset.maxscore;
                         if (isNaN(parseFloat(maxScoreText))) {
                             console.warn(`条文 ${foundClause} (为 ${primaryClause} 找到): 目标输入框不可评分，跳过.`);
                             return; // 跳过不可评分的项
                         }

                         const maxScore = parseFloat(maxScoreText);
                         let scoreToApply = parseFloat(item.score); // 使用原始item的得分

                         // 验证得分是否是数字并限制范围
                         if (!isNaN(scoreToApply)) {
                             if (scoreToApply > maxScore) {
                                 console.warn(`条文 ${primaryClause}: 提取得分 ${item.score} 超过目标条文 ${foundClause} 的最大值 ${maxScore}. 将应用最大值.`);
                                 scoreToApply = maxScore;
                             } else if (scoreToApply < 0) {
                                 console.warn(`条文 ${primaryClause}: 提取得分 ${item.score} 小于0. 将应用 0 到目标条文 ${foundClause}.`);
                                 scoreToApply = 0;
                             }

                             // 应用得分到找到的输入框
                             targetInput.value = scoreToApply;

                             // 应用技术措施到找到的文本域（如果存在）
                             if (targetTextarea) {
                                 if (item.filename) {
                                     // 提取文件名（去除后缀）
                                     const lastDotIndex = item.filename.lastIndexOf('.');
                                     const filenameWithoutExt = lastDotIndex > 0 ? item.filename.substring(0, lastDotIndex) : item.filename;
                                     // 填充技术措施
                                     targetTextarea.value = `满足要求，详见${filenameWithoutExt}`;
                                 } else {
                                     targetTextarea.value = '满足要求';
                                     console.warn(`条文 ${primaryClause} 应用到 ${foundClause}: 未找到来源文件名，技术措施仅填充 "满足要求".`);
                                 }
                             } else {
                                 console.warn(`条文 ${foundClause} (为 ${primaryClause} 找到): 未找到对应的技术措施文本域.`);
                             }

                             // 只有成功应用了有效分数才计数
                             appliedCount++;

                             // 如果应用到了备选条文，加个日志
                             if (primaryClause !== foundClause) {
                                 console.log(`成功将条文 ${primaryClause} 的数据应用到备选条文 ${foundClause}`);
                             }

                         } else {
                             console.warn(`条文 ${primaryClause}: 提取的得分 "${item.score}" 不是有效数字，跳过应用.`);
                         }
                     } else {
                         // 如果主条文和所有备选（如果适用）都找不到
                         console.warn(`条文 ${primaryClause}: 在主表单${clauseFallbacks[primaryClause] ? '及其备选条文' : ''}中均未找到对应的输入元素，跳过应用.`);
                     }
                 });

                closeAiPreviewModal(); // Close the preview modal after applying
                 // 修改：使用 Toastify
                 if (typeof Toastify === 'function') {
                     Toastify({
                        text: `成功应用 ${appliedCount} 条得分`,
                        duration: 3000,
                        gravity: 'top',
                        position: 'right',
                        style: {
                            background: 'linear-gradient(to right, #00b09b, #96c93d)'
                        }
                    }).showToast();
                 } else {
                    // Fallback, although unlikely needed now
                    alert(`成功应用 ${appliedCount} 条得分`);
                 }

                // Optionally update summary/badges after applying // 应用后可选择更新汇总/徽章
                if (typeof scoreUtils !== 'undefined' && scoreUtils.fetchScoreSummary) {
                    scoreUtils.fetchScoreSummary();
                }
                 if ('{{ current_level }}' === '提高级' && typeof updateCategoryBadges === 'function') {
                    setTimeout(updateCategoryBadges, 500);
                 }
            });
        } else {
             console.error('未能找到应用得分按钮。');
        }

         // Close preview modal on background click (Existing logic) // 点击背景关闭预览模态框（现有逻辑）
         if (aiScorePreviewModal) {
            // console.log('为预览模态框添加背景点击监听器。');
             aiScorePreviewModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    // console.log('预览模态框背景被点击。');
                    closeAiPreviewModal();
                 }
            });
        }
        // --- End AI Score Extraction Logic / Event Listeners ---

    }); // <-- Final closing bracket for DOMContentLoaded // <-- DOMContentLoaded 的最终结束括号

    /**
     * 获取条文的分类
     * @param {HTMLElement} element - 与条文相关的DOM元素
     * @return {string} 条文分类
     */
    function getCategoryForClause(element) {
        try {
            // 尝试获取条文所在行
            const row = element.closest('tr');
            if (!row) return '';
            
            // 尝试获取分类单元格
            const categoryCell = row.querySelector('td:nth-child(2)');
            if (!categoryCell) return '';
            
            // 尝试获取分类标签
            const categoryTag = categoryCell.querySelector('.category-tag');
            if (categoryTag) {
                return categoryTag.textContent.trim();
            }
            
            // 如果没有标签，直接获取单元格内容
            return categoryCell.textContent.trim();
        } catch (error) {
            console.warn('获取条文分类出错:', error);
            return '';
        }
    }
    
    /**
     * 保存评分信息
     */
    function saveScores() {
        // console.log('开始保存评分信息');
        
        // 检查是否有编辑权限
        if (!hasEditPermission) {
            // 修改：使用 Toastify
            if (typeof Toastify === 'function') {
                Toastify({
                    text: '您没有编辑权限，无法保存评分信息',
                    duration: 3000,
                    gravity: 'top',
                    position: 'right',
                    style: {
                        background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                    }
                }).showToast();
            } else {
                alert('您没有编辑权限，无法保存评分信息');
            }
            return;
        }
        
        // 创建评分数据对象
        // 首先尝试从隐藏字段获取项目ID
        let projectId = document.getElementById('project_id').value;
        
        // 如果项目ID为空，尝试从URL参数中获取
        if (!projectId) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('project_id');
                
                // 如果URL中的参数经过了多次编码，尝试解码
                if (projectId && projectId.includes('%')) {
                    projectId = decodeURIComponent(projectId);
                }
                
                // console.log('从URL参数中获取项目ID:', projectId);
            } catch(e) {
                console.error('解析URL参数错误:', e);
            }
        }
        
        // 如果仍为空，提示错误并返回
        if (!projectId) {
            console.error('项目ID为空，无法保存评分数据');
            // 修改：使用 Toastify
            if (typeof Toastify === 'function') {
                Toastify({
                    text: '项目ID为空，无法保存评分数据',
                    duration: 3000,
                    gravity: 'top',
                    position: 'right',
                    style: {
                        background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                    }
                }).showToast();
            } else {
                alert('项目ID为空，无法保存评分数据');
            }
            return;
        }
        
        const scoreData = {
            project_id: projectId,
            level: '{{ current_level }}',
            specialty: '{{ current_specialty }}',
            scores: []
        };
        
        // console.log('准备保存评分数据:', scoreData);
        
        // 根据评价等级获取不同的评分数据
        if ('{{ current_level }}' === '基本级') {
            // 获取所有基本级的数据
            const selects = document.querySelectorAll('.is-achieved-select');
            // console.log(`找到 ${selects.length} 个基本级选择框`);
            
            selects.forEach(select => {
                const clause = select.dataset.clause.trim(); // 修剪条文号，去除多余空格
                const isAchieved = select.value;
                const technicalMeasures = document.querySelector(`textarea[data-clause="${select.dataset.clause}"]`).value.trim();
                
                // 获取分类信息 - 查找该条文所在行
                const row = select.closest('tr');
                let category = '';
                
                // 尝试获取分类单元格
                const categoryCell = row.querySelector('td:nth-child(2)');
                if (categoryCell && categoryCell.querySelector('.category-tag')) {
                    category = categoryCell.querySelector('.category-tag').textContent.trim();
                }
                
                scoreData.scores.push({
                    clause_number: clause,
                    is_achieved: isAchieved,
                    technical_measures: technicalMeasures,
                    category: category
                });
            });
        } else if ('{{ current_level }}' === '提高级') {
            // 获取所有提高级的数据
            const scoreInputs = document.querySelectorAll('input[name="score"]');
            // console.log(`找到 ${scoreInputs.length} 个提高级输入框`);
            
            scoreInputs.forEach(input => {
                const clause = input.dataset.clause.trim(); // 修剪条文号，去除多余空格
                const maxScore = input.dataset.maxscore;
                let score = input.value.trim();
                
                // 如果分值为"—"，则特殊处理
                if (score === '—') {
                    // 对于分值为"—"的条目，我们记录特殊值
                    scoreData.scores.push({
                        clause_number: clause, // 使用修剪后的条文号
                        score: '—',
                        max_score: '—',
                        technical_measures: '',
                        category: getCategoryForClause(input),
                        is_achieved: '不参评'
                    });
                    return; // 跳过后续处理
                }
                
                // 验证得分是否超过最大值
                if (score !== '' && parseFloat(score) > parseFloat(maxScore)) {
                    // 修改：使用 Toastify
                    if (typeof Toastify === 'function') {
                        Toastify({
                            text: `条文${clause}的得分不能超过最大分值${maxScore}`,
                            duration: 3000,
                            gravity: 'top',
                            position: 'right',
                            style: {
                                background: 'linear-gradient(to right, #f59e0b, #f7b733)'
                            }
                        }).showToast();
                    } else {
                        alert(`条文${clause}的得分不能超过最大分值${maxScore}`);
                    }
                    input.focus();
                }
                
                const textarea = document.querySelector(`textarea[data-clause="${input.dataset.clause}"]`);
                let technicalMeasures = '';
                
                if (textarea) {
                    technicalMeasures = textarea.value.trim();
                } else {
                    console.warn(`未找到条文 ${clause} 的技术措施输入框`);
                }
                
                // 获取分类
                const category = getCategoryForClause(input);

                // 判断是否达标 - 根据得分判断
                const isAchieved = (score !== '' && parseFloat(score) > 0) ? "是" : "否";
                
                scoreData.scores.push({
                    clause_number: clause,
                    score: score,
                    max_score: maxScore,
                    technical_measures: technicalMeasures,
                    category: category,
                    is_achieved: isAchieved
                });
                
                // console.log(`添加评分数据: 条文=${clause}, 得分='${score}', 最大分值=${maxScore}, 分类=${category}, 是否达标=${isAchieved}`);
            });
        }
        
        // console.log(`即将发送的评分数据: ${scoreData.scores.length}条记录`);
        
        // 发送数据到服务器
        fetch('/api/save_score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(scoreData)
        })
        .then(response => {
            // console.log('服务器响应状态:', response.status);
            
            if (!response.ok) {
                throw new Error('保存失败: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // console.log('服务器响应数据:', data);
            
            if (data.success) {
                // 提示保存成功，但不使用阻塞性的alert，改用非阻塞通知
                // 修改：使用 Toastify
                if (typeof Toastify === 'function') {
                    Toastify({
                        text: '评分信息保存成功!',
                        duration: 3000,
                        gravity: 'top',
                        position: 'right',
                        style: {
                            background: 'linear-gradient(to right, #00b09b, #96c93d)'
                        }
                    }).showToast();
                } else {
                    // 使用非阻塞通知
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    notification.textContent = '评分信息保存成功!';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                }
                
                // 刷新评分汇总
                if (typeof scoreUtils !== 'undefined' && scoreUtils.fetchScoreSummary) {
                    // console.log('刷新评分汇总');
                    scoreUtils.fetchScoreSummary();
                }
                
                // 更新分类达标徽章状态
                if ('{{ current_level }}' === '提高级' && typeof updateCategoryBadges === 'function') {
                    // console.log('更新分类达标徽章');
                    setTimeout(updateCategoryBadges, 1000);
                }

                // 处理条文之间的依赖关系
                // 仅在评价标准不是国标时执行
                if (typeof handleAllClauseDependencies === 'function' && getCurrentProjectStandard() !== '国标') {
                    console.log('评价标准非国标，开始处理条文依赖关系');
                    handleAllClauseDependencies(projectId)
                        .then(results => {
                            console.log('条文依赖关系处理完成:', results);
                        })
                        .catch(error => {
                            console.error('处理条文依赖关系时出错:', error);
                        });
                } else {
                    // console.warn('未找到条文依赖关系处理函数或评价标准为国标，跳过处理');
                }
                
                // 不再重新加载评分数据，保留用户当前输入的内容
                // console.log('保留用户当前输入的内容，不重新加载');
                
                // 如果用户刷新页面，确保能正确加载数据
                // 添加记忆保存成功的标记
                sessionStorage.setItem('scores_saved_successfully', 'true');
                sessionStorage.setItem('last_saved_project', projectId);
            } else {
                // 保存失败时提示
                const errorMsg = data.message || '保存失败';
                console.error('保存失败:', errorMsg);
                // 修改：使用 Toastify
                if (typeof Toastify === 'function') {
                    Toastify({
                        text: errorMsg,
                        duration: 3000,
                        gravity: 'top',
                        position: 'right',
                        style: {
                            background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                        }
                    }).showToast();
                } else {
                    alert(errorMsg);
                }
            }
        })
        .catch(error => {
            console.error('保存失败:', error);
            // 修改：使用 Toastify
            if (typeof Toastify === 'function') {
                Toastify({
                    text: '保存失败，请重试: ' + error.message,
                    duration: 3000,
                    gravity: 'top',
                    position: 'right',
                    style: {
                        background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                    }
                }).showToast();
            } else {
                alert('保存失败，请重试: ' + error.message);
            }
        });
    }
    
    /**
     * 加载保存的评分信息
     * @param {boolean} forceRefresh - 是否强制刷新数据
     */
    function loadScores(forceRefresh = false) {
        // 首先尝试从项目ID隐藏字段获取
        let projectId = document.getElementById('project_id').value;
        
        // 如果项目ID为空，尝试从URL参数中获取
        if (!projectId) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('project_id');
                
                // 如果URL中的参数经过了多次编码，尝试解码
                if (projectId && projectId.includes('%')) {
                    projectId = decodeURIComponent(projectId);
                }
                
                // console.log('从URL参数中获取项目ID:', projectId);
            } catch(e) {
                console.error('解析URL参数错误:', e);
            }
        }
        
        // 如果仍为空，无法加载
        if (!projectId) {
            console.warn('项目ID为空，无法加载评分数据');
            return;
        }
        
        // console.log('开始加载评分数据，项目ID:', projectId, '强制刷新:', forceRefresh);
        
        try {
            // console.log('使用/api/project_scores端点');
            
            const url = `/api/project_scores?project_id=${projectId}&level={{ current_level }}&specialty={{ current_specialty }}&force_refresh=${forceRefresh}`;
            
            // console.log('请求URL:', url);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        console.error('API响应错误:', response.status, response.statusText);
                        throw new Error('获取数据失败: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // console.log('加载的评分数据:', data);
                    // 修改解析数据的方式，以匹配新API的返回格式
                    if (data.success && data.sample_scores && Array.isArray(data.sample_scores)) {
                        // 获取页面上所有的输入元素
                        const allInputs = document.querySelectorAll('input[name="score"]');
                        const allTextareas = document.querySelectorAll('textarea[name="technical_measures"]');
                        
                        // console.log(`页面上共有 ${allInputs.length} 个得分输入框和 ${allTextareas.length} 个技术措施输入框`);
                        
                        // 用于统计处理结果
                        let successCount = 0;
                        let failCount = 0;
                        
                        // 构建条文号映射表 - 更高效的查找
                        const formInputsByClause = {};
                        const formTextareasByClause = {};
                        
                        allInputs.forEach(input => {
                            if (input.dataset.clause) {
                                formInputsByClause[input.dataset.clause] = input;
                                // 也为规范化后的条文号建立映射
                                const normalizedClause = input.dataset.clause.replace(/[^\d\.]/g, '');
                                if (normalizedClause) {
                                    formInputsByClause[normalizedClause] = input;
                                }
                            }
                        });
                        
                        allTextareas.forEach(textarea => {
                            if (textarea.dataset.clause) {
                                formTextareasByClause[textarea.dataset.clause] = textarea;
                                // 也为规范化后的条文号建立映射
                                const normalizedClause = textarea.dataset.clause.replace(/[^\d\.]/g, '');
                                if (normalizedClause) {
                                    formTextareasByClause[normalizedClause] = textarea;
                                }
                            }
                        });
                        
                        // 填充表格 - 注意：从sample_scores字段提取数据
                        data.sample_scores.forEach(item => {
                            try {
                                // 获取条文号
                                const clause = item.clause_number;
                                
                                if (!clause) {
                                    console.warn('无法提取条文号:', item);
                                    failCount++;
                                    return; // 跳过无条文号的数据
                                }
                                
                                // 规范化条文号
                                const normalizedClause = clause.replace(/[^\d\.]/g, '');
                                
                                // 尝试查找对应的表单元素
                                let scoreInput = formInputsByClause[clause] || 
                                                formInputsByClause[normalizedClause];
                                                
                                let techTextarea = formTextareasByClause[clause] || 
                                                   formTextareasByClause[normalizedClause];
                                
                                // 如果没找到，尝试在页面中查找
                                if (!scoreInput) {
                                    scoreInput = document.querySelector(`input[name="score"][data-clause="${clause}"]`);
                                }
                                
                                if (!techTextarea) {
                                    techTextarea = document.querySelector(`textarea[data-clause="${clause}"]`);
                                }
                                
                                // 填充得分
                                if (scoreInput) {
                                    // Original line: const score = item.score !== undefined && item.score !== null ? item.score : '0';
                                    // Let's default to empty string '' instead of '0' if score is null/undefined from DB
                                    // 如果数据库中的 score 是 null/undefined，则默认为空字符串 '' 而不是 '0'
                                    const scoreValue = (item.score !== undefined && item.score !== null) ? String(item.score).trim() : '';
                                    let processedScore = scoreValue; // Start with the loaded value (as string) // 从加载的值开始（作为字符串）

                                    // Keep '—' as is, and also allow "达标" and "不达标" // 保留 '—'，并允许 "达标" 和 "不达标"
                                    if (scoreValue !== '—' && scoreValue !== '达标' && scoreValue !== '不达标') {
                                        // If it's not one of the allowed strings and not empty, try to parse and normalize // 如果它不是允许的字符串之一且不为空，则尝试解析和规范化
                                        if (scoreValue !== '') {
                                            const num = parseFloat(scoreValue);
                                            if (!isNaN(num)) {
                                                // Convert valid number back to string to remove leading zeros/normalize format // 将有效数字转换回字符串以删除前导零/规范化格式
                                                processedScore = num.toString();
                                            } else {
                                                // Handle case where loaded value is neither '—' nor a valid number/allowed string // 处理加载值既不是 '—' 也不是有效数字/允许字符串的情况
                                                console.warn(`Loaded invalid score value "${scoreValue}" for clause ${clause}. Resetting to empty.`);
                                                processedScore = ''; // Reset invalid values to empty // 将无效值重置为空
                                            }
                                        }
                                        // If scoreValue was '', processedScore remains '' // 如果 scoreValue 是空字符串，processedScore 保持为空字符串
                                    }
                                    // Now, processedScore is '—', '达标', '不达标', '', or a normalized number string // 现在，processedScore 是 '—', '达标', '不达标', 空字符串, 或规范化的数字字符串

                                    scoreInput.value = processedScore; // Set the processed value // 设置处理后的值
                                    successCount++;
                                } else {
                                    // console.warn(`未能找到条文 ${clause} 对应的得分输入框`);
                                    failCount++;
                                }
                                
                                // 填充技术措施
                                if (techTextarea) {
                                    techTextarea.value = item.technical_measures || '';
                                } else {
                                    // console.warn(`未能找到条文 ${clause} 对应的技术措施输入框`);
                                }
                            } catch (error) {
                                console.error(`处理条文数据项时发生错误:`, error, item);
                                failCount++;
                            }
                        });
                        
                        // console.log(`评分数据加载完成: 成功 ${successCount} 项, 失败 ${failCount} 项`);
                    } else {
                        console.warn('没有找到保存的评分数据:', data.message || '未知错误');
                        // 添加更详细的调试信息
                        console.log('请求详情:', {
                            url: url,
                            projectId: projectId,
                            level: '{{ current_level }}',
                            specialty: '{{ current_specialty }}',
                            responseData: data
                        });
                        
                        // 显示友好的错误提示
                        // 修改：使用 Toastify
                        if (typeof Toastify === 'function') {
                            Toastify({
                                text: '没有找到保存的评分数据，请先进行评分',
                                duration: 3000,
                                gravity: 'top',
                                position: 'right',
                                style: {
                                    background: 'linear-gradient(to right, #f59e0b, #f7b733)'
                                }
                            }).showToast();
                        } else {
                            alert('没有找到保存的评分数据，请先进行评分'); // Fallback
                        }
                    }
                })
                .catch(error => {
                    console.error('加载评分数据失败:', error);
                    // 修改：使用 Toastify
                    if (typeof Toastify === 'function') {
                        Toastify({
                            text: '加载评分数据失败: ' + error.message,
                            duration: 3000,
                            gravity: 'top',
                            position: 'right',
                            style: {
                                background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                            }
                        }).showToast();
                    } else {
                        alert('加载评分数据失败: ' + error.message); // Fallback
                    }
                });
        } catch (error) {
            console.error('加载过程发生异常:', error);
            // 修改：使用 Toastify
            if (typeof Toastify === 'function') {
                Toastify({
                    text: '加载过程发生异常:' + error.message,
                    duration: 3000,
                    gravity: 'top',
                    position: 'right',
                    style: {
                        background: 'linear-gradient(to right, #ff5f6d, #ffc371)'
                    }
                }).showToast();
            } else {
                alert('加载过程发生异常:' + error.message); // Fallback
            }
        }
    }
    
    /**
     * 加载用户的项目权限
     */
    function loadUserPermissionsForStandards() {
        const projectId = document.getElementById('project_id').value;
        if (!projectId) {
            console.warn('项目ID为空，无法获取权限');
            return;
        }
        
        // console.log('正在加载项目权限，项目ID:', projectId);
        
        fetch(`/api/projects/${projectId}/permissions`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    userPermissions = data.permissions;
                    // console.log('获取到用户权限:', userPermissions);
                    
                    // 检查是否有编辑权限
                    const role = userPermissions.role;
                    const permissions = userPermissions.permissions;
                    
                    // 创建者或具有"管理"权限的用户可以编辑
                    if (role === '创建者' || permissions === '管理' || permissions === '编辑') {
                        hasEditPermission = true;
                    } else {
                        hasEditPermission = false;
                    }
                    
                    // 更新UI
                    updateUIBasedOnPermissions();
                    
                    // 显示权限提示
                    // showPermissionIndicator();
                } else {
                    console.warn('获取权限失败:', data.error);
                    hasEditPermission = false;
                    updateUIBasedOnPermissions();
                }
            })
            .catch(error => {
                console.error('获取用户权限失败:', error);
                hasEditPermission = false;
                updateUIBasedOnPermissions();
            });
    }
    
    /**
     * 基于权限更新UI
     */
    function updateUIBasedOnPermissions() {
        // 获取所有输入元素
        const scoreInputs = document.querySelectorAll('.score-input');
        const technicalMeasures = document.querySelectorAll('.technical-measures');
        const achievedSelects = document.querySelectorAll('.is-achieved-select');
        const saveButtons = document.querySelectorAll('#saveScoreBtn, #floatingSaveBtn button');
        
        if (!hasEditPermission) {
            // 禁用所有输入元素
            scoreInputs.forEach(input => {
                input.disabled = true;
                input.classList.add('bg-gray-100');
                input.classList.add('cursor-not-allowed');
            });
            
            technicalMeasures.forEach(textarea => {
                textarea.disabled = true;
                textarea.classList.add('bg-gray-100');
                textarea.classList.add('cursor-not-allowed');
            });
            
            achievedSelects.forEach(select => {
                select.disabled = true;
                select.classList.add('bg-gray-100');
                select.classList.add('cursor-not-allowed');
            });
            
            // 禁用保存按钮
            saveButtons.forEach(button => {
                button.disabled = true;
                button.classList.add('opacity-50');
                button.classList.add('cursor-not-allowed');
            });
        } else {
            // 启用所有输入元素
            scoreInputs.forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-100');
                input.classList.remove('cursor-not-allowed');
            });
            
            technicalMeasures.forEach(textarea => {
                textarea.disabled = false;
                textarea.classList.remove('bg-gray-100');
                textarea.classList.remove('cursor-not-allowed');
            });
            
            achievedSelects.forEach(select => {
                select.disabled = false;
                select.classList.remove('bg-gray-100');
                select.classList.remove('cursor-not-allowed');
            });
            
            // 启用保存按钮
            saveButtons.forEach(button => {
                button.disabled = false;
                button.classList.remove('opacity-50');
                button.classList.remove('cursor-not-allowed');
            });
        }
    }
    
    /**
     * 显示权限提示
     */
    function showPermissionIndicator() {
        if (!userPermissions) return;
        
        // 检查是否已存在权限提示
        let permissionIndicator = document.getElementById('permission-indicator');
        if (!permissionIndicator) {
            permissionIndicator = document.createElement('div');
            permissionIndicator.id = 'permission-indicator';
            permissionIndicator.className = 'fixed top-4 right-4 px-3 py-2 rounded-lg shadow-md z-50 flex items-center space-x-2 text-sm';
            document.body.appendChild(permissionIndicator);
        }
        
        const role = userPermissions.role;
        const permissions = userPermissions.permissions;
        
        // 设置样式和内容
        if (!hasEditPermission) {
            permissionIndicator.className = 'fixed top-4 right-4 px-3 py-2 rounded-lg shadow-md z-50 flex items-center space-x-2 text-sm bg-amber-100 text-amber-800 border border-amber-200';
            permissionIndicator.innerHTML = `
                <i class="fas fa-lock"></i>
                <span>只读模式 (角色: ${role}, 权限: ${permissions})</span>
            `;
        } else {
            permissionIndicator.className = 'fixed top-4 right-4 px-3 py-2 rounded-lg shadow-md z-50 flex items-center space-x-2 text-sm bg-green-100 text-green-800 border border-green-200';
            permissionIndicator.innerHTML = `
                <i class="fas fa-edit"></i>
                <span>编辑模式 (角色: ${role}, 权限: ${permissions})</span>
            `;
        }
    }
    {% raw %}
    /**
     * 辅助函数：查找指定条文号的得分输入框和技术措施文本域
     * @param {string} clause - 条文号
     * @returns {{input: HTMLInputElement|null, textarea: HTMLTextAreaElement|null}|null} - 包含元素的对，如果找不到输入框则返回null
     */
    function findScoreElements(clause) {
        // --- 新增日志：打印正在查找的条文号 ---
        console.log(`[findScoreElements] 正在查找条文号: "${clause}"`);
        if (!clause) return null;

        const input = document.querySelector(`input[name="score"][data-clause="${clause}"]`);
        // --- 新增日志：打印查找 input 的结果 ---
        console.log(`[findScoreElements] 查找 input[data-clause="${clause}"] 结果:`, input);

        // 只有找到了输入框，才认为这对元素是有效的
        if (!input) {
            return null;
        }
        const textarea = document.querySelector(`textarea[name="technical_measures"][data-clause="${clause}"]`);
        // --- 可选新增日志：打印查找 textarea 的结果 ---
        // console.log(`[findScoreElements] 查找 textarea[data-clause="${clause}"] 结果:`, textarea);
        return { input, textarea };
    }
    {% endraw %}
    {% raw %}
    /**
     * 条文号备选查找映射
     * key: 主条文号 (string)
     * value: 备选条文号数组 (string[])，按查找顺序排列
     */
    const clauseFallbacks = {
        // --- 在这里添加其他需要备选查找的条文号映射 ---
        // '主条文号': ['备选1', '备选2', ...],
        '7.2.4': ['3.7.8', '3.1.2.26'],
        '7.2.5': ['3.4.4', '3.4.2.4'],
        '5.2.1': ['3.7.1', '3.4.2.1'],
        '5.2.6': ['3.7.2', '3.1.2.22'],
        '5.2.7': ['3.7.3', '3.1.2.23'],
        '5.2.8': ['3.7.4', '3.1.2.24'],
        '5.2.9': ['3.7.5', '3.4.2.2'],
        '5.2.10': ['3.7.6', '3.1.2.25'],
        '7.2.8': ['3.7.9', '3.4.2.7'],
        '8.2.6': ['3.7.10', '3.1.2.27'],
        '8.2.7': ['3.7.11', '3.6.2.6'],
        '8.2.8': ['3.7.12', '3.1.2.28'],
        '8.2.9': ['3.7.13', '3.6.2.7'],
        '9.2.1': ['3.7.14', '3.6.3.2'],
        '9.2.7': ['3.7.15', '3.1.3.4'],
        '7.2.18': ['3.1.24', '3.1.2.20'],
        '6.2.1': ['3.1.11', '3.1.2.9'],
        '5.2.11': ['3.1.10', '3.1.2.8'],
        '6.2.3': ['3.1.13', '3.1.2.11'],
        '7.2.17': ['3.1.23', '3.1.2.19'],

    };
    {% endraw %}
    {% raw %}
    /**
     * 查找目标元素（包括备选条文号）
     * @param {string} primaryClause - 主要查找的条文号
     * @returns {{elements: {input: HTMLInputElement, textarea: HTMLTextAreaElement|null}|null, foundClause: string|null}} - 返回找到的元素对和实际匹配的条文号，如果都找不到则返回null
     */
    function findTargetElementsWithFallback(primaryClause) {
        if (!primaryClause) return null;

        let elements = findScoreElements(primaryClause);
        if (elements) {
            return { elements, foundClause: primaryClause };
        }

        // 如果主条文号未找到，检查是否有备选定义
        const fallbacks = clauseFallbacks[primaryClause];
        if (fallbacks && Array.isArray(fallbacks)) {
            console.log(`[Fallback Check] 条文 ${primaryClause} 未直接找到，开始查找备选: ${fallbacks.join(', ')}`);
            for (const fallbackClause of fallbacks) {
                elements = findScoreElements(fallbackClause);
                if (elements) {
                    console.log(`[Fallback Check] 条文 ${primaryClause} 的备选 ${fallbackClause} 找到.`);
                    return { elements, foundClause: fallbackClause }; // 找到第一个匹配的备选
                }
            }
        }

        // 主条文和所有备选都找不到
        return null;
    }
    {% endraw %}
</script>

<!-- 引入条文依赖关系处理脚本 -->
<script src="/static/js/db_updater.js"></script>

<script>
    // 添加 filterTableByClause 函数，用于根据输入的条文号过滤表格行
    window.filterTableByClause = function(filterValue) {
        const searchTerm = filterValue.trim().toLowerCase();
        const rows = document.querySelectorAll('tbody tr'); // 获取所有表格行

        rows.forEach(row => {
            // 获取条文号单元格，假设它是第一列 (td:nth-child(1))
            const clauseCell = row.querySelector('td:first-child'); // 使用 first-child 更直接
            if (clauseCell) {
                const clauseText = clauseCell.textContent.trim().toLowerCase();

                // 检查条文号是否包含搜索词
                if (clauseText.includes(searchTerm)) {
                    row.style.display = ''; // 显示匹配的行
                } else {
                    row.style.display = 'none'; // 隐藏不匹配的行
                }
            }
        });
        // 在过滤后更新徽章状态（提高级页面）
        if ('{{ current_level }}' === '提高级' && typeof updateCategoryBadges === 'function') {
             // 添加一个小的延迟，确保 DOM 更新完成
             setTimeout(() => {
                 updateCategoryBadges(searchTerm); // 传递搜索词，让徽章知道当前过滤状态
             }, 100);
         } else if (typeof updateCategoryBadges === 'function') {
             // 如果不是提高级页面，或者updateCategoryBadges存在，但没法处理searchTerm，则调用不带参数的版本
             // updateCategoryBadges(); // 或者根据需要决定是否调用
         }

    };

    // ... existing code ...
</script>