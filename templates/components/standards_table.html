<!-- 标准列表内容 -->
<!-- 添加隐藏的项目ID字段 -->
<input type="hidden" id="project_id" name="project_id" value="{{ project.id if project else '' }}">
<input type="hidden" id="current-project-id" name="current-project-id" value="{{ project.id if project else '' }}">

<!-- 添加图片相关样式 -->
<style>
    .standard-image-container {
        margin-top: 8px;
    }
    .standard-image {
        max-height: 150px;
        object-fit: contain;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .standard-image:hover {
        transform: scale(1.02);
    }
</style>

{% if current_level == '提高级' %}
<!-- 在提高级页面加载浮动徽章组件 -->
{% include 'components/floating_badge.html' %}

<!-- 在提高级页面添加悬浮保存按钮 -->
<div class="fixed bottom-8 right-8 z-50" id="floatingSaveBtn">
    <button class="bg-primary text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-primary-dark transition-colors" title="保存评分信息">
        <i class="ri-save-line text-xl"></i>
    </button>
</div>
{% endif %}

<div class="overflow-x-auto">
    {% if standards %}
    
    {% if current_level == '提高级' %}
    <!-- 提高级分类过滤器 -->
    <div class="mb-4 p-4 bg-gray-50 rounded-lg shadow-sm">
        <div class="flex flex-wrap items-center">
            <span class="mr-2 font-medium">分类过滤:</span>
            <div class="flex flex-wrap">
                <button id="filter-all" class="px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium category-filter active">全部</button>
                <button id="filter-安全耐久" data-category="安全耐久" class="px-3 py-1 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm font-medium category-filter">安全耐久</button>
                <button id="filter-健康舒适" data-category="健康舒适" class="px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-800 text-sm font-medium category-filter">健康舒适</button>
                <button id="filter-生活便利" data-category="生活便利" class="px-3 py-1 rounded-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 text-sm font-medium category-filter">生活便利</button>
                <button id="filter-资源节约" data-category="资源节约" class="px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-800 text-sm font-medium category-filter">资源节约</button>
                <button id="filter-环境宜居" data-category="环境宜居" class="px-3 py-1 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 text-sm font-medium category-filter">环境宜居</button>
                <button id="filter-提高与创新" data-category="提高与创新" class="px-3 py-1 rounded-full bg-purple-100 hover:bg-purple-200 text-purple-800 text-sm font-medium category-filter">提高与创新</button>
            </div>
        </div>
    </div>
    {% endif %}
    
    <table class="min-w-full divide-y divide-gray-200 table-fixed">
        <thead class="bg-primary">
            <tr>
                {% if current_level == '基本级' %}
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">条文号</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-30">条文内容</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分值</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">是否达标</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap technical-measures-cell">技术措施</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">审查材料</th>
                {% elif current_level == '提高级' %}
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">条文号</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分类</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-30">条文内容</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分值</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">得分</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap technical-measures-cell">技术措施</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">审查材料</th>
                {% else %}
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">条文号</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">分类</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">条文内容</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">分值</th>
                <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">审查材料</th>
                {% endif %}
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for standard in standards %}
            <tr class="table-row-hover">
                <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">{{ standard.条文号 }}</td>
                {% if current_level == '提高级' %}
                <td class="px-6 py-4 whitespace-normal h-16 text-base text-gray-700">
                    <span class="category-tag category-{{ standard.分类 }}">{{ standard.分类 }}</span>
                </td>
                {% endif %}
                <td class="px-6 py-4 text-base text-gray-700">
                    {% if standard.图片路径 %}
                    <div class="mb-2">{{ standard.条文内容 }}</div>
                    <div class="standard-image-container">
                        <img src="{{ standard.图片路径 }}" alt="条文图片" class="standard-image max-w-full h-auto rounded border border-gray-200 hover:border-primary transition-colors cursor-pointer" onclick="showImageModal(this.src)">
                    </div>
                    {% else %}
                    {{ standard.条文内容 }}
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">{{ standard.分值 }}</td>
                
                {% if current_level == '基本级' %}
                <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">
                    <select name="is_achieved" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary is-achieved-select" title="符合性判断">
                        <option value="是">是</option>
                        <option value="否">否</option>
                        <option value="不参评">不参评</option>
                    </select>
                </td>
                <td class="px-6 py-4 text-base text-gray-700">
                    <textarea name="technical_measures" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary technical-measures" placeholder="请输入技术措施"></textarea>
                </td>
                <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                {% elif current_level == '提高级' %}
                <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">
                    {% if standard.分值 == '—' %}
                    <span class="text-gray-500">—</span>
                    {% else %}
                    <input type="number" name="score" data-clause="{{ standard.条文号 }}" data-maxscore="{{ standard.分值 }}" 
                           class="w-full rounded focus:border-primary score-input" 
                           placeholder="得分"
                           min="0"
                           max="{{ standard.分值 }}"
                           oninput="validateScore(this)">
                    {% endif %}
                </td>
                <td class="px-6 py-4 text-base text-gray-700 technical-measures-cell">
                    <textarea name="technical_measures" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary technical-measures" placeholder="请输入技术措施"></textarea>
                </td>
                <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                {% else %}
                <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- 添加保存按钮 -->
    <div class="mt-8 flex justify-center">
        <button type="button" id="saveScoreBtn" class="px-6 py-3 bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
            保存评分信息
        </button>
    </div>

    <!-- 评分统计表格 -->
    {% if current_level == '提高级' %}
    <!-- 这里可以添加提高级评分统计表格的内容 -->
    {% endif %}
    {% else %}
    <div class="text-center py-10">
        <p class="text-gray-500 text-xl">没有找到符合条件的记录</p>
        <p class="text-gray-400 text-lg mt-2">请尝试其他筛选条件</p>
    </div>
    {% endif %}
</div>

<!-- 图片模态框 -->
<div id="imageModal" class="fixed inset-0 z-50 hidden overflow-auto bg-black bg-opacity-75 flex items-center justify-center p-4">
    <div class="relative bg-white rounded-lg shadow-xl max-w-4xl w-full mx-auto">
        <div class="p-2 flex justify-between items-center border-b">
            <h3 class="text-lg font-medium text-gray-900">图片预览</h3>
            <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeImageModal()" title="关闭">
                <i class="ri-close-line text-xl"></i>
            </button>
        </div>
        <div class="p-4 flex justify-center">
            <img id="modalImage" src="" alt="放大图片" class="max-w-full max-h-[80vh]">
        </div>
    </div>
</div>

<!-- 添加标准表格相关的JavaScript -->
<script>
    // 定义权限控制变量
    let hasEditPermission = true; // 默认为可编辑
    let userPermissions = null;
    
    // 图片模态框相关函数
    function showImageModal(imageSrc) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageSrc;
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    
    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
    
    // 点击模态框背景关闭
    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeImageModal();
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== 初始化提高级页面 ===');
        
        // 加载用户权限
        loadUserPermissionsForStandards();
        
        // 检查是否为给排水专业
        const isWaterSpecialty = '{{ current_specialty }}' === '给排水' || 
                                 '{{ current_specialty }}'.includes('给') || 
                                 '{{ current_specialty }}'.includes('排') || 
                                 '{{ current_specialty }}'.includes('水');
        if (isWaterSpecialty) {
            console.log("检测到给排水专业页面，启用特殊处理");
            // 检查表格中是否存在给排水的条文
            const rows = document.querySelectorAll('tbody tr');
            console.log(`页面中共有 ${rows.length} 行条文数据`);
            let sampleRows = [];
            for (let i = 0; i < Math.min(5, rows.length); i++) {
                const clauseCell = rows[i].querySelector('td:first-child');
                sampleRows.push(clauseCell.textContent.trim());
            }
            console.log("页面中的前几个条文号样本:", sampleRows);
        }
        
        // 获取保存按钮并绑定事件
        const saveButton = document.getElementById('saveScoreBtn');
        if (saveButton) {
            saveButton.addEventListener('click', function() {
                saveScores();
            });
        }
        
        // 绑定悬浮保存按钮点击事件
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');
        if (floatingSaveBtn) {
            floatingSaveBtn.querySelector('button').addEventListener('click', function() {
                saveScores();
            });
        }
        
        // 提高级分类过滤器
        const categoryFilters = document.querySelectorAll('.category-filter');
        categoryFilters.forEach(button => {
            button.addEventListener('click', function() {
                // 移除所有按钮的active类
                categoryFilters.forEach(btn => btn.classList.remove('active'));
                // 为当前按钮添加active类
                this.classList.add('active');
                
                // 获取分类
                const category = this.dataset.category;
                
                // 过滤表格行
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    // 如果是"全部"按钮，显示所有行
                    if (this.id === 'filter-all') {
                        row.style.display = '';
                        return;
                    }
                    
                    // 获取分类单元格 - 修复分类过滤器的选择器
                    const categoryCell = row.querySelector('td:nth-child(2)');
                    if (categoryCell) {
                        // 确保我们获取正确的分类文本内容
                        const categoryText = categoryCell.textContent.trim();
                        const categoryTag = categoryCell.querySelector('.category-tag');
                        
                        if ((categoryTag && categoryTag.textContent === category) || 
                            categoryText === category) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
            });
        });
        
        // 检查是否需要强制刷新数据
        const projectId = document.getElementById('project_id').value;
        const lastSavedProject = sessionStorage.getItem('last_saved_project');
        const scoresSavedSuccessfully = sessionStorage.getItem('scores_saved_successfully') === 'true';
        
        if (scoresSavedSuccessfully && lastSavedProject === projectId) {
            console.log('检测到上次保存成功，强制刷新数据');
            // 清除会话存储的标记
            sessionStorage.removeItem('scores_saved_successfully');
            sessionStorage.removeItem('last_saved_project');
            // 强制刷新数据
            loadScores(true);
        } else {
            // 正常加载数据
            loadScores(false);
        }
        
        // 如果是提高级，初始化徽章过滤器和更新徽章状态
        if ('{{ current_level }}' === '提高级') {
            if (typeof initializeBadgeFilters === 'function') {
                initializeBadgeFilters();
            }
            if (typeof updateCategoryBadges === 'function') {
                setTimeout(updateCategoryBadges, 1500);
            }
        }
        
        // 添加得分输入验证函数
        window.validateScore = function(input) {
            const maxScore = parseFloat(input.dataset.maxscore);
            const currentScore = parseFloat(input.value);
            
            if (isNaN(currentScore)) {
                input.value = '0';
                return;
            }
            
            if (currentScore > maxScore) {
                input.value = maxScore;
                if (typeof toast === 'function') {
                    toast(`得分不能超过最大分值${maxScore}`, 'warning');
                }
            }
        };
        
        // 为所有得分输入框添加验证
        const scoreInputs = document.querySelectorAll('.score-input');
        scoreInputs.forEach(input => {
            input.addEventListener('input', function() {
                validateScore(this);
            });
        });
    });
    
    /**
     * 保存评分信息
     */
    function saveScores() {
        console.log('开始保存评分信息');
        
        // 检查是否有编辑权限
        if (!hasEditPermission) {
            if (typeof toast === 'function') {
                toast('您没有编辑权限，无法保存评分信息', 'error');
            } else {
                alert('您没有编辑权限，无法保存评分信息');
            }
            return;
        }
        
        // 创建评分数据对象
        const projectId = document.getElementById('project_id').value;
        const scoreData = {
            project_id: projectId,
            level: '{{ current_level }}',
            specialty: '{{ current_specialty }}',
            scores: []
        };
        
        console.log('准备保存评分数据:', scoreData);
        
        // 根据评价等级获取不同的评分数据
        if ('{{ current_level }}' === '基本级') {
            // 获取所有基本级的数据
            const selects = document.querySelectorAll('.is-achieved-select');
            console.log(`找到 ${selects.length} 个基本级选择框`);
            
            selects.forEach(select => {
                const clause = select.dataset.clause;
                const isAchieved = select.value;
                const technicalMeasures = document.querySelector(`textarea[data-clause="${clause}"]`).value;
                
                scoreData.scores.push({
                    clause_number: clause,
                    is_achieved: isAchieved,
                    technical_measures: technicalMeasures
                });
            });
        } else if ('{{ current_level }}' === '提高级') {
            // 获取所有提高级的数据
            const scoreInputs = document.querySelectorAll('input[name="score"]');
            console.log(`找到 ${scoreInputs.length} 个提高级输入框`);
            
            scoreInputs.forEach(input => {
                const clause = input.dataset.clause;
                const maxScore = input.dataset.maxscore;
                let score = input.value.trim();
                
                // 如果没有填写得分，默认为0
                if (score === '') score = '0';
                
                // 验证得分是否超过最大值
                if (parseFloat(score) > parseFloat(maxScore)) {
                    if (typeof toast === 'function') {
                        toast(`条文${clause}的得分不能超过最大分值${maxScore}`, 'warning');
                    } else {
                        alert(`条文${clause}的得分不能超过最大分值${maxScore}`);
                    }
                    input.focus();
                    return;
                }
                
                const textarea = document.querySelector(`textarea[data-clause="${clause}"]`);
                let technicalMeasures = '';
                
                if (textarea) {
                    technicalMeasures = textarea.value;
                } else {
                    console.warn(`未找到条文 ${clause} 的技术措施输入框`);
                }
                
                scoreData.scores.push({
                    clause_number: clause,
                    score: score,
                    max_score: maxScore,
                    technical_measures: technicalMeasures
                });
                
                console.log(`添加评分数据: 条文=${clause}, 得分=${score}, 最大分值=${maxScore}`);
            });
        }
        
        console.log(`即将发送的评分数据: ${scoreData.scores.length}条记录`);
        
        // 发送数据到服务器
        fetch('/api/save_score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(scoreData)
        })
        .then(response => {
            console.log('服务器响应状态:', response.status);
            
            if (!response.ok) {
                throw new Error('保存失败: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('服务器响应数据:', data);
            
            if (data.success) {
                // 提示保存成功，但不使用阻塞性的alert，改用非阻塞通知
                if (typeof toast === 'function') {
                    toast('评分信息保存成功!', 'success');
                } else {
                    // 使用非阻塞通知
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    notification.textContent = '评分信息保存成功!';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                }
                
                // 刷新评分汇总
                if (typeof scoreUtils !== 'undefined' && scoreUtils.fetchScoreSummary) {
                    console.log('刷新评分汇总');
                    scoreUtils.fetchScoreSummary();
                }
                
                // 更新分类达标徽章状态
                if ('{{ current_level }}' === '提高级' && typeof updateCategoryBadges === 'function') {
                    console.log('更新分类达标徽章');
                    setTimeout(updateCategoryBadges, 1000);
                }
                
                // 不再重新加载评分数据，保留用户当前输入的内容
                console.log('保留用户当前输入的内容，不重新加载');
                
                // 如果用户刷新页面，确保能正确加载数据
                // 添加记忆保存成功的标记
                sessionStorage.setItem('scores_saved_successfully', 'true');
                sessionStorage.setItem('last_saved_project', projectId);
            } else {
                // 保存失败时提示
                const errorMsg = data.message || '保存失败';
                console.error('保存失败:', errorMsg);
                if (typeof toast === 'function') {
                    toast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        })
        .catch(error => {
            console.error('保存失败:', error);
            if (typeof toast === 'function') {
                toast('保存失败，请重试: ' + error.message, 'error');
            } else {
                alert('保存失败，请重试: ' + error.message);
            }
        });
    }
    
    /**
     * 加载保存的评分信息
     * @param {boolean} forceRefresh - 是否强制刷新数据
     */
    function loadScores(forceRefresh = false) {
        const projectId = document.getElementById('project_id').value;
        if (!projectId) {
            console.warn('项目ID为空，无法加载评分数据');
            return;
        }
        
        console.log('开始加载评分数据，项目ID:', projectId, '强制刷新:', forceRefresh);
        
        try {
            console.log('使用/api/project_scores端点');
            
            const url = `/api/project_scores?project_id=${projectId}&level={{ current_level }}&specialty={{ current_specialty }}&force_refresh=${forceRefresh}`;
            
            console.log('请求URL:', url);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        console.error('API响应错误:', response.status, response.statusText);
                        throw new Error('获取数据失败: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('加载的评分数据:', data);
                    // 修改解析数据的方式，以匹配新API的返回格式
                    if (data.success && data.sample_scores && Array.isArray(data.sample_scores)) {
                        // 获取页面上所有的输入元素
                        const allInputs = document.querySelectorAll('input[name="score"]');
                        const allTextareas = document.querySelectorAll('textarea[name="technical_measures"]');
                        
                        console.log(`页面上共有 ${allInputs.length} 个得分输入框和 ${allTextareas.length} 个技术措施输入框`);
                        
                        // 用于统计处理结果
                        let successCount = 0;
                        let failCount = 0;
                        
                        // 构建条文号映射表 - 更高效的查找
                        const formInputsByClause = {};
                        const formTextareasByClause = {};
                        
                        allInputs.forEach(input => {
                            if (input.dataset.clause) {
                                formInputsByClause[input.dataset.clause] = input;
                                // 也为规范化后的条文号建立映射
                                const normalizedClause = input.dataset.clause.replace(/[^\d\.]/g, '');
                                if (normalizedClause) {
                                    formInputsByClause[normalizedClause] = input;
                                }
                            }
                        });
                        
                        allTextareas.forEach(textarea => {
                            if (textarea.dataset.clause) {
                                formTextareasByClause[textarea.dataset.clause] = textarea;
                                // 也为规范化后的条文号建立映射
                                const normalizedClause = textarea.dataset.clause.replace(/[^\d\.]/g, '');
                                if (normalizedClause) {
                                    formTextareasByClause[normalizedClause] = textarea;
                                }
                            }
                        });
                        
                        // 填充表格 - 注意：从sample_scores字段提取数据
                        data.sample_scores.forEach(item => {
                            try {
                                // 获取条文号
                                const clause = item.clause_number;
                                
                                if (!clause) {
                                    console.warn('无法提取条文号:', item);
                                    failCount++;
                                    return; // 跳过无条文号的数据
                                }
                                
                                // 规范化条文号
                                const normalizedClause = clause.replace(/[^\d\.]/g, '');
                                
                                // 尝试查找对应的表单元素
                                let scoreInput = formInputsByClause[clause] || 
                                                formInputsByClause[normalizedClause];
                                                
                                let techTextarea = formTextareasByClause[clause] || 
                                                   formTextareasByClause[normalizedClause];
                                
                                // 如果没找到，尝试在页面中查找
                                if (!scoreInput) {
                                    scoreInput = document.querySelector(`input[name="score"][data-clause="${clause}"]`);
                                }
                                
                                if (!techTextarea) {
                                    techTextarea = document.querySelector(`textarea[data-clause="${clause}"]`);
                                }
                                
                                // 填充得分
                                if (scoreInput) {
                                    const score = item.score !== undefined && item.score !== null ? item.score : '0';
                                    scoreInput.value = score;
                                    successCount++;
                                } else {
                                    console.warn(`未能找到条文 ${clause} 对应的得分输入框`);
                                    failCount++;
                                }
                                
                                // 填充技术措施
                                if (techTextarea) {
                                    techTextarea.value = item.technical_measures || '';
                                } else {
                                    console.warn(`未能找到条文 ${clause} 对应的技术措施输入框`);
                                }
                            } catch (error) {
                                console.error(`处理条文数据项时发生错误:`, error, item);
                                failCount++;
                            }
                        });
                        
                        console.log(`评分数据加载完成: 成功 ${successCount} 项, 失败 ${failCount} 项`);
                    } else {
                        console.warn('没有找到保存的评分数据:', data.message || '未知错误');
                    }
                })
                .catch(error => {
                    console.error('加载评分数据失败:', error);
                    if (typeof toast === 'function') {
                        toast('加载评分数据失败: ' + error.message, 'error');
                    }
                });
        } catch (error) {
            console.error('加载过程发生异常:', error);
            if (typeof toast === 'function') {
                toast('加载过程发生异常:' + error.message, 'error');
            }
        }
    }
    
    /**
     * 加载用户的项目权限
     */
    function loadUserPermissionsForStandards() {
        const projectId = document.getElementById('project_id').value;
        if (!projectId) {
            console.warn('项目ID为空，无法获取权限');
            return;
        }
        
        console.log('正在加载项目权限，项目ID:', projectId);
        
        fetch(`/api/projects/${projectId}/permissions`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    userPermissions = data.permissions;
                    console.log('获取到用户权限:', userPermissions);
                    
                    // 检查是否有编辑权限
                    const role = userPermissions.role;
                    const permissions = userPermissions.permissions;
                    
                    // 创建者或具有"管理"权限的用户可以编辑
                    if (role === '创建者' || permissions === '管理' || permissions === '编辑') {
                        hasEditPermission = true;
                    } else {
                        hasEditPermission = false;
                    }
                    
                    // 更新UI
                    updateUIBasedOnPermissions();
                    
                    // 显示权限提示
                    showPermissionIndicator();
                } else {
                    console.warn('获取权限失败:', data.error);
                    hasEditPermission = false;
                    updateUIBasedOnPermissions();
                }
            })
            .catch(error => {
                console.error('获取用户权限失败:', error);
                hasEditPermission = false;
                updateUIBasedOnPermissions();
            });
    }
    
    /**
     * 基于权限更新UI
     */
    function updateUIBasedOnPermissions() {
        // 获取所有输入元素
        const scoreInputs = document.querySelectorAll('.score-input');
        const technicalMeasures = document.querySelectorAll('.technical-measures');
        const achievedSelects = document.querySelectorAll('.is-achieved-select');
        const saveButtons = document.querySelectorAll('#saveScoreBtn, #floatingSaveBtn button');
        
        if (!hasEditPermission) {
            // 禁用所有输入元素
            scoreInputs.forEach(input => {
                input.disabled = true;
                input.classList.add('bg-gray-100');
                input.classList.add('cursor-not-allowed');
            });
            
            technicalMeasures.forEach(textarea => {
                textarea.disabled = true;
                textarea.classList.add('bg-gray-100');
                textarea.classList.add('cursor-not-allowed');
            });
            
            achievedSelects.forEach(select => {
                select.disabled = true;
                select.classList.add('bg-gray-100');
                select.classList.add('cursor-not-allowed');
            });
            
            // 禁用保存按钮
            saveButtons.forEach(button => {
                button.disabled = true;
                button.classList.add('opacity-50');
                button.classList.add('cursor-not-allowed');
            });
        } else {
            // 启用所有输入元素
            scoreInputs.forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-100');
                input.classList.remove('cursor-not-allowed');
            });
            
            technicalMeasures.forEach(textarea => {
                textarea.disabled = false;
                textarea.classList.remove('bg-gray-100');
                textarea.classList.remove('cursor-not-allowed');
            });
            
            achievedSelects.forEach(select => {
                select.disabled = false;
                select.classList.remove('bg-gray-100');
                select.classList.remove('cursor-not-allowed');
            });
            
            // 启用保存按钮
            saveButtons.forEach(button => {
                button.disabled = false;
                button.classList.remove('opacity-50');
                button.classList.remove('cursor-not-allowed');
            });
        }
    }
    
    /**
     * 显示权限提示
     */
    function showPermissionIndicator() {
        if (!userPermissions) return;
        
        // 检查是否已存在权限提示
        let permissionIndicator = document.getElementById('permission-indicator');
        if (!permissionIndicator) {
            permissionIndicator = document.createElement('div');
            permissionIndicator.id = 'permission-indicator';
            permissionIndicator.className = 'fixed top-4 right-4 px-3 py-2 rounded-lg shadow-md z-50 flex items-center space-x-2 text-sm';
            document.body.appendChild(permissionIndicator);
        }
        
        const role = userPermissions.role;
        const permissions = userPermissions.permissions;
        
        // 设置样式和内容
        if (!hasEditPermission) {
            permissionIndicator.className = 'fixed top-4 right-4 px-3 py-2 rounded-lg shadow-md z-50 flex items-center space-x-2 text-sm bg-amber-100 text-amber-800 border border-amber-200';
            permissionIndicator.innerHTML = `
                <i class="fas fa-lock"></i>
                <span>只读模式 (角色: ${role}, 权限: ${permissions})</span>
            `;
        } else {
            permissionIndicator.className = 'fixed top-4 right-4 px-3 py-2 rounded-lg shadow-md z-50 flex items-center space-x-2 text-sm bg-green-100 text-green-800 border border-green-200';
            permissionIndicator.innerHTML = `
                <i class="fas fa-edit"></i>
                <span>编辑模式 (角色: ${role}, 权限: ${permissions})</span>
            `;
        }
    }
</script>