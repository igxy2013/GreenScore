<!-- PDF查看器组件 -->
<div id="pdf-viewer-container" class="hidden">
    <div class="pdf-viewer-header flex justify-between items-center p-3 bg-indigo-900 text-white">
        <h3 id="current-pdf-title" class="text-lg font-medium truncate">规范文件</h3>
        <div class="flex space-x-3">
            <select id="pdf-file-selector" class="bg-indigo-800 border border-indigo-700 text-white rounded px-2 py-1 text-sm">
                <option value="">选择规范文件</option>
                <!-- PDF文件选项将通过JavaScript动态添加 -->
            </select>
            <button id="prev-page" class="px-2 py-1 bg-indigo-700 rounded hover:bg-indigo-600 text-sm">
                <i class="ri-arrow-left-line"></i> 上一页
            </button>
            <div class="flex items-center space-x-1">
                <input id="current-page" type="number" class="w-12 bg-indigo-800 border border-indigo-700 text-white rounded text-center" value="1">
                <span>/</span>
                <span id="total-pages">0</span>
            </div>
            <button id="next-page" class="px-2 py-1 bg-indigo-700 rounded hover:bg-indigo-600 text-sm">
                下一页 <i class="ri-arrow-right-line"></i>
            </button>
            <div class="flex items-center space-x-1">
                <button id="zoom-out" class="px-2 py-1 bg-indigo-700 rounded hover:bg-indigo-600 text-sm">
                    <i class="ri-zoom-out-line"></i>
                </button>
                <select id="zoom-level" class="bg-indigo-800 border border-indigo-700 text-white rounded px-2 py-1 text-sm">
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1" selected>100%</option>
                    <option value="1.25">125%</option>
                    <option value="1.5">150%</option>
                    <option value="2">200%</option>
                </select>
                <button id="zoom-in" class="px-2 py-1 bg-indigo-700 rounded hover:bg-indigo-600 text-sm">
                    <i class="ri-zoom-in-line"></i>
                </button>
            </div>
            <button id="close-pdf-viewer" class="px-2 py-1 bg-red-600 rounded hover:bg-red-500 text-sm">
                <i class="ri-close-line"></i> 关闭
            </button>
        </div>
    </div>
    <div id="pdf-viewer-content" class="bg-gray-900 flex justify-center overflow-auto" style="height: calc(100vh - 180px);">
        <canvas id="pdf-canvas"></canvas>
    </div>
</div>

<!-- PDF查看器脚本 -->
<script>
// 从侧边栏菜单打开PDF查看器的函数
function openPDFViewer() {
    // 如果pdfViewer实例已存在，则显示它
    if (window.pdfViewer) {
        window.pdfViewer.container.classList.remove('hidden');
        // 如果没有加载PDF，默认加载第一个
        if (!window.pdfViewer.pdfDoc && window.pdfViewer.pdfFiles.length > 0) {
            window.pdfViewer.pdfFileSelector.value = "0";
            window.pdfViewer.loadPDF(window.pdfViewer.pdfFiles[0]);
        }
    } else {
        console.error('PDF查看器未初始化');
        // 尝试初始化
        window.pdfViewer = new PDFViewer();
    }
}

// 确保PDF.js库已加载
function loadPDFJS() {
    return new Promise((resolve, reject) => {
        if (window.pdfjsLib) {
            resolve();
            return;
        }
        
        // 加载PDF.js库
        const pdfScript = document.createElement('script');
        pdfScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        pdfScript.integrity = 'sha512-q+4lTde3RFqhOLr3ZHZdBaEP50aECnGRGGzLuVGijQlBjCnpT2PJY5nOR9dqYnY0hJQvOyA9xXGaxuWBVOiO5w==';
        pdfScript.crossOrigin = 'anonymous';
        pdfScript.referrerPolicy = 'no-referrer';
        
        pdfScript.onload = () => {
            // 设置worker路径
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            resolve();
        };
        
        pdfScript.onerror = () => {
            reject(new Error('无法加载PDF.js库'));
        };
        
        document.head.appendChild(pdfScript);
    });
}

// PDF查看器类
class PDFViewer {
    constructor() {
        this.pdfDoc = null;
        this.currentPage = 1;
        this.scale = 1.0;
        this.canvas = document.getElementById('pdf-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.container = document.getElementById('pdf-viewer-container');
        this.currentPDFTitle = document.getElementById('current-pdf-title');
        this.pdfFileSelector = document.getElementById('pdf-file-selector');
        this.currentPageInput = document.getElementById('current-page');
        this.totalPagesSpan = document.getElementById('total-pages');
        this.zoomLevelSelect = document.getElementById('zoom-level');
        
        // 规范文件列表 (示例数据，后续可通过API获取)
        this.pdfFiles = [
            { title: '绿色建筑评价标准GB/T50378-2019', path: '/static/pdf/GB50378-2019.pdf' },
            { title: '四川省绿色建筑评价标准DBJ51/T005-2020', path: '/static/pdf/DBJ51T005-2020.pdf' },
            { title: '成都市绿色建筑评价标准CDCSF01-2020', path: '/static/pdf/CDCSF01-2020.pdf' }
        ];
        
        this.init();
    }
    
    async init() {
        try {
            await loadPDFJS();
            this.populatePDFSelector();
            this.bindEvents();
            console.log('PDF查看器初始化完成');
        } catch (error) {
            console.error('PDF查看器初始化失败:', error);
        }
    }
    
    populatePDFSelector() {
        // 清空现有选项（保留第一个默认选项）
        this.pdfFileSelector.innerHTML = '<option value="">选择规范文件</option>';
        
        // 添加PDF文件选项
        this.pdfFiles.forEach((file, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = file.title;
            this.pdfFileSelector.appendChild(option);
        });
    }
    
    bindEvents() {
        // 文件选择变化
        this.pdfFileSelector.addEventListener('change', (e) => {
            const selectedIndex = parseInt(e.target.value);
            if (!isNaN(selectedIndex) && selectedIndex >= 0) {
                this.loadPDF(this.pdfFiles[selectedIndex]);
            }
        });
        
        // 页面导航
        document.getElementById('prev-page').addEventListener('click', () => this.prevPage());
        document.getElementById('next-page').addEventListener('click', () => this.nextPage());
        this.currentPageInput.addEventListener('change', (e) => {
            const pageNum = parseInt(e.target.value);
            if (pageNum && pageNum > 0 && pageNum <= this.pdfDoc.numPages) {
                this.currentPage = pageNum;
                this.renderPage();
            } else {
                e.target.value = this.currentPage;
            }
        });
        
        // 缩放控制
        document.getElementById('zoom-in').addEventListener('click', () => this.zoomIn());
        document.getElementById('zoom-out').addEventListener('click', () => this.zoomOut());
        this.zoomLevelSelect.addEventListener('change', (e) => {
            this.scale = parseFloat(e.target.value);
            this.renderPage();
        });
        
        // 关闭查看器
        document.getElementById('close-pdf-viewer').addEventListener('click', () => {
            this.container.classList.add('hidden');
        });
    }
    
    async loadPDF(pdfFile) {
        try {
            // 显示加载中状态
            this.currentPDFTitle.textContent = `加载中: ${pdfFile.title}`;
            
            // 加载PDF文档
            const loadingTask = pdfjsLib.getDocument(pdfFile.path);
            this.pdfDoc = await loadingTask.promise;
            
            // 更新UI
            this.currentPage = 1;
            this.currentPDFTitle.textContent = pdfFile.title;
            this.totalPagesSpan.textContent = this.pdfDoc.numPages;
            this.currentPageInput.value = this.currentPage;
            this.currentPageInput.max = this.pdfDoc.numPages;
            
            // 渲染第一页
            this.renderPage();
            
            // 显示查看器
            this.container.classList.remove('hidden');
        } catch (error) {
            console.error('加载PDF失败:', error);
            alert(`无法加载PDF文件: ${pdfFile.title}`);
        }
    }
    
    async renderPage() {
        if (!this.pdfDoc) return;
        
        try {
            const page = await this.pdfDoc.getPage(this.currentPage);
            
            // 根据缩放比例计算视口
            const viewport = page.getViewport({ scale: this.scale });
            
            // 设置canvas尺寸
            this.canvas.height = viewport.height;
            this.canvas.width = viewport.width;
            
            // 渲染PDF页面
            const renderContext = {
                canvasContext: this.ctx,
                viewport: viewport
            };
            
            await page.render(renderContext).promise;
            
            // 更新当前页码输入框
            this.currentPageInput.value = this.currentPage;
        } catch (error) {
            console.error('渲染PDF页面失败:', error);
        }
    }
    
    prevPage() {
        if (this.currentPage > 1) {
            this.currentPage--;
            this.renderPage();
        }
    }
    
    nextPage() {
        if (this.pdfDoc && this.currentPage < this.pdfDoc.numPages) {
            this.currentPage++;
            this.renderPage();
        }
    }
    
    zoomIn() {
        this.scale += 0.25;
        if (this.scale > 3) this.scale = 3;
        this.updateZoomLevel();
        this.renderPage();
    }
    
    zoomOut() {
        this.scale -= 0.25;
        if (this.scale < 0.5) this.scale = 0.5;
        this.updateZoomLevel();
        this.renderPage();
    }
    
    updateZoomLevel() {
        // 更新缩放选择器
        const zoomOption = Array.from(this.zoomLevelSelect.options).find(option => 
            Math.abs(parseFloat(option.value) - this.scale) < 0.01
        );
        
        if (zoomOption) {
            this.zoomLevelSelect.value = zoomOption.value;
        } else {
            // 如果没有匹配的预设缩放级别，添加一个自定义选项
            const customOption = document.createElement('option');
            customOption.value = this.scale.toString();
            customOption.textContent = `${Math.round(this.scale * 100)}%`;
            this.zoomLevelSelect.appendChild(customOption);
            this.zoomLevelSelect.value = this.scale.toString();
        }
    }
}

// 初始化PDF查看器
document.addEventListener('DOMContentLoaded', () => {
    window.pdfViewer = new PDFViewer();
});
</script> 