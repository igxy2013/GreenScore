<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能绿建评价系统</title>
    
    <!-- 先加载Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- 加载loader.js -->
    <script src="{{ url_for('static', filename='js/loader.js') }}"></script>
    <!-- 加载气候区划查询工具 -->
    <script src="{{ url_for('static', filename='js/climate_zone.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.min.css') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='image/greenscore-sm.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='image/greenscore-32.png') }}">
    <link rel="icon" type="image/png" sizes="48x48" href="{{ url_for('static', filename='image/greenscore.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='image/greenscore-lg.png') }}">
    
    <!-- 绿色建材计算所需的外部库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" defer></script>
    <script src="/static/js/green_building_score_calculator.js"></script>
    <!-- 在 head 部分添加对 db_updater.js 的引用 -->
    <script src="/static/js/db_updater.js"></script>
     <!-- 使用Font Awesome图标库 -->
     <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
     <style>
     /* 图标样式兼容处理 */
     [class^="ri-"], [class*=" ri-"] {
         display: inline-block;
         font-style: normal;
         font-variant: normal;
         text-rendering: auto;
         line-height: 1;
         font-family: "Font Awesome 5 Free";
         font-weight: 900;
     }
 
     /* 定义图标映射关系 */
     .ri-add-line:before { content: "\f067"; }                    /* fa-plus */
     .ri-delete-bin-line:before { content: "\f2ed"; }            /* fa-trash-alt */
     .ri-edit-line:before { content: "\f044"; }                  /* fa-edit */
     .ri-search-line:before { content: "\f002"; }                /* fa-search */
     .ri-menu-line:before { content: "\f0c9"; }                  /* fa-bars */
     .ri-settings-line:before { content: "\f013"; }              /* fa-cog */
     .ri-user-line:before { content: "\f007"; }                  /* fa-user */
     .ri-home-line:before { content: "\f015"; }                  /* fa-home */
     .ri-arrow-down-s-line:before { content: "\f107"; }          /* fa-angle-down */
     .ri-arrow-up-s-line:before { content: "\f106"; }            /* fa-angle-up */
     .ri-close-line:before { content: "\f00d"; }                 /* fa-times */
     .ri-check-line:before { content: "\f00c"; }                 /* fa-check */
     .ri-information-line:before { content: "\f129"; }           /* fa-info */
     .ri-file-list-line:before { content: "\f15c"; }             /* fa-file-alt */
     .ri-calendar-line:before { content: "\f133"; }              /* fa-calendar */
     .ri-save-line:before { content: "\f0c7"; }                  /* fa-save */
     .ri-upload-line:before { content: "\f093"; }                /* fa-cloud-upload-alt */
     .ri-download-line:before { content: "\f019"; }              /* fa-download */
     .ri-refresh-line:before { content: "\f2f1"; }               /* fa-sync */
     .ri-loader-2-line:before { content: "\f110"; }             /* fa-spinner */
     .ri-arrow-left-line:before { content: "\f060"; }           /* fa-arrow-left */
     .ri-star-fill:before { content: "\f005"; }                  /* fa-star */
     .ri-close-circle-fill:before { content: "\f057"; }          /* fa-times-circle */
     .ri-bar-chart-line:before { content: "\f080"; }             /* fa-chart-bar */
     .ri-file-download-line:before { content: "\f56d"; }         /* fa-file-download */
     .ri-calculator-line:before { content: "\f1ec"; }            /* fa-calculator */
     .ri-building-line:before { content: "\f1ad"; }              /* fa-building */
     .ri-layout-2-line:before { content: "\f0db"; }              /* fa-columns */
     .ri-drop-line:before { content: "\f043"; }                  /* fa-tint */
     .ri-flashlight-line:before { content: "\f0eb"; }            /* fa-lightbulb */
     .ri-temp-hot-line:before { content: "\f2c7"; }             /* fa-thermometer-full */
     .ri-plant-line:before { content: "\f4d8"; }                 /* fa-seedling */
     .ri-checkbox-line:before { content: "\f0c8"; }              /* fa-square */
     .ri-checkbox-multiple-line:before { content: "\f14a"; }     /* fa-check-square */
     .ri-leaf-line:before { content: "\f06c"; }                  /* fa-leaf */
     .ri-file-list-3-line:before { content: "\f15c"; }          /* fa-file-alt */
     .ri-book-line:before { content: "\f02d"; }                  /* fa-book */
 
     /* 添加动画效果 */
     .fa-spin {
         animation: fa-spin 2s infinite linear;
     }
     @keyframes fa-spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
     }
     
     input[type="number"]::-webkit-inner-spin-button,
     input[type="number"]::-webkit-outer-spin-button {
         -webkit-appearance: none;
         margin: 0;
     }
     
     /* 用户菜单样式 */
     .user-icon {
         position: fixed;
         left: 20px;
         bottom: 20px;
         z-index: 60;
         width: 42px;
         height: 42px;
         background-color: white;
         border-radius: 50%;
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         transition: all 0.2s;
     }
     
     .user-icon:hover {
         transform: scale(1.05);
         box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
     }
     
     .user-menu {
         position: fixed;
         bottom: 60px;
         left: 20px;
         background: white;
         border-radius: 8px;
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
         z-index: 100;
         min-width: 200px;
         opacity: 0;
         transform: scale(0.9);
         transform-origin: top right;
         transition: all 0.2s ease;
         pointer-events: none;
     }
     
     .user-menu.active {
         opacity: 1;
         transform: scale(1);
         pointer-events: auto;
     }
    </style>
    <style>
        .page-container {
            min-width: 1024px;
            overflow-x: auto;
        }
        .main-content {
            margin-left: 18rem; /* 与左侧导航栏宽度一致 */
            width: calc(100% - 18rem);
            min-width: 768px;
        }
        /* 添加输入框和选择框的边框样式 */
        .is-achieved-select,
        .technical-measures,
        input[name="score"] {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        .is-achieved-select:focus,
        .technical-measures:focus,
        input[name="score"]:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
        }
        /* 提高级技术措施列样式 */
        .technical-measures-cell {
            width: 300px;
            min-width: 300px;
            max-width: 500px;
        }
        .technical-measures {
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }
        /* 进度条样式 */
        .submenu-item.loading {
            position: relative;
            overflow: hidden;
        }
        
        .submenu-item.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background-color: rgba(79, 209, 197, 0.3);
            transition: width 0.1s linear;
            z-index: 0;
        }
        
        .submenu-item.loading > * {
            position: relative;
            z-index: 1;
        }
        
        /* 评分汇总菜单进度条样式 */
        .menu-item.loading {
            position: relative;
            overflow: hidden;
        }
        
        /* 移除伪元素定义，改用背景图像实现进度条 */
        
        .menu-item.loading > * {
            position: relative;
            z-index: 1;
        }
        
        /* 添加图标旋转动画 */
        .menu-item.loading .ri-bar-chart-line {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    <style>
        /* 省市选择器加载平滑过渡 */
        .province-city-container select {
            min-width: 100px; /* 确保最小宽度 */
            transition: all 0.2s ease; /* 平滑过渡效果 */
            height: 42px; /* 固定高度 */
        }
    </style>
    <script>
    function filterTableByClause(query) {
        // 获取所有表格行
        const rows = document.querySelectorAll('table tbody tr');
        
        // 如果查询为空，显示所有行
        if (!query.trim()) {
            rows.forEach(row => row.style.display = '');
            return;
        }
        
        // 遍历每一行进行过滤
        rows.forEach(row => {
            // 获取条文号列的内容
            const clauseCell = row.querySelector('td:first-child');
            if (clauseCell) {
                const clauseText = clauseCell.textContent.toLowerCase();
                // 如果条文号包含查询文本，显示该行，否则隐藏
                if (clauseText.includes(query.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }
    </script>
    <style>
        /* 移除伪元素定义，改用背景图像实现进度条 */
        
        /* 分类过滤器按钮样式 */
        .category-filter {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .category-filter.active {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            font-weight: 600;
            transform: translateY(-1px);
        }
    </style>
    <style>
        /* 添加悬浮徽章样式 */
        .floating-badge {
            position: fixed;
            right: 20px;
            top: 80px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 12px;
            z-index: 50;
            width: auto;
            min-width: 160px;
            max-width: 200px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-badge:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .badge-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95rem;
        }

        .category-badges {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .category-badge {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: white;
            transition: all 0.2s ease;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .category-badge::before {
            content: '';
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .category-badge:hover::before {
            opacity: 1;
        }

        .category-badge.not-achieved {
            background-color: #f87171;
        }

        .category-badge.achieved {
            background-color: #34d399;
        }

        .category-badge.active {
            outline: 2px solid #4f46e5;
            outline-offset: 1px;
        }

        .badge-content {
            max-height: 500px;
            opacity: 1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .badge-content.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .toggle-badge {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }

        .toggle-badge:hover {
            background-color: #f3f4f6;
        }

        .toggle-badge i {
            transition: transform 0.3s ease;
            font-size: 0.85rem;
        }

        /* 响应式样式 */
        @media (min-width: 1280px) {
            .floating-badge {
                min-width: 180px;
                max-width: 220px;
                padding: 16px;
            }

            .badge-title {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }

            .category-badges {
                gap: 8px;
            }

            .category-badge {
                padding: 8px 12px;
                font-size: 1rem;
                border-radius: 8px;
            }

            .toggle-badge {
                padding: 6px;
            }

            .toggle-badge i {
                font-size: 1rem;
            }
        }

        @media (max-width: 768px) {
            .floating-badge {
                right: 10px;
                top: 70px;
                min-width: 140px;
                padding: 10px;
            }
            
            .category-badge {
                font-size: 0.8rem;
                padding: 5px 8px;
            }
        }
    </style>
    <style>
@keyframes bounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-6px);
    }
}

.bounce-animation {
    animation: bounce 2s ease-in-out infinite;
}

.bounce-animation:hover {
    animation-play-state: paused;
}

.ai-icon {
    animation: shake 3s ease infinite;
}

@keyframes shake {
    0%, 100% { transform: rotate(0deg); }
    20% { transform: rotate(-10deg); }
    40% { transform: rotate(10deg); }
    60% { transform: rotate(-5deg); }
    80% { transform: rotate(5deg); }
}

.ai-pulse {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0) 0%, 
        rgba(255, 255, 255, 0.2) 50%, 
        rgba(255, 255, 255, 0) 100%);
    opacity: 0;
    z-index: 1;
    pointer-events: none;
    animation: wave 2s infinite;
}

@keyframes wave {
    0% {
        transform: translateX(-100%);
        opacity: 0;
    }
    50% {
        opacity: 0.5;
    }
    100% {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes float {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.ai-extract-btn {
    animation: float 2s ease-in-out infinite;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4), 0 0 20px rgba(139, 92, 246, 0.2);
    transition: all 0.3s cubic-bezier(0.215, 0.61, 0.355, 1);
}

.ai-extract-btn:hover {
    animation-play-state: paused;
    transform: scale(1.05);
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.6);
}

.ai-icon {
    animation: shake 3s ease infinite;
}

@keyframes shake {
    0%, 100% { transform: rotate(0deg); }
    20% { transform: rotate(-10deg); }
    40% { transform: rotate(10deg); }
    60% { transform: rotate(-5deg); }
    80% { transform: rotate(5deg); }
}

.ai-pulse {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0) 0%, 
        rgba(255, 255, 255, 0.2) 50%, 
        rgba(255, 255, 255, 0) 100%);
    opacity: 0;
    z-index: 1;
    pointer-events: none;
    animation: wave 2s infinite;
}

@keyframes wave {
    0% {
        transform: translateX(-100%);
        opacity: 0;
    }
    50% {
        opacity: 0.5;
    }
    100% {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
    <style>
        .detail-table {
            table-layout: fixed !important;
            width: 100% !important;
        }
        .detail-table td {
            width: 16.66% !important;
        }
        .detail-table input,
        .detail-table select {
            width: 100% !important;
            box-sizing: border-box !important;
        }
    </style>
    <!-- 添加climate_zone.js引用，放在页面头部的script标签之前 -->
    <script src="{{ url_for('static', filename='js/climate_zone.js') }}"></script>
    <script>
        // 页面变量
        // ... existing code ...
    </script>
</head>
<body class="bg-gray-100">

    
    <!-- 隐藏字段，用于存储当前项目ID和标准 -->
    <input type="hidden" id="current-project-id" value="{{ project.id if project else '21' }}">
    <input type="hidden" id="current-project-standard" value="{{ project.standard if project else '成都市标' }}">
    
    <script>
        // 用户菜单相关的JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const userIcon = document.getElementById('userIcon');
            const userMenu = document.getElementById('userMenu');
            const userProfileBtn = document.getElementById('userProfileBtn');
            const contactUsBtn = document.getElementById('contactUsBtn');
            const avatarModal = document.getElementById('avatarModal');
            const contactModal = document.getElementById('contactModal');
            const avatarInput = document.getElementById('avatarInput');
            const avatarPreview = document.getElementById('avatarPreview');
            const defaultAvatar = document.getElementById('defaultAvatar');

            if (userIcon && userMenu) {
                // 点击用户图标显示菜单
                userIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userMenu.classList.toggle('active');
                    console.log('用户图标被点击'); // 添加调试日志
                });

                // 点击用户信息显示头像上传模态框
                if (userProfileBtn) {
                    userProfileBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        userMenu.classList.remove('active');
                        avatarModal.classList.remove('hidden');
                    });
                }



                // 头像预览
                if (avatarInput) {
                    avatarInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                avatarPreview.src = e.target.result;
                                avatarPreview.classList.remove('hidden');
                                defaultAvatar.classList.add('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }

                // 关闭模态框
                window.closeAvatarModal = function() {
                    if (avatarModal) {
                        avatarModal.classList.add('hidden');
                        if (avatarInput) {
                            avatarInput.value = '';
                        }
                        if (avatarPreview) {
                            avatarPreview.classList.add('hidden');
                        }
                        if (defaultAvatar) {
                            defaultAvatar.classList.remove('hidden');
                        }
                    }
                };



                // 点击页面其他区域关闭菜单和模态框
                document.addEventListener('click', function(e) {
                    if (!userMenu.contains(e.target) && !userIcon.contains(e.target)) {
                        userMenu.classList.remove('active');
                    }
                    if (avatarModal && !avatarModal.querySelector('.bg-white').contains(e.target)) {
                        closeAvatarModal();
                    }

                });
            }
        });
    </script>
    
    <div class="page-container">
        <div class="flex min-h-screen">
            <!-- 侧边导航栏 -->
            <aside class="w-72 bg-white shadow-lg fixed h-screen overflow-y-auto z-10">
                <div class="p-6 border-b">
                    <h1 class="text-2xl font-bold text-primary flex items-center">                
                        <picture>
                            <source srcset="{{ url_for('static', filename='image/greenscore@3x.png') }}" media="(-webkit-min-device-pixel-ratio: 3), (min-resolution: 288dpi)">
                            <source srcset="{{ url_for('static', filename='image/greenscore@2x.png') }}" media="(-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi)">
                            <img src="{{ url_for('static', filename='image/greenscore.png') }}" alt="logo" class="inline-block h-8 w-8 mr-2">
                        </picture>
                        <span>智能绿建评价系统</span>
                    </h1>
                    </div>
                <nav class="p-4">
                    <div class="space-y-3">
                        <a href="{{ url_for('project_detail', project_id=project.id) }}" class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50 {% if current_page == 'project_info' %}active{% endif %}">
                            <i class="ri-file-list-line mr-3"></i>
                            <span>项目信息</span>
                        </a>
                        <div class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50" id="basicMenuToggle">
                            <i class="ri-checkbox-line mr-3"></i>
                            <span>基本级</span>
                            <i class="ri-arrow-down-s-line ml-auto"></i>
                        </div>
                        <div id="basicMenuContent" class="menu-content">
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='建筑', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '建筑' %}active{% endif %}">
                                    <i class="ri-building-line mr-3"></i>
                                <span>建筑</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='结构', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '结构' %}active{% endif %}">
                                <i class="ri-layout-2-line mr-3"></i>
                                <span>结构</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='给排水', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '给排水' %}active{% endif %}">
                                <i class="ri-drop-line mr-3"></i>
                                <span>给排水</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='电气', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '电气' %}active{% endif %}">
                                <i class="ri-flashlight-line mr-3"></i>
                                <span>电气</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='暖通', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '暖通' %}active{% endif %}">
                                <i class="ri-temp-hot-line mr-3"></i>
                                <span>暖通</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='景观', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '景观' %}active{% endif %}">
                                <i class="ri-plant-line mr-3"></i>
                                <span>景观</span>
                            </a>
                            {% if project and project.standard == '四川省标' %}
                            <a href="{{ url_for('filter_standards', level='基本级', specialty='环境健康与节能', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '基本级' and current_specialty == '环境健康与节能' %}active{% endif %}">
                                    <i class="ri-leaf-line mr-3"></i>
                                    <span>环境健康与节能</span>
                                </a>
                                {% endif %}
                            </div>

                        {% if not project or project.star_rating_target != '基本级' %}
                        <div class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50" id="advancedMenuToggle">
                            <i class="ri-checkbox-multiple-line mr-3"></i>
                            <span>提高级</span>
                            <i class="ri-arrow-down-s-line ml-auto"></i>
                        </div>
                        <div id="advancedMenuContent" class="menu-content">
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='建筑', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '建筑' %}active{% endif %}">
                                <i class="ri-building-line mr-3"></i>
                                <span>建筑</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='结构', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '结构' %}active{% endif %}">
                                <i class="ri-layout-2-line mr-3"></i>
                                <span>结构</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='给排水', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '给排水' %}active{% endif %}">
                                    <i class="ri-drop-line mr-3"></i>
                                <span>给排水</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='电气', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '电气' %}active{% endif %}">
                                <i class="ri-flashlight-line mr-3"></i>
                                <span>电气</span>
                            </a>
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='暖通', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '暖通' %}active{% endif %}">
                                <i class="ri-temp-hot-line mr-3"></i>
                                <span>暖通</span>
                            </a>
                            {% if project and project.standard == '成都市标' or project and project.standard == '四川省标' %}
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='景观', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '景观' %}active{% endif %}">
                                    <i class="ri-plant-line mr-3"></i>
                                <span>景观</span>
                            </a>
                            {% endif %}
                            {% if project and project.standard == '四川省标' %}
                            <a href="{{ url_for('filter_standards', level='提高级', specialty='环境健康与节能', project_id=project.id if project else None) }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_level == '提高级' and current_specialty == '环境健康与节能' %}active{% endif %}">
                                <i class="ri-leaf-line mr-3"></i>
                                    <span>环境健康与节能</span>
                                </a>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        {% if not project or project.star_rating_target != '基本级' %}
                        <a href="{{ url_for('project_detail', project_id=project.id, page='score_summary') }}" 
                        class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50 {% if current_page == 'score_summary' %}active{% endif %}"
                        id="scoreSummaryMenuItem">
                         <i class="ri-bar-chart-line mr-3"></i>
                         <span>评分汇总</span>
                        </a>
                        {% endif %}
                        
                        <div class="menu-item flex items-center p-4 text-gray-600 rounded-lg hover:bg-gray-50" id="reportMenuToggle">
                            <i class="ri-file-download-line mr-3"></i>
                            <span>报告导出</span>
                            <i class="ri-arrow-down-s-line ml-auto"></i>
                        </div>
                        <div id="reportMenuContent" class="menu-content">
                            <div class="submenu-group" id="reportSubmenu">
                                <a href="javascript:void(0)" onclick="generateWord()" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_page == 'report_table' %}active{% endif %}">
                                    <i class="ri-file-list-3-line mr-3"></i>
                                    <span>报审表</span>
                                </a>
                                <a href="javascript:void(0)" onclick="generateDWG()" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_page == 'dwg_export' %}active{% endif %}">
                                    <i class="ri-leaf-line mr-3"></i>
                                    <span>绿色建筑设计专篇</span>
                                </a>
                                <a href="{{ url_for('project_detail', project_id=project.id, page='green_materials') }}" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50 {% if current_page == 'green_materials' %}active{% endif %}">
                                    <i class="ri-calculator-line mr-3"></i>
                                    <span>绿色建材应用比例</span>
                                </a>
                                {% if project and project.standard == '国标' %}
                                <a href="javascript:void(0)" onclick="generateSelfAssessmentReport(); return false;" class="submenu-item flex items-center px-4 py-3 text-gray-600 hover:bg-gray-50">
                                    <i class="ri-book-line mr-3"></i>
                                    <span>绿建自评估报告</span>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </nav>
                
                <!-- 移除用户指南链接 -->
            </aside>

            <!-- 主内容区域 -->
            <main class="flex-1 overflow-y-auto p-8 bg-transparent main-content" style="min-height: 100vh;">
                <!-- 用户图标 -->
                <div class="user-icon" id="userIcon">
                    <i class="fas fa-user-circle text-primary text-xl"></i>
                </div>
                <!-- 用户菜单，默认隐藏 -->
                <div class="user-menu" id="userMenu">
                    <!-- 用户信息 -->
                    <div class="flex items-center px-4 py-3 border-b border-gray-100">
                        <i class="fas fa-user-circle text-primary text-xl"></i>
                        <span class="ml-2 text-gray-700 font-medium">
                            {{ session.get('username', '未登录').split('@')[0] }}
                        </span>
                    </div>
                    
                    <!-- 系统设置选项 -->
                    <div class="flex items-center px-4 py-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer hidden">
                        <i class="fas fa-cog text-gray-500"></i>
                        <span class="ml-2 text-gray-700">系统设置</span>
                    </div>
                    
                    <!-- 用户指南选项 -->
                    <a href="{{ url_for('user_guide') }}" class="flex items-center px-4 py-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer">
                        <i class="fas fa-book text-gray-500"></i>
                        <span class="ml-2 text-gray-700">用户使用指南</span>
                    </a>
                    
                    <!-- 退出登录选项 -->
                    <a href="{{ url_for('logout') }}" class="flex items-center px-4 py-3 hover:bg-gray-50 cursor-pointer group">
                        <i class="fas fa-sign-out-alt text-gray-500 group-hover:text-red-500"></i>
                        <span class="ml-2 text-gray-700 group-hover:text-red-500">退出登录</span>
                    </a>
                </div>

                <!-- 头像选择模态框 -->
                <div id="avatarModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative" style="z-index: 10000;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">选择头像</h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="closeAvatarModal()" title="关闭">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <!-- 预设头像选项 -->
                            <div class="avatar-option cursor-pointer hover:opacity-80 transition-opacity" data-avatar="default">
                                <img src="{{ url_for('static', filename='image/greenscore-64.png') }}" alt="默认头像" class="w-full h-auto rounded-full">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeAvatarModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                取消
                            </button>
                            <button type="button" onclick="saveSelectedAvatar()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                                确定
                            </button>
                        </div>
                    </div>
                </div>


                <div class="max-w-7xl mx-auto px-4 py-8">
                    <!-- 添加项目管理按钮 -->
                    {% if current_page == 'green_materials' %}
                    <!-- 绿色建材页面特殊布局 -->
                    <div class="flex flex-col items-center">
                        <h1 class="text-3xl font-bold text-primary ">绿色建材应用比例计算</h1>
                    </div>
                    {% else %}
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                            {% if current_page == 'score_summary' %}
                            <h2 class="text-2xl font-bold text-primary">评分汇总</h2>
                            {% elif current_page == 'project_info' %}
                            <h2 class="text-2xl font-bold text-primary">项目信息</h2>
                            {% elif current_page == 'report_table' %}
                            <h2 class="text-2xl font-bold text-primary">报审表</h2>
                            {% elif current_level %}
                            <div class="flex flex-col gap-2">
                                <h2 class="text-2xl font-bold text-primary">{{ current_specialty }}专业</h2>
                                <div class="text-sm text-gray-600">
                                    当前评价标准: {% if project and project.standard == '国标' %}
                                        绿色建筑评价标准 GB/T 50378-2019（2024版）
                                    {% elif project and project.standard == '四川省标' %}
                                        四川省民用绿色建筑设计施工图阶段审查技术要点（2024版）
                                    {% elif project and project.standard == '成都市标' %}
                                        成都市绿色建筑施工图设计与审查技术要点（2024版）
                                    {% else %}
                                        成都市绿色建筑施工图设计与审查技术要点（2024版）
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <h2 class="text-2xl font-bold">绿色建筑评价系统</h2>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-4">
                            {% if current_level in ['基本级', '提高级'] %}
                            <div class="relative" >
                                <input type="text" id="clause-filter" placeholder="输入条文号过滤..." class="px-4 py-2 pr-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" oninput="filterTableByClause(this.value)">
                                <!-- <i class="ri-search-line text-gray-400 "></i> -->
                            </div>
                            {% endif %}
                            <a href="{{ url_for('project_management') }}" class="flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                <i class="ri-arrow-left-line mr-2"></i>
                                <span>返回项目管理</span>
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- 添加隐藏的项目名称字段，在所有页面都可用 -->
                    <input type="hidden" id="current_project_name" value="{{ project.name if project else '' }}">
                    <!-- 添加隐藏的项目ID字段，在所有页面都可用 -->
                    <input type="hidden" id="project_id" value="{{ project.id if project else '' }}">

                    {% if current_page == 'score_summary' %}
                    <input type="hidden" id="current-project-standard" value="{{ project.standard if project and project.standard else '成都市标' }}">
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                        <!-- 页面标题和工具栏 -->
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center">
                                <h3 class="text-lg font-medium mr-4">各专业得分汇总</h3>
                            </div>
                            <!-- 移除刷新按钮和计算评分按钮 -->
                        </div>

                        <div class="overflow-x-auto score-summary-container">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-blue-500 text-white">
                                        <th class="px-6 py-3 text-center">专业</th>
                                        <th class="px-6 py-3 text-center">建筑专业</th>
                                        <th class="px-6 py-3 text-center">结构专业</th>
                                        <th class="px-6 py-3 text-center">给排水专业</th>
                                        <th class="px-6 py-3 text-center">电气专业</th>
                                        <th class="px-6 py-3 text-center">暖通专业</th>
                                        <th class="px-6 py-3 text-center">景观专业</th>
                                        <th class="px-6 py-3 text-center" id="env_health_energy_header">环境健康与节能专业</th>
                                        <th class="px-6 py-3 text-center">合计</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 专业得分行 -->
                                    <tr id="specialty-scores-row" class="border-b text-center">
                                        <td class="px-6 py-4">得分</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4" id="env_health_energy_column">0.0</td>
                                        <td class="px-6 py-4 font-bold total-score">0.0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-medium mb-4">各分类得分汇总</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-blue-500 text-white">
                                        <th class="px-6 py-3 text-center">分类</th>
                                        <th class="px-6 py-3 text-center">安全耐久</th>
                                        <th class="px-6 py-3 text-center">健康舒适</th>
                                        <th class="px-6 py-3 text-center">生活便利</th>
                                        <th class="px-6 py-3 text-center">资源节约</th>
                                        <th class="px-6 py-3 text-center">环境宜居</th>
                                        <th class="px-6 py-3 text-center">提高与创新</th>
                                        <th class="px-6 py-3 text-center">合计</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 分类得分行 - 将由JavaScript动态更新 -->
                                    <tr id="category-scores-row" class="border-b text-center">
                                        <td class="px-6 py-4">得分</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4 font-bold">0.0</td>
                                    </tr>
                                    <!-- 最低分值行 - 将由JavaScript动态更新 -->
                                    <tr>
                                        <td class="px-6 py-4">最低分值</td>
                                        <td class="px-6 py-4">30.0</td>
                                        <td class="px-6 py-4">30.0</td>
                                        <td class="px-6 py-4">21.0</td>
                                        <td class="px-6 py-4">60.0</td>
                                        <td class="px-6 py-4">30.0</td>
                                        <td class="px-6 py-4">0.0</td>
                                        <td class="px-6 py-4 font-bold">171</td>
                                    </tr>
                                    <!-- 达标判断行 - 将由JavaScript动态更新 -->
                                    <tr>
                                        <td class="px-6 py-4">达标判断</td>
                                        <td class="px-6 py-4">-</td>
                                        <td class="px-6 py-4">-</td>
                                        <td class="px-6 py-4">-</td>
                                        <td class="px-6 py-4">-</td>
                                        <td class="px-6 py-4">-</td>
                                        <td class="px-6 py-4">-</td>
                                        <td class="px-6 py-4 font-bold">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 星级判定表格 - 单独显示 -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
                        <h3 class="text-xl font-bold mb-4 text-primary">绿色建筑星级评定</h3>
                        <div class="overflow-auto">
                            <table class="w-full score-table">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-4 text-center bg-primary">项目名称</th>
                                        <th class="px-6 py-4 text-center bg-primary">总得分</th>
                                        <th class="px-6 py-4 text-center bg-primary align-middle">星级评定</th>
                                        <th class="px-6 py-4 text-center bg-primary">评定结果</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="star-rating-row" class="star-rating-row">
                                        <td class="px-6 py-4 text-xl">{{ project.name if project else '未设置项目名称' }}</td>
                                        <td class="px-6 py-4 text-xl" id="star-rating-score">0.0</td>
                                        <td class="px-6 py-4 text-xl text-center align-middle" id="star-rating-stars-cell">
                                            <span id="star-rating-stars" class="text-2xl"></span>
                                        </td>
                                        <td class="px-6 py-4 text-xl" id="star-rating-total">-</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- 添加保存星级案例按钮，仅管理员可见 -->
                            {% if session.get('role') == 'admin' %}
                            <div class="mt-6 flex justify-center">
                                <button id="saveStarCaseBtn" class="px-6 py-3 bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    <i class="ri-save-line mr-2"></i>保存星级案例
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- 星级标准说明 -->
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                            <h4 class="font-bold mb-2">星级评定标准说明：</h4>
                            <ul class="list-disc pl-5 space-y-2">
                                <li><span class="inline-block px-3 py-1 rounded-full bg-green-100 text-green-800 font-medium">三星级</span>：总得分 ≥ 450分 且 <span class="font-medium">所有分类均达标</span></li>
                                <li><span class="inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-800 font-medium">二星级</span>：总得分 ≥ 300分 且 <span class="font-medium">所有分类均达标</span></li>
                                <li><span class="inline-block px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 font-medium">一星级</span>：总得分 ≥ 200分 且 <span class="font-medium">所有分类均达标</span></li>
                                <li><span class="inline-block px-3 py-1 rounded-full bg-red-100 text-red-600 font-medium">未达标</span>：总得分 < 200分 或 <span class="text-red-600">任一分类未达标</span></li>
                            </ul>
                        </div>
                    </div>
                    
                    <script>
                        function updateStarRating() {
                            try {
                                // 获取总分
                                const categoryScoresRow = document.getElementById('category-scores-row');
                                if (!categoryScoresRow) {
                                    console.error('找不到得分行元素');
                                    return;
                                }
                                
                                // 获取总分单元格（第8个单元格，索引为7）
                                const totalScoreCell = categoryScoresRow.cells[7];
                                if (!totalScoreCell) {
                                    console.error('找不到总分单元格');
                                    return;
                                }
                                
                                const totalScoreText = totalScoreCell.innerText;
                                const totalScore = parseFloat(totalScoreText);
                                
                                if (isNaN(totalScore)) {
                                    console.error('总分不是有效数字:', totalScoreText);
                                    return;
                                }
                                
                                console.log('当前总分:', totalScore);
                                
                                // 更新星级判定表格中的总分
                                const starRatingScore = document.getElementById('star-rating-score');
                                if (starRatingScore) {
                                    starRatingScore.innerText = totalScore.toFixed(1);
                                }
                                
                                // 检查所有分类是否都达标
                                const judgmentRow = categoryScoresRow.parentNode.querySelector('tr:nth-child(3)');
                                let allCategoriesAchieved = true;
                                
                                if (judgmentRow) {
                                    // 检查每个分类的达标情况（从第2个单元格到第7个单元格，索引1-6）
                                    for (let i = 1; i <= 6; i++) {
                                        const cell = judgmentRow.cells[i];
                                        if (cell && cell.textContent !== '达标') {
                                            allCategoriesAchieved = false;
                                            console.log(`分类 ${i} 未达标`);
                                            break;
                                        }
                                    }
                                    
                                    // 检查总体达标情况（第8个单元格，索引7）
                                    const totalJudgmentCell = judgmentRow.cells[7];
                                    if (totalJudgmentCell && totalJudgmentCell.textContent !== '达标') {
                                        allCategoriesAchieved = false;
                                        console.log('总体未达标');
                                    }
                                } else {
                                    console.error('找不到达标判断行');
                                    allCategoriesAchieved = false;
                                }
                                
                                console.log('所有分类是否达标:', allCategoriesAchieved);
                                
                                // 判断星级
                                let starRating = '-';
                                let starClass = '';
                                let starIcons = '';
                                let rowClass = '';
                                
                                // 只有当所有分类都达标时，才进行星级判定
                                if (allCategoriesAchieved) {
                                    if (totalScore >= 450) {
                                        starRating = '三星级';
                                        starClass = 'star-three';
                                        starIcons = '<i class="ri-star-fill star-icon text-green-600"></i>'.repeat(3);
                                        rowClass = 'bg-green-50';
                                    } else if (totalScore >= 300) {
                                        starRating = '二星级';
                                        starClass = 'star-two';
                                        starIcons = '<i class="ri-star-fill star-icon text-blue-600"></i>'.repeat(2);
                                        rowClass = 'bg-blue-50';
                                    } else if (totalScore >= 200) {
                                        starRating = '一星级';
                                        starClass = 'star-one';
                                        starIcons = '<i class="ri-star-fill star-icon text-yellow-600"></i>';
                                        rowClass = 'bg-yellow-50';
                                    } else {
                                        starRating = '未达标';
                                        starClass = 'star-none';
                                        starIcons = '<i class="ri-close-circle-fill star-icon text-red-600"></i>';
                                        rowClass = 'bg-red-50';
                                    }
                                } else {
                                    // 如果有任何分类未达标，则星级判定为"未达标"
                                    starRating = '未达标';
                                    starClass = 'star-none';
                                    starIcons = '<i class="ri-close-circle-fill star-icon text-red-600"></i>';
                                    rowClass = 'bg-red-50';
                                }
                                
                                // 更新星级判定结果
                                const starRatingTotal = document.getElementById('star-rating-total');
                                if (starRatingTotal) {
                                    starRatingTotal.innerText = starRating;
                                    // 使用内联样式直接设置样式
                                    if (starClass === 'star-three') {
                                        starRatingTotal.style.color = '#10b981';

                                    } else if (starClass === 'star-two') {
                                        starRatingTotal.style.color = '#3b82f6';

                                    } else if (starClass === 'star-one') {
                                        starRatingTotal.style.color = '#f59e0b';

                                    } else {
                                        starRatingTotal.style.color = '#ef4444';

                                    }
                                }
                                
                                // 更新星级图标
                                const starRatingStars = document.getElementById('star-rating-stars');
                                if (starRatingStars) {
                                    starRatingStars.innerHTML = starIcons;
                                    starRatingStars.style.display = 'inline-block';
                                    starRatingStars.style.verticalAlign = 'middle';
                                }
                                
                                // 确保星级图标单元格垂直居中
                                const starRatingStarsCell = document.getElementById('star-rating-stars-cell');
                                if (starRatingStarsCell) {
                                    starRatingStarsCell.style.verticalAlign = 'middle';
                                }
                                
                                // 更新星级判定行样式
                                const starRatingRow = document.getElementById('star-rating-row');
                                if (starRatingRow) {
                                    // 移除旧的背景色类
                                    starRatingRow.classList.remove('bg-blue-50', 'bg-green-50', 'bg-yellow-50', 'bg-red-50');
                                    
                                    // 添加新的背景色类
                                    starRatingRow.classList.add(rowClass);
                                }
                                
                                console.log('星级判定更新为:', starRating);
                            } catch (error) {
                                console.error('更新星级判定时出错:', error);
                            }
                        }

                        // 在页面加载完成后执行星级判定
                        document.addEventListener('DOMContentLoaded', function() {
                            console.log('页面加载完成，初始化星级判定');
                            // 延迟执行，确保数据已加载
                            setTimeout(updateStarRating, 500);
                        });
                    </script>
                    {% endif %}
                    {% block content %}
                    {% if current_page == 'project_info' %}
                    <!-- 项目信息表单 -->
                    <!-- <h1 class="text-xl font-medium text-primary mb-6 text-center">项目信息</h1> -->
                    
                    <!-- AI提取项目信息悬浮按钮 -->
                    <div>
                        <button id="aiExtractButton" onclick="showAiExtractModal()" class="ai-extract-btn flex items-center bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 text-white px-3 py-3 rounded-lg shadow-lg transform hover:scale-105 transition-all hover:shadow-[0_0_15px_rgba(139,92,246,0.5)] group">
                            <i class="fas fa-robot mr-3 text-xl ai-icon"></i>
                            <span class="font-medium text-lg">AI提取项目信息</span>
                            <div class="ai-pulse"></div>
                        </button>
                    </div>
                    
                    <!-- AI提取项目信息按钮和模态框样式 -->
                    <style>
                        /* 按钮样式 */
                        .ai-extract-btn {
                            position: relative;
                            overflow: hidden;
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4), 0 0 20px rgba(139, 92, 246, 0.2);
                            transition: all 0.3s cubic-bezier(0.215, 0.61, 0.355, 1);
                        }
                        
                        /* 按钮悬停效果 */
                        .ai-extract-btn:hover {
                            border-color: rgba(255, 255, 255, 0.4);
                            animation: pulse 1.5s infinite;
                        }
                        
                        /* 按钮脉冲动画 */
                        @keyframes pulse {
                            0% {
                                box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4), 0 0 0 0 rgba(139, 92, 246, 0.4);
                            }
                            70% {
                                box-shadow: 0 4px 15px rgba(79, 70, 229, 0.6), 0 0 0 10px rgba(139, 92, 246, 0);
                            }
                            100% {
                                box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4), 0 0 0 0 rgba(139, 92, 246, 0);
                            }
                        }
                        
                        /* 机器人图标动画 */
                        .ai-icon {
                            transition: transform 0.3s ease;
                        }
                        
                        .ai-extract-btn:hover .ai-icon {
                            animation: shake 1s ease infinite;
                        }
                        
                        @keyframes shake {
                            0%, 100% { transform: rotate(0deg); }
                            20% { transform: rotate(-10deg); }
                            40% { transform: rotate(10deg); }
                            60% { transform: rotate(-5deg); }
                            80% { transform: rotate(5deg); }
                        }
                        
                        /* 按钮背景脉冲效果 */
                        .ai-pulse {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(90deg, 
                                rgba(255, 255, 255, 0) 0%, 
                                rgba(255, 255, 255, 0.2) 50%, 
                                rgba(255, 255, 255, 0) 100%);
                            opacity: 0;
                            z-index: 1;
                            pointer-events: none;
                            animation: wave 2s infinite;
                        }
                        
                        @keyframes wave {
                            0% {
                                transform: translateX(-100%);
                                opacity: 0;
                            }
                            50% {
                                opacity: 0.5;
                            }
                            100% {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                        }
                        
                        /* 模态框样式 */
                        .modal-backdrop {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background-color: rgba(0, 0, 0, 0.7);
                            backdrop-filter: blur(5px);
                            -webkit-backdrop-filter: blur(5px);
                            z-index: 999;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            opacity: 0;
                            visibility: hidden;
                            transition: opacity 0.3s ease, visibility 0.3s ease;
                        }
                        
                        .modal-backdrop.show {
                            opacity: 1;
                            visibility: visible;
                        }
                        
                        .modal-content {
                            background: linear-gradient(135deg, #1e293b, #0f172a);
                            color: white;
                            border-radius: 1rem;
                            border: 1px solid rgba(139, 92, 246, 0.3);
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4),
                                       0 0 30px rgba(139, 92, 246, 0.3);
                            width: 100%;
                            max-width: 500px;
                            padding: 2rem;
                            transform: translateY(-30px) scale(0.95);
                            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                            position: relative;
                            max-height: 90vh;
                            overflow-y: auto;
                            margin: 0 1rem;
                        }
                        
                        .modal-backdrop.show .modal-content {
                            transform: translateY(0) scale(1);
                        }
                        
                        /* 模态框内容样式 */
                        .modal-content h3 {
                            color: #d8b4fe;
                            margin-bottom: 1rem;
                            font-size: 1.5rem;
                            position: relative;
                            padding-bottom: 0.5rem;
                        }
                        
                        .modal-content h3:after {
                            content: '';
                            position: absolute;
                            bottom: 0;
                            left: 0;
                            width: 100%;
                            height: 2px;
                            background: linear-gradient(90deg, #d8b4fe, transparent);
                        }
                        
                        .modal-content p {
                            color: #cbd5e1;
                        }
                        
                        /* 文件上传区域样式 */
                        #wordFileInput {
                            background: rgba(30, 41, 59, 0.7);
                            border: 1px dashed rgba(139, 92, 246, 0.5);
                            border-radius: 0.5rem;
                            color: #e2e8f0;
                            transition: all 0.3s ease;
                        }
                        
                        #wordFileInput:hover, #wordFileInput:focus {
                            border-color: rgba(139, 92, 246, 0.8);
                            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
                        }
                        
                        /* 按钮样式 */
                        .modal-content button {
                            position: relative;
                            overflow: hidden;
                            transition: all 0.3s ease;
                        }
                        
                        .modal-content button:after {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 0;
                            height: 100%;
                            background: rgba(255, 255, 255, 0.1);
                            transition: width 0.4s ease;
                        }
                        
                        .modal-content button:hover:after {
                            width: 100%;
                        }
                        
                        /* 提取结果区域样式 */
                        #extractedInfo {
                            background: rgba(30, 41, 59, 0.6);
                            border-radius: 0.5rem;
                            border: 1px solid rgba(139, 92, 246, 0.2);
                            color: #e2e8f0;
                        }
                        
                        /* 加载动画样式 */
                        #extractLoading i {
                            animation: spin 1s infinite linear;
                        }
                        
                        @keyframes spin {
                            from { transform: rotate(0deg); }
                            to { transform: rotate(360deg); }
                        }
                        
                        /* Tab切换按钮样式 */
                        .tab-btn {
                            transition: all 0.3s ease;
                        }
                        
                        .tab-btn.active {
                            background: rgba(139, 92, 246, 0.2);
                            color: #f3f4f6;
                            font-weight: 500;
                            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
                        }
                        
                        /* 图片上传区域样式 */
                        #imageDropArea {
                            transition: all 0.3s ease;
                            min-height: 150px;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                        }
                        
                        #imageDropArea:hover, .word-upload-area:hover {
                            border-color: #a78bfa;
                            background-color: rgba(30, 41, 59, 0.8);
                            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
                        }
                        
                        #previewContainer {
                            width: 100%;
                            display: flex;
                            justify-content: center;
                            position: relative;
                        }
                        
                        /* 选择文件后的文件名显示 */
                        #wordFileName {
                            font-style: italic;
                            color: #a78bfa;
                        }
                        
                        /* 上传区域悬停效果 */
                        .word-upload-area {
                            transition: all 0.3s ease;
                        }
                        
                        /* 动画效果 */
                        @keyframes fadeIn {
                            from { opacity: 0; transform: translateY(10px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        
                        #wordUploadTab, #imageUploadTab {
                            animation: fadeIn 0.3s ease-out;
                        }
                    </style>
                    
                    <!-- AI提取项目信息模态框 -->
                    <div id="aiExtractModal" class="modal-backdrop">
                        <div class="modal-content">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold">AI提取项目信息</h3>
                                <button class="text-purple-300 hover:text-purple-100 p-1 rounded-full hover:bg-purple-900 transition-all" onclick="closeAiExtractModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <!-- Tab切换按钮 -->
                            <div class="flex mb-6 bg-gray-800 rounded-lg p-1">
                                <button id="wordTabBtn" onclick="switchTab('word')" class="tab-btn active flex-1 py-2 rounded-md text-center text-gray-300 transition-all">
                                    <i class="fas fa-file-word mr-2"></i>Word文档
                                </button>
                                <button id="imageTabBtn" onclick="switchTab('image')" class="tab-btn flex-1 py-2 rounded-md text-center text-gray-300 transition-all">
                                    <i class="fas fa-image mr-2"></i>图片识别
                                </button>
                            </div>
                            
                            <!-- Word文档上传区域 -->
                            <div id="wordUploadTab" class="mb-6">
                                <label for="wordFileInput" class="block cursor-pointer">
                                    <div id="wordDropArea" class="text-center py-4 border-2 border-dashed border-purple-500 rounded-lg hover:border-purple-300 transition-all bg-gray-800 word-upload-area">
                                        <i class="fas fa-file-word text-purple-400 text-4xl mb-3"></i>
                                        <p class="text-gray-300 mb-1">点击或拖放Word文档到此处</p>
                                        <p class="text-gray-400 text-sm">支持.doc和.docx格式</p>
                                    </div>
                                </label>
                                <input type="file" id="wordFileInput" accept=".doc,.docx" class="hidden">
                                <div id="wordFileName" class="mt-2 text-sm text-center text-gray-400 hidden"></div>
                            </div>
                            
                            <!-- 图片上传和粘贴区域 -->
                            <div id="imageUploadTab" class="mb-6 hidden">
                                <label for="imageFileInput" class="block cursor-pointer" id="imageDropLabel">
                                    <div id="imageDropArea" class="border-2 border-dashed border-purple-500 rounded-lg p-4 mb-3 text-center bg-gray-800 hover:border-purple-300 transition-all relative overflow-hidden">
                                        <div id="dropAreaText">
                                            <i class="fas fa-cloud-upload-alt text-purple-400 text-3xl mb-2"></i>
                                            <p class="text-gray-300">点击或拖放图片到此处</p>
                                            <p class="text-gray-400 text-sm">支持 JPG, JPEG, PNG, BMP 格式</p>
                                        </div>
                                        <div id="previewContainer" class="hidden">
                                            <img id="imagePreview" class="max-h-40 mx-auto mb-2" />
                                            <button type="button" onclick="clearImagePreview(event)" class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-1 hover:bg-red-700">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </label>
                                <input type="file" id="imageFileInput" accept=".jpg,.jpeg,.png,.bmp" class="hidden">
                                <div class="flex justify-between items-center">
                                    <p class="text-gray-400 text-sm"><i class="fas fa-info-circle mr-1"></i> 提示：您也可以直接按 Ctrl+V 粘贴剪贴板中的图片</p>
                                    <button type="button" id="clearImageBtn" class="text-sm text-red-400 hover:text-red-300 hidden">
                                        <i class="fas fa-trash-alt mr-1"></i>移除图片
                                    </button>
                                </div>
                            </div>
                            
                            <div id="extractResult" class="mb-6 hidden">
                                <h4 class="font-bold text-purple-300 mb-2">提取结果:</h4>
                                <div id="extractedInfo" class="p-4 bg-gray-800 rounded-md text-sm max-h-56 overflow-y-auto"></div>
                            </div>
                            <div id="extractLoading" class="mb-6 hidden">
                                <div class="flex items-center justify-center p-4 bg-gray-800 rounded-md">
                                    <i class="fas fa-spinner text-purple-400 text-2xl mr-3"></i>
                                    <span class="text-gray-300">智能提取中，请稍候...</span>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="closeAiExtractModal()" class="px-4 py-2 border border-gray-600 rounded-lg text-gray-300 hover:bg-gray-700 transition-all">
                                    取消
                                </button>
                                <button type="button" id="extractButton" onclick="extractProjectInfo()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all">
                                    提取信息
                                </button>
                                <button type="button" id="applyButton" onclick="applyExtractedInfo()" class="px-4 py-2 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg hover:from-green-700 hover:to-teal-700 transition-all hidden">
                                    应用到表单
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        // 全局变量存储粘贴的图片
                        let pastedImage = null;
                        let currentTab = 'word'; // 当前激活的标签页
                        
                        // 切换标签页
                        function switchTab(tabName) {
                            currentTab = tabName;
                            const wordTab = document.getElementById('wordUploadTab');
                            const imageTab = document.getElementById('imageUploadTab');
                            const wordBtn = document.getElementById('wordTabBtn');
                            const imageBtn = document.getElementById('imageTabBtn');
                            
                            // 重置提取结果
                            document.getElementById('extractResult').classList.add('hidden');
                            document.getElementById('applyButton').classList.add('hidden');
                            
                            if (tabName === 'word') {
                                wordTab.classList.remove('hidden');
                                imageTab.classList.add('hidden');
                                wordBtn.classList.add('active');
                                imageBtn.classList.remove('active');
                            } else {
                                wordTab.classList.add('hidden');
                                imageTab.classList.remove('hidden');
                                wordBtn.classList.remove('active');
                                imageBtn.classList.add('active');
                            }
                        }
                        
                        // 清除图片预览
                        function clearImagePreview(event) {
                            // 阻止事件冒泡，防止触发文件选择
                            if (event) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            
                            // 完全清除图片状态
                            const previewContainer = document.getElementById('previewContainer');
                            const dropAreaText = document.getElementById('dropAreaText');
                            const imageFileInput = document.getElementById('imageFileInput');
                            const clearImageBtn = document.getElementById('clearImageBtn');
                            const imagePreview = document.getElementById('imagePreview');
                            
                            // 重置图片元素
                            previewContainer.classList.add('hidden');
                            dropAreaText.classList.remove('hidden');
                            clearImageBtn.classList.add('hidden');
                            imageFileInput.value = '';
                            imagePreview.src = '';
                            
                            // 清除粘贴的图片数据
                            pastedImage = null;
                            
                            console.log('图片已清除');
                        }
                        
                        // 处理图片预览
                        function handleImagePreview(file) {
                            if (!file || !file.type || !file.type.match('image.*')) {
                                alert('请选择图片文件');
                                return;
                            }
                            
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const img = document.getElementById('imagePreview');
                                img.src = e.target.result;
                                document.getElementById('previewContainer').classList.remove('hidden');
                                document.getElementById('dropAreaText').classList.add('hidden');
                                document.getElementById('clearImageBtn').classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                        
                        // 显示Word文件名
                        function showWordFileName(file) {
                            const fileNameDiv = document.getElementById('wordFileName');
                            if (file) {
                                fileNameDiv.textContent = `已选择: ${file.name}`;
                                fileNameDiv.classList.remove('hidden');
                            } else {
                                fileNameDiv.classList.add('hidden');
                            }
                        }
                        
                        // AI提取项目信息相关函数
                        function showAiExtractModal() {
                            const modal = document.getElementById('aiExtractModal');
                            modal.classList.add('show');
                            
                            // 重置所有状态
                            document.getElementById('extractResult').classList.add('hidden');
                            document.getElementById('extractLoading').classList.add('hidden');
                            document.getElementById('applyButton').classList.add('hidden');
                            document.getElementById('wordFileInput').value = '';
                            document.getElementById('wordFileName').classList.add('hidden');
                            clearImagePreview();
                            
                            // 添加ESC键监听
                            document.addEventListener('keydown', handleEscKeyForModal);
                            // 添加粘贴监听
                            document.addEventListener('paste', handlePasteImage);
                        }
                        
                        function closeAiExtractModal() {
                            const modal = document.getElementById('aiExtractModal');
                            modal.classList.remove('show');
                            
                            // 强制重置所有状态
                            const resetElements = {
                                'wordFileInput': el => el.value = '',
                                'wordFileName': el => el.classList.add('hidden'),
                                'imageFileInput': el => el.value = '',
                                'imagePreview': el => el.src = '',
                                'previewContainer': el => el.classList.add('hidden'),
                                'dropAreaText': el => el.classList.remove('hidden'),
                                'clearImageBtn': el => el.classList.add('hidden'),
                                'extractResult': el => el.classList.add('hidden'),
                                'applyButton': el => el.classList.add('hidden')
                            };
                            
                            // 应用所有重置
                            for (const [id, resetFn] of Object.entries(resetElements)) {
                                const element = document.getElementById(id);
                                if (element) resetFn(element);
                            }
                            
                            // 清除粘贴的图片数据
                            pastedImage = null;
                            
                            // 移除ESC键监听
                            document.removeEventListener('keydown', handleEscKeyForModal);
                            // 移除粘贴监听
                            document.removeEventListener('paste', handlePasteImage);
                            
                            console.log('模态窗口已关闭，所有状态已重置');
                        }
                        
                        // 处理ESC键按下事件
                        function handleEscKeyForModal(event) {
                            if (event.key === 'Escape') {
                                closeAiExtractModal();
                            }
                        }
                        
                        // 处理粘贴图片事件
                        function handlePasteImage(event) {
                            // 检查当前是否在图片标签页
                            if (currentTab !== 'image') return;
                            
                            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                            let hasImage = false;
                            
                            for (let index in items) {
                                const item = items[index];
                                
                                if (item.kind === 'file') {
                                    const blob = item.getAsFile();
                                    if (blob && blob.type.indexOf('image') !== -1) {
                                        event.preventDefault();
                                        
                                        // 先清除之前的图片
                                        clearImagePreview();
                                        
                                        // 设置新的图片
                                        pastedImage = blob;
                                        handleImagePreview(blob);
                                        
                                        // 创建新的FileList对象
                                        try {
                                            const dataTransfer = new DataTransfer();
                                            dataTransfer.items.add(blob);
                                            const imageFileInput = document.getElementById('imageFileInput');
                                            imageFileInput.files = dataTransfer.files;
                                        } catch (error) {
                                            console.error('设置文件列表失败:', error);
                                        }
                                        
                                        hasImage = true;
                                        console.log('已粘贴新图片');
                                        break;
                                    }
                                }
                            }
                            
                            if (!hasImage) {
                                console.log('粘贴内容中没有找到图片');
                            }
                        }
                        
                        // 页面加载完成后初始化事件监听
                        document.addEventListener('DOMContentLoaded', function() {
                            // 点击模态窗口外部区域关闭模态窗口
                            const modal = document.getElementById('aiExtractModal');
                            modal.addEventListener('click', function(event) {
                                // 如果点击的是模态窗口背景（而不是内容区域），则关闭模态窗口
                                if (event.target === modal) {
                                    closeAiExtractModal();
                                }
                            });
                            
                            // 设置移除图片按钮事件监听
                            const clearImageBtn = document.getElementById('clearImageBtn');
                            if (clearImageBtn) {
                                clearImageBtn.addEventListener('click', function(event) {
                                    clearImagePreview(event);
                                    console.log('通过移除按钮清除图片');
                                });
                            }
                            
                            // Word文件选择处理
                            const wordFileInput = document.getElementById('wordFileInput');
                            if (wordFileInput) {
                                wordFileInput.addEventListener('change', function() {
                                    if (this.files && this.files[0]) {
                                        showWordFileName(this.files[0]);
                                    }
                                });
                            }
                            
                            // 图片文件选择处理
                            const imageFileInput = document.getElementById('imageFileInput');
                            if (imageFileInput) {
                                imageFileInput.addEventListener('change', function() {
                                    if (this.files && this.files[0]) {
                                        handleImagePreview(this.files[0]);
                                    }
                                });
                            }
                            
                            // 防止整个文档的默认拖放行为
                            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                                document.addEventListener(eventName, preventDefaults, false);
                            });
                            
                            function preventDefaults(e) {
                                e.preventDefault();
                                e.stopPropagation();
                            }
                            
                            // 设置Word文档拖放区域处理
                            const wordDropArea = document.getElementById('wordDropArea');
                            if (wordDropArea) {
                                // 拖放高亮效果
                                ['dragenter', 'dragover'].forEach(eventName => {
                                    wordDropArea.addEventListener(eventName, function() {
                                        wordDropArea.classList.add('border-purple-300');
                                    });
                                });
                                
                                ['dragleave', 'drop'].forEach(eventName => {
                                    wordDropArea.addEventListener(eventName, function() {
                                        wordDropArea.classList.remove('border-purple-300');
                                    });
                                });
                                
                                // 处理Word文档拖放
                                wordDropArea.addEventListener('drop', function(e) {
                                    e.preventDefault();
                                    const dt = e.dataTransfer;
                                    const file = dt.files[0];
                                    
                                    if (file && (file.name.endsWith('.doc') || file.name.endsWith('.docx'))) {
                                        // 设置文件输入
                                        const fileInput = document.getElementById('wordFileInput');
                                        
                                        // 创建新的FileList对象
                                        const dataTransfer = new DataTransfer();
                                        dataTransfer.items.add(file);
                                        fileInput.files = dataTransfer.files;
                                        
                                        // 显示文件名
                                        showWordFileName(file);
                                    } else {
                                        alert('请选择Word文档 (.doc 或 .docx 格式)');
                                    }
                                });
                            }
                            
                            // 设置图片拖放区域处理
                            const imageDropArea = document.getElementById('imageDropArea');
                            if (imageDropArea) {
                                // 拖放高亮效果
                                ['dragenter', 'dragover'].forEach(eventName => {
                                    imageDropArea.addEventListener(eventName, function() {
                                        imageDropArea.classList.add('border-purple-300');
                                    });
                                });
                                
                                ['dragleave', 'drop'].forEach(eventName => {
                                    imageDropArea.addEventListener(eventName, function() {
                                        imageDropArea.classList.remove('border-purple-300');
                                    });
                                });
                                
                                // 处理图片拖放
                                imageDropArea.addEventListener('drop', function(e) {
                                    e.preventDefault();
                                    const dt = e.dataTransfer;
                                    const file = dt.files[0];
                                    
                                    if (file && file.type.indexOf('image') !== -1) {
                                        // 设置图片预览
                                        handleImagePreview(file);
                                        
                                        // 创建新的FileList对象
                                        const dataTransfer = new DataTransfer();
                                        dataTransfer.items.add(file);
                                        imageFileInput.files = dataTransfer.files;
                                        
                                        // 显示清除按钮
                                        document.getElementById('clearImageBtn').classList.remove('hidden');
                                    } else {
                                        alert('请选择图片文件');
                                    }
                                });
                            }
                        });
                        
                        function extractProjectInfo() {
                            // 根据当前选择的标签页确定处理方式
                            if (currentTab === 'word') {
                                // Word文档提取
                                const fileInput = document.getElementById('wordFileInput');
                                const file = fileInput.files[0];
                                
                                if (!file) {
                                    alert('请先选择Word文档');
                                    return;
                                }
                                
                                // 显示加载状态
                                document.getElementById('extractLoading').classList.remove('hidden');
                                document.getElementById('extractButton').disabled = true;
                                
                                // 准备FormData
                                const formData = new FormData();
                                formData.append('word_file', file);
                                
                                // 发送请求到后端
                                sendExtractRequest(formData);
                            } else {
                                // 图片提取
                                const fileInput = document.getElementById('imageFileInput');
                                let file = fileInput.files[0];
                                
                                // 优先使用粘贴的图片
                                if (pastedImage) {
                                    file = pastedImage;
                                }
                                
                                if (!file) {
                                    alert('请先选择或粘贴图片');
                                    return;
                                }
                                
                                // 显示加载状态
                                document.getElementById('extractLoading').classList.remove('hidden');
                                document.getElementById('extractButton').disabled = true;
                                
                                // 准备FormData
                                const formData = new FormData();
                                formData.append('image_file', file);
                                
                                // 发送请求到后端
                                sendExtractRequest(formData);
                            }
                        }
                        
                        function sendExtractRequest(formData) {
                            // 发送请求到后端
                            fetch('/api/extract_project_info', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                // 隐藏加载状态
                                document.getElementById('extractLoading').classList.add('hidden');
                                document.getElementById('extractButton').disabled = false;
                                
                                if (data.success) {
                                    // 显示提取结果
                                    document.getElementById('extractResult').classList.remove('hidden');
                                    document.getElementById('applyButton').classList.remove('hidden');
                                    
                                    // 存储提取的数据
                                    window.extractedProjectInfo = data.info;
                                    
                                    // 显示提取的信息
                                    let infoHtml = '';
                                    for (const [key, value] of Object.entries(data.info)) {
                                        // 跳过原始文本字段
                                        if (key === 'raw_text') continue;
                                        infoHtml += `<div><strong>${key}:</strong> ${value}</div>`;
                                    }
                                    document.getElementById('extractedInfo').innerHTML = infoHtml;
                                } else {
                                    alert('提取信息失败: ' + data.message);
                                }
                            })
                            .catch(error => {
                                document.getElementById('extractLoading').classList.add('hidden');
                                document.getElementById('extractButton').disabled = false;
                                alert('提取信息出错: ' + error);
                            });
                        }
                        
                        function applyExtractedInfo() {
                            const info = window.extractedProjectInfo;
                            if (!info) return;
                            
                            // 应用提取的信息到表单
                            if (info['项目名称'] || info['name']) document.getElementById('project_name').value = info['项目名称'] || info['name'];
                            if (info['建设单位'] || info['construction_unit']) document.getElementById('construction_unit').value = info['建设单位'] || info['construction_unit'];
                            if (info['设计单位'] || info['design_unit']) document.getElementById('design_unit').value = info['设计单位'] || info['design_unit'];
                            
                            // 处理项目地点
                            if (info['项目地点'] || info['location']) {
                                const location = info['项目地点'] || info['location'];
                                document.getElementById('project_location').value = location;
                                // 触发省市选择器更新
                                try {
                                    // 如果是省市区格式，尝试自动选择省市
                                    const provinceSelect = document.getElementById('province');
                                    const citySelect = document.getElementById('city');
                                    
                                    // 常见城市列表
                                    const cityMap = {
                                        '成都市': '四川省',
                                        '北京市': '北京市',
                                        '上海市': '上海市',
                                        '广州市': '广东省',
                                        '深圳市': '广东省',
                                        '重庆市': '重庆市',
                                        '武汉市': '湖北省',
                                        '南京市': '江苏省',
                                        '杭州市': '浙江省',
                                        '西安市': '陕西省',
                                        '成都': '四川省'
                                    };
                                    
                                    // 尝试根据城市选择省份
                                    if (provinceSelect && citySelect) {
                                        for (const city in cityMap) {
                                            if (location.includes(city)) {
                                                const province = cityMap[city];
                                                // 设置省份
                                                for (let i = 0; i < provinceSelect.options.length; i++) {
                                                    if (provinceSelect.options[i].text.includes(province)) {
                                                        provinceSelect.selectedIndex = i;
                                                        // 触发省份变更事件
                                                        const event = new Event('change');
                                                        provinceSelect.dispatchEvent(event);
                                                        
                                                        // 设置城市
                                                        setTimeout(() => {
                                                            for (let j = 0; j < citySelect.options.length; j++) {
                                                                if (citySelect.options[j].text.includes(city)) {
                                                                    citySelect.selectedIndex = j;
                                                                    citySelect.dispatchEvent(new Event('change'));
                                                                    break;
                                                                }
                                                            }
                                                        }, 300);
                                                        break;
                                                    }
                                                }
                                                break;
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error('省市选择器处理失败:', e);
                                }
                            }
                            
                            // 处理建筑分类
                            if (info['建筑分类'] || info['building_type']) {
                                const type = info['建筑分类'] || info['building_type'];
                                if (type.includes('居住') && type.includes('公共')) {
                                    document.getElementById('building_type').value = '居住+公共建筑';
                                } else if (type.includes('居住')) {
                                    document.getElementById('building_type').value = '居住建筑';
                                } else if (type.includes('公共')) {
                                    document.getElementById('building_type').value = '公共建筑';
                                } else {
                                    document.getElementById('building_type').value = type;
                                }
                            }
                            
                            // 处理气候分区
                            if (info['气候分区'] || info['climate_zone']) {
                                const zone = info['气候分区'] || info['climate_zone'];
                                if (zone.includes('I') || zone.includes('i') || zone.includes('1') || zone.includes('一')) {
                                    document.getElementById('climate_zone').value = 'I';
                                } else if (zone.includes('II') || zone.includes('ii') || zone.includes('2') || zone.includes('二')) {
                                    document.getElementById('climate_zone').value = 'II';
                                } else if (zone.includes('III') || zone.includes('iii') || zone.includes('3') || zone.includes('三')) {
                                    document.getElementById('climate_zone').value = 'III';
                                } else if (zone.includes('IV') || zone.includes('iv') || zone.includes('4') || zone.includes('四')) {
                                    document.getElementById('climate_zone').value = 'IV';
                                } else if (zone.includes('V') || zone.includes('v') || zone.includes('5') || zone.includes('五')) {
                                    document.getElementById('climate_zone').value = 'V';
                                } else {
                                    document.getElementById('climate_zone').value = zone;
                                }
                            }
                            
                            // 处理建筑面积数据
                            // 如果有总建筑面积
                            if (info['total_building_area'] || info['总建筑面积']) {
                                const area = (info['total_building_area'] || info['总建筑面积']).toString().replace(/[,\s]/g, '');
                                document.getElementById('total_building_area').value = area;
                            }
                            
                            // 如果有总用地面积
                            if (info['total_land_area'] || info['总用地面积']) {
                                const area = (info['total_land_area'] || info['总用地面积']).toString().replace(/[,\s平方米㎡m²]/g, '');
                                document.getElementById('total_land_area').value = area;
                                console.log('设置总用地面积:', area);
                            }
                            
                            // 如果有地上建筑面积
                            if (info['above_ground_area'] || info['地上建筑面积']) {
                                const area = (info['above_ground_area'] || info['地上建筑面积']).toString().replace(/[,\s]/g, '');
                                document.getElementById('above_ground_area').value = area;
                            }
                            
                            // 如果有地下建筑面积
                            if (info['underground_area'] || info['地下建筑面积']) {
                                const area = (info['underground_area'] || info['地下建筑面积']).toString().replace(/[,\s]/g, '');
                                document.getElementById('underground_area').value = area;
                            }
                            
                            // 处理建筑层数
                            if (info['building_floors'] || info['建筑层数']) {
                                const floors = info['building_floors'] || info['建筑层数'];
                                document.getElementById('building_floors').value = floors;
                                
                                // 解析层数信息，尝试提取地上/地下层数
                                try {
                                    const floorParts = floors.split('/');
                                    if (floorParts.length > 1 && parseInt(floorParts[1]) > 0) {
                                        // 如果有地下层
                                        document.getElementById('has_underground_garage').value = '有';
                                    }
                                } catch (e) {
                                    console.error('解析建筑层数失败:', e);
                                }
                            }
                            
                            // 处理建筑高度
                            if (info['building_height'] || info['建筑高度']) {
                                const height = (info['building_height'] || info['建筑高度']).toString().replace(/[,\s米m]/g, '');
                                document.getElementById('building_height').value = height;
                            }
                            
                            // 处理容积率
                            if (info['plot_ratio'] || info['容积率']) {
                                const ratio = (info['plot_ratio'] || info['容积率']).toString();
                                document.getElementById('plot_ratio').value = ratio;
                            }
                            
                            // 处理建筑密度
                            if (info['building_density'] || info['建筑密度']) {
                                const density = (info['building_density'] || info['建筑密度']).toString();
                                document.getElementById('building_density').value = density;
                            }
                            
                            // 处理绿地率
                            if (info['green_ratio'] || info['绿地率']) {
                                const ratio = (info['green_ratio'] || info['绿地率']).toString();
                                document.getElementById('green_ratio').value = ratio;
                            }
                            
                            // 处理基底面积
                            if (info['building_base_area'] || info['基底面积']) {
                                const baseArea = (info['building_base_area'] || info['基底面积']).toString().replace(/[,\s平方米㎡m²]/g, '');
                                document.getElementById('building_base_area').value = baseArea;
                                console.log('设置基底面积:', baseArea);
                            }
                            
                            // 处理绿地面积
                            if (info['green_area'] || info['绿地面积']) {
                                const greenArea = (info['green_area'] || info['绿地面积']).toString().replace(/[,\s平方米㎡m²]/g, '');
                                document.getElementById('green_area').value = greenArea;
                                console.log('设置绿地面积:', greenArea);
                            }
                            
                            // 关闭模态框
                            closeAiExtractModal();
                            
                            // 触发得分计算
                            if (typeof calculateAndUpdateScores === 'function') {
                                calculateAndUpdateScores();
                            }
                        }
                    </script>
                    
                    <form action="{{ url_for('index') }}" method="post" class="space-y-6">
                        <input type="hidden" name="form_type" value="project_info">
                        <input type="hidden" id="project_id" name="project_id" value="{{ project.id if project else '' }}">
                        <input type="hidden" id="project_name_hidden" value="{{ project.name if project else '' }}">
                        
                        <!-- 基本信息部分 -->
                        <h3 class="text-lg font-medium text-primary mb-4">基本信息</h3>
                        <div class="bg-white overflow-x-auto rounded-lg grid grid-cols-3 gap-c-1">
                            <div class="mb-4 px-3 ">
                                <label for="project_name" class="block text-base font-medium text-primary mb-2">项目名称 <span class="text-red-500">*</span></label>
                                <input type="text" id="project_name" name="project_name" class="w-full px-4 py-2 border border-gray-300 rounded-button " placeholder="请输入项目名称" value="{{ project.name if project else '' }}" required>
                            </div>
                            
                            <div class="mb-4 px-3">
                                <label for="project_code" class="block text-base font-medium text-primary mb-2">项目编号</label>
                                <input type="text" id="project_code" name="project_code" class="w-full px-4 py-2 border border-gray-300 rounded-button" placeholder="请输入项目编号" value="{{ project.code if project and project.code is not none else '' }}">
                            </div>
                            
                            <div class="mb-4 px-3">
                                <label for="construction_unit" class="block text-base font-medium text-primary mb-2">建设单位</label>
                                <input type="text" id="construction_unit" name="construction_unit" class="w-full px-4 py-2 border border-gray-300 rounded-button " placeholder="请输入建设单位名称" value="{{ project.construction_unit if project and project.construction_unit is not none else '' }}">
                            </div>
                            
                            <div class="mb-4 px-3">
                                <label for="design_unit" class="block text-base font-medium text-primary mb-2">设计单位</label>
                                <input type="text" id="design_unit" name="design_unit" class="w-full px-4 py-2 border border-gray-300 rounded-button  " placeholder="请输入设计单位名称" value="{{ project.design_unit if project and project.design_unit is not none else '' }}">
                            </div>
                            
                            <div class="mb-4 px-3">
                                <label for="project_location" class="block text-base font-medium text-primary mb-2">项目地点</label>
                                <div class="flex space-x-2 province-city-container">
                                    <select id="province" class="flex-1 px-4 py-2 border border-gray-300 rounded-button" onchange="updateProvinceCity()" title="省份">
                                        <option value="">正在加载...</option>
                                    </select>
                                    <select id="city" class="flex-1 px-4 py-2 border border-gray-300 rounded-button" onchange="updateProvinceCity()" title="城市">
                                        <option value="">请选择城市</option>
                                    </select>
                                    <input type="hidden" id="project_location" name="project_location" value="{{ project.location if project and project.location is not none else '' }}">
                                </div>
                            </div>
                            
                            <div class="mb-4 px-3">
                                <label for="building_type" class="block text-base font-medium text-primary mb-2">建筑类型</label>
                                <div class="relative">
                                    <select id="building_type" name="building_type" class="w-full px-4 py-2 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary appearance-none pr-8" required title="建筑类型">
                                        <option value="">请选择建筑类型</option>
                                        <option value="居住建筑" {% if project and project.building_type == '居住建筑' %}selected{% endif %}>居住建筑</option>
                                        <option value="公共建筑" {% if project and project.building_type == '公共建筑' %}selected{% endif %}>公共建筑</option>
                                        <option value="工业建筑" {% if project and project.building_type == '工业建筑' %}selected{% endif %}>工业建筑</option>
                                        <option value="居住+公共建筑" {% if project and project.building_type == '居住+公共建筑' %}selected{% endif %}>居住+公共建筑</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-4 px-3">
                                <label for="standard_selection" class="block text-base font-medium text-primary mb-2">评价标准</label>
                                <div class="mt-2">
                                    <select id="standard_selection" name="standard_selection" class="w-full px-4 py-2 border border-gray-300 rounded-button">
                                        <option value="">请选择评价标准</option>
                                        <option value="国标" {% if project and project.standard == '国标' %}selected{% endif %}>绿色建筑评价标准 GB/T 50378-2019（2024版）</option>
                                        <option value="四川省标" {% if project and project.standard == '四川省标' %}selected{% endif %}>四川省民用绿色建筑设计施工图阶段审查技术要点（2024版）</option>
                                        <option value="成都市标" {% if project and project.standard == '成都市标' %}selected{% endif %}>成都市绿色建筑施工图设计与审查技术要点（2024版）</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-4 px-3">
                                <div class="flex items-center justify-between mb-2">
                                    <label for="climate_zone" class="block text-base font-medium text-primary">建筑气候区划</label>
                                    <a href="{{ url_for('static', filename='image/气候区划.png') }}" target="_blank" class="underline text-blue-600 px-2 py-1 rounded-md transition-all duration-300 hover:bg-blue-50 hover:text-purple-600 hover:shadow-sm text-sm">
                                        <i class="fas fa-external-link-alt text-blue-500 mr-1"></i>查看气候区划图
                                    </a>
                                </div>
                                <div class="relative">
                                    <select id="climate_zone" name="climate_zone" class="w-full px-4 py-2 border border-gray-300 rounded-button appearance-none pr-8" title="建筑气候区划">
                                        <option value="">请选择建筑气候区划</option>
                                        <option value="I" {% if project and project.climate_zone == 'I' %}selected{% endif %}>I</option>
                                        <option value="II" {% if project and project.climate_zone == 'II' %}selected{% endif %}>II</option>
                                        <option value="III" {% if project and project.climate_zone == 'III' %}selected{% endif %}>III</option>
                                        <option value="IV" {% if project and project.climate_zone == 'IV' %}selected{% endif %}>IV</option>
                                        <option value="V" {% if project and project.climate_zone == 'V' %}selected{% endif %}>V</option>
                                        <option value="VI" {% if project and project.climate_zone == 'VI' %}selected{% endif %}>VI</option>
                                        <option value="VII" {% if project and project.climate_zone == 'VII' %}selected{% endif %}>VII</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-4 px-3">
                                <label for="star_rating_target" class="block text-base font-medium text-primary mb-2">星级目标</label>
                                <div class="relative">
                                    <select id="star_rating_target" name="star_rating_target" class="w-full px-4 py-2 border border-gray-300 rounded-button appearance-none pr-8">
                                        <option value="基本级" {% if project and project.star_rating_target == '基本级' %}selected{% endif %}>基本级</option>
                                        <option value="一星级" {% if project and project.star_rating_target == '一星级' %}selected{% endif %}>一星级</option>
                                        <option value="二星级" {% if project and project.star_rating_target == '二星级' %}selected{% endif %}>二星级</option>
                                        <option value="三星级" {% if project and project.star_rating_target == '三星级' %}selected{% endif %}>三星级</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                        <h3 class="text-xl font-medium text-primary mb-4 mt-8">详细信息</h3>
                        <div class="bg-white overflow-x-auto rounded-lg">
                            <table class="min-w-full detail-table divide-y divide-gray-200">
                                <colgroup>
                                    <col style="width: 16.66%;">
                                    <col style="width: 16.66%;">
                                    <col style="width: 16.66%;">
                                    <col style="width: 16.66%;">
                                    <col style="width: 16.66%;">
                                    <col style="width: 16.66%;">
                                </colgroup>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <!-- 第一行 -->
                                    <tr>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="total_land_area" class="block text-sm font-medium text-gray-700 mb-1">总用地面积（平方米）</label>
                                            <input type="number" step="0.01" id="total_land_area" name="total_land_area" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ '%.2f'|format(project.total_land_area) if project and project.total_land_area else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="total_building_area" class="block text-sm font-medium text-gray-700 mb-1">总建筑面积（平方米）</label>
                                            <input type="number" step="0.01" id="total_building_area" name="total_building_area" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ '%.2f'|format(project.total_building_area) if project and project.total_building_area else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="above_ground_area" class="block text-sm font-medium text-gray-700 mb-1">地上建筑面积（平方米）</label>
                                            <input type="number" step="0.01" id="above_ground_area" name="above_ground_area" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ '%.2f'|format(project.above_ground_area) if project and project.above_ground_area else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="underground_area" class="block text-sm font-medium text-gray-700 mb-1">地下建筑面积（平方米）</label>
                                            <input type="number" step="0.01" id="underground_area" name="underground_area" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ '%.2f'|format(project.underground_area) if project and project.underground_area else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="first_floor_underground_area" class="block text-sm font-medium text-gray-700 mb-1">地下一层建筑面积（平方米）</label>
                                            <input type="number" step="0.01" id="first_floor_underground_area" name="first_floor_underground_area" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ '%.2f'|format(project.underground_floor_area) if project and project.underground_floor_area else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="ground_parking_spaces" class="block text-sm font-medium text-gray-700 mb-1">地面停车位数量</label>
                                            <input type="number" id="ground_parking_spaces" name="ground_parking_spaces" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ project.ground_parking_spaces if project and project.ground_parking_spaces is not none else '' }}">
                                        </td>
                                    </tr>
                                    <!-- 第二行 -->
                                    <tr>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="plot_ratio" class="block text-sm font-medium text-gray-700 mb-1">容积率</label>
                                            <input type="number" step="0.01" id="plot_ratio" name="plot_ratio" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ project.plot_ratio if project and project.plot_ratio is not none else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="building_base_area" class="block text-sm font-medium text-gray-700 mb-1">建筑基底面积（平方米）</label>
                                            <input type="number" step="0.01" id="building_base_area" name="building_base_area" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ '%.2f'|format(project.building_base_area) if project and project.building_base_area else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="building_density" class="block text-sm font-medium text-gray-700 mb-1">建筑密度（%）</label>
                                            <input type="number" step="0.01" id="building_density" name="building_density" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ project.building_density if project and project.building_density is not none else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="green_area" class="block text-sm font-medium text-gray-700 mb-1">绿地面积（平方米）</label>
                                            <input type="number" step="0.01" id="green_area" name="green_area" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ '%.2f'|format(project.green_area) if project and project.green_area else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="green_ratio" class="block text-sm font-medium text-gray-700 mb-1">绿地率（%）</label>
                                            <input type="number" step="0.01" id="green_ratio" name="green_ratio" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ project.green_ratio if project and project.green_ratio is not none else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="residential_units" class="block text-sm font-medium text-gray-700 mb-1">住宅户数</label>
                                            <input type="number" id="residential_units" name="residential_units" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ project.residential_units if project and project.residential_units is not none else '' }}">
                                        </td>
                                    </tr>
                                    <!-- 第三行 -->
                                    <tr>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="building_floors" class="block text-sm font-medium text-gray-700 mb-1">建筑层数（地上/地下）</label>
                                            <input type="text" id="building_floors" name="building_floors" class="w-full px-2 py-1 border border-gray-300 rounded-md" placeholder="例如：18/2" value="{{ project.building_floors if project and project.building_floors is not none else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="building_height" class="block text-sm font-medium text-gray-700 mb-1">建筑高度（米）</label>
                                            <input type="number" step="0.01" id="building_height" name="building_height" class="w-full px-2 py-1 border border-gray-300 rounded-md" value="{{ project.building_height if project and project.building_height is not none else '' }}">
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="ac_type" class="block text-sm font-medium text-gray-700 mb-1">空调形式</label>
                                            <div class="relative">
                                                <select id="ac_type" name="ac_type" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="分体式空调" {% if project and project.air_conditioning_type == '分体式空调' %}selected{% endif %}>分体式空调</option>
                                                    <option value="多联式空调" {% if project and project.air_conditioning_type == '多联式空调' %}selected{% endif %}>多联式空调</option>
                                                    <option value="集中空调" {% if project and project.air_conditioning_type == '集中空调' %}selected{% endif %}>集中空调</option>
                                                    <option value="组合形式" {% if project and project.air_conditioning_type == '组合形式' %}selected{% endif %}>组合形式</option>
                                                    <option value="无" {% if project and project.air_conditioning_type == '无' %}selected{% endif %}>无</option>
                                                </select>
                                          
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="avg_floors" class="block text-sm font-medium text-gray-700 mb-1">住宅平均层数</label>
                                            <div class="relative">
                                                <select id="avg_floors" name="avg_floors" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="平均3层及以下" {% if project and project.average_floors == '平均3层及以下' %}selected{% endif %}>平均3层及以下</option>
                                                    <option value="平均4-6层" {% if project and project.average_floors == '平均4-6层' %}selected{% endif %}>平均4-6层</option>
                                                    <option value="平均7-9层" {% if project and project.average_floors == '平均7-9层' %}selected{% endif %}>平均7-9层</option>
                                                    <option value="平均10-18层" {% if project and project.average_floors == '平均10-18层' %}selected{% endif %}>平均10-18层</option>
                                                    <option value="平均19层及以上" {% if project and project.average_floors == '平均19层及以上' %}selected{% endif %}>平均19层及以上</option>
                                                </select>
                                                
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="has_garbage_room" class="block text-sm font-medium text-gray-700 mb-1">有无垃圾用房</label>
                                            <div class="relative">
                                                <select id="has_garbage_room" name="has_garbage_room" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="有" {% if project and project.has_garbage_room == '有' %}selected{% endif %}>有</option>
                                                    <option value="无" {% if project and project.has_garbage_room == '无' %}selected{% endif %}>无</option>
                                                </select>
                              
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="has_elevator" class="block text-sm font-medium text-gray-700 mb-1">有无电梯或扶梯</label>
                                            <div class="relative">
                                                <select id="has_elevator" name="has_elevator" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="有" {% if project and project.has_elevator == '有' %}selected{% endif %}>有</option>
                                                    <option value="无" {% if project and project.has_elevator == '无' %}selected{% endif %}>无</option>
                                                </select>
                                                
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- 第四行 -->
                                    <tr>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="has_underground_garage" class="block text-sm font-medium text-gray-700 mb-1">有无地下车库</label>
                                            <div class="relative">
                                                <select id="has_underground_garage" name="has_underground_garage" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="有" {% if project and project.has_underground_garage == '有' %}selected{% endif %}>有</option>
                                                    <option value="无" {% if project and project.has_underground_garage == '无' %}selected{% endif %}>无</option>
                                                </select>
                                            
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap w-1/6">
                                            <label for="construction_type" class="block text-sm font-medium text-gray-700 mb-1">项目建设情况</label>
                                            <div class="relative">
                                                <select id="construction_type" name="construction_type" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="新区建设" {% if project and project.construction_type == '新区建设' %}selected{% endif %}>新区建设</option>
                                                    <option value="旧区改建" {% if project and project.construction_type == '旧区改建' %}selected{% endif %}>旧区改建</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="has_water_landscape" class="block text-sm font-medium text-gray-700 mb-1">有无景观水体</label>
                                            <div class="relative">
                                                <select id="has_water_landscape" name="has_water_landscape" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="有" {% if project and project.has_water_landscape == '有' %}selected{% endif %}>有</option>
                                                    <option value="无" {% if project and project.has_water_landscape == '无' %}selected{% endif %}>无</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="is_fully_decorated" class="block text-sm font-medium text-gray-700 mb-1">是否为全装修项目</label>
                                            <div class="relative">
                                                <select id="is_fully_decorated" name="is_fully_decorated" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="是" {% if project and project.is_fully_decorated == '是' %}selected{% endif %}>是</option>
                                                    <option value="否" {% if project and project.is_fully_decorated == '否' %}selected{% endif %}>否</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="public_building_type" class="block text-sm font-medium text-gray-700 mb-1">公建类型</label>
                                            <div class="relative">
                                                <select id="public_building_type" name="public_building_type" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="办公" {% if project and project.public_building_type == '办公' %}selected{% endif %}>办公</option>
                                                    <option value="商业" {% if project and project.public_building_type == '商业' %}selected{% endif %}>商业</option>
                                                    <option value="金融" {% if project and project.public_building_type == '金融' %}selected{% endif %}>金融</option>
                                                    <option value="旅馆饭店" {% if project and project.public_building_type == '旅馆饭店' %}selected{% endif %}>旅馆饭店</option>
                                                    <option value="交通枢纽" {% if project and project.public_building_type == '交通枢纽' %}selected{% endif %}>交通枢纽</option>
                                                    <option value="教育" {% if project and project.public_building_type == '教育' %}selected{% endif %}>教育</option>
                                                    <option value="文化" {% if project and project.public_building_type == '文化' %}selected{% endif %}>文化</option>
                                                    <option value="体育" {% if project and project.public_building_type == '体育' %}selected{% endif %}>体育</option>
                                                    <option value="医疗" {% if project and project.public_building_type == '医疗' %}selected{% endif %}>医疗</option>
                                                    <option value="卫生" {% if project and project.public_building_type == '卫生' %}selected{% endif %}>卫生</option>
                                                    <option value="社会福利" {% if project and project.public_building_type == '社会福利' %}selected{% endif %}>社会福利</option>
                                                </select>
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 whitespace-nowrap w-1/6">
                                            <label for="public_green_space" class="block text-sm font-medium text-gray-700 mb-1">绿地向公众开发</label>
                                            <div class="relative">
                                                <select id="public_green_space" name="public_green_space" class="w-full px-2 py-1 border border-gray-300 rounded-md appearance-none pr-8">
                                                    <option value="">请选择</option>
                                                    <option value="是" {% if project and project.public_green_space == '是' %}selected{% endif %}>是</option>
                                                    <option value="否" {% if project and project.public_green_space == '否' %}selected{% endif %}>否</option>
                                                </select>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mt-8">
                        <button type="submit" class="px-6 py-2 bg-primary text-white rounded-button hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            保存项目信息
                        </button>
                        <button type="button" id="loadStarCaseBtn" class="ml-4 px-6 py-2 bg-primary text-white rounded-button hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                            载入星级案例
                        </button>
                    </div>
                    </form>
                    <!-- 自动计算得分 --> 
                    <div class="mt-4 bg-green-50 rounded-lg px-2" style="display: inline-block;">
                        <label class="text-gray-700">绿建得分自动计算</label>
                        <div class="text-sm text-gray-700 " style="font-style: italic;">
                            <label id="per_capita_land_score">人均居住用地指标得分：</label>
                            <label id="plot_ratio_score">公建容积率指标得分：</label>
                            <label id="underground_score">地下空间开发利用得分：</label>
                            <label id="green_space_score">绿化用地指标得分：</label>
                            <label id="parking_score">停车设施得分：</label>
                        </div>
                    </div>
                    <script>
                        // 页面加载完成后执行计算和更新
                        document.addEventListener('DOMContentLoaded', function() {
                            calculateAndUpdateScores();
                            
                            // 监听表单字段变化，重新计算得分
                            const formFields = [
                                'total_land_area', 'residential_units', 'avg_floors', 'building_type',
                                'underground_area', 'first_floor_underground_area', 'above_ground_area',
                                'green_area', 'construction_type', 'public_green_space', 'climate_zone',
                                'plot_ratio', 'public_building_type', 'green_ratio', 'ground_parking_spaces',
                                'has_underground_garage'
                            ];
                            
                            formFields.forEach(fieldId => {
                                const field = document.getElementById(fieldId);
                                if (field) {
                                    field.addEventListener('change', calculateAndUpdateScores);
                                }
                            });
                        });
                        
                        // 计算得分并更新数据库
                        function calculateAndUpdateScores() {
                            //总用地面积
                            const totalLandArea = parseFloat(document.getElementById('total_land_area').value) || 0;
                            //住宅总套数
                            const residentialUnits = parseInt(document.getElementById('residential_units').value) || 0;
                            //住宅平均层数
                            const averageFloors = document.getElementById('avg_floors').value;
                            //建筑类型
                            const buildingType = document.getElementById('building_type').value;
                            //地下空间面积
                            const undergroundArea = parseFloat(document.getElementById('underground_area').value) || 0;
                            //地下一层面积
                            const undergroundFirstFloor = parseFloat(document.getElementById('first_floor_underground_area').value) || 0;
                            //地上面积
                            const aboveGroundArea = parseFloat(document.getElementById('above_ground_area').value) || 0;
                            //绿化用地面积
                            const greenSpaceArea = parseFloat(document.getElementById('green_area').value) || 0;
                            //项目类型
                            const projectType = document.getElementById('construction_type').value;
                            //绿地向公众开放
                            const publicGreenSpace = document.getElementById('public_green_space').value;
                            //建筑层数
                            let floors = 0;
                            switch (averageFloors) {
                                case "平均3层及以下": floors = 3; break;
                                case "平均4-6层": floors = 4; break;
                                case "平均7-9层": floors = 7; break;
                                case "平均10-18层": floors = 10; break;
                                case "平均19层及以上": floors = 19; break;
                                default: floors = 0;
                            }
                            //气候区
                            const climateZone = document.getElementById('climate_zone').value;
                            //容积率
                            const plotRatio = parseFloat(document.getElementById('plot_ratio').value) || 0;
                            //公建类型
                            const publicBuildingType = document.getElementById('public_building_type').value;
                            //绿地率与规划绿地率的比值
                            const greenRate = parseFloat(document.getElementById('green_ratio').value) /0.3|| 0;
                            //人均集中绿地面积
                            const greenArea = parseFloat(document.getElementById('green_area').value)/(residentialUnits*3.2) || 0;
                            //地面停车位数量
                            const groundParkingCount = parseFloat(document.getElementById('ground_parking_spaces').value) || 0;
                            // 计算各项得分
                            const perCapitaLandScore = calculatePerCapitaLandScore(totalLandArea, residentialUnits, 3.2, climateZone, floors);
                            //公建容积率指标得分
                            const plotRatioScore = calculatePlotRatioScore(plotRatio, publicBuildingType);
                            //地下空间开发利用得分
                            const undergroundScore = calculateUndergroundScore(buildingType, undergroundArea, undergroundFirstFloor, aboveGroundArea, totalLandArea);
                            //绿化用地指标得分
                            const greenSpaceScore = calculateGreenScore(buildingType, greenRate, greenArea, projectType, publicGreenSpace);
                            //有无地下车库
                            const hasundergroundgarage=document.getElementById('has_underground_garage').value;
                            //停车设施得分
                            let parkingScore = 0;
                            if (hasundergroundgarage === '有') {
                                if (buildingType === '居住建筑') {
                                     parkingScore = calculateParkingScore(buildingType, groundParkingCount, residentialUnits);
                                } else if (buildingType === '公共建筑'){
                                     parkingScore = calculateParkingScore(buildingType, groundParkingCount*34, totalLandArea);
                                }
                            }
                            // 更新显示
                            document.getElementById('per_capita_land_score').innerHTML = '人均居住用地指标得分：' + perCapitaLandScore+' ;';
                            document.getElementById('plot_ratio_score').innerHTML = '公建容积率指标得分：' + plotRatioScore+' ;';
                            document.getElementById('underground_score').innerHTML = '地下空间开发利用得分：' + undergroundScore+' ;';
                            document.getElementById('green_space_score').innerHTML = '绿化用地指标得分：' + greenSpaceScore+' ;';
                            document.getElementById('parking_score').innerHTML = '停车设施得分：' + parkingScore+' ;';
                            
                            // 修改多个条文的得分   
                            let standard = document.getElementById('current-project-standard').value || '成都市标';
                            let projectId = document.getElementById('current-project-id').value;
                            
                            if (!projectId) {
                                console.log('未找到项目ID，无法更新得分');
                                return;
                            }
                            
                            try {
                                if (standard === '成都市标'){
                                    if (buildingType === '居住建筑'){
                                        updateDatabaseScore('3.1.2.14', perCapitaLandScore, projectId);
                                    } else if (buildingType === '公共建筑'){
                                        updateDatabaseScore('3.1.2.14', plotRatioScore, projectId);
                                    }
                                    updateDatabaseScore('3.1.2.15', undergroundScore, projectId);
                                    updateDatabaseScore('3.1.2.21', greenSpaceScore, projectId);
                                    updateDatabaseScore('3.1.2.16', parkingScore, projectId);
                                }
                                else if (standard === '四川省标'){
                                    if (buildingType === '居住建筑'){
                                        updateDatabaseScore('3.1.16', perCapitaLandScore, projectId);
                                    }
                                    else if (buildingType === '公共建筑'){
                                        updateDatabaseScore('3.1.16', plotRatioScore, projectId);
                                    }
                                    updateDatabaseScore('3.1.17', undergroundScore, projectId);
                                    updateDatabaseScore('3.1.25', greenSpaceScore, projectId);
                                    updateDatabaseScore('3.1.18', parkingScore, projectId);
                                }
                                else if (standard === '国标'){
                                    if (buildingType === '居住建筑'){
                                        updateDatabaseScore('7.2.1', perCapitaLandScore, projectId);
                                    }
                                    else if (buildingType === '公共建筑'){
                                        updateDatabaseScore('7.2.1', plotRatioScore, projectId);
                                    }
                                    updateDatabaseScore('7.2.2', undergroundScore, projectId);
                                    updateDatabaseScore('8.2.3', greenSpaceScore, projectId);
                                    updateDatabaseScore('7.2.3', parkingScore, projectId);
                                }
                                console.log('得分更新完成');
                            } catch (error) {
                                console.error('更新得分时出错:', error);
                            }
                        }
                    </script>
                    {% elif current_page == 'green_materials' %}
                    <!-- 绿色建材计算器内容 -->
                    <div class="green-materials-container">
                        <!-- 使用iframe嵌入绿色建材计算器，添加preload提前加载 -->
                        <iframe id="myIframe" src="{{ url_for('calculator') }}" 
                            style="width:100%; border:none;overflow:hidden;"
                            title="绿色建材比例计算" loading="eager"></iframe>
                    </div>
                    <script>
                        function resizeIframe() {
                          const iframe = document.getElementById('myIframe');
                          iframe.style.height = iframe.contentWindow.document.body.scrollHeight + 'px';
                        }
                      
                        window.onload = resizeIframe;
                        window.onresize = resizeIframe;
                      </script>
                    {% elif current_page == 'specialty' %}
                    <!-- 标准列表内容 -->
                    <!-- 添加隐藏的项目ID字段 -->
                    <input type="hidden" id="project_id" name="project_id" value="{{ project.id if project else '' }}">
                    
                    <div class="overflow-x-auto ">
                        {% if standards %}
                        
                        {% if current_level == '提高级' %}
                        <!-- 提高级分类过滤器 -->
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg shadow-sm">
                            <div class="flex flex-wrap items-center">
                                <span class="mr-2 font-medium">分类过滤:</span>
                                <div class="flex flex-wrap gap-2">
                                    <button id="filter-all" class="px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-medium category-filter active">全部</button>
                                    <button id="filter-安全耐久" data-category="安全耐久" class="px-3 py-1 rounded-full bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm font-medium category-filter">安全耐久</button>
                                    <button id="filter-健康舒适" data-category="健康舒适" class="px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-800 text-sm font-medium category-filter">健康舒适</button>
                                    <button id="filter-生活便利" data-category="生活便利" class="px-3 py-1 rounded-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 text-sm font-medium category-filter">生活便利</button>
                                    <button id="filter-资源节约" data-category="资源节约" class="px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-800 text-sm font-medium category-filter">资源节约</button>
                                    <button id="filter-环境宜居" data-category="环境宜居" class="px-3 py-1 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 text-sm font-medium category-filter">环境宜居</button>
                                    <button id="filter-提高与创新" data-category="提高与创新" class="px-3 py-1 rounded-full bg-purple-100 hover:bg-purple-200 text-purple-800 text-sm font-medium category-filter">提高与创新</button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <table class="min-w-full divide-y divide-gray-200 table-fixed">
                            <thead class="bg-primary">
                                <tr>
                                    {% if current_level == '基本级' %}
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">条文号</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-30">条文内容</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分值</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">是否达标</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap technical-measures-cell">技术措施</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">审查材料</th>
                                    {% elif current_level == '提高级' %}
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">条文号</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分类</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-30">条文内容</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-5">分值</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">得分</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap technical-measures-cell">技术措施</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap w-10">审查材料</th>
                                    {% else %}
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">条文号</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">分类</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">条文内容</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">分值</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-white tracking-wider whitespace-nowrap">审查材料</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for standard in standards %}
                                <tr class="table-row-hover">
                                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">{{ standard.条文号 }}</td>
                                    {% if current_level == '提高级' %}
                                    <td class="px-6 py-4 whitespace-normal h-16 text-base text-gray-700">
                                        <span class="category-tag category-{{ standard.分类 }}">{{ standard.分类 }}</span>
                                    </td>
                                    {% endif %}
                                    <td class="px-6 py-4 text-base text-gray-700">{{ standard.条文内容 }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">{{ standard.分值 }}</td>
                                    
                                    {% if current_level == '基本级' %}
                                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">
                                        <select name="is_achieved" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary is-achieved-select" title="符合性判断">
                                            <option value="是">是</option>
                                            <option value="否">否</option>
                                            <option value="不参评">不参评</option>
                                        </select>
                                    </td>
                                    <td class="px-6 py-4 text-base text-gray-700">
                                        <textarea name="technical_measures" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary technical-measures" placeholder="请输入技术措施"></textarea>
                                    </td>
                                    <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                                    {% elif current_level == '提高级' %}
                                    <td class="px-6 py-4 whitespace-nowrap text-base text-gray-700">
                                        {% if standard.分值 == '—' %}
                                        <span class="text-gray-500">—</span>
                                        {% else %}
                                        <input type="text" name="score" data-clause="{{ standard.条文号 }}" data-maxscore="{{ standard.分值 }}" class="w-full rounded focus:border-primary" placeholder="得分">
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 text-base text-gray-700 technical-measures-cell">
                                        <textarea name="technical_measures" data-clause="{{ standard.条文号 }}" class="w-full rounded focus:border-primary technical-measures" placeholder="请输入技术措施"></textarea>
                                    </td>
                                    <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                                    {% else %}
                                    <td class="px-6 py-4 text-base text-gray-700">{{ standard.审查材料 }}</td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <!-- 添加保存按钮 -->
                        <div class="mt-8 flex justify-center">
                            <button type="button" id="saveScoreBtn" class="px-6 py-3 bg-primary text-white rounded-lg shadow-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                保存评分信息
                            </button>
                        </div>

                        <!-- 评分统计表格 -->
                        {% if current_level == '提高级' %}

                        {% endif %}
                        {% else %}
                        <div class="text-center py-10">
                            <p class="text-gray-500 text-xl">没有找到符合条件的记录</p>
                            <p class="text-gray-400 text-lg mt-2">请尝试其他筛选条件</p>
                        </div>
                        {% endif %}
                    {% endif %}
                    {% endblock %}
                </div>
            </main>
        </div>
    </div>

    <!-- 添加悬浮保存按钮，仅在基本级和提高级页面显示 -->
    {% if current_level == '基本级' or current_level == '提高级' %}
    <div class="floating-save-btn" id="floatingSaveBtn">
        <i class="ri-save-line"></i>
    </div>
    {% endif %}

    <script>
    // 获取DOM元素
    const basicMenuToggle = document.getElementById('basicMenuToggle');
    const basicMenuContent = document.getElementById('basicMenuContent');
    const advancedMenuToggle = document.getElementById('advancedMenuToggle');
    const advancedMenuContent = advancedMenuToggle ? document.getElementById('advancedMenuContent') : null;
    const reportMenuToggle = document.getElementById('reportMenuToggle');
    const reportMenuContent = document.getElementById('reportMenuContent');
    const loadStarCaseBtn = document.getElementById('loadStarCaseBtn');
    const saveStarCaseBtn = document.getElementById('saveStarCaseBtn');

    // 添加防抖函数
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    // 为载入星级案例按钮添加点击事件
    if (loadStarCaseBtn) {
        loadStarCaseBtn.addEventListener('click', async function() {
            try {
                // 获取项目ID
                const projectId = document.getElementById('project_id').value;
                if (!projectId) {
                    alert('未找到项目ID');
                    return;
                }

                // 显示加载状态
                const originalText = this.textContent;
                this.textContent = '载入中...';
                this.disabled = true;

                // 调用API获取星级案例数据
                const response = await fetch(`/api/star_case_scores?target_project_id=${projectId}`);
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                } else {
                    alert(data.message || '载入星级案例失败');
                }
            } catch (error) {
                console.error('载入星级案例失败:', error);
                alert('载入星级案例失败，请重试');
            } finally {
                // 恢复按钮状态
                this.textContent = '载入星级案例';
                this.disabled = false;
            }
        });
    }

    // 为保存星级案例按钮添加点击事件
    if (saveStarCaseBtn) {
        saveStarCaseBtn.addEventListener('click', async function() {
            try {
                // 获取项目ID
                const projectId = document.getElementById('project_id').value;
                if (!projectId) {
                    alert('未找到项目ID');
                    return;
                }

                // 显示加载状态
                const originalText = this.textContent;
                this.textContent = '保存中...';
                this.disabled = true;

                // 调用API保存星级案例数据
                const response = await fetch(`/api/save_star_case?project_id=${projectId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                } else {
                    alert(data.message || '保存星级案例失败');
                }
            } catch (error) {
                console.error('保存星级案例失败:', error);
                alert('保存星级案例失败，请重试');
            } finally {
                // 恢复按钮状态
                this.textContent = '保存星级案例';
                this.disabled = false;
            }
        });
    }

    // 防止页面跳动的函数
    function preventPageJump() {
        // 记录当前滚动位置
        const scrollPosition = window.scrollY;
        
        // 在下一个事件循环中恢复滚动位置
        setTimeout(() => {
            window.scrollTo(0, scrollPosition);
        }, 0);
    }
    
    // 添加菜单切换事件
    basicMenuToggle.addEventListener('click', function() {
        basicMenuContent.classList.toggle('expanded');
        const arrow = this.querySelector('.ri-arrow-down-s-line');
        if (arrow) {
            arrow.style.transform = basicMenuContent.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
    });
    
    if (advancedMenuToggle) {
        advancedMenuToggle.addEventListener('click', function() {
            advancedMenuContent.classList.toggle('expanded');
            const arrow = this.querySelector('.ri-arrow-down-s-line');
            if (arrow) {
                arrow.style.transform = advancedMenuContent.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        });
    }
    
    reportMenuToggle.addEventListener('click', function() {
        reportMenuContent.classList.toggle('expanded');
        const arrow = this.querySelector('.ri-arrow-down-s-line');
        if (arrow) {
            arrow.style.transform = reportMenuContent.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
        }
    });
    
    // 获取评分汇总数据
    function fetchScoreSummary(forceRefresh = false) {
        // 获取项目ID
        let projectId = null;
        const projectIdField = document.getElementById('project_id');
        if (projectIdField) {
            projectId = projectIdField.value;
        } else {
            // 尝试从URL中获取项目ID
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('project_id');
        }
        
        // 如果没有项目ID，则无法获取评分汇总
        if (!projectId) {
            console.warn('未找到项目ID，无法获取评分汇总');
            return;
        }
        
        // 获取项目评价标准
        let projectStandard = '{{ project.standard if project and project.standard else "成都市标" }}';
        
        console.log(`获取评分汇总数据: 项目ID=${projectId}, 评价标准=${projectStandard}, 强制刷新=${forceRefresh}`);
     
        // 直接调用计算评分API，使用返回数据更新界面
        fetch(`/api/calculate_scores/${projectId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`服务器错误 (${response.status})`);
            }
            return response.json();
        })
        .then(data => {
            console.log('获取评分计算数据成功:', data);
            
            // 显示评价标准信息 - 如果元素存在才执行
            if (standardInfoEl && data.project_standard) {
                standardInfoEl.innerHTML = `
                    <span class="font-semibold">当前评价标准:</span> 
                    <span class="text-primary">${data.project_standard}</span>
                `;
            }
            
            // 更新评分汇总表格
            updateScoreSummaryTables(data);

        })
        .catch(error => {
            console.error('获取评分计算数据失败:', error);
        });
    }
    
    // 使用防抖处理的获取评分汇总函数
    const debouncedFetchScoreSummary = debounce(fetchScoreSummary, 300);
    
    // 在页面加载完成后获取评分汇总数据
    document.addEventListener('DOMContentLoaded', function() {
        // 恢复之前保存的滚动位置
        const savedScrollPosition = sessionStorage.getItem('scrollPosition');
        if (savedScrollPosition) {
            window.scrollTo(0, parseInt(savedScrollPosition));
            // 清除保存的滚动位置，避免影响后续页面加载
            sessionStorage.removeItem('scrollPosition');
        }
        
        // 获取项目星级目标
        const starRatingTarget = document.getElementById('star_rating_target')?.value || '';
        
        // 如果不是基本级且当前是评分汇总页面，才获取评分汇总数据
        if (starRatingTarget !== '基本级' && '{{ current_page }}' === 'score_summary') {
            console.log('当前在评分汇总页面，获取最新评分汇总数据');
            
            // 获取最新评分汇总数据（自动计算评分）
            fetchScoreSummary(true);
        }
        
        // 为项目信息保存按钮添加点击事件
        const saveProjectInfoBtn = document.getElementById('saveProjectInfoBtn');
        if (saveProjectInfoBtn) {
            console.log('找到项目信息保存按钮，添加点击事件');
            saveProjectInfoBtn.addEventListener('click', function(e) {
                e.preventDefault(); // 阻止表单默认提交
                
                // 显示保存中状态
                const originalText = saveProjectInfoBtn.textContent;
                saveProjectInfoBtn.textContent = '保存中...';
                saveProjectInfoBtn.disabled = true;

                // 获取表单元素
                const form = saveProjectInfoBtn.closest('form');
                if (!form) {
                    console.error('未找到表单元素');
                    saveProjectInfoBtn.textContent = originalText;
                    saveProjectInfoBtn.disabled = false;
                    return;
                }
                
                // 使用FormData获取表单数据
                const formData = new FormData(form);
                
                // 添加详细表单标志
                formData.append('detail_form', '1');
                
                // 保存当前滚动位置
                const scrollPosition = window.scrollY;
                
                // 使用AJAX提交表单，防止页面刷新
                fetch('/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('提交失败，请稍后重试');
                    }
                    return response.json().catch(() => {
                        console.log('返回值不是JSON格式，可能是重定向响应');
                        // 如果服务器返回了重定向响应，我们手动重载页面并保留滚动位置
                        sessionStorage.setItem('scrollPosition', scrollPosition);
                        window.location.reload();
                        throw new Error('服务器返回了非JSON响应');
                    });
                })
                .then(result => {
                    // 恢复按钮状态
                    saveProjectInfoBtn.textContent = originalText;
                    saveProjectInfoBtn.disabled = false;
                    
                    // 显示成功消息
                    alert('项目信息保存成功');
                    
                    // 刷新页面但保持滚动位置
                    sessionStorage.setItem('scrollPosition', scrollPosition);
                    window.location.reload();
                })
                .catch(error => {
                    console.error('保存项目信息出错:', error);
                    
                    // 恢复按钮状态
                    saveProjectInfoBtn.textContent = originalText;
                    saveProjectInfoBtn.disabled = false;
                    
                    // 显示错误消息，但不是重定向错误
                    if (!error.message.includes('非JSON响应')) {
                        alert('保存失败: ' + error.message);
                    }
                });
                
                // 不使用传统的form.submit()，防止页面刷新
                // 注释掉原来的代码: form.submit();
                calculateAndUpdateScores();
            });
        } else {
            console.log('未找到项目信息保存按钮');
        }
        
        // 使用JavaScript条件判断替代模板语法
        const currentLevel = "{{ current_level }}";
        const currentPage = "{{ current_page }}";
        const currentSpecialty = "{{ current_specialty }}";
        
        if (currentLevel === '基本级') {
            basicMenuContent.classList.add('expanded');
            const arrow = basicMenuToggle.querySelector('.ri-arrow-down-s-line');
            if (arrow) {
                arrow.style.transform = 'rotate(180deg)';
            }
        } else if (currentLevel === '提高级') {
            advancedMenuContent.classList.add('expanded');
            const arrow = advancedMenuToggle.querySelector('.ri-arrow-down-s-line');
            if (arrow) {
                arrow.style.transform = 'rotate(180deg)';
            }
        }
        
        // 如果当前页面是报告导出相关页面，展开报告导出菜单
        if (currentPage === 'report_table' || currentPage === 'green_materials') {
            reportMenuContent.classList.add('expanded');
            const arrow = reportMenuToggle.querySelector('.ri-arrow-down-s-line');
            if (arrow) {
                arrow.style.transform = 'rotate(180deg)';
            }
        }
        
        // 为所有子菜单链接添加点击事件处理
        const allSubmenuItems = document.querySelectorAll('.submenu-item');
        const allMenuItems = document.querySelectorAll('.menu-item');
        
        // 辅助函数：从URL中提取参数
        function getParamsFromUrl(url) {
            try {
                const queryString = url.split('?')[1] || '';
                return new URLSearchParams(queryString);
            } catch (e) {
                console.error('解析URL参数失败:', e);
                return new URLSearchParams();
            }
        }
        
        // 辅助函数：检查两个URL是否指向同一个页面
        function isSamePage(url1, url2) {
            const params1 = getParamsFromUrl(url1);
            const params2 = getParamsFromUrl(url2);
            
            // 对于专业页面，检查level和specialty参数
            if (params1.has('level') && params1.has('specialty') && 
                params2.has('level') && params2.has('specialty')) {
                return params1.get('level') === params2.get('level') && 
                       params1.get('specialty') === params2.get('specialty');
            }
            
            // 对于其他页面，检查page参数
            if (params1.has('page') && params2.has('page')) {
                return params1.get('page') === params2.get('page');
            }
            
            // 如果没有参数，比较基本URL
            return url1.split('?')[0] === url2.split('?')[0];
        }
        
        allSubmenuItems.forEach(item => {
            // 阻止事件冒泡，防止触发父菜单的折叠
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // 获取当前链接的href和当前URL
                const href = this.getAttribute('href');
                const currentUrl = window.location.href;
                
                // 在导航前调用防止页面跳动的函数
                preventPageJump();
                
                // 检查是否点击的是当前页面的链接
                if (isSamePage(href, currentUrl) || currentUrl.includes(href)) {
                    e.preventDefault();
                    
                    // 手动设置活动状态
                    allSubmenuItems.forEach(subItem => subItem.classList.remove('active'));
                    allMenuItems.forEach(menuItem => {
                        if (!menuItem.id) { // 排除菜单切换按钮
                            menuItem.classList.remove('active');
                        }
                    });
                    this.classList.add('active');
                    
                    // 保持父菜单展开
                    if (href.includes('level=基本级')) {
                        basicMenuContent.classList.add('expanded');
                        const arrow = basicMenuToggle.querySelector('.ri-arrow-down-s-line');
                        if (arrow) {
                            arrow.style.transform = 'rotate(180deg)';
                        }
                    } else if (href.includes('level=提高级')) {
                        advancedMenuContent.classList.add('expanded');
                        const arrow = advancedMenuToggle.querySelector('.ri-arrow-down-s-line');
                        if (arrow) {
                            arrow.style.transform = 'rotate(180deg)';
                        }
                    }
                }
            });
        });
        
        // 为主菜单项添加点击事件处理
        document.querySelectorAll('.menu-item:not([id])').forEach(item => {
            item.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                const currentUrl = window.location.href;
                
                if (isSamePage(href, currentUrl)) {
                    e.preventDefault();
                    
                    // 手动设置活动状态
                    allSubmenuItems.forEach(subItem => subItem.classList.remove('active'));
                    allMenuItems.forEach(menuItem => {
                        if (!menuItem.id) { // 排除菜单切换按钮
                            menuItem.classList.remove('active');
                        }
                    });
                    this.classList.add('active');
                }
            });
        });
        
        // 增强下拉菜单样式
        const selects = document.querySelectorAll('select');
        selects.forEach(select => {
            // 初始化时设置选中项的样式
            const selectedOption = select.querySelector('option:checked');
            if (selectedOption) {
                selectedOption.style.backgroundColor = '#f3f4f6';
                selectedOption.style.color = '#374151';
                selectedOption.style.boxShadow = '0 0 0 1000px #f3f4f6 inset';
                selectedOption.style.webkitTextFillColor = '#374151';
            }
        });

        // 为评分汇总菜单添加点击事件
        const scoreSummaryMenuItem = document.getElementById('scoreSummaryMenuItem');
        if (scoreSummaryMenuItem) {
            scoreSummaryMenuItem.addEventListener('click', async function(e) {
                e.preventDefault();
                
                // 移除其他菜单项的active类
                const currentMenuItems = document.querySelectorAll('.submenu-item.active');
                currentMenuItems.forEach(item => {
                    item.classList.remove('active');
                });
                
                // 添加active类和loading效果
                this.classList.add('active');
                this.classList.add('loading');
                let progressInterval;
                
                // 获取项目ID
                const projectId = document.getElementById('current-project-id').value;
                if (!projectId) {
                    alert('请先选择项目');
                    this.classList.remove('active');
                    this.classList.remove('loading');
                    return;
                }
                
                // 创建进度条动画，使用与报审表相同的实现方式
                let progress = 0;
                progressInterval = setInterval(() => {
                    progress += 2;
                    if (progress > 90) {
                        clearInterval(progressInterval);
                    }
                    // 使用backgroundImage线性渐变实现进度条
                    this.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) ${progress}%, transparent ${progress}%)`;
                }, 100);
                
                try {
                    // 获取评分汇总数据
                    const summaryResponse = await fetch(`/api/get_score_summary?project_id=${projectId}&force_refresh=true`);
                    const summaryData = await summaryResponse.json();
                    console.log('获取评分汇总数据:', summaryData);
                    
                    // 将数据存储到 sessionStorage
                    sessionStorage.setItem('score_summary_data', JSON.stringify(summaryData));
                    
                    // 完成进度条 - 循序渐进地增长到100%
                    clearInterval(progressInterval);
                    
                    // 获取当前进度
                    const currentProgress = parseInt(this.style.backgroundImage.match(/(\d+)%/) ? this.style.backgroundImage.match(/(\d+)%/)[1] : 0);
                    // 计算剩余步数
                    const stepsLeft = Math.ceil((100 - currentProgress) / 2);
                    // 创建新的进度条动画，从当前进度到100%
                    let finalProgress = currentProgress;
                    progressInterval = setInterval(() => {
                        finalProgress += 2;
                        this.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) ${finalProgress}%, transparent ${finalProgress}%)`;
                        
                        if (finalProgress >= 100) {
                            clearInterval(progressInterval);
                            // 进度条达到100%后立即跳转
                            window.location.href = this.getAttribute('href');
                        }
                    }, 40); // 稍微加快速度，每40毫秒更新一次
                    
                } catch (error) {
                    console.error('获取评分数据失败:', error);
                    alert(`获取评分数据失败: ${error.message}`);
                    
                    // 重置进度条
                    clearInterval(progressInterval);
                    this.classList.remove('active');
                    this.classList.remove('loading');
                    this.style.backgroundImage = '';
                }
            });
        }
        
        // 为刷新按钮添加点击事件
        const refreshScoreBtn = document.getElementById('refreshScoreBtn');
        if (refreshScoreBtn) {
            console.log('找到刷新评分数据按钮，添加点击事件');
            // 使用防抖函数包装点击事件处理函数，避免短时间内多次请求
            const debouncedFetch = debounce(function() {
                console.log('手动获取评分数据（防抖）');
                fetchScoreSummary(); // 使用修改后的函数直接获取评分数据
            }, 300);
            
            refreshScoreBtn.addEventListener('click', debouncedFetch);
        }
        
        // 如果当前页面是评分汇总页面，立即获取最新数据
        if ('{{ current_page }}' === 'score_summary') {
            console.log('当前页面是评分汇总页面');
            // 不再自动获取数据
        } else {
            console.log('当前页面不是评分汇总页面，current_page =', '{{ current_page }}');
        }
    });

    // 在页面加载时检查是否有预加载的数据
    document.addEventListener('DOMContentLoaded', function() {
        if ('{{ current_page }}' === 'score_summary') {
            const preloadedData = sessionStorage.getItem('score_summary_data');
            if (preloadedData) {
                // 使用预加载的数据更新页面
                const data = JSON.parse(preloadedData);
                updateScoreSummaryTables(data);
                // 清除预加载数据
                sessionStorage.removeItem('score_summary_data');
            }
            // 删除自动刷新的代码
        }
    });

    // 添加JavaScript代码，用于收集表格数据并发送到服务器
    document.addEventListener('DOMContentLoaded', function() {
        const saveScoreBtn = document.getElementById('saveScoreBtn');
        const floatingSaveBtn = document.getElementById('floatingSaveBtn');
        
        // 为保存按钮添加点击事件监听器
        if (saveScoreBtn) {
            saveScoreBtn.addEventListener('click', saveScoreData);
        }
        if (floatingSaveBtn) {
            floatingSaveBtn.addEventListener('click', saveScoreData);
        }
        
        // 为提高级得分输入框添加验证
        if ('{{ current_level }}' === '提高级') {
            // 获取所有得分输入框
            const scoreInputs = document.querySelectorAll('input[name="score"]');
            
            // 为每个输入框添加事件监听
            scoreInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    // 获取输入值
                    const scoreValue = parseFloat(this.value);
                    
                    // 如果不是数字，不做处理
                    if (isNaN(scoreValue)) {
                        return;
                    }
                    
                    // 获取最大分值
                    const maxScore = parseFloat(this.getAttribute('data-maxscore'));
                    
                    // 验证输入值不大于最大分值
                    if (scoreValue > maxScore) {
                        // 提示用户
                        alert(`输入的分数不能大于该条文的分值(${maxScore})`);
                        // 重置为最大分值
                        this.value = maxScore;
                    }
                    
                    // 确保不为负数
                    if (scoreValue < 0) {
                        this.value = 0;
                    }
                });
                
                // 添加失焦事件，确保在用户完成输入后格式化值
                input.addEventListener('blur', function() {
                    // 如果值为空或不是数字，设为0
                    if (this.value === '' || isNaN(parseFloat(this.value))) {
                        this.value = '0';
                    }
                });
            });
            
            // 添加分类过滤功能
            const categoryFilters = document.querySelectorAll('.category-filter');
            const tableRows = document.querySelectorAll('table tbody tr');
            
            categoryFilters.forEach(filter => {
                filter.addEventListener('click', function() {
                    // 移除所有过滤器的active状态
                    categoryFilters.forEach(f => f.classList.remove('active'));
                    // 为当前过滤器添加active状态
                    this.classList.add('active');
                    
                    const category = this.getAttribute('data-category');
                    
                    // 显示或隐藏表格行
                    tableRows.forEach(row => {
                        const rowCategory = row.querySelector('td:nth-child(2) span')?.textContent.trim();
                        
                        if (category === null || category === undefined || this.id === 'filter-all') {
                            // 显示所有行
                            row.style.display = '';
                        } else if (rowCategory === category) {
                            // 显示匹配的行
                            row.style.display = '';
                        } else {
                            // 隐藏不匹配的行
                            row.style.display = 'none';
                        }
                    });
                });
            });
        }

        // 定义保存评分的函数
        function saveScoreData() {
            // 显示保存中状态
            const saveBtn = this;
            const originalText = saveBtn.textContent || '';
            const originalHTML = saveBtn.innerHTML;
            
            if (saveBtn.tagName === 'BUTTON') {
                saveBtn.textContent = '保存中...';
            } else {
                saveBtn.innerHTML = '<i class="ri-loader-2-line"></i>';
                saveBtn.style.animation = 'rotate 1s linear infinite';
            }
            saveBtn.disabled = true;
            
            // 获取项目名称和ID
            const projectName = document.getElementById('current_project_name')?.value || '';
            const projectId = document.getElementById('project_id')?.value;
            
            if (!projectId) {
                alert('未找到项目ID');
                restoreButton(saveBtn, originalText, originalHTML);
                return;
            }

            // 收集表格数据
            const scoreData = collectScoreData();
            if (scoreData.length === 0) {
                alert('未找到可保存的评分数据，请确保页面包含评分表格。');
                restoreButton(saveBtn, originalText, originalHTML);
                return;
            }

            const requestData = {
                level: '{{ current_level }}',
                specialty: '{{ current_specialty }}',
                project_id: projectId,
                scores: scoreData,
                standard: '{{ project.standard if project and project.standard else "成都市标" }}'
            };

            // 发送数据到服务器
            fetch('/api/save_score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || '保存失败');
                }
                
                // 显示成功消息
                alert('评分信息保存成功！');
                
                // 更新徽章状态
                if ('{{ current_level }}' === '提高级') {
                    // 延迟一小段时间后更新徽章，确保数据已保存到数据库
                    setTimeout(() => {
                        updateCategoryBadges();
                    }, 500);
                }
            })
            .catch(error => {
                console.error('保存失败:', error);
                alert('保存失败: ' + error.message);
            })
            .finally(() => {
                restoreButton(saveBtn, originalText, originalHTML);
            });
        }

        // 辅助函数：收集评分数据
        function collectScoreData() {
            const scoreData = [];
            const rows = document.querySelectorAll('table tbody tr');
            const currentLevel = '{{ current_level }}';
            
            rows.forEach((row, index) => {
                try {
                    // 基本级
                    if (currentLevel === '基本级') {
                        const clauseNumber = row.querySelector('td:nth-child(1)')?.textContent.trim();
                        if (!clauseNumber) return;
                        
                        const isAchievedSelect = row.querySelector('select.is-achieved-select');
                        if (!isAchievedSelect) return;
                        
                        const technicalMeasuresTextarea = row.querySelector('textarea.technical-measures');
                        if (!technicalMeasuresTextarea) return;
                        
                        const contentText = row.querySelector('td:nth-child(3)')?.textContent.trim() || '';
                        let category = getCategory(contentText);
                        
                        scoreData.push({
                            project_name: document.getElementById('current_project_name')?.value || '',
                            clause_number: clauseNumber,
                            category: category,
                            is_achieved: isAchievedSelect.value,
                            score: '0',
                            technical_measures: technicalMeasuresTextarea.value || ''
                        });
                    } 
                    // 提高级
                    else if (currentLevel === '提高级') {
                        const clauseNumber = row.querySelector('td:nth-child(1)')?.textContent.trim();
                        if (!clauseNumber) return;
                        
                        const categoryElement = row.querySelector('td:nth-child(2) span');
                        if (!categoryElement) return;
                        
                        const category = categoryElement.textContent.trim();
                        const scoreInput = row.querySelector('input[name="score"]');
                        const technicalMeasuresTextarea = row.querySelector('textarea.technical-measures');
                        
                        let score = '0';
                        if (scoreInput) {
                            score = scoreInput.value || '0';
                            const maxScore = parseFloat(row.querySelector('td:nth-child(4)')?.textContent.trim());
                            if (!isNaN(maxScore) && parseFloat(score) > maxScore) {
                                score = maxScore.toString();
                                scoreInput.value = score;
                            }
                        }
                        
                        scoreData.push({
                            project_name: document.getElementById('current_project_name')?.value || '',
                            clause_number: clauseNumber,
                            category: category,
                            is_achieved: '是',
                            score: score,
                            technical_measures: technicalMeasuresTextarea?.value || ''
                        });
                    }
                } catch (rowError) {
                    console.error(`处理第 ${index+1} 行时出错:`, rowError);
                }
            });
            
            return scoreData;
        }

        // 辅助函数：根据内容判断分类
        function getCategory(contentText) {
            if (contentText.includes('安全') || contentText.includes('耐久')) return '安全耐久';
            if (contentText.includes('健康') || contentText.includes('舒适')) return '健康舒适';
            if (contentText.includes('生活') || contentText.includes('便利')) return '生活便利';
            if (contentText.includes('资源') || contentText.includes('节约')) return '资源节约';
            if (contentText.includes('环境') || contentText.includes('宜居')) return '环境宜居';
            if (contentText.includes('提高') || contentText.includes('创新')) return '提高与创新';
            return '其他';
        }

        // 辅助函数：恢复按钮状态
        function restoreButton(button, originalText, originalHTML) {
            if (button.tagName === 'BUTTON') {
                button.textContent = originalText;
            } else {
                button.innerHTML = originalHTML;
                button.style.animation = '';
            }
            button.disabled = false;
        }
        
        // 为保存按钮添加点击事件
        if (saveScoreBtn) {
            saveScoreBtn.addEventListener('click', saveScoreData);
        } else {
            console.warn('未找到保存评分按钮');
        }
        
        // 为悬浮保存按钮添加点击事件（仅在基本级和提高级页面存在）
        if (floatingSaveBtn) {
            floatingSaveBtn.addEventListener('click', saveScoreData);
        }

        // 检查当前是否在专业评分页面
        if ('{{ current_page }}' === 'specialty') {
            console.log('当前在专业评分页面，加载已保存的评分');
            loadSavedScores();
        }
    });

    // 添加旋转动画样式
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            @keyframes rotate {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        </style>
    `);

    // 加载已保存的评分数据
    function loadSavedScores() {
        const level = '{{ current_level }}';
        const specialty = '{{ current_specialty }}';
        const standard = '{{ project.standard if project and project.standard else "成都市标" }}';
        
        // 获取项目ID（如果有的话）
        let projectId = null;
        const projectIdField = document.getElementById('project_id');
        if (projectIdField) {
            projectId = projectIdField.value;
        }
        
        // 构建API URL
        let apiUrl = `/api/load_scores?level=${encodeURIComponent(level)}&specialty=${encodeURIComponent(specialty)}&standard=${encodeURIComponent(standard)}`;
        if (projectId) {
            apiUrl += `&project_id=${encodeURIComponent(projectId)}`;
        }
        
        console.log('加载评分数据URL:', apiUrl);
        
        // 请求服务器数据
        fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('网络响应异常');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.scores && data.scores.length > 0) {
                // 填充表格数据
                fillScoreTable(data.scores);
                console.log('成功加载评分数据，共', data.scores.length, '条记录');
                
                // 如果需要，可以更新统计数据
                if (level === '提高级') {
                    updateScoreStatistics();
                }
            } else {
                console.log('未找到评分数据或数据为空');
            }
        })
        .catch(error => {
            console.error('加载评分数据失败:', error);
        });
    }

    // 填充表格数据
    function fillScoreTable(scores) {
        const rows = document.querySelectorAll('table tbody tr');
        const level = '{{ current_level }}';
        
        rows.forEach(row => {
            const clauseNumber = row.querySelector('td:nth-child(1)')?.textContent.trim();
            if (!clauseNumber) return;
            
            // 查找匹配的评分数据
            const scoreData = scores.find(s => s.clause_number === clauseNumber);
            if (!scoreData) return;
            
            console.log(`填充数据: 条文号=${clauseNumber}, 是否达标=${scoreData.is_achieved}, 技术措施长度=${scoreData.technical_measures ? scoreData.technical_measures.length : 0}`);
            
            // 根据不同级别填充数据
            if (level === '基本级') {
                // 选择"是否达标"下拉框
                const selectElement = row.querySelector('select.is-achieved-select');
                if (selectElement) {
                    selectElement.value = scoreData.is_achieved;
                    console.log(`设置是否达标: ${scoreData.is_achieved}`);
                } else {
                    console.log(`未找到是否达标下拉框: 条文号=${clauseNumber}`);
                }
                
                // 填充技术措施
                const textareaElement = row.querySelector('textarea.technical-measures');
                if (textareaElement) {
                    textareaElement.value = scoreData.technical_measures || '';
                    console.log(`设置技术措施: 长度=${scoreData.technical_measures ? scoreData.technical_measures.length : 0}`);
                } else {
                    console.log(`未找到技术措施文本框: 条文号=${clauseNumber}`);
                }
            } else if (level === '提高级') {
                // 填充得分
                const inputElement = row.querySelector('input[name="score"]');
                if (inputElement) {
                    inputElement.value = scoreData.score || '0';
                    console.log(`设置得分: ${scoreData.score}`);
                } else {
                    console.log(`未找到得分输入框: 条文号=${clauseNumber}`);
                }
                
                // 填充技术措施
                const textareaElement = row.querySelector('textarea.technical-measures');
                if (textareaElement) {
                    textareaElement.value = scoreData.technical_measures || '';
                    console.log(`设置技术措施: 长度=${scoreData.technical_measures ? scoreData.technical_measures.length : 0}`);
                } else {
                    console.log(`未找到技术措施文本框: 条文号=${clauseNumber}`);
                }
            }
        });
    }

    // 添加评分统计更新功能
    function updateScoreStatistics() {
        // 获取所有填写了得分的条目
        const rows = document.querySelectorAll('table tbody tr');
        
        // 准备各分类的得分统计
        const categoryScores = {
            '安全耐久': 0,
            '健康舒适': 0,
            '生活便利': 0,
            '资源节约': 0,
            '环境宜居': 0,
            '提高与创新': 0
        };
        
        // 计算各分类的得分
        rows.forEach(row => {
            const category = row.querySelector('td:nth-child(2) span')?.textContent.trim();
            // 检查是否有输入框，如果没有则查找span元素（针对分值为'-'的情况）
            const scoreInput = row.querySelector('td:nth-child(5) input');
            let score = 0;
            
            if (scoreInput) {
                // 如果有输入框，获取其值
                if (scoreInput.value && !isNaN(parseFloat(scoreInput.value))) {
                    score = parseFloat(scoreInput.value);
                }
            } else {
                // 如果没有输入框，查找span元素（针对分值为'-'的情况）
                const scoreSpan = row.querySelector('td:nth-child(5) span');
                if (scoreSpan && scoreSpan.textContent === '0') {
                    score = 0;
                }
            }
            
            if (category && categoryScores.hasOwnProperty(category)) {
                categoryScores[category] += score;
            }
        });
        
        // 更新统计表格
        const statTable = document.querySelector('.mt-10 table');
        if (statTable) {
            const statRow = statTable.querySelector('tbody tr');
            if (statRow) {
                // 更新各分类得分
                updateCategoryCell(statRow, 1, categoryScores['安全耐久']);
                updateCategoryCell(statRow, 2, categoryScores['健康舒适']);
                updateCategoryCell(statRow, 3, categoryScores['生活便利']);
                updateCategoryCell(statRow, 4, categoryScores['资源节约']);
                updateCategoryCell(statRow, 5, categoryScores['环境宜居']);
                updateCategoryCell(statRow, 6, categoryScores['提高与创新']);
                
                // 计算总分
                const totalScore = Object.values(categoryScores).reduce((sum, score) => sum + score, 0);
                updateCategoryCell(statRow, 7, totalScore);
            }
        }
    }

    // 更新统计表格的单元格
    function updateCategoryCell(row, cellIndex, score) {
        const cell = row.querySelector(`td:nth-child(${cellIndex + 1})`);
        if (cell) {
            cell.textContent = score.toFixed(1);
        }
    }

    // 更新评分汇总表格
    function updateScoreSummaryTables(data) {
        console.log('更新评分汇总表格:', data);
        
        // 显示最后更新时间
        const lastUpdateTimeElement = document.getElementById('lastUpdateTime');
        if (lastUpdateTimeElement && data.timestamp) {
            lastUpdateTimeElement.textContent = `最后更新时间: ${data.timestamp}`;
        }
        
        // 更新专业得分行
        const specialtyScoresRow = document.getElementById('specialty-scores-row');
        if (specialtyScoresRow && data.specialty_scores) {
            const specialtyScores = data.specialty_scores;
            
            // 获取项目评价标准
            const projectStandard = document.getElementById('current-project-standard')?.value || '';
            
            // 显示或隐藏环境健康与节能专业列
            const envHealthEnergyHeader = document.getElementById('env_health_energy_header');
            const envHealthEnergyColumn = document.getElementById('env_health_energy_column');
            if (envHealthEnergyHeader) {
                envHealthEnergyHeader.style.display = projectStandard === '四川省标' ? '' : 'none';
                if (envHealthEnergyColumn) {
                    envHealthEnergyColumn.style.display = projectStandard === '四川省标' ? '' : 'none';
                }
            }
            
            // 更新各专业得分
            updateCell(specialtyScoresRow, 1, specialtyScores['建筑专业'] || 0);
            updateCell(specialtyScoresRow, 2, specialtyScores['结构专业'] || 0);
            updateCell(specialtyScoresRow, 3, specialtyScores['给排水专业'] || 0);
            updateCell(specialtyScoresRow, 4, specialtyScores['电气专业'] || 0);
            updateCell(specialtyScoresRow, 5, specialtyScores['暖通专业'] || 0);
            updateCell(specialtyScoresRow, 6, specialtyScores['景观专业'] || 0);
            
            // 如果是四川省标，更新环境健康与节能专业得分
            if (projectStandard === '四川省标') {
                updateCell(specialtyScoresRow, 7, specialtyScores['环境健康与节能专业'] || 0);
            }
            
            // 更新总分
            const totalScore = data.total_score || 0;
            const totalScoreCell = specialtyScoresRow.querySelector('.total-score');
            if (totalScoreCell) {
                totalScoreCell.textContent = totalScore.toFixed(1);
            }
        }
        
        // 更新分类得分行
        const categoryScoresRow = document.getElementById('category-scores-row');
        if (categoryScoresRow && data.specialty_scores_by_category) {
            // 计算各分类得分
            const categoryScores = {
                '安全耐久': 0,
                '健康舒适': 0,
                '生活便利': 0,
                '资源节约': 0,
                '环境宜居': 0,
                '提高与创新': 0
            };
            
            // 遍历各专业的分类得分
            Object.values(data.specialty_scores_by_category).forEach(specialtyData => {
                Object.entries(specialtyData).forEach(([category, score]) => {
                    if (category !== '总分' && categoryScores.hasOwnProperty(category)) {
                        categoryScores[category] += parseFloat(score) || 0;
                    }
                });
            });
            
            // 更新各分类得分
            updateCell(categoryScoresRow, 1, categoryScores['安全耐久']);
            updateCell(categoryScoresRow, 2, categoryScores['健康舒适']);
            updateCell(categoryScoresRow, 3, categoryScores['生活便利']);
            updateCell(categoryScoresRow, 4, categoryScores['资源节约']);
            updateCell(categoryScoresRow, 5, categoryScores['环境宜居']);
            updateCell(categoryScoresRow, 6, categoryScores['提高与创新']);
            
            // 更新总分
            const totalScore = Object.values(categoryScores).reduce((sum, score) => sum + score, 0);
            updateCell(categoryScoresRow, 7, totalScore);
            
            // 更新达标判断行
            const judgmentRow = categoryScoresRow.parentNode.querySelector('tr:nth-child(3)');
            if (judgmentRow) {
                // 使用静态的最低分值数据
                const minScores = {
                    '安全耐久': 30.0,
                    '健康舒适': 30.0,
                    '生活便利': 21.0,
                    '资源节约': 60.0,
                    '环境宜居': 30.0,
                    '提高与创新': 0.0
                };
                const totalMinScore = 171; // 静态总分
                
                // 判断各分类是否达标
                updateJudgmentCell(judgmentRow, 1, categoryScores['安全耐久'] >= minScores['安全耐久']);
                updateJudgmentCell(judgmentRow, 2, categoryScores['健康舒适'] >= minScores['健康舒适']);
                updateJudgmentCell(judgmentRow, 3, categoryScores['生活便利'] >= minScores['生活便利']);
                updateJudgmentCell(judgmentRow, 4, categoryScores['资源节约'] >= minScores['资源节约']);
                updateJudgmentCell(judgmentRow, 5, categoryScores['环境宜居'] >= minScores['环境宜居']);
                updateJudgmentCell(judgmentRow, 6, categoryScores['提高与创新'] >= minScores['提高与创新']);
                
                // 判断总分是否达标 - 只有当所有分类都达标时，总分才达标
                const allCategoriesAchieved = 
                    categoryScores['安全耐久'] >= minScores['安全耐久'] &&
                    categoryScores['健康舒适'] >= minScores['健康舒适'] &&
                    categoryScores['生活便利'] >= minScores['生活便利'] &&
                    categoryScores['资源节约'] >= minScores['资源节约'] &&
                    categoryScores['环境宜居'] >= minScores['环境宜居'] &&
                    categoryScores['提高与创新'] >= minScores['提高与创新'];
                
                // 总分达标需要同时满足：1.总分达到要求 2.所有分类都达标
                updateJudgmentCell(judgmentRow, 7, totalScore >= totalMinScore && allCategoriesAchieved);
            }
            
            // 更新星级判定
            setTimeout(updateStarRating, 100);
        }
    }
    
    // 更新表格单元格
    function updateCell(row, cellIndex, value) {
        const cell = row.querySelector(`td:nth-child(${cellIndex + 1})`);
        if (cell) {
            cell.textContent = typeof value === 'number' ? value.toFixed(1) : value;
        }
    }
    
    // 更新判断单元格
    function updateJudgmentCell(row, cellIndex, isAchieved) {
        const cell = row.querySelector(`td:nth-child(${cellIndex + 1})`);
        if (cell) {
            if (isAchieved) {
                cell.textContent = '达标';
                cell.className = 'px-6 py-4 text-green-600 bg-green-50';
            } else {
                cell.textContent = '未达标';
                cell.className = 'px-6 py-4 text-red-600 bg-red-50';
            }
        }
    }

    // 添加生成Word文档的函数
    function generateWord() {
        // 临时设置当前页面为report_table，以便高亮显示菜单项
        // 获取项目评价标准
        const currentProjectStandard = document.getElementById('current-project-standard').value;
        const currentMenuItems = document.querySelectorAll('.submenu-item.active');
        if (currentProjectStandard=='国标') {
            alert('当前标准下暂无报审表模板!');
            return;
        }
        currentMenuItems.forEach(item => {
            item.classList.remove('active');
        });
        
        // 找到报审表菜单项并添加active类
        const wordMenuItem = document.querySelector('a[onclick="generateWord()"]');
        let progressInterval;
        
        if (wordMenuItem) {
            wordMenuItem.classList.add('active');
            wordMenuItem.classList.add('loading');
            
            // 创建进度条动画
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += 2;
                if (progress > 90) {
                    clearInterval(progressInterval);
                }
                wordMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) ${progress}%, transparent ${progress}%)`;
            }, 100);
        }
        
        // 显示加载指示器
        const pageLoader = document.getElementById('page-loader');
        if (pageLoader) {
            pageLoader.style.display = 'flex';
        }

        // 获取项目ID
        const projectId = document.getElementById('current-project-id').value;

        if (!projectId) {
            alert('请先选择项目');
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            if (wordMenuItem) {
                wordMenuItem.classList.remove('loading');
                wordMenuItem.style.backgroundImage = '';
                clearInterval(progressInterval);
            }
            return;
        }
        
        // 调用generate_word接口
        fetch('/api/generate_word', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                standard: currentProjectStandard
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '生成报审表失败');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            if (currentProjectStandard=='四川省标') {
                a.download = '四川省绿色建筑报审表.docx';
            } else if (currentProjectStandard=='成都市标') {
                a.download = '成都市绿色建筑报审表.docx';
            } else {
                a.download = '报审表.docx';
            }
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 完成进度条
            if (wordMenuItem) {
                clearInterval(progressInterval);
                wordMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) 100%, transparent 100%)`;
                setTimeout(() => {
                    wordMenuItem.classList.remove('loading');
                    wordMenuItem.style.backgroundImage = '';
                }, 500);
            }
        })
        .catch(error => {
            console.error('生成报审表失败:', error);
            alert(error.message || '生成报审表失败，请重试');
            
            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 重置进度条
            if (wordMenuItem) {
                clearInterval(progressInterval);
                wordMenuItem.classList.remove('loading');
                wordMenuItem.style.backgroundImage = '';
            }
        });
    }

    // 基础脚本
    document.addEventListener('DOMContentLoaded', function() {
        console.log('base.html: DOM加载完成');
        hideLoader();
        
        // 检查main-content元素
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            console.log('找到main-content元素');
        } else {
            console.error('找不到main-content元素');
        }
    });

    // 添加生成DWG文档的函数
    function generateDWG() {
        // 临时设置当前页面为dwg_export，以便高亮显示菜单项
        const currentProjectStandard = document.getElementById('current-project-standard').value;
        const currentMenuItems = document.querySelectorAll('.submenu-item.active');
        currentMenuItems.forEach(item => {
            item.classList.remove('active');
        });
        
        // 找到绿色建筑设计专篇菜单项并添加active类
        const dwgMenuItem = document.querySelector('a[onclick="generateDWG()"]');
        let progressInterval;
        
        if (dwgMenuItem) {
            dwgMenuItem.classList.add('active');
            dwgMenuItem.classList.add('loading');
            
            // 创建进度条动画
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += 2;
                if (progress > 90) {
                    clearInterval(progressInterval);
                }
                dwgMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) ${progress}%, transparent ${progress}%)`;
            }, 100);
        }
        
        // 显示加载指示器
        const pageLoader = document.getElementById('page-loader');
        if (pageLoader) {
            pageLoader.style.display = 'flex';
        }

        // 获取项目ID
        const projectId = document.getElementById('current-project-id').value;
        if (!projectId) {
            alert('请先选择项目');
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            if (dwgMenuItem) {
                dwgMenuItem.classList.remove('loading');
                dwgMenuItem.style.backgroundImage = '';
                clearInterval(progressInterval);
            }
            return;
        }
        
        // 调用generate_dwg接口
        fetch(`${window.location.protocol}//${window.location.host}/api/generate_dwg`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId,
                standard: currentProjectStandard
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '生成绿色建筑设计专篇失败');
                });
            }
            return response.blob();
        })
        .then(blob => {
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            if (currentProjectStandard=='四川省标') {
                a.download = '绿色建筑设计专篇（四川省标）.dwg';
            } else if (currentProjectStandard=='成都市标') {
                a.download = '绿色建筑设计专篇（成都市标）.dwg';
            } else {
                a.download = '绿色建筑设计专篇.dwg';
            }
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 完成进度条
            if (dwgMenuItem) {
                clearInterval(progressInterval);
                dwgMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) 100%, transparent 100%)`;
                setTimeout(() => {
                    dwgMenuItem.classList.remove('loading');
                    dwgMenuItem.style.backgroundImage = '';
                }, 500);
            }
        })
        .catch(error => {
            console.error('生成绿色建筑设计专篇失败:', error);
            alert(error.message || '生成绿色建筑设计专篇失败，请重试');
            
            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 重置进度条
            if (dwgMenuItem) {
                clearInterval(progressInterval);
                dwgMenuItem.classList.remove('loading');
                dwgMenuItem.style.backgroundImage = '';
            }
        });
    }

    // 页面加载完成后，添加事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        // 获取项目星级目标
        const starRatingTarget = document.getElementById('star_rating_target')?.value || '';
        
        // 如果不是基本级，才加载评分汇总数据
        if (starRatingTarget !== '基本级') {
            // 获取评分汇总数据
            if (document.querySelector('.score-summary-container')) {
                fetchScoreSummary(true);  // 使用强制刷新选项，确保调用计算API
            }
        }
        
        // 已移除计算评分按钮和刷新数据按钮的事件监听器
        
        // 用户信息点击显示/隐藏退出按钮
        const userInfoBtn = document.getElementById('userInfoBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        if (userInfoBtn && logoutBtn) {
            // 点击用户信息显示退出按钮
            userInfoBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                logoutBtn.classList.toggle('hidden');
            });
            
            // 点击页面其他区域隐藏退出按钮
            document.addEventListener('click', function(e) {
                if (!userInfoBtn.contains(e.target) && !logoutBtn.contains(e.target)) {
                    logoutBtn.classList.add('hidden');
                }
            });
        }
    });

    // 更新用户菜单交互逻辑
    const userIcon = document.getElementById('userIcon');
    const userMenu = document.getElementById('userMenu');
    
    if (userIcon && userMenu) {
        // 点击用户图标显示或隐藏菜单
        userIcon.addEventListener('click', function(e) {
            e.stopPropagation();
            userMenu.classList.toggle('active');
        });
        
        // 点击页面其他区域关闭菜单
        document.addEventListener('click', function(e) {
            if (!userMenu.contains(e.target) && !userIcon.contains(e.target)) {
                userMenu.classList.remove('active');
            }
        });
    }
    
    // 初始化标签页系统
    </script>
    
    
    <!-- 添加脚本：省市二级联动 -->
    <script>
        // 省市联动功能
        let provinceData = {};
        let cityData = {};
        
        // 初始化省市数据
        document.addEventListener('DOMContentLoaded', function() {
            initializeProvinceCitySelectors();
        });

        // 初始化省市选择器
        function initializeProvinceCitySelectors() {
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const projectLocationInput = document.getElementById('project_location');
            
            // 只在项目表单页面初始化
            if (provinceSelect && citySelect && projectLocationInput) {
                // 设置loading状态，防止抖动
                provinceSelect.innerHTML = '<option value="">加载中...</option>';
                citySelect.innerHTML = '<option value="">请选择城市</option>';
                
                // 加载省市数据
                fetch('/static/json/province_city.json')
                    .then(response => response.json())
                    .then(data => {
                        provinceData = data['86']; // 所有省份
                        cityData = data; // 所有城市数据
                        
                        // 添加省份选项
                        let provinceOptions = '<option value="">请选择省份</option>';
                        for (let code in provinceData) {
                            provinceOptions += `<option value="${code}">${provinceData[code]}</option>`;
                        }
                        provinceSelect.innerHTML = provinceOptions;
                        
                        // 如果有已保存的地址，尝试初始化选择框
                        if (projectLocationInput.value) {
                            const parts = projectLocationInput.value.split(' ');
                            if (parts.length > 0) {
                                const provinceName = parts[0];
                                let provinceCode = null;
                                
                                // 查找省份代码
                                for (let code in provinceData) {
                                    if (provinceData[code] === provinceName) {
                                        provinceCode = code;
                                        provinceSelect.value = code;
                                        
                                        // 加载城市选项
                                        const cities = cityData[code] || {};
                                        let cityOptions = '<option value="">请选择城市</option>';
                                        for (let cityCode in cities) {
                                            cityOptions += `<option value="${cityCode}">${cities[cityCode]}</option>`;
                                        }
                                        citySelect.innerHTML = cityOptions;
                                        
                                        // 如果有城市数据，设置选中状态
                                        if (parts.length > 1) {
                                            const cityName = parts[1];
                                            for (let cityCode in cities) {
                                                if (cities[cityCode] === cityName) {
                                                    citySelect.value = cityCode;
                                                    break;
                                                }
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('加载省市数据失败:', error);
                        provinceSelect.innerHTML = '<option value="">请选择省份</option>';
                    });
            }
        }
        
        // 更新省市选择
        function updateProvinceCity() {
            const provinceSelect = document.getElementById('province');
            const citySelect = document.getElementById('city');
            const projectLocationInput = document.getElementById('project_location');
            const climateZoneSelect = document.getElementById('climate_zone');
            
            if (!provinceSelect || !citySelect || !projectLocationInput) return;
            
            // 如果切换了省份，加载对应的城市
            if (provinceSelect.value && provinceSelect.value !== citySelect.dataset.provinceCode) {
                citySelect.dataset.provinceCode = provinceSelect.value;
                
                // 构建城市选项
                const cities = cityData[provinceSelect.value] || {};
                let cityOptions = '<option value="">请选择城市</option>';
                for (let cityCode in cities) {
                    cityOptions += `<option value="${cityCode}">${cities[cityCode]}</option>`;
                }
                citySelect.innerHTML = cityOptions;
                citySelect.value = "";
            }
            
            // 更新地址输入框
            const provinceName = provinceSelect.options[provinceSelect.selectedIndex]?.text || '';
            const cityName = citySelect.options[citySelect.selectedIndex]?.text || '';
            
            let location = [];
            if (provinceName && provinceName !== '请选择省份' && provinceName !== '加载中...') location.push(provinceName);
            if (cityName && cityName !== '请选择城市') location.push(cityName);
            
            projectLocationInput.value = location.join(' ');
            
            // 更新气候区划
            if (climateZoneSelect && provinceName && cityName && 
                provinceName !== '请选择省份' && provinceName !== '加载中...' && 
                cityName !== '请选择城市') {
                
                const zoneInfo = getClimateZone(provinceName, cityName);
                if (zoneInfo) {
                    // 设置气候区划选择框的值
                    for (let i = 0; i < climateZoneSelect.options.length; i++) {
                        if (climateZoneSelect.options[i].value === zoneInfo.气候区划) {
                            climateZoneSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            }
        }
        
        // 在页面加载完成后执行的函数
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化省市选择器
            initializeProvinceCitySelectors();
            
            // 其他初始化代码...
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userIcon = document.getElementById('userIcon');
            const userMenu = document.getElementById('userMenu');

            // 点击用户图标时切换菜单显示状态
            if (userIcon && userMenu) {
                userIcon.addEventListener('click', function() {
                    userMenu.classList.toggle('active');
                });

                // 点击页面其他区域时隐藏菜单
                document.addEventListener('click', function(event) {
                    if (!userIcon.contains(event.target) && !userMenu.contains(event.target)) {
                        userMenu.classList.remove('active');
                    }
                });
            }
        });

        // 关闭联系我们模态窗口
        function closeContactModal() {
            const contactModal = document.getElementById('contactModal');
            contactModal.classList.add('hidden');
            document.body.style.overflow = ''; // 恢复背景滚动
        }

        // 点击模态窗口外部关闭
        document.addEventListener('click', function(e) {
            const contactModal = document.getElementById('contactModal');
            if (contactModal && !contactModal.querySelector('.bg-white').contains(e.target)) {
                closeContactModal();
            }
        });
    </script>

    <!-- 在适当的JS部分添加生成自评估报告的函数 -->
    <script>
    // 调试辅助函数
    function showDebugMessage(message) {
        console.log(message);
        if (typeof showLoadingModal === 'undefined') {
            alert("错误: showLoadingModal函数未定义");
        }
        if (typeof hideLoadingModal === 'undefined') {
            alert("错误: hideLoadingModal函数未定义");
        }
        if (typeof showErrorModal === 'undefined') {
            alert("错误: showErrorModal函数未定义");
        }
        if (typeof showSuccessModal === 'undefined') {
            alert("错误: showSuccessModal函数未定义");
        }
    }

    // 绿建自评估报告生成函数
    function generateSelfAssessmentReport() {
        // 获取项目评价标准
        const currentProjectStandard = document.getElementById('current-project-standard')?.value || '国标';
        const currentMenuItems = document.querySelectorAll('.submenu-item.active');
        
        // 只有国标项目才能生成绿建自评估报告
        if (currentProjectStandard !== '国标') {
            alert('只有国标项目才能生成绿建自评估报告！');
            return;
        }
        
        // 移除其他菜单项的激活状态
        currentMenuItems.forEach(item => {
            item.classList.remove('active');
        });
        
        // 找到绿建自评估报告菜单项并添加active类
        const reportMenuItem = document.querySelector('a[onclick="generateSelfAssessmentReport(); return false;"]');
        let progressInterval;
        
        if (reportMenuItem) {
            reportMenuItem.classList.add('active');
            reportMenuItem.classList.add('loading');
            
            // 创建进度条动画
            let progress = 0;
            progressInterval = setInterval(() => {
                progress += 2;
                if (progress > 90) {
                    clearInterval(progressInterval);
                }
                reportMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) ${progress}%, transparent ${progress}%)`;
            }, 100);
        }
        
        // 显示加载指示器
        const pageLoader = document.getElementById('page-loader');
        if (pageLoader) {
            pageLoader.style.display = 'flex';
        }

        // 获取当前项目ID
        const projectId = document.getElementById('project_id').value;
        console.log("项目ID:", projectId);
        
        if (!projectId) {
            alert('未找到项目ID');
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            if (reportMenuItem) {
                reportMenuItem.classList.remove('loading');
                reportMenuItem.style.backgroundImage = '';
                clearInterval(progressInterval);
            }
            return;
        }

        console.log("正在生成绿建自评估报告，项目ID: " + projectId);

        // 发送请求
        fetch('/api/self-assessment-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                project_id: projectId
            })
        })
        .then(response => {
            console.log("收到服务器响应状态:", response.status);
            
            if (!response.ok) {
                // 如果服务器返回错误，尝试获取错误信息
                return response.json().then(data => {
                    console.error("服务器返回错误:", data);
                    throw new Error(data.error || '生成绿建自评估报告失败');
                });
            }
            return response.blob();
        })
        .then(blob => {
            console.log("收到blob数据，类型:", blob.type, "大小:", blob.size, "bytes");
            
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            const projectName = document.getElementById('current_project_name').value || '';
            console.log("项目名称:", projectName);
            
            a.href = url;
            a.download = projectName ? `${projectName}_绿建自评估报告.docx` : '绿建自评估报告.docx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 完成进度条
            if (reportMenuItem) {
                clearInterval(progressInterval);
                reportMenuItem.style.backgroundImage = `linear-gradient(to right, rgba(79, 209, 197, 0.3) 100%, transparent 100%)`;
                setTimeout(() => {
                    reportMenuItem.classList.remove('loading');
                    reportMenuItem.style.backgroundImage = '';
                }, 500);
            }
        })
        .catch(error => {
            console.error('生成报告失败:', error);
            alert(error.message || '生成绿建自评估报告失败，请稍后重试');
            
            // 隐藏加载指示器
            if (pageLoader) {
                pageLoader.style.display = 'none';
            }
            
            // 重置进度条
            if (reportMenuItem) {
                clearInterval(progressInterval);
                reportMenuItem.classList.remove('loading');
                reportMenuItem.style.backgroundImage = '';
            }
        });
    }
    </script>

    <script>
        // 通用模态窗口函数
        // 加载中模态窗口
        function showLoadingModal(message = '处理中，请稍候...') {
            // 检查是否已存在加载模态窗口
            let loadingModal = document.getElementById('loadingModal');
            
            // 如果不存在，创建一个
            if (!loadingModal) {
                loadingModal = document.createElement('div');
                loadingModal.id = 'loadingModal';
                loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                loadingModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <div class="animate-spin mb-4 mx-auto">
                            <i class="ri-loader-4-line text-4xl text-primary"></i>
                        </div>
                        <p id="loadingMessage" class="text-gray-700"></p>
                    </div>
                `;
                document.body.appendChild(loadingModal);
            }
            
            // 设置消息并显示
            const messageElement = loadingModal.querySelector('#loadingMessage');
            if (messageElement) {
                messageElement.textContent = message;
            }
            
            loadingModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
        
        // 隐藏加载中模态窗口
        function hideLoadingModal() {
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.classList.add('hidden');
                document.body.style.overflow = ''; // 恢复背景滚动
            }
        }
        
        // 显示错误模态窗口
        function showErrorModal(message, title = '出错了') {
            // 隐藏加载窗口
            hideLoadingModal();
            
            // 检查是否已存在错误模态窗口
            let errorModal = document.getElementById('errorModal');
            
            // 如果不存在，创建一个
            if (!errorModal) {
                errorModal = document.createElement('div');
                errorModal.id = 'errorModal';
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="errorTitle" class="text-xl font-bold text-red-600"></h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="closeErrorModal()" aria-label="关闭">
                                <i class="ri-close-line text-xl"></i>
                            </button>
                        </div>
                        <div class="mb-6">
                            <p id="errorMessage" class="text-gray-700"></p>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="closeErrorModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                我知道了
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
            }
            
            // 设置标题和消息并显示
            const titleElement = errorModal.querySelector('#errorTitle');
            const messageElement = errorModal.querySelector('#errorMessage');
            
            if (titleElement) {
                titleElement.textContent = title;
            }
            
            if (messageElement) {
                messageElement.textContent = message;
            }
            
            errorModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
        
        // 关闭错误模态窗口
        function closeErrorModal() {
            const errorModal = document.getElementById('errorModal');
            if (errorModal) {
                errorModal.classList.add('hidden');
                document.body.style.overflow = ''; // 恢复背景滚动
            }
        }
        
        // 显示成功模态窗口
        function showSuccessModal(message, title = '操作成功') {
            // 隐藏加载窗口
            hideLoadingModal();
            
            // 检查是否已存在成功模态窗口
            let successModal = document.getElementById('successModal');
            
            // 如果不存在，创建一个
            if (!successModal) {
                successModal = document.createElement('div');
                successModal.id = 'successModal';
                successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                successModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="successTitle" class="text-xl font-bold text-green-600"></h3>
                            <button class="text-gray-500 hover:text-gray-700" onclick="closeSuccessModal()" aria-label="关闭">
                                <i class="ri-close-line text-xl"></i>
                            </button>
                        </div>
                        <div class="mb-6">
                            <p id="successMessage" class="text-gray-700"></p>
                        </div>
                        <div class="flex justify-end">
                            <button onclick="closeSuccessModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                确定
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
            }
            
            // 设置标题和消息并显示
            const titleElement = successModal.querySelector('#successTitle');
            const messageElement = successModal.querySelector('#successMessage');
            
            if (titleElement) {
                titleElement.textContent = title;
            }
            
            if (messageElement) {
                messageElement.textContent = message;
            }
            
            successModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
        
        // 关闭成功模态窗口
        function closeSuccessModal() {
            const successModal = document.getElementById('successModal');
            if (successModal) {
                successModal.classList.add('hidden');
                document.body.style.overflow = ''; // 恢复背景滚动
            }
        }
        
        // 点击模态窗口外部关闭
        document.addEventListener('click', function(e) {
            const errorModal = document.getElementById('errorModal');
            const successModal = document.getElementById('successModal');
            
            if (errorModal && !errorModal.querySelector('.bg-white').contains(e.target) && !errorModal.classList.contains('hidden')) {
                closeErrorModal();
            }
            
            if (successModal && !successModal.querySelector('.bg-white').contains(e.target) && !successModal.classList.contains('hidden')) {
                closeSuccessModal();
            }
        });
    </script>

    <!-- 评分汇总按钮的JS代码 -->
    <script>
        // 获取当前选中的项目ID
        function getSelectedProjectId() {
            // 先尝试从隐藏字段获取
            let projectId = document.getElementById('current-project-id')?.value;
            if (!projectId) {
                // 尝试从project_id字段获取
                projectId = document.getElementById('project_id')?.value;
            }
            if (!projectId) {
                // 尝试从URL参数获取
                const urlParams = new URLSearchParams(window.location.search);
                projectId = urlParams.get('project_id');
            }
            return projectId;
        }
        
        /**
         * 更新项目评分表的函数
         * 注意：此函数不再自动调用，因为后端get_score_summary已集成更新项目表的功能
         * 保留此函数以便需要时手动触发项目评分更新
         */
        async function updateProjectScores(projectId, scoreData) {
            try {
                console.log('更新项目表中的评分数据:', projectId, scoreData);
                
                // 调用更新项目评分的API
                const response = await fetch('/api/update_project_scores', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_id: projectId,
                        scores: scoreData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('成功更新项目评分:', result);
                    return true;
                } else {
                    console.error('更新项目评分失败:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('更新项目评分时出错:', error);
                return false;
            }
        }
        
        // 获取评分汇总信息的函数
        async function fetchScoreSummary() {
            const projectId = getSelectedProjectId();
            if (!projectId) {
                showToast('请先选择项目', 'warning');
                return;
            }

            const summaryContainer = document.getElementById('score-summary-container');
            const standardInfoEl = document.getElementById('current-standard-info');
            
            // 显示加载状态
            summaryContainer.innerHTML = '<div class="text-center p-5"><div class="spinner-border" role="status"></div><p class="mt-3">正在获取项目评分数据，请稍候...</p></div>';
            standardInfoEl.textContent = '正在加载评价标准信息...';
            
            try {
                // 直接调用get_score_summary端点获取评分数据，后端会自动更新项目表
                const response = await fetch(`/api/get_score_summary?project_id=${projectId}&force_refresh=true`);
                
                if (!response.ok) {
                    throw new Error(`获取评分数据失败: ${response.status} ${response.statusText}`);
                }
                
                // 解析响应数据
                const data = await response.json();
                
                // 显示评分汇总数据
                displayScoreSummary(data);
                
                // 更新标准信息
                standardInfoEl.textContent = `当前评价标准: ${data.project_standard || '未知'}, 更新时间: ${data.timestamp || '未知'}`;
                
            } catch (error) {
                console.error('获取评分汇总数据出错:', error);
                summaryContainer.innerHTML = `<div class="alert alert-danger">获取评分汇总数据出错: ${error.message}</div>`;
                standardInfoEl.textContent = '加载评价标准信息失败';
            }
        }
        
        // 显示评分汇总数据
        function displayScoreSummary(data) {
            const summaryContainer = document.getElementById('score-summary-container');
            
            // 从响应中获取专业分数和分类分数
            const { total_score, evaluation_result, specialty_scores, scores_detail } = data;
            const specialtyScores = specialty_scores || {};
            const scoresDetail = scores_detail || {};
            
            // 创建总分和评定结果卡片
            let html = `
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">总体评分</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h2 class="mb-0">${total_score || 0} <small>分</small></h2>
                                <p class="text-muted">总分</p>
                            </div>
                            <div class="col-md-6">
                                <h2 class="mb-0">${evaluation_result || '未评定'}</h2>
                                <p class="text-muted">评定结果</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 创建专业得分卡片
            html += `
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">专业得分</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>专业</th>
                                        <th>得分</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            // 使用评分详情中的专业分数
            const 专业分数 = scoresDetail['专业分数'] || {};
            
            // 专业显示顺序
            const specialties = [
                {key: '建筑', label: '建筑专业'},
                {key: '结构', label: '结构专业'},
                {key: '给排水', label: '给排水专业'},
                {key: '电气', label: '电气专业'},
                {key: '暖通', label: '暖通专业'},
                {key: '景观', label: '景观专业'},
                {key: '环境健康与节能', label: '环境健康与节能专业'}
            ];
            
            // 添加专业得分行
            specialties.forEach(specialty => {
                const score = 专业分数[specialty.key] || 0;
                html += `
                    <tr>
                        <td>${specialty.label}</td>
                        <td>${score}</td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // 创建章节得分卡片
            html += `
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">章节得分</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>章节</th>
                                        <th>得分</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            // 使用评分详情中的章节分数
            const 章节分数 = scoresDetail['章节分数'] || {};
            
            // 章节显示顺序
            const categories = [
                {key: '安全耐久', label: '安全耐久'},
                {key: '健康舒适', label: '健康舒适'},
                {key: '生活便利', label: '生活便利'},
                {key: '资源节约', label: '资源节约'},
                {key: '环境宜居', label: '环境宜居'},
                {key: '提高与创新', label: '提高与创新'}
            ];
            
            // 添加章节得分行
            categories.forEach(category => {
                const score = 章节分数[category.key] || 0;
                html += `
                    <tr>
                        <td>${category.label}</td>
                        <td>${score}</td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // 更新容器内容
            summaryContainer.innerHTML = html;
        }
        
        // 简单的提示函数
        function showToast(message, type = 'info') {
            // 如果有现成的Toast系统可以使用
            if (typeof toast !== 'undefined') {
                toast(message, type);
                return;
            }
            
            // 否则使用简单的alert
            alert(message);
        }
        
        // 在页面加载完成后，添加评分菜单点击事件
        document.addEventListener('DOMContentLoaded', function() {
            // 如果当前是评分汇总页面，不再自动加载评分数据
            if (window.location.href.includes('page=score_summary')) {
                console.log('当前是评分汇总页面');
            }
            
            // 获取评分汇总菜单项
            const scoreSummaryMenuItem = document.querySelector('a[data-content="score-summary"]');
            if (scoreSummaryMenuItem) {
                console.log('找到评分汇总菜单项，添加点击事件');
                
                // 添加点击事件，确保点击时先计算评分
                scoreSummaryMenuItem.addEventListener('click', function(e) {
                    // 不阻止默认行为，让导航正常工作
                });
            }
        });
    </script>

    <!-- 评分汇总面板 -->
    <div id="score-summary" class="content-panel" style="display: none;">
        <h3>评分汇总</h3>
        <div class="alert alert-info">
            <p id="current-standard-info">当前评价标准: 加载中...</p>
        </div>
        <div id="score-summary-container">
            <!-- 评分汇总内容将通过JavaScript加载 -->
            <div class="text-center p-5">
                <p>请选择项目并点击"评分汇总"菜单查看评分结果</p>
            </div>
        </div>
    </div>

    <script>
        // ... existing code ...

        // 为提高级得分输入框添加验证
        document.addEventListener('DOMContentLoaded', function() {
            // 如果当前是提高级页面，添加输入验证
            if ('{{ current_level }}' === '提高级') {
                // 获取所有得分输入框
                const scoreInputs = document.querySelectorAll('input[name="score"]');
                
                // 为每个输入框添加事件监听
                scoreInputs.forEach(input => {
                    input.addEventListener('input', function(e) {
                        // 获取输入值
                        const scoreValue = parseFloat(this.value);
                        
                        // 如果不是数字，不做处理
                        if (isNaN(scoreValue)) {
                            return;
                        }
                        
                        // 获取最大分值
                        const maxScore = parseFloat(this.getAttribute('data-maxscore'));
                        
                        // 验证输入值不大于最大分值
                        if (scoreValue > maxScore) {
                            // 提示用户
                            alert(`输入的分数不能大于该条文的分值(${maxScore})`);
                            // 重置为最大分值
                            this.value = maxScore;
                        }
                        
                        // 确保不为负数
                        if (scoreValue < 0) {
                            this.value = 0;
                        }
                    });
                    
                    // 添加失焦事件，确保在用户完成输入后格式化值
                    input.addEventListener('blur', function() {
                        // 如果值为空或不是数字，设为0
                        if (this.value === '' || isNaN(parseFloat(this.value))) {
                            this.value = '0';
                        }
                    });
                });
            }
        });
        
        // ... existing code ...
    </script>
    {% if current_level == '提高级' %}
    <!-- 添加悬浮徽章组件 -->
    <div class="floating-badge" id="categoryBadge" role="status" aria-label="分类达标情况">
        <div class="badge-title">
            <span>分类达标情况</span>
            <span class="toggle-badge" onclick="toggleBadgeContent()" title="展开/收起分类达标情况" aria-label="展开/收起分类达标情况">
                <i class="fas fa-chevron-up" aria-hidden="true"></i>
            </span>
        </div>
        <div class="badge-content" id="badgeContent">
            <div class="category-badges">
                <div class="category-badge" data-category="安全耐久" role="status" aria-label="安全耐久达标状态">安全耐久</div>
                <div class="category-badge" data-category="健康舒适" role="status" aria-label="健康舒适达标状态">健康舒适</div>
                <div class="category-badge" data-category="生活便利" role="status" aria-label="生活便利达标状态">生活便利</div>
                <div class="category-badge" data-category="资源节约" role="status" aria-label="资源节约达标状态">资源节约</div>
                <div class="category-badge" data-category="环境宜居" role="status" aria-label="环境宜居达标状态">环境宜居</div>
                <div class="category-badge" data-category="提高与创新" role="status" aria-label="提高与创新达标状态">提高与创新</div>
            </div>
        </div>
    </div>
    {% endif %}
    <script>
    // 添加徽章相关的JavaScript函数
    function toggleBadgeContent() {
        const content = document.getElementById('badgeContent');
        const icon = document.querySelector('.toggle-badge i');
        content.classList.toggle('collapsed');
        icon.style.transform = content.classList.contains('collapsed') ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    // 更新分类达标状态的函数
    function updateCategoryBadges() {
        const projectId = document.getElementById('current-project-id').value;
        if (!projectId) {
            console.error('未找到项目ID');
            return;
        }

        // 从后端获取项目整体的分类得分数据，强制刷新
        fetch(`/api/get_score_summary?project_id=${projectId}&force_refresh=true`)
            .then(response => response.json())
            .then(data => {
                const minScores = {
                    '安全耐久': 30.0,
                    '健康舒适': 30.0,
                    '生活便利': 21.0,
                    '资源节约': 60.0,
                    '环境宜居': 30.0,
                    '提高与创新': 0.0
                };

                // 使用后端返回的分类得分数据
                const categoryScores = {};
                if (data.specialty_scores_by_category) {
                    Object.values(data.specialty_scores_by_category).forEach(specialtyData => {
                        Object.entries(specialtyData).forEach(([category, score]) => {
                            if (!categoryScores[category]) {
                                categoryScores[category] = 0;
                            }
                            categoryScores[category] += parseFloat(score) || 0;
                        });
                    });
                }

                console.log('更新后的分类得分:', categoryScores);

                // 更新徽章状态
                const badges = document.querySelectorAll('.category-badge');
                badges.forEach(badge => {
                    const category = badge.getAttribute('data-category');
                    const score = categoryScores[category] || 0;
                    const minScore = minScores[category] || 0;
                    
                    console.log(`${category} - 得分: ${score}, 最低要求: ${minScore}`);
                    
                    if (score >= minScore) {
                        badge.classList.remove('not-achieved');
                        badge.classList.add('achieved');
                        badge.title = `${category}: ${score.toFixed(1)} (已达标)`;
                    } else {
                        badge.classList.remove('achieved');
                        badge.classList.add('not-achieved');
                        badge.title = `${category}: ${score.toFixed(1)} (未达标)`;
                    }
                });
            })
            .catch(error => {
                console.error('获取项目评分数据失败:', error);
            });
    }

    function saveScoreData() {
        // 显示保存中状态
        const saveBtn = this;
        const originalText = saveBtn.textContent || '';
        const originalHTML = saveBtn.innerHTML;
        
        if (saveBtn.tagName === 'BUTTON') {
            saveBtn.textContent = '保存中...';
        } else {
            saveBtn.innerHTML = '<i class="ri-loader-2-line"></i>';
            saveBtn.style.animation = 'rotate 1s linear infinite';
        }
        saveBtn.disabled = true;

        // 获取项目名称和ID
        const projectName = document.getElementById('current_project_name')?.value || '';
        const projectId = document.getElementById('project_id')?.value;
        
        if (!projectId) {
            alert('未找到项目ID');
            restoreButton(saveBtn, originalText, originalHTML);
            return;
        }

        // 收集表格数据
        const scoreData = collectScoreData();
        if (scoreData.length === 0) {
            alert('未找到可保存的评分数据，请确保页面包含评分表格。');
            restoreButton(saveBtn, originalText, originalHTML);
            return;
        }

        const requestData = {
            level: '{{ current_level }}',
            specialty: '{{ current_specialty }}',
            project_id: projectId,
            scores: scoreData,
            standard: '{{ project.standard if project and project.standard else "成都市标" }}'
        };

        // 发送数据到服务器
        fetch('/api/save_score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || '保存失败');
            }
            
            // 显示成功消息
            alert('评分信息保存成功！');
            
            // 更新徽章状态
            if ('{{ current_level }}' === '提高级') {
                // 延迟1秒后更新徽章，确保数据已保存到数据库
                setTimeout(() => {
                    console.log('开始更新徽章状态...');
                    updateCategoryBadges();
                }, 1000);
            }
        })
        .catch(error => {
            console.error('保存失败:', error);
            alert('保存失败: ' + error.message);
        })
        .finally(() => {
            restoreButton(saveBtn, originalText, originalHTML);
        });
    }

    // 在页面加载和得分变化时更新徽章
    document.addEventListener('DOMContentLoaded', function() {
        if ('{{ current_level }}' === '提高级') {
            updateCategoryBadges();
            initializeBadgeFilters();
            
            // 监听得分输入变化和保存按钮点击
            const scoreInputs = document.querySelectorAll('input[name="score"]');
            const saveScoreBtn = document.getElementById('saveScoreBtn');
            const floatingSaveBtn = document.getElementById('floatingSaveBtn');
            
            scoreInputs.forEach(input => {
                input.addEventListener('change', () => {
                    // 延迟更新，等待数据保存
                    setTimeout(updateCategoryBadges, 500);
                });
            });

            if (saveScoreBtn) {
                saveScoreBtn.addEventListener('click', () => {
                    // 延迟更新，等待数据保存
                    setTimeout(updateCategoryBadges, 1000);
                });
            }

            if (floatingSaveBtn) {
                floatingSaveBtn.addEventListener('click', () => {
                    // 延迟更新，等待数据保存
                    setTimeout(updateCategoryBadges, 1000);
                });
            }
        }
    });

    // 初始化徽章过滤器功能
    function initializeBadgeFilters() {
        const badges = document.querySelectorAll('.category-badge');
        const tableRows = document.querySelectorAll('table tbody tr');
        let activeCategory = null;

        badges.forEach(badge => {
            badge.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                
                // 如果点击的是当前激活的分类，则取消过滤
                if (this.classList.contains('active')) {
                    this.classList.remove('active');
                    activeCategory = null;
                    // 显示所有行
                    tableRows.forEach(row => {
                        row.style.display = '';
                    });
                } else {
                    // 移除其他徽章的激活状态
                    badges.forEach(b => b.classList.remove('active'));
                    // 激活当前徽章
                    this.classList.add('active');
                    activeCategory = category;
                    
                    // 过滤表格行
                    tableRows.forEach(row => {
                        const rowCategory = row.querySelector('td:nth-child(2) span')?.textContent.trim();
                        if (rowCategory === category) {
                            row.style.display = '';
                            row.style.animation = 'fadeIn 0.3s ease-in';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                }
            });
        });
    }
    </script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</body>
</html>