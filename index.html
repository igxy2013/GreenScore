<!-- 在相关部分添加错误处理 -->
<script>
// DWG导出按钮点击事件
$('#exportDwgBtn').click(function() {
    // 显示加载中状态
    $(this).prop('disabled', true).html('<i class="ri-loader-2-fill animate-spin"></i> 生成中...');
    
    // 获取当前项目ID
    const projectId = $('#project_id').val();
    
    // 调用API
    $.ajax({
        url: '/api/export_dwg',
        type: 'POST',
        data: {
            project_id: projectId,
            template: 'green_building'
        },
        success: function(response) {
            if (response.success) {
                // 下载文件
                window.location.href = '/download/' + response.filename;
                showToast('成功', '已生成DWG文件，正在下载...', 'success');
            } else {
                showToast('失败', response.message || '生成DWG文件失败', 'error');
                console.error('DWG导出错误:', response);
            }
        },
        error: function(xhr) {
            let errorMessage = '生成DWG文件失败';
            
            // 检查是否是DWG服务不可用的错误
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.error && response.error.includes('DWG服务不可用')) {
                    errorMessage = 'DWG导出服务暂不可用，请联系管理员';
                }
            } catch(e) {}
            
            showToast('错误', errorMessage, 'error');
            console.error('DWG导出请求失败:', xhr);
        },
        complete: function() {
            // 恢复按钮状态
            $('#exportDwgBtn').prop('disabled', false).html('<i class="ri-file-download-line"></i> 导出DWG');
        }
    });
});
</script> 